/*! For license information please see 277.82a02d5864aac071401e.js.LICENSE.txt */
"use strict";(self.webpackChunkjoyride=self.webpackChunkjoyride||[]).push([[277],{1591:(t,e,n)=>{n.r(e),n.d(e,{AbstractUserDataWriter:()=>Ip,Bytes:()=>Sf,CACHE_SIZE_UNLIMITED:()=>rf,CollectionReference:()=>Kd,DocumentReference:()=>jd,DocumentSnapshot:()=>np,FieldPath:()=>wf,FieldValue:()=>Ef,Firestore:()=>sf,FirestoreError:()=>Pi,GeoPoint:()=>Tf,LoadBundleTask:()=>nf,Query:()=>Xd,QueryConstraint:()=>lp,QueryDocumentSnapshot:()=>ip,QuerySnapshot:()=>rp,SnapshotMetadata:()=>ep,Timestamp:()=>$i,Transaction:()=>Kp,WriteBatch:()=>Dp,_DatabaseId:()=>$r,_DocumentKey:()=>er,_EmptyAppCheckTokenProvider:()=>Hi,_EmptyAuthCredentialsProvider:()=>Fi,_FieldPath:()=>tr,_cast:()=>zd,_debugAssert:()=>Ri,_isBase64Available:()=>kr,_logWarn:()=>Mi,_validateIsNotUsedTogether:()=>Ud,addDoc:()=>Hp,arrayRemove:()=>Zp,arrayUnion:()=>Jp,clearIndexedDbPersistence:()=>ff,collection:()=>$d,collectionGroup:()=>Yd,connectFirestoreEmulator:()=>qd,deleteDoc:()=>Gp,deleteField:()=>Yp,disableNetwork:()=>gf,doc:()=>Qd,documentId:()=>bf,enableIndexedDbPersistence:()=>uf,enableMultiTabIndexedDbPersistence:()=>hf,enableNetwork:()=>mf,endAt:()=>bp,endBefore:()=>wp,ensureFirestoreConfigured:()=>lf,executeWrite:()=>jp,getDoc:()=>Pp,getDocFromCache:()=>Op,getDocFromServer:()=>Fp,getDocs:()=>Up,getDocsFromCache:()=>Vp,getDocsFromServer:()=>kp,getFirestore:()=>of,increment:()=>tm,initializeFirestore:()=>af,limit:()=>mp,limitToLast:()=>gp,loadBundle:()=>yf,namedQuery:()=>_f,onSnapshot:()=>Wp,onSnapshotsInSync:()=>qp,orderBy:()=>fp,query:()=>cp,queryEqual:()=>Zd,refEqual:()=>Jd,runTransaction:()=>$p,serverTimestamp:()=>Qp,setDoc:()=>Bp,setIndexConfiguration:()=>nm,setLogLevel:()=>Si,snapshotEqual:()=>ap,startAfter:()=>_p,startAt:()=>yp,terminate:()=>vf,updateDoc:()=>zp,waitForPendingWrites:()=>pf,where:()=>hp,writeBatch:()=>em});var i,r=n(389),s=n(8463),a=n(3333),o=n(4444),l="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},c={},u=u||{},h=l||self;function d(){}function f(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function p(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var m="closure_uid_"+(1e9*Math.random()>>>0),g=0;function v(t,e,n){return t.call.apply(t.bind,arguments)}function y(t,e,n){if(!t)throw Error();if(2<arguments.length){var i=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,i),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function _(t,e,n){return(_=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?v:y).apply(null,arguments)}function x(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function w(t,e){function n(){}n.prototype=e.prototype,t.Z=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Vb=function(t,n,i){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return e.prototype[n].apply(t,r)}}function b(){this.s=this.s,this.o=this.o}var S={};b.prototype.s=!1,b.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),0)){var t=function(t){return Object.prototype.hasOwnProperty.call(t,m)&&t[m]||(t[m]=++g)}(this);delete S[t]}},b.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const E=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},T=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){const i=t.length,r="string"==typeof t?t.split(""):t;for(let s=0;s<i;s++)s in r&&e.call(n,r[s],s,t)};function M(t){return Array.prototype.concat.apply([],arguments)}function A(t){const e=t.length;if(0<e){const n=Array(e);for(let i=0;i<e;i++)n[i]=t[i];return n}return[]}function I(t){return/^[\s\xa0]*$/.test(t)}var C,R=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function D(t,e){return-1!=t.indexOf(e)}function L(t,e){return t<e?-1:t>e?1:0}t:{var P=h.navigator;if(P){var N=P.userAgent;if(N){C=N;break t}}C=""}function O(t,e,n){for(const i in t)e.call(n,t[i],i,t)}function F(t){const e={};for(const n in t)e[n]=t[n];return e}var U="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function V(t,e){let n,i;for(let e=1;e<arguments.length;e++){for(n in i=arguments[e],i)t[n]=i[n];for(let e=0;e<U.length;e++)n=U[e],Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}}function k(t){return k[" "](t),t}k[" "]=d;var B,z,G=D(C,"Opera"),H=D(C,"Trident")||D(C,"MSIE"),W=D(C,"Edge"),q=W||H,j=D(C,"Gecko")&&!(D(C.toLowerCase(),"webkit")&&!D(C,"Edge"))&&!(D(C,"Trident")||D(C,"MSIE"))&&!D(C,"Edge"),X=D(C.toLowerCase(),"webkit")&&!D(C,"Edge");function K(){var t=h.document;return t?t.documentMode:void 0}t:{var $="",Y=(z=C,j?/rv:([^\);]+)(\)|;)/.exec(z):W?/Edge\/([\d\.]+)/.exec(z):H?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(z):X?/WebKit\/(\S+)/.exec(z):G?/(?:Version)[ \/]?(\S+)/.exec(z):void 0);if(Y&&($=Y?Y[1]:""),H){var Q=K();if(null!=Q&&Q>parseFloat($)){B=String(Q);break t}}B=$}var J,Z={};function tt(){return t=Z,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=function(){let t=0;const e=R(String(B)).split("."),n=R("9").split("."),i=Math.max(e.length,n.length);for(let a=0;0==t&&a<i;a++){var r=e[a]||"",s=n[a]||"";do{if(r=/(\d*)(\D*)(.*)/.exec(r)||["","","",""],s=/(\d*)(\D*)(.*)/.exec(s)||["","","",""],0==r[0].length&&0==s[0].length)break;t=L(0==r[1].length?0:parseInt(r[1],10),0==s[1].length?0:parseInt(s[1],10))||L(0==r[2].length,0==s[2].length)||L(r[2],s[2]),r=r[3],s=s[3]}while(0==t)}return 0<=t}();var t}h.document&&H?J=K()||parseInt(B,10)||void 0:J=void 0;var et=J,nt=function(){if(!h.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{h.addEventListener("test",d,e),h.removeEventListener("test",d,e)}catch(t){}return t}();function it(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function rt(t,e){if(it.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,i=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(j){t:{try{k(e.nodeName);var r=!0;break t}catch(t){}r=!1}r||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,i?(this.clientX=void 0!==i.clientX?i.clientX:i.pageX,this.clientY=void 0!==i.clientY?i.clientY:i.pageY,this.screenX=i.screenX||0,this.screenY=i.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:st[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&rt.Z.h.call(this)}}it.prototype.h=function(){this.defaultPrevented=!0},w(rt,it);var st={2:"touch",3:"pen",4:"mouse"};rt.prototype.h=function(){rt.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var at="closure_listenable_"+(1e6*Math.random()|0),ot=0;function lt(t,e,n,i,r){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!i,this.ia=r,this.key=++ot,this.ca=this.fa=!1}function ct(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function ut(t){this.src=t,this.g={},this.h=0}function ht(t,e){var n=e.type;if(n in t.g){var i,r=t.g[n],s=E(r,e);(i=0<=s)&&Array.prototype.splice.call(r,s,1),i&&(ct(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function dt(t,e,n,i){for(var r=0;r<t.length;++r){var s=t[r];if(!s.ca&&s.listener==e&&s.capture==!!n&&s.ia==i)return r}return-1}ut.prototype.add=function(t,e,n,i,r){var s=t.toString();(t=this.g[s])||(t=this.g[s]=[],this.h++);var a=dt(t,e,i,r);return-1<a?(e=t[a],n||(e.fa=!1)):((e=new lt(e,this.src,s,!!i,r)).fa=n,t.push(e)),e};var ft="closure_lm_"+(1e6*Math.random()|0),pt={};function mt(t,e,n,i,r){if(i&&i.once)return vt(t,e,n,i,r);if(Array.isArray(e)){for(var s=0;s<e.length;s++)mt(t,e[s],n,i,r);return null}return n=Et(n),t&&t[at]?t.N(e,n,p(i)?!!i.capture:!!i,r):gt(t,e,n,!1,i,r)}function gt(t,e,n,i,r,s){if(!e)throw Error("Invalid event type");var a=p(r)?!!r.capture:!!r,o=bt(t);if(o||(t[ft]=o=new ut(t)),(n=o.add(e,n,i,a,s)).proxy)return n;if(i=function(){var t=wt;return function e(n){return t.call(e.src,e.listener,n)}}(),n.proxy=i,i.src=t,i.listener=n,t.addEventListener)nt||(r=a),void 0===r&&(r=!1),t.addEventListener(e.toString(),i,r);else if(t.attachEvent)t.attachEvent(xt(e.toString()),i);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(i)}return n}function vt(t,e,n,i,r){if(Array.isArray(e)){for(var s=0;s<e.length;s++)vt(t,e[s],n,i,r);return null}return n=Et(n),t&&t[at]?t.O(e,n,p(i)?!!i.capture:!!i,r):gt(t,e,n,!0,i,r)}function yt(t,e,n,i,r){if(Array.isArray(e))for(var s=0;s<e.length;s++)yt(t,e[s],n,i,r);else i=p(i)?!!i.capture:!!i,n=Et(n),t&&t[at]?(t=t.i,(e=String(e).toString())in t.g&&-1<(n=dt(s=t.g[e],n,i,r))&&(ct(s[n]),Array.prototype.splice.call(s,n,1),0==s.length&&(delete t.g[e],t.h--))):t&&(t=bt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=dt(e,n,i,r)),(n=-1<t?e[t]:null)&&_t(n))}function _t(t){if("number"!=typeof t&&t&&!t.ca){var e=t.src;if(e&&e[at])ht(e.i,t);else{var n=t.type,i=t.proxy;e.removeEventListener?e.removeEventListener(n,i,t.capture):e.detachEvent?e.detachEvent(xt(n),i):e.addListener&&e.removeListener&&e.removeListener(i),(n=bt(e))?(ht(n,t),0==n.h&&(n.src=null,e[ft]=null)):ct(t)}}}function xt(t){return t in pt?pt[t]:pt[t]="on"+t}function wt(t,e){if(t.ca)t=!0;else{e=new rt(e,this);var n=t.listener,i=t.ia||t.src;t.fa&&_t(t),t=n.call(i,e)}return t}function bt(t){return(t=t[ft])instanceof ut?t:null}var St="__closure_events_fn_"+(1e9*Math.random()>>>0);function Et(t){return"function"==typeof t?t:(t[St]||(t[St]=function(e){return t.handleEvent(e)}),t[St])}function Tt(){b.call(this),this.i=new ut(this),this.P=this,this.I=null}function Mt(t,e){var n,i=t.I;if(i)for(n=[];i;i=i.I)n.push(i);if(t=t.P,i=e.type||e,"string"==typeof e)e=new it(e,t);else if(e instanceof it)e.target=e.target||t;else{var r=e;V(e=new it(i,t),r)}if(r=!0,n)for(var s=n.length-1;0<=s;s--){var a=e.g=n[s];r=At(a,i,!0,e)&&r}if(r=At(a=e.g=t,i,!0,e)&&r,r=At(a,i,!1,e)&&r,n)for(s=0;s<n.length;s++)r=At(a=e.g=n[s],i,!1,e)&&r}function At(t,e,n,i){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var r=!0,s=0;s<e.length;++s){var a=e[s];if(a&&!a.ca&&a.capture==n){var o=a.listener,l=a.ia||a.src;a.fa&&ht(t.i,a),r=!1!==o.call(l,i)&&r}}return r&&!i.defaultPrevented}w(Tt,b),Tt.prototype[at]=!0,Tt.prototype.removeEventListener=function(t,e,n,i){yt(this,t,e,n,i)},Tt.prototype.M=function(){if(Tt.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],i=0;i<n.length;i++)ct(n[i]);delete e.g[t],e.h--}}this.I=null},Tt.prototype.N=function(t,e,n,i){return this.i.add(String(t),e,!1,n,i)},Tt.prototype.O=function(t,e,n,i){return this.i.add(String(t),e,!0,n,i)};var It=h.JSON.stringify;function Ct(){var t=Ft;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Rt,Dt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Lt),(t=>t.reset()));class Lt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Pt(t){h.setTimeout((()=>{throw t}),0)}function Nt(t,e){Rt||function(){var t=h.Promise.resolve(void 0);Rt=function(){t.then(Ut)}}(),Ot||(Rt(),Ot=!0),Ft.add(t,e)}var Ot=!1,Ft=new class{constructor(){this.h=this.g=null}add(t,e){const n=Dt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Ut(){for(var t;t=Ct();){try{t.h.call(t.g)}catch(t){Pt(t)}var e=Dt;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Ot=!1}function Vt(t,e){Tt.call(this),this.h=t||1,this.g=e||h,this.j=_(this.kb,this),this.l=Date.now()}function kt(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Bt(t,e,n){if("function"==typeof t)n&&(t=_(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=_(t.handleEvent,t)}return 2147483647<Number(e)?-1:h.setTimeout(t,e||0)}function zt(t){t.g=Bt((()=>{t.g=null,t.i&&(t.i=!1,zt(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}w(Vt,Tt),(i=Vt.prototype).da=!1,i.S=null,i.kb=function(){if(this.da){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Mt(this,"tick"),this.da&&(kt(this),this.start()))}},i.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},i.M=function(){Vt.Z.M.call(this),kt(this),delete this.g};class Gt extends b{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:zt(this)}M(){super.M(),this.g&&(h.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ht(t){b.call(this),this.h=t,this.g={}}w(Ht,b);var Wt=[];function qt(t,e,n,i){Array.isArray(n)||(n&&(Wt[0]=n.toString()),n=Wt);for(var r=0;r<n.length;r++){var s=mt(e,n[r],i||t.handleEvent,!1,t.h||t);if(!s)break;t.g[s.key]=s}}function jt(t){O(t.g,(function(t,e){this.g.hasOwnProperty(e)&&_t(t)}),t),t.g={}}function Xt(){this.g=!0}function Kt(t,e,n,i){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var i=n[t];if(!(2>i.length)){var r=i[1];if(Array.isArray(r)&&!(1>r.length)){var s=r[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var a=1;a<r.length;a++)r[a]=""}}}return It(n)}catch(t){return e}}(t,n)+(i?" "+i:"")}))}Ht.prototype.M=function(){Ht.Z.M.call(this),jt(this)},Ht.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Xt.prototype.Aa=function(){this.g=!1},Xt.prototype.info=function(){};var $t={},Yt=null;function Qt(){return Yt=Yt||new Tt}function Jt(t){it.call(this,$t.Ma,t)}function Zt(t){const e=Qt();Mt(e,new Jt(e,t))}function te(t,e){it.call(this,$t.STAT_EVENT,t),this.stat=e}function ee(t){const e=Qt();Mt(e,new te(e,t))}function ne(t,e){it.call(this,$t.Na,t),this.size=e}function ie(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return h.setTimeout((function(){t()}),e)}$t.Ma="serverreachability",w(Jt,it),$t.STAT_EVENT="statevent",w(te,it),$t.Na="timingevent",w(ne,it);var re={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},se={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function ae(){}function oe(t){return t.h||(t.h=t.i())}function le(){}ae.prototype.h=null;var ce,ue={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function he(){it.call(this,"d")}function de(){it.call(this,"c")}function fe(){}function pe(t,e,n,i){this.l=t,this.j=e,this.m=n,this.X=i||1,this.V=new Ht(this),this.P=ge,t=q?125:void 0,this.W=new Vt(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new me}function me(){this.i=null,this.g="",this.h=!1}w(he,it),w(de,it),w(fe,ae),fe.prototype.g=function(){return new XMLHttpRequest},fe.prototype.i=function(){return{}},ce=new fe;var ge=45e3,ve={},ye={};function _e(t,e,n){t.K=1,t.v=Ge(Fe(e)),t.s=n,t.U=!0,xe(t,null)}function xe(t,e){t.F=Date.now(),Ee(t),t.A=Fe(t.v);var n=t.A,i=t.X;Array.isArray(i)||(i=[String(i)]),en(n.h,"t",i),t.C=0,n=t.l.H,t.h=new me,t.g=ni(t.l,n?e:null,!t.s),0<t.O&&(t.L=new Gt(_(t.Ia,t,t.g),t.O)),qt(t.V,t.g,"readystatechange",t.gb),e=t.H?F(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Zt(1),function(t,e,n,i,r,s){t.info((function(){if(t.g)if(s)for(var a="",o=s.split("&"),l=0;l<o.length;l++){var c=o[l].split("=");if(1<c.length){var u=c[0];c=c[1];var h=u.split("_");a=2<=h.length&&"type"==h[1]?a+(u+"=")+c+"&":a+(u+"=redacted&")}}else a=null;else a=s;return"XMLHTTP REQ ("+i+") [attempt "+r+"]: "+e+"\n"+n+"\n"+a}))}(t.j,t.u,t.A,t.m,t.X,t.s)}function we(t){return!!t.g&&"GET"==t.u&&2!=t.K&&t.l.Ba}function be(t,e,n){let i,r=!0;for(;!t.I&&t.C<n.length;){if(i=Se(t,n),i==ye){4==e&&(t.o=4,ee(14),r=!1),Kt(t.j,t.m,null,"[Incomplete Response]");break}if(i==ve){t.o=4,ee(15),Kt(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}Kt(t.j,t.m,i,null),Ce(t,i)}we(t)&&i!=ye&&i!=ve&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,ee(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Kn(e),e.L=!0,ee(11))):(Kt(t.j,t.m,n,"[Invalid Chunked Response]"),Ie(t),Ae(t))}function Se(t,e){var n=t.C,i=e.indexOf("\n",n);return-1==i?ye:(n=Number(e.substring(n,i)),isNaN(n)?ve:(i+=1)+n>e.length?ye:(e=e.substr(i,n),t.C=i+n,e))}function Ee(t){t.Y=Date.now()+t.P,Te(t,t.P)}function Te(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=ie(_(t.eb,t),e)}function Me(t){t.B&&(h.clearTimeout(t.B),t.B=null)}function Ae(t){0==t.l.G||t.I||Qn(t.l,t)}function Ie(t){Me(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,kt(t.W),jt(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function Ce(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||ln(n.i,t)))if(n.I=t.N,!t.J&&ln(n.i,t)&&3==n.G){try{var i=n.Ca.g.parse(e)}catch(t){i=null}if(Array.isArray(i)&&3==i.length){var r=i;if(0==r[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;Yn(n),kn(n)}Xn(n),ee(18)}}else n.ta=r[1],0<n.ta-n.U&&37500>r[2]&&n.N&&0==n.A&&!n.v&&(n.v=ie(_(n.ab,n),6e3));if(1>=on(n.i)&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Zn(n,11)}else if((t.J||n.g==t)&&Yn(n),!I(e))for(r=n.Ca.g.parse(e),e=0;e<r.length;e++){let c=r[e];if(n.U=c[0],c=c[1],2==n.G)if("c"==c[0]){n.J=c[1],n.la=c[2];const e=c[3];null!=e&&(n.ma=e,n.h.info("VER="+n.ma));const r=c[4];null!=r&&(n.za=r,n.h.info("SVER="+n.za));const u=c[5];null!=u&&"number"==typeof u&&0<u&&(i=1.5*u,n.K=i,n.h.info("backChannelRequestTimeoutMs_="+i)),i=n;const h=t.g;if(h){const t=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var s=i.i;!s.g&&(D(t,"spdy")||D(t,"quic")||D(t,"h2"))&&(s.j=s.l,s.g=new Set,s.h&&(cn(s,s.h),s.h=null))}if(i.D){const t=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(i.sa=t,ze(i.F,i.D,t))}}n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var a=t;if((i=n).oa=ei(i,i.H?i.la:null,i.W),a.J){un(i.i,a);var o=a,l=i.K;l&&o.setTimeout(l),o.B&&(Me(o),Ee(o)),i.g=a}else jn(i);0<n.l.length&&Gn(n)}else"stop"!=c[0]&&"close"!=c[0]||Zn(n,7);else 3==n.G&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?Zn(n,7):Vn(n):"noop"!=c[0]&&n.j&&n.j.wa(c),n.A=0)}Zt(4)}catch(t){}}function Re(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(f(t)||"string"==typeof t)T(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(f(t)||"string"==typeof t){n=[];for(var i=t.length,r=0;r<i;r++)n.push(r)}else for(r in n=[],i=0,t)n[i++]=r;i=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(f(t)){for(var e=[],n=t.length,i=0;i<n;i++)e.push(t[i]);return e}for(i in e=[],n=0,t)e[n++]=t[i];return e}(t),r=i.length;for(var s=0;s<r;s++)e.call(void 0,i[s],n&&n[s],t)}}function De(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var i=0;i<n;i+=2)this.set(arguments[i],arguments[i+1])}else if(t)if(t instanceof De)for(n=t.T(),i=0;i<n.length;i++)this.set(n[i],t.get(n[i]));else for(i in t)this.set(i,t[i])}function Le(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var i=t.g[e];Pe(t.h,i)&&(t.g[n++]=i),e++}t.g.length=n}if(t.i!=t.g.length){var r={};for(n=e=0;e<t.g.length;)Pe(r,i=t.g[e])||(t.g[n++]=i,r[i]=1),e++;t.g.length=n}}function Pe(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(i=pe.prototype).setTimeout=function(t){this.P=t},i.gb=function(t){t=t.target;const e=this.L;e&&3==Pn(t)?e.l():this.Ia(t)},i.Ia=function(t){try{if(t==this.g)t:{const u=Pn(this.g);var e=this.g.Da();const d=this.g.ba();if(!(3>u)&&(3!=u||q||this.g&&(this.h.h||this.g.ga()||Nn(this.g)))){this.I||4!=u||7==e||Zt(8==e||0>=d?3:2),Me(this);var n=this.g.ba();this.N=n;e:if(we(this)){var i=Nn(this.g);t="";var r=i.length,s=4==Pn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Ie(this),Ae(this);var a="";break e}this.h.i=new h.TextDecoder}for(e=0;e<r;e++)this.h.h=!0,t+=this.h.i.decode(i[e],{stream:s&&e==r-1});i.splice(0,r),this.h.g+=t,this.C=0,a=this.h.g}else a=this.g.ga();if(this.i=200==n,function(t,e,n,i,r,s,a){t.info((function(){return"XMLHTTP RESP ("+i+") [ attempt "+r+"]: "+e+"\n"+n+"\n"+s+" "+a}))}(this.j,this.u,this.A,this.m,this.X,u,n),this.i){if(this.$&&!this.J){e:{if(this.g){var o,l=this.g;if((o=l.g?l.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!I(o)){var c=o;break e}}c=null}if(!(n=c)){this.i=!1,this.o=3,ee(12),Ie(this),Ae(this);break t}Kt(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Ce(this,n)}this.U?(be(this,u,a),q&&this.i&&3==u&&(qt(this.V,this.W,"tick",this.fb),this.W.start())):(Kt(this.j,this.m,a,null),Ce(this,a)),4==u&&Ie(this),this.i&&!this.I&&(4==u?Qn(this.l,this):(this.i=!1,Ee(this)))}else 400==n&&0<a.indexOf("Unknown SID")?(this.o=3,ee(12)):(this.o=0,ee(13)),Ie(this),Ae(this)}}}catch(t){}},i.fb=function(){if(this.g){var t=Pn(this.g),e=this.g.ga();this.C<e.length&&(Me(this),be(this,t,e),this.i&&4!=t&&Ee(this))}},i.cancel=function(){this.I=!0,Ie(this)},i.eb=function(){this.B=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.K&&(Zt(3),ee(17)),Ie(this),this.o=2,Ae(this)):Te(this,this.Y-t)},(i=De.prototype).R=function(){Le(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},i.T=function(){return Le(this),this.g.concat()},i.get=function(t,e){return Pe(this.h,t)?this.h[t]:e},i.set=function(t,e){Pe(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},i.forEach=function(t,e){for(var n=this.T(),i=0;i<n.length;i++){var r=n[i],s=this.get(r);t.call(e,s,r,this)}};var Ne=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Oe(t,e){if(this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof Oe){this.g=void 0!==e?e:t.g,Ue(this,t.j),this.s=t.s,Ve(this,t.i),ke(this,t.m),this.l=t.l,e=t.h;var n=new Qe;n.i=e.i,e.g&&(n.g=new De(e.g),n.h=e.h),Be(this,n),this.o=t.o}else t&&(n=String(t).match(Ne))?(this.g=!!e,Ue(this,n[1]||"",!0),this.s=He(n[2]||""),Ve(this,n[3]||"",!0),ke(this,n[4]),this.l=He(n[5]||"",!0),Be(this,n[6]||"",!0),this.o=He(n[7]||"")):(this.g=!!e,this.h=new Qe(null,this.g))}function Fe(t){return new Oe(t)}function Ue(t,e,n){t.j=n?He(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Ve(t,e,n){t.i=n?He(e,!0):e}function ke(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Be(t,e,n){e instanceof Qe?(t.h=e,function(t,e){e&&!t.j&&(Je(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(Ze(this,e),en(this,n,t))}),t)),t.j=e}(t.h,t.g)):(n||(e=We(e,$e)),t.h=new Qe(e,t.g))}function ze(t,e,n){t.h.set(e,n)}function Ge(t){return ze(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function He(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function We(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,qe),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function qe(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Oe.prototype.toString=function(){var t=[],e=this.j;e&&t.push(We(e,je,!0),":");var n=this.i;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(We(e,je,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(We(n,"/"==n.charAt(0)?Ke:Xe,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",We(n,Ye)),t.join("")};var je=/[#\/\?@]/g,Xe=/[#\?:]/g,Ke=/[#\?]/g,$e=/[#\?@]/g,Ye=/#/g;function Qe(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Je(t){t.g||(t.g=new De,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var i=t[n].indexOf("="),r=null;if(0<=i){var s=t[n].substring(0,i);r=t[n].substring(i+1)}else s=t[n];e(s,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function Ze(t,e){Je(t),e=nn(t,e),Pe(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,Pe((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&Le(t)))}function tn(t,e){return Je(t),e=nn(t,e),Pe(t.g.h,e)}function en(t,e,n){Ze(t,e),0<n.length&&(t.i=null,t.g.set(nn(t,e),A(n)),t.h+=n.length)}function nn(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}function rn(t){this.l=t||sn,t=h.PerformanceNavigationTiming?0<(t=h.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(h.g&&h.g.Ea&&h.g.Ea()&&h.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(i=Qe.prototype).add=function(t,e){Je(this),this.i=null,t=nn(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},i.forEach=function(t,e){Je(this),this.g.forEach((function(n,i){T(n,(function(n){t.call(e,n,i,this)}),this)}),this)},i.T=function(){Je(this);for(var t=this.g.R(),e=this.g.T(),n=[],i=0;i<e.length;i++)for(var r=t[i],s=0;s<r.length;s++)n.push(e[i]);return n},i.R=function(t){Je(this);var e=[];if("string"==typeof t)tn(this,t)&&(e=M(e,this.g.get(nn(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=M(e,t[n])}return e},i.set=function(t,e){return Je(this),this.i=null,tn(this,t=nn(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},i.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},i.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++){var i=e[n],r=encodeURIComponent(String(i));i=this.R(i);for(var s=0;s<i.length;s++){var a=r;""!==i[s]&&(a+="="+encodeURIComponent(String(i[s]))),t.push(a)}}return this.i=t.join("&")};var sn=10;function an(t){return!!t.h||!!t.g&&t.g.size>=t.j}function on(t){return t.h?1:t.g?t.g.size:0}function ln(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function cn(t,e){t.g?t.g.add(e):t.h=e}function un(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function hn(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return A(t.i)}function dn(){}function fn(){this.g=new dn}function pn(t,e,n){const i=n||"";try{Re(t,(function(t,n){let r=t;p(t)&&(r=It(t)),e.push(i+n+"="+encodeURIComponent(r))}))}catch(t){throw e.push(i+"type="+encodeURIComponent("_badmap")),t}}function mn(t,e,n,i,r){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,r(i)}catch(t){}}function gn(t){this.l=t.$b||null,this.j=t.ib||!1}function vn(t,e){Tt.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=yn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}rn.prototype.cancel=function(){if(this.i=hn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},dn.prototype.stringify=function(t){return h.JSON.stringify(t,void 0)},dn.prototype.parse=function(t){return h.JSON.parse(t,void 0)},w(gn,ae),gn.prototype.g=function(){return new vn(this.l,this.j)},gn.prototype.i=function(t){return function(){return t}}({}),w(vn,Tt);var yn=0;function _n(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function xn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,wn(t)}function wn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(i=vn.prototype).open=function(t,e){if(this.readyState!=yn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,wn(this)},i.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||h).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},i.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,xn(this)),this.readyState=yn},i.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,wn(this)),this.g&&(this.readyState=3,wn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==h.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;_n(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},i.Sa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?xn(this):wn(this),3==this.readyState&&_n(this)}},i.Ua=function(t){this.g&&(this.response=this.responseText=t,xn(this))},i.Ta=function(t){this.g&&(this.response=t,xn(this))},i.ha=function(){this.g&&xn(this)},i.setRequestHeader=function(t,e){this.v.append(t,e)},i.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},i.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(vn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var bn=h.JSON.parse;function Sn(t){Tt.call(this),this.headers=new De,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=En,this.K=this.L=!1}w(Sn,Tt);var En="",Tn=/^https?$/i,Mn=["POST","PUT"];function An(t){return"content-type"==t.toLowerCase()}function In(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Cn(t),Dn(t)}function Cn(t){t.D||(t.D=!0,Mt(t,"complete"),Mt(t,"error"))}function Rn(t){if(t.h&&void 0!==u&&(!t.C[1]||4!=Pn(t)||2!=t.ba()))if(t.v&&4==Pn(t))Bt(t.Fa,0,t);else if(Mt(t,"readystatechange"),4==Pn(t)){t.h=!1;try{const o=t.ba();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var i;if(i=0===o){var r=String(t.H).match(Ne)[1]||null;if(!r&&h.self&&h.self.location){var s=h.self.location.protocol;r=s.substr(0,s.length-1)}i=!Tn.test(r?r.toLowerCase():"")}n=i}if(n)Mt(t,"complete"),Mt(t,"success");else{t.m=6;try{var a=2<Pn(t)?t.g.statusText:""}catch(t){a=""}t.j=a+" ["+t.ba()+"]",Cn(t)}}finally{Dn(t)}}}function Dn(t,e){if(t.g){Ln(t);const n=t.g,i=t.C[0]?d:null;t.g=null,t.C=null,e||Mt(t,"ready");try{n.onreadystatechange=i}catch(t){}}}function Ln(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(h.clearTimeout(t.A),t.A=null)}function Pn(t){return t.g?t.g.readyState:0}function Nn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case En:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function On(t,e,n){t:{for(i in n){var i=!1;break t}i=!0}i||(n=function(t){let e="";return O(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):ze(t,e,n))}function Fn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Un(t){this.za=0,this.l=[],this.h=new Xt,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Fn("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Fn("baseRetryDelayMs",5e3,t),this.$a=Fn("retryDelaySeedMs",1e4,t),this.Ya=Fn("forwardChannelMaxRetries",2,t),this.ra=Fn("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new rn(t&&t.concurrentRequestLimit),this.Ca=new fn,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function Vn(t){if(Bn(t),3==t.G){var e=t.V++,n=Fe(t.F);ze(n,"SID",t.J),ze(n,"RID",e),ze(n,"TYPE","terminate"),Wn(t,n),(e=new pe(t,t.h,e,void 0)).K=2,e.v=Ge(Fe(n)),n=!1,h.navigator&&h.navigator.sendBeacon&&(n=h.navigator.sendBeacon(e.v.toString(),"")),!n&&h.Image&&((new Image).src=e.v,n=!0),n||(e.g=ni(e.l,null),e.g.ea(e.v)),e.F=Date.now(),Ee(e)}ti(t)}function kn(t){t.g&&(Kn(t),t.g.cancel(),t.g=null)}function Bn(t){kn(t),t.u&&(h.clearTimeout(t.u),t.u=null),Yn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&h.clearTimeout(t.m),t.m=null)}function zn(t,e){t.l.push(new class{constructor(t,e){this.h=t,this.g=e}}(t.Za++,e)),3==t.G&&Gn(t)}function Gn(t){an(t.i)||t.m||(t.m=!0,Nt(t.Ha,t),t.C=0)}function Hn(t,e){var n;n=e?e.m:t.V++;const i=Fe(t.F);ze(i,"SID",t.J),ze(i,"RID",n),ze(i,"AID",t.U),Wn(t,i),t.o&&t.s&&On(i,t.o,t.s),n=new pe(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=qn(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),cn(t.i,n),_e(n,i,e)}function Wn(t,e){t.j&&Re({},(function(t,n){ze(e,n,t)}))}function qn(t,e,n){n=Math.min(t.l.length,n);var i=t.j?_(t.j.Oa,t.j,t):null;t:{var r=t.l;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=r[0].h,t.push("ofs="+e)):e=0:t.push("ofs="+e);let s=!0;for(let a=0;a<n;a++){let n=r[a].h;const o=r[a].g;if(n-=e,0>n)e=Math.max(0,r[a].h-100),s=!1;else try{pn(o,t,"req"+n+"_")}catch(t){i&&i(o)}}if(s){i=t.join("&");break t}}}return t=t.l.splice(0,n),e.D=t,i}function jn(t){t.g||t.u||(t.Y=1,Nt(t.Ga,t),t.A=0)}function Xn(t){return!(t.g||t.u||3<=t.A||(t.Y++,t.u=ie(_(t.Ga,t),Jn(t,t.A)),t.A++,0))}function Kn(t){null!=t.B&&(h.clearTimeout(t.B),t.B=null)}function $n(t){t.g=new pe(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=Fe(t.oa);ze(e,"RID","rpc"),ze(e,"SID",t.J),ze(e,"CI",t.N?"0":"1"),ze(e,"AID",t.U),Wn(t,e),ze(e,"TYPE","xmlhttp"),t.o&&t.s&&On(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=Ge(Fe(e)),n.s=null,n.U=!0,xe(n,t)}function Yn(t){null!=t.v&&(h.clearTimeout(t.v),t.v=null)}function Qn(t,e){var n=null;if(t.g==e){Yn(t),Kn(t),t.g=null;var i=2}else{if(!ln(t.i,e))return;n=e.D,un(t.i,e),i=1}if(t.I=e.N,0!=t.G)if(e.i)if(1==i){n=e.s?e.s.length:0,e=Date.now()-e.F;var r=t.C;Mt(i=Qt(),new ne(i,n,e,r)),Gn(t)}else jn(t);else if(3==(r=e.o)||0==r&&0<t.I||!(1==i&&function(t,e){return!(on(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.l=e.D.concat(t.l),0):1==t.G||2==t.G||t.C>=(t.Xa?0:t.Ya)||(t.m=ie(_(t.Ha,t,e),Jn(t,t.C)),t.C++,0)))}(t,e)||2==i&&Xn(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),r){case 1:Zn(t,5);break;case 4:Zn(t,10);break;case 3:Zn(t,6);break;default:Zn(t,2)}}function Jn(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Zn(t,e){if(t.h.info("Error code "+e),2==e){var n=null;t.j&&(n=null);var i=_(t.jb,t);n||(n=new Oe("//www.google.com/images/cleardot.gif"),h.location&&"http"==h.location.protocol||Ue(n,"https"),Ge(n)),function(t,e){const n=new Xt;if(h.Image){const i=new Image;i.onload=x(mn,n,i,"TestLoadImage: loaded",!0,e),i.onerror=x(mn,n,i,"TestLoadImage: error",!1,e),i.onabort=x(mn,n,i,"TestLoadImage: abort",!1,e),i.ontimeout=x(mn,n,i,"TestLoadImage: timeout",!1,e),h.setTimeout((function(){i.ontimeout&&i.ontimeout()}),1e4),i.src=t}else e(!1)}(n.toString(),i)}else ee(2);t.G=0,t.j&&t.j.va(e),ti(t),Bn(t)}function ti(t){t.G=0,t.I=-1,t.j&&(0==hn(t.i).length&&0==t.l.length||(t.i.i.length=0,A(t.l),t.l.length=0),t.j.ua())}function ei(t,e,n){let i=function(t){return t instanceof Oe?Fe(t):new Oe(t,void 0)}(n);if(""!=i.i)e&&Ve(i,e+"."+i.i),ke(i,i.m);else{const t=h.location;i=function(t,e,n,i){var r=new Oe(null,void 0);return t&&Ue(r,t),e&&Ve(r,e),n&&ke(r,n),i&&(r.l=i),r}(t.protocol,e?e+"."+t.hostname:t.hostname,+t.port,n)}return t.aa&&O(t.aa,(function(t,e){ze(i,e,t)})),e=t.D,n=t.sa,e&&n&&ze(i,e,n),ze(i,"VER",t.ma),Wn(t,i),i}function ni(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new Sn(new gn({ib:!0})):new Sn(t.qa)).L=t.H,e}function ii(){}function ri(){if(H&&!(10<=Number(et)))throw Error("Environmental error: no available transport.")}function si(t,e){Tt.call(this),this.g=new Un(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!I(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!I(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&e in(t=this.h)&&delete t[e]),this.j=new li(this)}function ai(t){he.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function oi(){de.call(this),this.status=1}function li(t){this.g=t}(i=Sn.prototype).ea=function(t,e,n,i){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():ce.g(),this.C=this.u?oe(this.u):oe(ce),this.g.onreadystatechange=_(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void In(this,t)}t=n||"";const r=new De(this.headers);i&&Re(i,(function(t,e){r.set(e,t)})),i=function(t){t:{var e=An;const n=t.length,i="string"==typeof t?t.split(""):t;for(let r=0;r<n;r++)if(r in i&&e.call(void 0,i[r],r,t)){e=r;break t}e=-1}return 0>e?null:"string"==typeof t?t.charAt(e):t[e]}(r.T()),n=h.FormData&&t instanceof h.FormData,!(0<=E(Mn,e))||i||n||r.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r.forEach((function(t,e){this.g.setRequestHeader(e,t)}),this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Ln(this),0<this.B&&((this.K=function(t){return H&&tt()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=_(this.pa,this)):this.A=Bt(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){In(this,t)}},i.pa=function(){void 0!==u&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Mt(this,"timeout"),this.abort(8))},i.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,Mt(this,"complete"),Mt(this,"abort"),Dn(this))},i.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Dn(this,!0)),Sn.Z.M.call(this)},i.Fa=function(){this.s||(this.F||this.v||this.l?Rn(this):this.cb())},i.cb=function(){Rn(this)},i.ba=function(){try{return 2<Pn(this)?this.g.status:-1}catch(t){return-1}},i.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},i.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),bn(e)}},i.Da=function(){return this.m},i.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(i=Un.prototype).ma=8,i.G=1,i.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},i.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const r=new pe(this,this.h,t,void 0);let s=this.s;if(this.P&&(s?(s=F(s),V(s,this.P)):s=this.P),null===this.o&&(r.H=s),this.ja)t:{for(var e=0,n=0;n<this.l.length;n++){var i=this.l[n];if(void 0===(i="__data__"in i.g&&"string"==typeof(i=i.g.__data__)?i.length:void 0))break;if(4096<(e+=i)){e=n;break t}if(4096===e||n===this.l.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=qn(this,r,e),ze(n=Fe(this.F),"RID",t),ze(n,"CVER",22),this.D&&ze(n,"X-HTTP-Session-Id",this.D),Wn(this,n),this.o&&s&&On(n,this.o,s),cn(this.i,r),this.Ra&&ze(n,"TYPE","init"),this.ja?(ze(n,"$req",e),ze(n,"SID","null"),r.$=!0,_e(r,n,null)):_e(r,n,e),this.G=2}}else 3==this.G&&(t?Hn(this,t):0==this.l.length||an(this.i)||Hn(this))},i.Ga=function(){if(this.u=null,$n(this),this.$&&!(this.L||null==this.g||0>=this.O)){var t=2*this.O;this.h.info("BP detection timer enabled: "+t),this.B=ie(_(this.bb,this),t)}},i.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,ee(10),kn(this),$n(this))},i.ab=function(){null!=this.v&&(this.v=null,kn(this),Xn(this),ee(19))},i.jb=function(t){t?(this.h.info("Successfully pinged google.com"),ee(2)):(this.h.info("Failed to ping google.com"),ee(1))},(i=ii.prototype).xa=function(){},i.wa=function(){},i.va=function(){},i.ua=function(){},i.Oa=function(){},ri.prototype.g=function(t,e){return new si(t,e)},w(si,Tt),si.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Nt(_(t.hb,t,e))),ee(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=ei(t,null,t.W),Gn(t)},si.prototype.close=function(){Vn(this.g)},si.prototype.u=function(t){if("string"==typeof t){var e={};e.__data__=t,zn(this.g,e)}else this.v?((e={}).__data__=It(t),zn(this.g,e)):zn(this.g,t)},si.prototype.M=function(){this.g.j=null,delete this.j,Vn(this.g),delete this.g,si.Z.M.call(this)},w(ai,he),w(oi,de),w(li,ii),li.prototype.xa=function(){Mt(this.g,"a")},li.prototype.wa=function(t){Mt(this.g,new ai(t))},li.prototype.va=function(t){Mt(this.g,new oi(t))},li.prototype.ua=function(){Mt(this.g,"b")},ri.prototype.createWebChannel=ri.prototype.g,si.prototype.send=si.prototype.u,si.prototype.open=si.prototype.m,si.prototype.close=si.prototype.close,re.NO_ERROR=0,re.TIMEOUT=8,re.HTTP_ERROR=6,se.COMPLETE="complete",le.EventType=ue,ue.OPEN="a",ue.CLOSE="b",ue.ERROR="c",ue.MESSAGE="d",Tt.prototype.listen=Tt.prototype.N,Sn.prototype.listenOnce=Sn.prototype.O,Sn.prototype.getLastError=Sn.prototype.La,Sn.prototype.getLastErrorCode=Sn.prototype.Da,Sn.prototype.getStatus=Sn.prototype.ba,Sn.prototype.getResponseJson=Sn.prototype.Qa,Sn.prototype.getResponseText=Sn.prototype.ga,Sn.prototype.send=Sn.prototype.ea;var ci=c.createWebChannelTransport=function(){return new ri},ui=c.getStatEventTarget=function(){return Qt()},hi=c.ErrorCode=re,di=c.EventType=se,fi=c.Event=$t,pi=c.Stat={rb:0,ub:1,vb:2,Ob:3,Tb:4,Qb:5,Rb:6,Pb:7,Nb:8,Sb:9,PROXY:10,NOPROXY:11,Lb:12,Hb:13,Ib:14,Gb:15,Jb:16,Kb:17,nb:18,mb:19,ob:20},mi=c.FetchXmlHttpFactory=gn,gi=c.WebChannel=le,vi=c.XhrIo=Sn;const yi="@firebase/firestore";class _i{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}_i.UNAUTHENTICATED=new _i(null),_i.GOOGLE_CREDENTIALS=new _i("google-credentials-uid"),_i.FIRST_PARTY=new _i("first-party-uid"),_i.MOCK_USER=new _i("mock-user");let xi="9.9.2";const wi=new a.Yd("@firebase/firestore");function bi(){return wi.logLevel}function Si(t){wi.setLogLevel(t)}function Ei(t,...e){if(wi.logLevel<=a.in.DEBUG){const n=e.map(Ai);wi.debug(`Firestore (${xi}): ${t}`,...n)}}function Ti(t,...e){if(wi.logLevel<=a.in.ERROR){const n=e.map(Ai);wi.error(`Firestore (${xi}): ${t}`,...n)}}function Mi(t,...e){if(wi.logLevel<=a.in.WARN){const n=e.map(Ai);wi.warn(`Firestore (${xi}): ${t}`,...n)}}function Ai(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function Ii(t="Unexpected state"){const e=`FIRESTORE (${xi}) INTERNAL ASSERTION FAILED: `+t;throw Ti(e),new Error(e)}function Ci(t,e){t||Ii()}function Ri(t,e){t||Ii()}function Di(t,e){return t}const Li={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Pi extends o.ZR{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Ni{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Oi{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Fi{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(_i.UNAUTHENTICATED)))}shutdown(){}}class Ui{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class Vi{constructor(t){this.t=t,this.currentUser=_i.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const i=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let r=new Ni;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Ni,t.enqueueRetryable((()=>i(this.currentUser)))};const s=()=>{const e=r;t.enqueueRetryable((async()=>{await e.promise,await i(this.currentUser)}))},a=t=>{Ei("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),s()};this.t.onInit((t=>a(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?a(t):(Ei("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Ni)}}),0),s()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(Ei("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Ci("string"==typeof e.accessToken),new Oi(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Ci(null===t||"string"==typeof t),new _i(t)}}class ki{constructor(t,e,n){this.type="FirstParty",this.user=_i.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",e);const i=t.auth.getAuthHeaderValueForFirstParty([]);i&&this.headers.set("Authorization",i),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class Bi{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new ki(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(_i.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class zi{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Gi{constructor(t){this.g=t,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(t,e){const n=t=>{null!=t.error&&Ei("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.p;return this.p=t.token,Ei("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const i=t=>{Ei("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.g.onInit((t=>i(t))),setTimeout((()=>{if(!this.appCheck){const t=this.g.getImmediate({optional:!0});t?i(t):Ei("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Ci("string"==typeof t.token),this.p=t.token,new zi(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Hi{getToken(){return Promise.resolve(new zi(""))}invalidateToken(){}start(t,e){}shutdown(){}}function Wi(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class qi{static I(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const i=Wi(40);for(let r=0;r<i.length;++r)n.length<20&&i[r]<e&&(n+=t.charAt(i[r]%t.length))}return n}}function ji(t,e){return t<e?-1:t>e?1:0}function Xi(t,e,n){return t.length===e.length&&t.every(((t,i)=>n(t,e[i])))}function Ki(t){return t+"\0"}class $i{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Pi(Li.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Pi(Li.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Pi(Li.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Pi(Li.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return $i.fromMillis(Date.now())}static fromDate(t){return $i.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new $i(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?ji(this.nanoseconds,t.nanoseconds):ji(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Yi{constructor(t){this.timestamp=t}static fromTimestamp(t){return new Yi(t)}static min(){return new Yi(new $i(0,0))}static max(){return new Yi(new $i(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Qi{constructor(t,e,n){void 0===e?e=0:e>t.length&&Ii(),void 0===n?n=t.length-e:n>t.length-e&&Ii(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===Qi.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Qi?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let i=0;i<n;i++){const n=t.get(i),r=e.get(i);if(n<r)return-1;if(n>r)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class Ji extends Qi{construct(t,e,n){return new Ji(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Pi(Li.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new Ji(e)}static emptyPath(){return new Ji([])}}const Zi=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class tr extends Qi{construct(t,e,n){return new tr(t,e,n)}static isValidIdentifier(t){return Zi.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),tr.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new tr(["__name__"])}static fromServerFormat(t){const e=[];let n="",i=0;const r=()=>{if(0===n.length)throw new Pi(Li.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let s=!1;for(;i<t.length;){const e=t[i];if("\\"===e){if(i+1===t.length)throw new Pi(Li.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[i+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Pi(Li.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,i+=2}else"`"===e?(s=!s,i++):"."!==e||s?(n+=e,i++):(r(),i++)}if(r(),s)throw new Pi(Li.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new tr(e)}static emptyPath(){return new tr([])}}class er{constructor(t){this.path=t}static fromPath(t){return new er(Ji.fromString(t))}static fromName(t){return new er(Ji.fromString(t).popFirst(5))}static empty(){return new er(Ji.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===Ji.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return Ji.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new er(new Ji(t.slice()))}}class nr{constructor(t,e,n,i){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=i}}function ir(t){return t.fields.find((t=>2===t.kind))}function rr(t){return t.fields.filter((t=>2!==t.kind))}function sr(t,e){let n=ji(t.collectionGroup,e.collectionGroup);if(0!==n)return n;for(let i=0;i<Math.min(t.fields.length,e.fields.length);++i)if(n=or(t.fields[i],e.fields[i]),0!==n)return n;return ji(t.fields.length,e.fields.length)}nr.UNKNOWN_ID=-1;class ar{constructor(t,e){this.fieldPath=t,this.kind=e}}function or(t,e){const n=tr.comparator(t.fieldPath,e.fieldPath);return 0!==n?n:ji(t.kind,e.kind)}class lr{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new lr(0,hr.min())}}function cr(t,e){const n=t.toTimestamp().seconds,i=t.toTimestamp().nanoseconds+1,r=Yi.fromTimestamp(1e9===i?new $i(n+1,0):new $i(n,i));return new hr(r,er.empty(),e)}function ur(t){return new hr(t.readTime,t.key,-1)}class hr{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new hr(Yi.min(),er.empty(),-1)}static max(){return new hr(Yi.max(),er.empty(),-1)}}function dr(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=er.comparator(t.documentKey,e.documentKey),0!==n?n:ji(t.largestBatchId,e.largestBatchId))}const fr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class pr{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function mr(t){if(t.code!==Li.FAILED_PRECONDITION||t.message!==fr)throw t;Ei("LocalStore","Unexpectedly lost primary lease")}class gr{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Ii(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new gr(((n,i)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,i)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,i)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof gr?e:gr.resolve(e)}catch(t){return gr.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):gr.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):gr.reject(e)}static resolve(t){return new gr(((e,n)=>{e(t)}))}static reject(t){return new gr(((e,n)=>{n(t)}))}static waitFor(t){return new gr(((e,n)=>{let i=0,r=0,s=!1;t.forEach((t=>{++i,t.next((()=>{++r,s&&r===i&&e()}),(t=>n(t)))})),s=!0,r===i&&e()}))}static or(t){let e=gr.resolve(!1);for(const n of t)e=e.next((t=>t?gr.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,i)=>{n.push(e.call(this,t,i))})),this.waitFor(n)}static mapArray(t,e){return new gr(((n,i)=>{const r=t.length,s=new Array(r);let a=0;for(let o=0;o<r;o++){const l=o;e(t[l]).next((t=>{s[l]=t,++a,a===r&&n(s)}),(t=>i(t)))}}))}static doWhile(t,e){return new gr(((n,i)=>{const r=()=>{!0===t()?e().next((()=>{r()}),i):n()};r()}))}}class vr{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.T=new Ni,this.transaction.oncomplete=()=>{this.T.resolve()},this.transaction.onabort=()=>{e.error?this.T.reject(new xr(t,e.error)):this.T.resolve()},this.transaction.onerror=e=>{const n=Tr(e.target.error);this.T.reject(new xr(t,n))}}static open(t,e,n,i){try{return new vr(e,t.transaction(i,n))}catch(t){throw new xr(e,t)}}get A(){return this.T.promise}abort(t){t&&this.T.reject(t),this.aborted||(Ei("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}R(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new br(e)}}class yr{constructor(t,e,n){this.name=t,this.version=e,this.P=n,12.2===yr.v((0,o.z$)())&&Ti("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return Ei("SimpleDb","Removing database:",t),Sr(window.indexedDB.deleteDatabase(t)).toPromise()}static V(){if(!(0,o.hl)())return!1;if(yr.S())return!0;const t=(0,o.z$)(),e=yr.v(t),n=0<e&&e<10,i=yr.D(t),r=0<i&&i<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||r)}static S(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.C)}static N(t,e){return t.store(e)}static v(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static D(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async k(t){return this.db||(Ei("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const i=indexedDB.open(this.name,this.version);i.onsuccess=t=>{const n=t.target.result;e(n)},i.onblocked=()=>{n(new xr(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},i.onerror=e=>{const i=e.target.error;"VersionError"===i.name?n(new Pi(Li.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===i.name?n(new Pi(Li.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+i)):n(new xr(t,i))},i.onupgradeneeded=t=>{Ei("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.P.M(e,i.transaction,t.oldVersion,this.version).next((()=>{Ei("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.O&&(this.db.onversionchange=t=>this.O(t)),this.db}F(t){this.O=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,i){const r="readonly"===e;let s=0;for(;;){++s;try{this.db=await this.k(t);const e=vr.open(this.db,t,r?"readonly":"readwrite",n),s=i(e).next((t=>(e.R(),t))).catch((t=>(e.abort(t),gr.reject(t)))).toPromise();return s.catch((()=>{})),await e.A,s}catch(t){const e=t,n="FirebaseError"!==e.name&&s<3;if(Ei("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class _r{constructor(t){this.$=t,this.B=!1,this.L=null}get isDone(){return this.B}get U(){return this.L}set cursor(t){this.$=t}done(){this.B=!0}q(t){this.L=t}delete(){return Sr(this.$.delete())}}class xr extends Pi{constructor(t,e){super(Li.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function wr(t){return"IndexedDbTransactionError"===t.name}class br{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(Ei("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Ei("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Sr(n)}add(t){return Ei("SimpleDb","ADD",this.store.name,t,t),Sr(this.store.add(t))}get(t){return Sr(this.store.get(t)).next((e=>(void 0===e&&(e=null),Ei("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return Ei("SimpleDb","DELETE",this.store.name,t),Sr(this.store.delete(t))}count(){return Ei("SimpleDb","COUNT",this.store.name),Sr(this.store.count())}K(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.G(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new gr(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}j(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new gr(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}W(t,e){Ei("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.H=!1;const i=this.cursor(n);return this.G(i,((t,e,n)=>n.delete()))}J(t,e){let n;e?n=t:(n={},e=t);const i=this.cursor(n);return this.G(i,e)}Y(t){const e=this.cursor({});return new gr(((n,i)=>{e.onerror=t=>{const e=Tr(t.target.error);i(e)},e.onsuccess=e=>{const i=e.target.result;i?t(i.primaryKey,i.value).next((t=>{t?i.continue():n()})):n()}}))}G(t,e){const n=[];return new gr(((i,r)=>{t.onerror=t=>{r(t.target.error)},t.onsuccess=t=>{const r=t.target.result;if(!r)return void i();const s=new _r(r),a=e(r.primaryKey,r.value,s);if(a instanceof gr){const t=a.catch((t=>(s.done(),gr.reject(t))));n.push(t)}s.isDone?i():null===s.U?r.continue():r.continue(s.U)}})).next((()=>gr.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.H?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Sr(t){return new gr(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Tr(t.target.error);n(e)}}))}let Er=!1;function Tr(t){const e=yr.v((0,o.z$)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Pi("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Er||(Er=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Mr{constructor(t,e){this.asyncQueue=t,this.X=e,this.task=null}start(){this.Z(15)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}Z(t){Ei("IndexBackiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{Ei("IndexBackiller",`Documents written: ${await this.X.tt()}`)}catch(t){wr(t)?Ei("IndexBackiller","Ignoring IndexedDB error during index backfill: ",t):await mr(t)}await this.Z(1)}))}}class Ar{constructor(t,e){this.localStore=t,this.persistence=e}async tt(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.et(e,t)))}et(t,e){const n=new Set;let i=e,r=!0;return gr.doWhile((()=>!0===r&&i>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return Ei("IndexBackiller",`Processing collection: ${e}`),this.nt(t,e,i).next((t=>{i-=t,n.add(e)}));r=!1})))).next((()=>e-i))}nt(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((i=>this.localStore.localDocuments.getNextDocuments(t,e,i,n).next((n=>{const r=n.changes;return this.localStore.indexManager.updateIndexEntries(t,r).next((()=>this.st(i,n))).next((n=>(Ei("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>r.size))}))))}st(t,e){let n=t;return e.changes.forEach(((t,e)=>{const i=ur(e);dr(i,n)>0&&(n=i)})),new hr(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Ir{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.it(t),this.rt=t=>e.writeSequenceNumber(t))}it(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.rt&&this.rt(t),t}}function Cr(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function Rr(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Dr(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}Ir.ot=-1;class Lr{constructor(t,e){this.comparator=t,this.root=e||Nr.EMPTY}insert(t,e){return new Lr(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Nr.BLACK,null,null))}remove(t){return new Lr(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Nr.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const i=this.comparator(t,n.key);if(0===i)return e+n.left.size;i<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Pr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Pr(this.root,t,this.comparator,!1)}getReverseIterator(){return new Pr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Pr(this.root,t,this.comparator,!0)}}class Pr{constructor(t,e,n,i){this.isReverse=i,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?n(t.key,e):1,e&&i&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Nr{constructor(t,e,n,i,r){this.key=t,this.value=e,this.color=null!=n?n:Nr.RED,this.left=null!=i?i:Nr.EMPTY,this.right=null!=r?r:Nr.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,i,r){return new Nr(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=i?i:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let i=this;const r=n(t,i.key);return i=r<0?i.copy(null,null,null,i.left.insert(t,e,n),null):0===r?i.copy(null,e,null,null,null):i.copy(null,null,null,null,i.right.insert(t,e,n)),i.fixUp()}removeMin(){if(this.left.isEmpty())return Nr.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,i=this;if(e(t,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(t,e),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),0===e(t,i.key)){if(i.right.isEmpty())return Nr.EMPTY;n=i.right.min(),i=i.copy(n.key,n.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(t,e))}return i.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Nr.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Nr.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Ii();if(this.right.isRed())throw Ii();const t=this.left.check();if(t!==this.right.check())throw Ii();return t+(this.isRed()?0:1)}}Nr.EMPTY=null,Nr.RED=!0,Nr.BLACK=!1,Nr.EMPTY=new class{constructor(){this.size=0}get key(){throw Ii()}get value(){throw Ii()}get color(){throw Ii()}get left(){throw Ii()}get right(){throw Ii()}copy(t,e,n,i,r){return this}insert(t,e,n){return new Nr(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Or{constructor(t){this.comparator=t,this.data=new Lr(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const i=n.getNext();if(this.comparator(i.key,t[1])>=0)return;e(i.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Fr(this.data.getIterator())}getIteratorFrom(t){return new Fr(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Or))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,i=n.getNext().key;if(0!==this.comparator(t,i))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Or(this.comparator);return e.data=t,e}}class Fr{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Ur(t){return t.hasNext()?t.getNext():void 0}class Vr{constructor(t){this.fields=t,t.sort(tr.comparator)}static empty(){return new Vr([])}unionWith(t){let e=new Or(tr.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new Vr(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Xi(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function kr(){return"undefined"!=typeof atob}class Br{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new Br(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Br(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return ji(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Br.EMPTY_BYTE_STRING=new Br("");const zr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Gr(t){if(Ci(!!t),"string"==typeof t){let e=0;const n=zr.exec(t);if(Ci(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const i=new Date(t);return{seconds:Math.floor(i.getTime()/1e3),nanos:e}}return{seconds:Hr(t.seconds),nanos:Hr(t.nanos)}}function Hr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Wr(t){return"string"==typeof t?Br.fromBase64String(t):Br.fromUint8Array(t)}function qr(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function jr(t){const e=t.mapValue.fields.__previous_value__;return qr(e)?jr(e):e}function Xr(t){const e=Gr(t.mapValue.fields.__local_write_time__.timestampValue);return new $i(e.seconds,e.nanos)}class Kr{constructor(t,e,n,i,r,s,a,o){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=i,this.ssl=r,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.useFetchStreams=o}}class $r{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new $r("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof $r&&t.projectId===this.projectId&&t.database===this.database}}function Yr(t){return null==t}function Qr(t){return 0===t&&1/t==-1/0}function Jr(t){return"number"==typeof t&&Number.isInteger(t)&&!Qr(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}const Zr={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},ts={nullValue:"NULL_VALUE"};function es(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?qr(t)?4:ms(t)?9007199254740991:10:Ii()}function ns(t,e){if(t===e)return!0;const n=es(t);if(n!==es(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return Xr(t).isEqual(Xr(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Gr(t.timestampValue),i=Gr(e.timestampValue);return n.seconds===i.seconds&&n.nanos===i.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return Wr(t.bytesValue).isEqual(Wr(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return Hr(t.geoPointValue.latitude)===Hr(e.geoPointValue.latitude)&&Hr(t.geoPointValue.longitude)===Hr(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Hr(t.integerValue)===Hr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=Hr(t.doubleValue),i=Hr(e.doubleValue);return n===i?Qr(n)===Qr(i):isNaN(n)&&isNaN(i)}return!1}(t,e);case 9:return Xi(t.arrayValue.values||[],e.arrayValue.values||[],ns);case 10:return function(t,e){const n=t.mapValue.fields||{},i=e.mapValue.fields||{};if(Cr(n)!==Cr(i))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===i[t]||!ns(n[t],i[t])))return!1;return!0}(t,e);default:return Ii()}}function is(t,e){return void 0!==(t.values||[]).find((t=>ns(t,e)))}function rs(t,e){if(t===e)return 0;const n=es(t),i=es(e);if(n!==i)return ji(n,i);switch(n){case 0:case 9007199254740991:return 0;case 1:return ji(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=Hr(t.integerValue||t.doubleValue),i=Hr(e.integerValue||e.doubleValue);return n<i?-1:n>i?1:n===i?0:isNaN(n)?isNaN(i)?0:-1:1}(t,e);case 3:return ss(t.timestampValue,e.timestampValue);case 4:return ss(Xr(t),Xr(e));case 5:return ji(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Wr(t),i=Wr(e);return n.compareTo(i)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),i=e.split("/");for(let t=0;t<n.length&&t<i.length;t++){const e=ji(n[t],i[t]);if(0!==e)return e}return ji(n.length,i.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=ji(Hr(t.latitude),Hr(e.latitude));return 0!==n?n:ji(Hr(t.longitude),Hr(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],i=e.values||[];for(let t=0;t<n.length&&t<i.length;++t){const e=rs(n[t],i[t]);if(e)return e}return ji(n.length,i.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===Zr.mapValue&&e===Zr.mapValue)return 0;if(t===Zr.mapValue)return 1;if(e===Zr.mapValue)return-1;const n=t.fields||{},i=Object.keys(n),r=e.fields||{},s=Object.keys(r);i.sort(),s.sort();for(let t=0;t<i.length&&t<s.length;++t){const e=ji(i[t],s[t]);if(0!==e)return e;const a=rs(n[i[t]],r[s[t]]);if(0!==a)return a}return ji(i.length,s.length)}(t.mapValue,e.mapValue);default:throw Ii()}}function ss(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return ji(t,e);const n=Gr(t),i=Gr(e),r=ji(n.seconds,i.seconds);return 0!==r?r:ji(n.nanos,i.nanos)}function as(t){return os(t)}function os(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Gr(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?Wr(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,er.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const i of t.values||[])n?n=!1:e+=",",e+=os(i);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",i=!0;for(const r of e)i?i=!1:n+=",",n+=`${r}:${os(t.fields[r])}`;return n+"}"}(t.mapValue):Ii();var e,n}function ls(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function cs(t){return!!t&&"integerValue"in t}function us(t){return!!t&&"arrayValue"in t}function hs(t){return!!t&&"nullValue"in t}function ds(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function fs(t){return!!t&&"mapValue"in t}function ps(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return Rr(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=ps(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=ps(t.arrayValue.values[n]);return e}return Object.assign({},t)}function ms(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function gs(t){return"nullValue"in t?ts:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?ls($r.empty(),er.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:Ii()}function vs(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?ls($r.empty(),er.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?Zr:Ii()}function ys(t,e){const n=rs(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function _s(t,e){const n=rs(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class xs{constructor(t){this.value=t}static empty(){return new xs({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!fs(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=ps(e)}setAll(t){let e=tr.emptyPath(),n={},i=[];t.forEach(((t,r)=>{if(!e.isImmediateParentOf(r)){const t=this.getFieldsMap(e);this.applyChanges(t,n,i),n={},i=[],e=r.popLast()}t?n[r.lastSegment()]=ps(t):i.push(r.lastSegment())}));const r=this.getFieldsMap(e);this.applyChanges(r,n,i)}delete(t){const e=this.field(t.popLast());fs(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return ns(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let i=e.mapValue.fields[t.get(n)];fs(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=i),e=i}return e.mapValue.fields}applyChanges(t,e,n){Rr(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new xs(ps(this.value))}}function ws(t){const e=[];return Rr(t.fields,((t,n)=>{const i=new tr([t]);if(fs(n)){const t=ws(n.mapValue).fields;if(0===t.length)e.push(i);else for(const n of t)e.push(i.child(n))}else e.push(i)})),new Vr(e)}class bs{constructor(t,e,n,i,r,s){this.key=t,this.documentType=e,this.version=n,this.readTime=i,this.data=r,this.documentState=s}static newInvalidDocument(t){return new bs(t,0,Yi.min(),Yi.min(),xs.empty(),0)}static newFoundDocument(t,e,n){return new bs(t,1,e,Yi.min(),n,0)}static newNoDocument(t,e){return new bs(t,2,e,Yi.min(),xs.empty(),0)}static newUnknownDocument(t,e){return new bs(t,3,e,Yi.min(),xs.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=xs.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=xs.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Yi.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof bs&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new bs(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ss{constructor(t,e=null,n=[],i=[],r=null,s=null,a=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=i,this.limit=r,this.startAt=s,this.endAt=a,this.ut=null}}function Es(t,e=null,n=[],i=[],r=null,s=null,a=null){return new Ss(t,e,n,i,r,s,a)}function Ts(t){const e=Di(t);if(null===e.ut){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>{return(e=t).field.canonicalString()+e.op.toString()+as(e.value);var e})).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),Yr(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>as(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>as(t))).join(",")),e.ut=t}return e.ut}function Ms(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!Gs(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let r=0;r<t.filters.length;r++)if(n=t.filters[r],i=e.filters[r],n.op!==i.op||!n.field.isEqual(i.field)||!ns(n.value,i.value))return!1;var n,i;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Ws(t.startAt,e.startAt)&&Ws(t.endAt,e.endAt)}function As(t){return er.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function Is(t,e){return t.filters.filter((t=>t instanceof Ds&&t.field.isEqual(e)))}function Cs(t,e,n){let i=ts,r=!0;for(const n of Is(t,e)){let t=ts,e=!0;switch(n.op){case"<":case"<=":t=gs(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=ts}ys({value:i,inclusive:r},{value:t,inclusive:e})<0&&(i=t,r=e)}if(null!==n)for(let s=0;s<t.orderBy.length;++s)if(t.orderBy[s].field.isEqual(e)){const t=n.position[s];ys({value:i,inclusive:r},{value:t,inclusive:n.inclusive})<0&&(i=t,r=n.inclusive);break}return{value:i,inclusive:r}}function Rs(t,e,n){let i=Zr,r=!0;for(const n of Is(t,e)){let t=Zr,e=!0;switch(n.op){case">=":case">":t=vs(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=Zr}_s({value:i,inclusive:r},{value:t,inclusive:e})>0&&(i=t,r=e)}if(null!==n)for(let s=0;s<t.orderBy.length;++s)if(t.orderBy[s].field.isEqual(e)){const t=n.position[s];_s({value:i,inclusive:r},{value:t,inclusive:n.inclusive})>0&&(i=t,r=n.inclusive);break}return{value:i,inclusive:r}}class Ds extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.ct(t,e,n):new Ls(t,e,n):"array-contains"===e?new Fs(t,n):"in"===e?new Us(t,n):"not-in"===e?new Vs(t,n):"array-contains-any"===e?new ks(t,n):new Ds(t,e,n)}static ct(t,e,n){return"in"===e?new Ps(t,n):new Ns(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.at(rs(e,this.value)):null!==e&&es(this.value)===es(e)&&this.at(rs(e,this.value))}at(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Ii()}}ht(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Ls extends Ds{constructor(t,e,n){super(t,e,n),this.key=er.fromName(n.referenceValue)}matches(t){const e=er.comparator(t.key,this.key);return this.at(e)}}class Ps extends Ds{constructor(t,e){super(t,"in",e),this.keys=Os(0,e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Ns extends Ds{constructor(t,e){super(t,"not-in",e),this.keys=Os(0,e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Os(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>er.fromName(t.referenceValue)))}class Fs extends Ds{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return us(e)&&is(e.arrayValue,this.value)}}class Us extends Ds{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&is(this.value.arrayValue,e)}}class Vs extends Ds{constructor(t,e){super(t,"not-in",e)}matches(t){if(is(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!is(this.value.arrayValue,e)}}class ks extends Ds{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!us(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>is(this.value.arrayValue,t)))}}class Bs{constructor(t,e){this.position=t,this.inclusive=e}}class zs{constructor(t,e="asc"){this.field=t,this.dir=e}}function Gs(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function Hs(t,e,n){let i=0;for(let r=0;r<t.position.length;r++){const s=e[r],a=t.position[r];if(i=s.field.isKeyField()?er.comparator(er.fromName(a.referenceValue),n.key):rs(a,n.data.field(s.field)),"desc"===s.dir&&(i*=-1),0!==i)break}return i}function Ws(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!ns(t.position[n],e.position[n]))return!1;return!0}class qs{constructor(t,e=null,n=[],i=[],r=null,s="F",a=null,o=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=i,this.limit=r,this.limitType=s,this.startAt=a,this.endAt=o,this.lt=null,this.ft=null,this.startAt,this.endAt}}function js(t,e,n,i,r,s,a,o){return new qs(t,e,n,i,r,s,a,o)}function Xs(t){return new qs(t)}function Ks(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function $s(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Ys(t){for(const e of t.filters)if(e.ht())return e.field;return null}function Qs(t){return null!==t.collectionGroup}function Js(t){const e=Di(t);if(null===e.lt){e.lt=[];const t=Ys(e),n=$s(e);if(null!==t&&null===n)t.isKeyField()||e.lt.push(new zs(t)),e.lt.push(new zs(tr.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.lt.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.lt.push(new zs(tr.keyField(),t))}}}return e.lt}function Zs(t){const e=Di(t);if(!e.ft)if("F"===e.limitType)e.ft=Es(e.path,e.collectionGroup,Js(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of Js(e)){const e="desc"===n.dir?"asc":"desc";t.push(new zs(n.field,e))}const n=e.endAt?new Bs(e.endAt.position,e.endAt.inclusive):null,i=e.startAt?new Bs(e.startAt.position,e.startAt.inclusive):null;e.ft=Es(e.path,e.collectionGroup,t,e.filters,e.limit,n,i)}return e.ft}function ta(t,e,n){return new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function ea(t,e){return Ms(Zs(t),Zs(e))&&t.limitType===e.limitType}function na(t){return`${Ts(Zs(t))}|lt:${t.limitType}`}function ia(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${as(e.value)}`;var e})).join(", ")}]`),Yr(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>as(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>as(t))).join(",")),`Target(${e})`}(Zs(t))}; limitType=${t.limitType})`}function ra(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):er.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const i=Hs(t,e,n);return t.inclusive?i<=0:i<0}(t.startAt,Js(t),e)||t.endAt&&!function(t,e,n){const i=Hs(t,e,n);return t.inclusive?i>=0:i>0}(t.endAt,Js(t),e))}(t,e)}function sa(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function aa(t){return(e,n)=>{let i=!1;for(const r of Js(t)){const t=oa(r,e,n);if(0!==t)return t;i=i||r.field.isKeyField()}return 0}}function oa(t,e,n){const i=t.field.isKeyField()?er.comparator(e.key,n.key):function(t,e,n){const i=e.data.field(t),r=n.data.field(t);return null!==i&&null!==r?rs(i,r):Ii()}(t.field,e,n);switch(t.dir){case"asc":return i;case"desc":return-1*i;default:return Ii()}}function la(t,e){if(t.dt){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Qr(e)?"-0":e}}function ca(t){return{integerValue:""+t}}function ua(t,e){return Jr(e)?ca(e):la(t,e)}class ha{constructor(){this._=void 0}}function da(t,e,n){return t instanceof ma?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof ga?va(t,e):t instanceof ya?_a(t,e):function(t,e){const n=pa(t,e),i=wa(n)+wa(t._t);return cs(n)&&cs(t._t)?ca(i):la(t.wt,i)}(t,e)}function fa(t,e,n){return t instanceof ga?va(t,e):t instanceof ya?_a(t,e):n}function pa(t,e){return t instanceof xa?cs(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class ma extends ha{}class ga extends ha{constructor(t){super(),this.elements=t}}function va(t,e){const n=ba(e);for(const e of t.elements)n.some((t=>ns(t,e)))||n.push(e);return{arrayValue:{values:n}}}class ya extends ha{constructor(t){super(),this.elements=t}}function _a(t,e){let n=ba(e);for(const e of t.elements)n=n.filter((t=>!ns(t,e)));return{arrayValue:{values:n}}}class xa extends ha{constructor(t,e){super(),this.wt=t,this._t=e}}function wa(t){return Hr(t.integerValue||t.doubleValue)}function ba(t){return us(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Sa{constructor(t,e){this.field=t,this.transform=e}}class Ea{constructor(t,e){this.version=t,this.transformResults=e}}class Ta{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Ta}static exists(t){return new Ta(void 0,t)}static updateTime(t){return new Ta(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Ma(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Aa{}function Ia(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new Va(t.key,Ta.none()):new Pa(t.key,t.data,Ta.none());{const n=t.data,i=xs.empty();let r=new Or(tr.comparator);for(let t of e.fields)if(!r.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?i.delete(t):i.set(t,e),r=r.add(t)}return new Na(t.key,i,new Vr(r.toArray()),Ta.none())}}function Ca(t,e,n){t instanceof Pa?function(t,e,n){const i=t.value.clone(),r=Fa(t.fieldTransforms,e,n.transformResults);i.setAll(r),e.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(t,e,n):t instanceof Na?function(t,e,n){if(!Ma(t.precondition,e))return void e.convertToUnknownDocument(n.version);const i=Fa(t.fieldTransforms,e,n.transformResults),r=e.data;r.setAll(Oa(t)),r.setAll(i),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Ra(t,e,n,i){return t instanceof Pa?function(t,e,n,i){if(!Ma(t.precondition,e))return n;const r=t.value.clone(),s=Ua(t.fieldTransforms,i,e);return r.setAll(s),e.convertToFoundDocument(e.version,r).setHasLocalMutations(),null}(t,e,n,i):t instanceof Na?function(t,e,n,i){if(!Ma(t.precondition,e))return n;const r=Ua(t.fieldTransforms,i,e),s=e.data;return s.setAll(Oa(t)),s.setAll(r),e.convertToFoundDocument(e.version,s).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,i):function(t,e,n){return Ma(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function Da(t,e){let n=null;for(const i of t.fieldTransforms){const t=e.data.field(i.field),r=pa(i.transform,t||null);null!=r&&(null===n&&(n=xs.empty()),n.set(i.field,r))}return n||null}function La(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&Xi(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof ga&&e instanceof ga||t instanceof ya&&e instanceof ya?Xi(t.elements,e.elements,ns):t instanceof xa&&e instanceof xa?ns(t._t,e._t):t instanceof ma&&e instanceof ma}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class Pa extends Aa{constructor(t,e,n,i=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}}class Na extends Aa{constructor(t,e,n,i,r=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=i,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Oa(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const i=t.data.field(n);e.set(n,i)}})),e}function Fa(t,e,n){const i=new Map;Ci(t.length===n.length);for(let r=0;r<n.length;r++){const s=t[r],a=s.transform,o=e.data.field(s.field);i.set(s.field,fa(a,o,n[r]))}return i}function Ua(t,e,n){const i=new Map;for(const r of t){const t=r.transform,s=n.data.field(r.field);i.set(r.field,da(t,s,e))}return i}class Va extends Aa{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class ka extends Aa{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Ba{constructor(t){this.count=t}}var za,Ga;function Ha(t){switch(t){default:return Ii();case Li.CANCELLED:case Li.UNKNOWN:case Li.DEADLINE_EXCEEDED:case Li.RESOURCE_EXHAUSTED:case Li.INTERNAL:case Li.UNAVAILABLE:case Li.UNAUTHENTICATED:return!1;case Li.INVALID_ARGUMENT:case Li.NOT_FOUND:case Li.ALREADY_EXISTS:case Li.PERMISSION_DENIED:case Li.FAILED_PRECONDITION:case Li.ABORTED:case Li.OUT_OF_RANGE:case Li.UNIMPLEMENTED:case Li.DATA_LOSS:return!0}}function Wa(t){if(void 0===t)return Ti("GRPC error has no .code"),Li.UNKNOWN;switch(t){case za.OK:return Li.OK;case za.CANCELLED:return Li.CANCELLED;case za.UNKNOWN:return Li.UNKNOWN;case za.DEADLINE_EXCEEDED:return Li.DEADLINE_EXCEEDED;case za.RESOURCE_EXHAUSTED:return Li.RESOURCE_EXHAUSTED;case za.INTERNAL:return Li.INTERNAL;case za.UNAVAILABLE:return Li.UNAVAILABLE;case za.UNAUTHENTICATED:return Li.UNAUTHENTICATED;case za.INVALID_ARGUMENT:return Li.INVALID_ARGUMENT;case za.NOT_FOUND:return Li.NOT_FOUND;case za.ALREADY_EXISTS:return Li.ALREADY_EXISTS;case za.PERMISSION_DENIED:return Li.PERMISSION_DENIED;case za.FAILED_PRECONDITION:return Li.FAILED_PRECONDITION;case za.ABORTED:return Li.ABORTED;case za.OUT_OF_RANGE:return Li.OUT_OF_RANGE;case za.UNIMPLEMENTED:return Li.UNIMPLEMENTED;case za.DATA_LOSS:return Li.DATA_LOSS;default:return Ii()}}(Ga=za||(za={}))[Ga.OK=0]="OK",Ga[Ga.CANCELLED=1]="CANCELLED",Ga[Ga.UNKNOWN=2]="UNKNOWN",Ga[Ga.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ga[Ga.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ga[Ga.NOT_FOUND=5]="NOT_FOUND",Ga[Ga.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ga[Ga.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ga[Ga.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ga[Ga.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ga[Ga.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ga[Ga.ABORTED=10]="ABORTED",Ga[Ga.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ga[Ga.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ga[Ga.INTERNAL=13]="INTERNAL",Ga[Ga.UNAVAILABLE=14]="UNAVAILABLE",Ga[Ga.DATA_LOSS=15]="DATA_LOSS";class qa{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,i]of n)if(this.equalsFn(e,t))return i}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),i=this.inner[n];if(void 0===i)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],t))return void(i[n]=[t,e]);i.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let i=0;i<n.length;i++)if(this.equalsFn(n[i][0],t))return 1===n.length?delete this.inner[e]:n.splice(i,1),this.innerSize--,!0;return!1}forEach(t){Rr(this.inner,((e,n)=>{for(const[e,i]of n)t(e,i)}))}isEmpty(){return Dr(this.inner)}size(){return this.innerSize}}const ja=new Lr(er.comparator);function Xa(){return ja}const Ka=new Lr(er.comparator);function $a(...t){let e=Ka;for(const n of t)e=e.insert(n.key,n);return e}function Ya(t){let e=Ka;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function Qa(){return Za()}function Ja(){return Za()}function Za(){return new qa((t=>t.toString()),((t,e)=>t.isEqual(e)))}const to=new Lr(er.comparator),eo=new Or(er.comparator);function no(...t){let e=eo;for(const n of t)e=e.add(n);return e}const io=new Or(ji);function ro(){return io}class so{constructor(t,e,n,i,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=i,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,ao.createSynthesizedTargetChangeForCurrentChange(t,e)),new so(Yi.min(),n,ro(),Xa(),no())}}class ao{constructor(t,e,n,i,r){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=i,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e){return new ao(Br.EMPTY_BYTE_STRING,e,no(),no(),no())}}class oo{constructor(t,e,n,i){this.gt=t,this.removedTargetIds=e,this.key=n,this.yt=i}}class lo{constructor(t,e){this.targetId=t,this.It=e}}class co{constructor(t,e,n=Br.EMPTY_BYTE_STRING,i=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=i}}class uo{constructor(){this.Tt=0,this.Et=po(),this.At=Br.EMPTY_BYTE_STRING,this.Rt=!1,this.bt=!0}get current(){return this.Rt}get resumeToken(){return this.At}get Pt(){return 0!==this.Tt}get vt(){return this.bt}Vt(t){t.approximateByteSize()>0&&(this.bt=!0,this.At=t)}St(){let t=no(),e=no(),n=no();return this.Et.forEach(((i,r)=>{switch(r){case 0:t=t.add(i);break;case 2:e=e.add(i);break;case 1:n=n.add(i);break;default:Ii()}})),new ao(this.At,this.Rt,t,e,n)}Dt(){this.bt=!1,this.Et=po()}Ct(t,e){this.bt=!0,this.Et=this.Et.insert(t,e)}xt(t){this.bt=!0,this.Et=this.Et.remove(t)}Nt(){this.Tt+=1}kt(){this.Tt-=1}Mt(){this.bt=!0,this.Rt=!0}}class ho{constructor(t){this.Ot=t,this.Ft=new Map,this.$t=Xa(),this.Bt=fo(),this.Lt=new Or(ji)}Ut(t){for(const e of t.gt)t.yt&&t.yt.isFoundDocument()?this.qt(e,t.yt):this.Kt(e,t.key,t.yt);for(const e of t.removedTargetIds)this.Kt(e,t.key,t.yt)}Gt(t){this.forEachTarget(t,(e=>{const n=this.Qt(e);switch(t.state){case 0:this.jt(e)&&n.Vt(t.resumeToken);break;case 1:n.kt(),n.Pt||n.Dt(),n.Vt(t.resumeToken);break;case 2:n.kt(),n.Pt||this.removeTarget(e);break;case 3:this.jt(e)&&(n.Mt(),n.Vt(t.resumeToken));break;case 4:this.jt(e)&&(this.Wt(e),n.Vt(t.resumeToken));break;default:Ii()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ft.forEach(((t,n)=>{this.jt(n)&&e(n)}))}zt(t){const e=t.targetId,n=t.It.count,i=this.Ht(e);if(i){const t=i.target;if(As(t))if(0===n){const n=new er(t.path);this.Kt(e,n,bs.newNoDocument(n,Yi.min()))}else Ci(1===n);else this.Jt(e)!==n&&(this.Wt(e),this.Lt=this.Lt.add(e))}}Yt(t){const e=new Map;this.Ft.forEach(((n,i)=>{const r=this.Ht(i);if(r){if(n.current&&As(r.target)){const e=new er(r.target.path);null!==this.$t.get(e)||this.Xt(i,e)||this.Kt(i,e,bs.newNoDocument(e,t))}n.vt&&(e.set(i,n.St()),n.Dt())}}));let n=no();this.Bt.forEach(((t,e)=>{let i=!0;e.forEachWhile((t=>{const e=this.Ht(t);return!e||2===e.purpose||(i=!1,!1)})),i&&(n=n.add(t))})),this.$t.forEach(((e,n)=>n.setReadTime(t)));const i=new so(t,e,this.Lt,this.$t,n);return this.$t=Xa(),this.Bt=fo(),this.Lt=new Or(ji),i}qt(t,e){if(!this.jt(t))return;const n=this.Xt(t,e.key)?2:0;this.Qt(t).Ct(e.key,n),this.$t=this.$t.insert(e.key,e),this.Bt=this.Bt.insert(e.key,this.Zt(e.key).add(t))}Kt(t,e,n){if(!this.jt(t))return;const i=this.Qt(t);this.Xt(t,e)?i.Ct(e,1):i.xt(e),this.Bt=this.Bt.insert(e,this.Zt(e).delete(t)),n&&(this.$t=this.$t.insert(e,n))}removeTarget(t){this.Ft.delete(t)}Jt(t){const e=this.Qt(t).St();return this.Ot.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Nt(t){this.Qt(t).Nt()}Qt(t){let e=this.Ft.get(t);return e||(e=new uo,this.Ft.set(t,e)),e}Zt(t){let e=this.Bt.get(t);return e||(e=new Or(ji),this.Bt=this.Bt.insert(t,e)),e}jt(t){const e=null!==this.Ht(t);return e||Ei("WatchChangeAggregator","Detected inactive target",t),e}Ht(t){const e=this.Ft.get(t);return e&&e.Pt?null:this.Ot.te(t)}Wt(t){this.Ft.set(t,new uo),this.Ot.getRemoteKeysForTarget(t).forEach((e=>{this.Kt(t,e,null)}))}Xt(t,e){return this.Ot.getRemoteKeysForTarget(t).has(e)}}function fo(){return new Lr(er.comparator)}function po(){return new Lr(er.comparator)}const mo={asc:"ASCENDING",desc:"DESCENDING"},go={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class vo{constructor(t,e){this.databaseId=t,this.dt=e}}function yo(t,e){return t.dt?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function _o(t,e){return t.dt?e.toBase64():e.toUint8Array()}function xo(t,e){return yo(t,e.toTimestamp())}function wo(t){return Ci(!!t),Yi.fromTimestamp(function(t){const e=Gr(t);return new $i(e.seconds,e.nanos)}(t))}function bo(t,e){return function(t){return new Ji(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function So(t){const e=Ji.fromString(t);return Ci(qo(e)),e}function Eo(t,e){return bo(t.databaseId,e.path)}function To(t,e){const n=So(e);if(n.get(1)!==t.databaseId.projectId)throw new Pi(Li.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Pi(Li.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new er(Co(n))}function Mo(t,e){return bo(t.databaseId,e)}function Ao(t){const e=So(t);return 4===e.length?Ji.emptyPath():Co(e)}function Io(t){return new Ji(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Co(t){return Ci(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Ro(t,e,n){return{name:Eo(t,e),fields:n.value.mapValue.fields}}function Do(t,e,n){const i=To(t,e.name),r=wo(e.updateTime),s=new xs({mapValue:{fields:e.fields}}),a=bs.newFoundDocument(i,r,s);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Lo(t,e){let n;if(e instanceof Pa)n={update:Ro(t,e.key,e.value)};else if(e instanceof Va)n={delete:Eo(t,e.key)};else if(e instanceof Na)n={update:Ro(t,e.key,e.data),updateMask:Wo(e.fieldMask)};else{if(!(e instanceof ka))return Ii();n={verify:Eo(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof ma)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ga)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof ya)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof xa)return{fieldPath:e.field.canonicalString(),increment:n._t};throw Ii()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:xo(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Ii()}(t,e.precondition)),n}function Po(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Ta.updateTime(wo(t.updateTime)):void 0!==t.exists?Ta.exists(t.exists):Ta.none()}(e.currentDocument):Ta.none(),i=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Ci("REQUEST_TIME"===e.setToServerValue),n=new ma;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new ga(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new ya(t)}else"increment"in e?n=new xa(t,e.increment):Ii();const i=tr.fromServerFormat(e.fieldPath);return new Sa(i,n)}(t,e))):[];if(e.update){e.update.name;const r=To(t,e.update.name),s=new xs({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Vr(e.map((t=>tr.fromServerFormat(t))))}(e.updateMask);return new Na(r,s,t,n,i)}return new Pa(r,s,n,i)}if(e.delete){const i=To(t,e.delete);return new Va(i,n)}if(e.verify){const i=To(t,e.verify);return new ka(i,n)}return Ii()}function No(t,e){return{documents:[Mo(t,e.path)]}}function Oo(t,e){const n={structuredQuery:{}},i=e.path;null!==e.collectionGroup?(n.parent=Mo(t,i),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Mo(t,i.popLast()),n.structuredQuery.from=[{collectionId:i.lastSegment()}]);const r=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(ds(t.value))return{unaryFilter:{field:Bo(t.field),op:"IS_NAN"}};if(hs(t.value))return{unaryFilter:{field:Bo(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(ds(t.value))return{unaryFilter:{field:Bo(t.field),op:"IS_NOT_NAN"}};if(hs(t.value))return{unaryFilter:{field:Bo(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Bo(t.field),op:ko(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);r&&(n.structuredQuery.where=r);const s=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Bo(t.field),direction:Vo(t.dir)}}(t)))}(e.orderBy);s&&(n.structuredQuery.orderBy=s);const a=function(t,e){return t.dt||Yr(e)?e:{value:e}}(t,e.limit);var o;return null!==a&&(n.structuredQuery.limit=a),e.startAt&&(n.structuredQuery.startAt={before:(o=e.startAt).inclusive,values:o.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function Fo(t){let e=Ao(t.parent);const n=t.structuredQuery,i=n.from?n.from.length:0;let r=null;if(i>0){Ci(1===i);const t=n.from[0];t.allDescendants?r=t.collectionId:e=e.child(t.collectionId)}let s=[];n.where&&(s=Uo(n.where));let a=[];n.orderBy&&(a=n.orderBy.map((t=>function(t){return new zs(zo(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let o=null;n.limit&&(o=function(t){let e;return e="object"==typeof t?t.value:t,Yr(e)?null:e}(n.limit));let l=null;n.startAt&&(l=function(t){const e=!!t.before,n=t.values||[];return new Bs(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new Bs(n,e)}(n.endAt)),js(e,r,a,s,o,"F",l,c)}function Uo(t){return t?void 0!==t.unaryFilter?[Ho(t)]:void 0!==t.fieldFilter?[Go(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>Uo(t))).reduce(((t,e)=>t.concat(e))):Ii():[]}function Vo(t){return mo[t]}function ko(t){return go[t]}function Bo(t){return{fieldPath:t.canonicalString()}}function zo(t){return tr.fromServerFormat(t.fieldPath)}function Go(t){return Ds.create(zo(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Ii()}}(t.fieldFilter.op),t.fieldFilter.value)}function Ho(t){switch(t.unaryFilter.op){case"IS_NAN":const e=zo(t.unaryFilter.field);return Ds.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=zo(t.unaryFilter.field);return Ds.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const i=zo(t.unaryFilter.field);return Ds.create(i,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=zo(t.unaryFilter.field);return Ds.create(r,"!=",{nullValue:"NULL_VALUE"});default:return Ii()}}function Wo(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function qo(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function jo(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=Ko(e)),e=Xo(t.get(n),e);return Ko(e)}function Xo(t,e){let n=e;const i=t.length;for(let e=0;e<i;e++){const i=t.charAt(e);switch(i){case"\0":n+="";break;case"":n+="";break;default:n+=i}}return n}function Ko(t){return t+""}function $o(t){const e=t.length;if(Ci(e>=2),2===e)return Ci(""===t.charAt(0)&&""===t.charAt(1)),Ji.emptyPath();const n=e-2,i=[];let r="";for(let s=0;s<e;){const e=t.indexOf("",s);switch((e<0||e>n)&&Ii(),t.charAt(e+1)){case"":const n=t.substring(s,e);let a;0===r.length?a=n:(r+=n,a=r,r=""),i.push(a);break;case"":r+=t.substring(s,e),r+="\0";break;case"":r+=t.substring(s,e+1);break;default:Ii()}s=e+2}return new Ji(i)}const Yo=["userId","batchId"];function Qo(t,e){return[t,jo(e)]}function Jo(t,e,n){return[t,jo(e),n]}const Zo={},tl=["prefixPath","collectionGroup","readTime","documentId"],el=["prefixPath","collectionGroup","documentId"],nl=["collectionGroup","readTime","prefixPath","documentId"],il=["canonicalId","targetId"],rl=["targetId","path"],sl=["path","targetId"],al=["collectionId","parent"],ol=["indexId","uid"],ll=["uid","sequenceNumber"],cl=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],ul=["indexId","uid","orderedDocumentKey"],hl=["userId","collectionPath","documentId"],dl=["userId","collectionPath","largestBatchId"],fl=["userId","collectionGroup","largestBatchId"],pl=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ml=[...pl,"documentOverlays"],gl=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],vl=gl,yl=[...vl,"indexConfiguration","indexState","indexEntries"];class _l extends pr{constructor(t,e){super(),this.ee=t,this.currentSequenceNumber=e}}function xl(t,e){const n=Di(t);return yr.N(n.ee,e)}class wl{constructor(t,e,n,i){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=i}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const i=this.mutations[e];i.key.isEqual(t.key)&&Ca(i,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=Ra(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=Ra(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=Ja();return this.mutations.forEach((i=>{const r=t.get(i.key),s=r.overlayedDocument;let a=this.applyToLocalView(s,r.mutatedFields);a=e.has(i.key)?null:a;const o=Ia(s,a);null!==o&&n.set(i.key,o),s.isValidDocument()||s.convertToNoDocument(Yi.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),no())}isEqual(t){return this.batchId===t.batchId&&Xi(this.mutations,t.mutations,((t,e)=>La(t,e)))&&Xi(this.baseMutations,t.baseMutations,((t,e)=>La(t,e)))}}class bl{constructor(t,e,n,i){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=i}static from(t,e,n){Ci(t.mutations.length===n.length);let i=to;const r=t.mutations;for(let t=0;t<r.length;t++)i=i.insert(r[t].key,n[t].version);return new bl(t,e,n,i)}}class Sl{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class El{constructor(t,e,n,i,r=Yi.min(),s=Yi.min(),a=Br.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=i,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a}withSequenceNumber(t){return new El(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new El(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new El(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class Tl{constructor(t){this.ne=t}}function Ml(t,e){const n=e.key,i={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Al(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())i.document=function(t,e){return{name:Eo(t,e.key),fields:e.data.value.mapValue.fields,updateTime:yo(t,e.version.toTimestamp())}}(t.ne,e);else if(e.isNoDocument())i.noDocument={path:n.path.toArray(),readTime:Il(e.version)};else{if(!e.isUnknownDocument())return Ii();i.unknownDocument={path:n.path.toArray(),version:Il(e.version)}}return i}function Al(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Il(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Cl(t){const e=new $i(t.seconds,t.nanoseconds);return Yi.fromTimestamp(e)}function Rl(t,e){const n=(e.baseMutations||[]).map((e=>Po(t.ne,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const i=e.mutations[t+1];n.updateTransforms=i.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const i=e.mutations.map((e=>Po(t.ne,e))),r=$i.fromMillis(e.localWriteTimeMs);return new wl(e.batchId,r,n,i)}function Dl(t){const e=Cl(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Cl(t.lastLimboFreeSnapshotVersion):Yi.min();let i;var r;return void 0!==t.query.documents?(Ci(1===(r=t.query).documents.length),i=Zs(Xs(Ao(r.documents[0])))):i=function(t){return Zs(Fo(t))}(t.query),new El(i,t.targetId,0,t.lastListenSequenceNumber,e,n,Br.fromBase64String(t.resumeToken))}function Ll(t,e){const n=Il(e.snapshotVersion),i=Il(e.lastLimboFreeSnapshotVersion);let r;r=As(e.target)?No(t.ne,e.target):Oo(t.ne,e.target);const s=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Ts(e.target),readTime:n,resumeToken:s,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:r}}function Pl(t){const e=Fo({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?ta(e,e.limit,"L"):e}function Nl(t,e){return new Sl(e.largestBatchId,Po(t.ne,e.overlayMutation))}function Ol(t,e){const n=e.path.lastSegment();return[t,jo(e.path.popLast()),n]}function Fl(t,e,n,i){return{indexId:t,uid:e.uid||"",sequenceNumber:n,readTime:Il(i.readTime),documentKey:jo(i.documentKey.path),largestBatchId:i.largestBatchId}}class Ul{getBundleMetadata(t,e){return Vl(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:Cl(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return Vl(t).put({bundleId:(n=e).id,createTime:Il(wo(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return kl(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:Pl(e.bundledQuery),readTime:Cl(e.readTime)};var e}))}saveNamedQuery(t,e){return kl(t).put(function(t){return{name:t.name,readTime:Il(wo(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function Vl(t){return xl(t,"bundles")}function kl(t){return xl(t,"namedQueries")}class Bl{constructor(t,e){this.wt=t,this.userId=e}static se(t,e){const n=e.uid||"";return new Bl(t,n)}getOverlay(t,e){return zl(t).get(Ol(this.userId,e)).next((t=>t?Nl(this.wt,t):null))}getOverlays(t,e){const n=Qa();return gr.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const i=[];return n.forEach(((n,r)=>{const s=new Sl(e,r);i.push(this.ie(t,s))})),gr.waitFor(i)}removeOverlaysForBatchId(t,e,n){const i=new Set;e.forEach((t=>i.add(jo(t.getCollectionPath()))));const r=[];return i.forEach((e=>{const i=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);r.push(zl(t).W("collectionPathOverlayIndex",i))})),gr.waitFor(r)}getOverlaysForCollection(t,e,n){const i=Qa(),r=jo(e),s=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return zl(t).K("collectionPathOverlayIndex",s).next((t=>{for(const e of t){const t=Nl(this.wt,e);i.set(t.getKey(),t)}return i}))}getOverlaysForCollectionGroup(t,e,n,i){const r=Qa();let s;const a=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return zl(t).J({index:"collectionGroupOverlayIndex",range:a},((t,e,n)=>{const a=Nl(this.wt,e);r.size()<i||a.largestBatchId===s?(r.set(a.getKey(),a),s=a.largestBatchId):n.done()})).next((()=>r))}ie(t,e){return zl(t).put(function(t,e,n){const[i,r,s]=Ol(e,n.mutation.key);return{userId:e,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Lo(t.ne,n.mutation)}}(this.wt,this.userId,e))}}function zl(t){return xl(t,"documentOverlays")}class Gl{constructor(){}re(t,e){this.oe(t,e),e.ue()}oe(t,e){if("nullValue"in t)this.ce(e,5);else if("booleanValue"in t)this.ce(e,10),e.ae(t.booleanValue?1:0);else if("integerValue"in t)this.ce(e,15),e.ae(Hr(t.integerValue));else if("doubleValue"in t){const n=Hr(t.doubleValue);isNaN(n)?this.ce(e,13):(this.ce(e,15),Qr(n)?e.ae(0):e.ae(n))}else if("timestampValue"in t){const n=t.timestampValue;this.ce(e,20),"string"==typeof n?e.he(n):(e.he(`${n.seconds||""}`),e.ae(n.nanos||0))}else if("stringValue"in t)this.le(t.stringValue,e),this.fe(e);else if("bytesValue"in t)this.ce(e,30),e.de(Wr(t.bytesValue)),this.fe(e);else if("referenceValue"in t)this._e(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.ce(e,45),e.ae(n.latitude||0),e.ae(n.longitude||0)}else"mapValue"in t?ms(t)?this.ce(e,Number.MAX_SAFE_INTEGER):(this.we(t.mapValue,e),this.fe(e)):"arrayValue"in t?(this.me(t.arrayValue,e),this.fe(e)):Ii()}le(t,e){this.ce(e,25),this.ge(t,e)}ge(t,e){e.he(t)}we(t,e){const n=t.fields||{};this.ce(e,55);for(const t of Object.keys(n))this.le(t,e),this.oe(n[t],e)}me(t,e){const n=t.values||[];this.ce(e,50);for(const t of n)this.oe(t,e)}_e(t,e){this.ce(e,37),er.fromName(t).path.forEach((t=>{this.ce(e,60),this.ge(t,e)}))}ce(t,e){t.ae(e)}fe(t){t.ae(2)}}function Hl(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function Wl(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const i=Hl(255&t[n]);if(e+=i,8!==i)break}return e}(t);return Math.ceil(e/8)}Gl.ye=new Gl;class ql{constructor(){this.buffer=new Uint8Array(1024),this.position=0}pe(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ie(n.value),n=e.next();this.Te()}Ee(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ae(n.value),n=e.next();this.Re()}be(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ie(t);else if(t<2048)this.Ie(960|t>>>6),this.Ie(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ie(480|t>>>12),this.Ie(128|63&t>>>6),this.Ie(128|63&t);else{const t=e.codePointAt(0);this.Ie(240|t>>>18),this.Ie(128|63&t>>>12),this.Ie(128|63&t>>>6),this.Ie(128|63&t)}}this.Te()}Pe(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ae(t);else if(t<2048)this.Ae(960|t>>>6),this.Ae(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ae(480|t>>>12),this.Ae(128|63&t>>>6),this.Ae(128|63&t);else{const t=e.codePointAt(0);this.Ae(240|t>>>18),this.Ae(128|63&t>>>12),this.Ae(128|63&t>>>6),this.Ae(128|63&t)}}this.Re()}ve(t){const e=this.Ve(t),n=Wl(e);this.Se(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}De(t){const e=this.Ve(t),n=Wl(e);this.Se(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}Ce(){this.xe(255),this.xe(255)}Ne(){this.ke(255),this.ke(255)}reset(){this.position=0}seed(t){this.Se(t.length),this.buffer.set(t,this.position),this.position+=t.length}Me(){return this.buffer.slice(0,this.position)}Ve(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ie(t){const e=255&t;0===e?(this.xe(0),this.xe(255)):255===e?(this.xe(255),this.xe(0)):this.xe(e)}Ae(t){const e=255&t;0===e?(this.ke(0),this.ke(255)):255===e?(this.ke(255),this.ke(0)):this.ke(t)}Te(){this.xe(0),this.xe(1)}Re(){this.ke(0),this.ke(1)}xe(t){this.Se(1),this.buffer[this.position++]=t}ke(t){this.Se(1),this.buffer[this.position++]=~t}Se(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const i=new Uint8Array(n);i.set(this.buffer),this.buffer=i}}class jl{constructor(t){this.Oe=t}de(t){this.Oe.pe(t)}he(t){this.Oe.be(t)}ae(t){this.Oe.ve(t)}ue(){this.Oe.Ce()}}class Xl{constructor(t){this.Oe=t}de(t){this.Oe.Ee(t)}he(t){this.Oe.Pe(t)}ae(t){this.Oe.De(t)}ue(){this.Oe.Ne()}}class Kl{constructor(){this.Oe=new ql,this.Fe=new jl(this.Oe),this.$e=new Xl(this.Oe)}seed(t){this.Oe.seed(t)}Be(t){return 0===t?this.Fe:this.$e}Me(){return this.Oe.Me()}reset(){this.Oe.reset()}}class $l{constructor(t,e,n,i){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=i}Le(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new $l(this.indexId,this.documentKey,this.arrayValue,n)}}function Yl(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Ql(t.arrayValue,e.arrayValue),0!==n?n:(n=Ql(t.directionalValue,e.directionalValue),0!==n?n:er.comparator(t.documentKey,e.documentKey)))}function Ql(t,e){for(let n=0;n<t.length&&n<e.length;++n){const i=t[n]-e[n];if(0!==i)return i}return t.length-e.length}class Jl{constructor(t){this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Ue=t.orderBy,this.qe=[];for(const e of t.filters){const t=e;t.ht()?this.Ke=t:this.qe.push(t)}}Ge(t){const e=ir(t);if(void 0!==e&&!this.Qe(e))return!1;const n=rr(t);let i=0,r=0;for(;i<n.length&&this.Qe(n[i]);++i);if(i===n.length)return!0;if(void 0!==this.Ke){const t=n[i];if(!this.je(this.Ke,t)||!this.We(this.Ue[r++],t))return!1;++i}for(;i<n.length;++i){const t=n[i];if(r>=this.Ue.length||!this.We(this.Ue[r++],t))return!1}return!0}Qe(t){for(const e of this.qe)if(this.je(e,t))return!0;return!1}je(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}We(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}class Zl{constructor(){this.ze=new tc}addToCollectionParentIndex(t,e){return this.ze.add(e),gr.resolve()}getCollectionParents(t,e){return gr.resolve(this.ze.getEntries(e))}addFieldIndex(t,e){return gr.resolve()}deleteFieldIndex(t,e){return gr.resolve()}getDocumentsMatchingTarget(t,e){return gr.resolve(null)}getIndexType(t,e){return gr.resolve(0)}getFieldIndexes(t,e){return gr.resolve([])}getNextCollectionGroupToUpdate(t){return gr.resolve(null)}getMinOffset(t,e){return gr.resolve(hr.min())}getMinOffsetFromCollectionGroup(t,e){return gr.resolve(hr.min())}updateCollectionGroup(t,e,n){return gr.resolve()}updateIndexEntries(t,e){return gr.resolve()}}class tc{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),i=this.index[e]||new Or(Ji.comparator),r=!i.has(n);return this.index[e]=i.add(n),r}has(t){const e=t.lastSegment(),n=t.popLast(),i=this.index[e];return i&&i.has(n)}getEntries(t){return(this.index[t]||new Or(Ji.comparator)).toArray()}}const ec=new Uint8Array(0);class nc{constructor(t,e){this.user=t,this.databaseId=e,this.He=new tc,this.Je=new qa((t=>Ts(t)),((t,e)=>Ms(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.He.has(e)){const n=e.lastSegment(),i=e.popLast();t.addOnCommittedListener((()=>{this.He.add(e)}));const r={collectionId:n,parent:jo(i)};return ic(t).put(r)}return gr.resolve()}getCollectionParents(t,e){const n=[],i=IDBKeyRange.bound([e,""],[Ki(e),""],!1,!0);return ic(t).K(i).next((t=>{for(const i of t){if(i.collectionId!==e)break;n.push($o(i.parent))}return n}))}addFieldIndex(t,e){const n=sc(t),i=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete i.indexId;const r=n.add(i);if(e.indexState){const n=ac(t);return r.next((t=>{n.put(Fl(t,this.user,e.indexState.sequenceNumber,e.indexState.offset))}))}return r.next()}deleteFieldIndex(t,e){const n=sc(t),i=ac(t),r=rc(t);return n.delete(e.indexId).next((()=>i.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e){const n=rc(t);let i=!0;const r=new Map;return gr.forEach(this.Ye(e),(e=>this.Xe(t,e).next((t=>{i&&(i=!!t),r.set(e,t)})))).next((()=>{if(i){let t=no();const i=[];return gr.forEach(r,((r,s)=>{var a;Ei("IndexedDbIndexManager",`Using index ${a=r,`id=${a.indexId}|cg=${a.collectionGroup}|f=${a.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`} to execute ${Ts(e)}`);const o=function(t,e){const n=ir(e);if(void 0===n)return null;for(const e of Is(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(s,r),l=function(t,e){const n=new Map;for(const i of rr(e))for(const e of Is(t,i.fieldPath))switch(e.op){case"==":case"in":n.set(i.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(i.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(s,r),c=function(t,e){const n=[];let i=!0;for(const r of rr(e)){const e=0===r.kind?Cs(t,r.fieldPath,t.startAt):Rs(t,r.fieldPath,t.startAt);n.push(e.value),i&&(i=e.inclusive)}return new Bs(n,i)}(s,r),u=function(t,e){const n=[];let i=!0;for(const r of rr(e)){const e=0===r.kind?Rs(t,r.fieldPath,t.endAt):Cs(t,r.fieldPath,t.endAt);n.push(e.value),i&&(i=e.inclusive)}return new Bs(n,i)}(s,r),h=this.Ze(r,s,c),d=this.Ze(r,s,u),f=this.tn(r,s,l),p=this.en(r.indexId,o,h,c.inclusive,d,u.inclusive,f);return gr.forEach(p,(r=>n.j(r,e.limit).next((e=>{e.forEach((e=>{const n=er.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),i.push(n))}))}))))})).next((()=>i))}return gr.resolve(null)}))}Ye(t){let e=this.Je.get(t);return e||(e=[t],this.Je.set(t,e),e)}en(t,e,n,i,r,s,a){const o=(null!=e?e.length:1)*Math.max(n.length,r.length),l=o/(null!=e?e.length:1),c=[];for(let u=0;u<o;++u){const o=e?this.nn(e[u/l]):ec,h=this.sn(t,o,n[u%l],i),d=this.rn(t,o,r[u%l],s),f=a.map((e=>this.sn(t,o,e,!0)));c.push(...this.createRange(h,d,f))}return c}sn(t,e,n,i){const r=new $l(t,er.empty(),e,n);return i?r:r.Le()}rn(t,e,n,i){const r=new $l(t,er.empty(),e,n);return i?r.Le():r}Xe(t,e){const n=new Jl(e),i=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,i).next((t=>{let e=null;for(const i of t)n.Ge(i)&&(!e||i.fields.length>e.fields.length)&&(e=i);return e}))}getIndexType(t,e){let n=2;return gr.forEach(this.Ye(e),(e=>this.Xe(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Or(tr.comparator),n=!1;for(const i of t.filters){const t=i;t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field))}for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>n))}on(t,e){const n=new Kl;for(const i of rr(t)){const t=e.data.field(i.fieldPath);if(null==t)return null;const r=n.Be(i.kind);Gl.ye.re(t,r)}return n.Me()}nn(t){const e=new Kl;return Gl.ye.re(t,e.Be(0)),e.Me()}un(t,e){const n=new Kl;return Gl.ye.re(ls(this.databaseId,e),n.Be(function(t){const e=rr(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Me()}tn(t,e,n){if(null===n)return[];let i=[];i.push(new Kl);let r=0;for(const s of rr(t)){const t=n[r++];for(const n of i)if(this.cn(e,s.fieldPath)&&us(t))i=this.an(i,s,t);else{const e=n.Be(s.kind);Gl.ye.re(t,e)}}return this.hn(i)}Ze(t,e,n){return this.tn(t,e,n.position)}hn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Me();return e}an(t,e,n){const i=[...t],r=[];for(const t of n.arrayValue.values||[])for(const n of i){const i=new Kl;i.seed(n.Me()),Gl.ye.re(t,i.Be(e.kind)),r.push(i)}return r}cn(t,e){return!!t.filters.find((t=>t instanceof Ds&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=sc(t),i=ac(t);return(e?n.K("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.K()).next((t=>{const e=[];return gr.forEach(t,(t=>i.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new lr(e.sequenceNumber,new hr(Cl(e.readTime),new er($o(e.documentKey)),e.largestBatchId)):lr.empty(),i=t.fields.map((([t,e])=>new ar(tr.fromServerFormat(t),e)));return new nr(t.indexId,t.collectionGroup,i,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:ji(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const i=sc(t),r=ac(t);return this.ln(t).next((t=>i.K("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>gr.forEach(e,(e=>r.put(Fl(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return gr.forEach(e,((e,i)=>{const r=n.get(e.collectionGroup);return(r?gr.resolve(r):this.getFieldIndexes(t,e.collectionGroup)).next((r=>(n.set(e.collectionGroup,r),gr.forEach(r,(n=>this.fn(t,e,n).next((e=>{const r=this.dn(i,n);return e.isEqual(r)?gr.resolve():this._n(t,i,n,e,r)})))))))}))}wn(t,e,n,i){return rc(t).put({indexId:i.indexId,uid:this.uid,arrayValue:i.arrayValue,directionalValue:i.directionalValue,orderedDocumentKey:this.un(n,e.key),documentKey:e.key.path.toArray()})}mn(t,e,n,i){return rc(t).delete([i.indexId,this.uid,i.arrayValue,i.directionalValue,this.un(n,e.key),e.key.path.toArray()])}fn(t,e,n){const i=rc(t);let r=new Or(Yl);return i.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.un(n,e)])},((t,i)=>{r=r.add(new $l(n.indexId,e,i.arrayValue,i.directionalValue))})).next((()=>r))}dn(t,e){let n=new Or(Yl);const i=this.on(e,t);if(null==i)return n;const r=ir(e);if(null!=r){const s=t.data.field(r.fieldPath);if(us(s))for(const r of s.arrayValue.values||[])n=n.add(new $l(e.indexId,t.key,this.nn(r),i))}else n=n.add(new $l(e.indexId,t.key,ec,i));return n}_n(t,e,n,i,r){Ei("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const s=[];return function(t,e,n,i,r){const s=t.getIterator(),a=e.getIterator();let o=Ur(s),l=Ur(a);for(;o||l;){let t=!1,e=!1;if(o&&l){const i=n(o,l);i<0?e=!0:i>0&&(t=!0)}else null!=o?e=!0:t=!0;t?(i(l),l=Ur(a)):e?(r(o),o=Ur(s)):(o=Ur(s),l=Ur(a))}}(i,r,Yl,(i=>{s.push(this.wn(t,e,n,i))}),(i=>{s.push(this.mn(t,e,n,i))})),gr.waitFor(s)}ln(t){let e=1;return ac(t).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,i)=>{i.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>Yl(t,e))).filter(((t,e,n)=>!e||0!==Yl(t,n[e-1])));const i=[];i.push(t);for(const r of n){const n=Yl(r,t),s=Yl(r,e);if(0===n)i[0]=t.Le();else if(n>0&&s<0)i.push(r),i.push(r.Le());else if(s>0)break}i.push(e);const r=[];for(let t=0;t<i.length;t+=2)r.push(IDBKeyRange.bound([i[t].indexId,this.uid,i[t].arrayValue,i[t].directionalValue,ec,[]],[i[t+1].indexId,this.uid,i[t+1].arrayValue,i[t+1].directionalValue,ec,[]]));return r}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(oc)}getMinOffset(t,e){return gr.mapArray(this.Ye(e),(e=>this.Xe(t,e).next((t=>t||Ii())))).next(oc)}}function ic(t){return xl(t,"collectionParents")}function rc(t){return xl(t,"indexEntries")}function sc(t){return xl(t,"indexConfiguration")}function ac(t){return xl(t,"indexState")}function oc(t){Ci(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let i=1;i<t.length;i++){const r=t[i].indexState.offset;dr(r,e)<0&&(e=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new hr(e.readTime,e.documentKey,n)}const lc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class cc{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new cc(t,cc.DEFAULT_COLLECTION_PERCENTILE,cc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function uc(t,e,n){const i=t.store("mutations"),r=t.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId);let o=0;const l=i.J({range:a},((t,e,n)=>(o++,n.delete())));s.push(l.next((()=>{Ci(1===o)})));const c=[];for(const t of n.mutations){const i=Jo(e,t.key.path,n.batchId);s.push(r.delete(i)),c.push(t.key)}return gr.waitFor(s).next((()=>c))}function hc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Ii();e=t.noDocument}return JSON.stringify(e).length}cc.DEFAULT_COLLECTION_PERCENTILE=10,cc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,cc.DEFAULT=new cc(41943040,cc.DEFAULT_COLLECTION_PERCENTILE,cc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),cc.DISABLED=new cc(-1,0,0);class dc{constructor(t,e,n,i){this.userId=t,this.wt=e,this.indexManager=n,this.referenceDelegate=i,this.gn={}}static se(t,e,n,i){Ci(""!==t.uid);const r=t.isAuthenticated()?t.uid:"";return new dc(r,e,n,i)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return pc(t).J({index:"userMutationsIndex",range:n},((t,n,i)=>{e=!1,i.done()})).next((()=>e))}addMutationBatch(t,e,n,i){const r=mc(t),s=pc(t);return s.add({}).next((a=>{Ci("number"==typeof a);const o=new wl(a,e,n,i),l=function(t,e,n){const i=n.baseMutations.map((e=>Lo(t.ne,e))),r=n.mutations.map((e=>Lo(t.ne,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:i,mutations:r}}(this.wt,this.userId,o),c=[];let u=new Or(((t,e)=>ji(t.canonicalString(),e.canonicalString())));for(const t of i){const e=Jo(this.userId,t.key.path,a);u=u.add(t.key.path.popLast()),c.push(s.put(l)),c.push(r.put(e,Zo))}return u.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.gn[a]=o.keys()})),gr.waitFor(c).next((()=>o))}))}lookupMutationBatch(t,e){return pc(t).get(e).next((t=>t?(Ci(t.userId===this.userId),Rl(this.wt,t)):null))}yn(t,e){return this.gn[e]?gr.resolve(this.gn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.gn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,i=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return pc(t).J({index:"userMutationsIndex",range:i},((t,e,i)=>{e.userId===this.userId&&(Ci(e.batchId>=n),r=Rl(this.wt,e)),i.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return pc(t).J({index:"userMutationsIndex",range:e,reverse:!0},((t,e,i)=>{n=e.batchId,i.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return pc(t).K("userMutationsIndex",e).next((t=>t.map((t=>Rl(this.wt,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=Qo(this.userId,e.path),i=IDBKeyRange.lowerBound(n),r=[];return mc(t).J({range:i},((n,i,s)=>{const[a,o,l]=n,c=$o(o);if(a===this.userId&&e.path.isEqual(c))return pc(t).get(l).next((t=>{if(!t)throw Ii();Ci(t.userId===this.userId),r.push(Rl(this.wt,t))}));s.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Or(ji);const i=[];return e.forEach((e=>{const r=Qo(this.userId,e.path),s=IDBKeyRange.lowerBound(r),a=mc(t).J({range:s},((t,i,r)=>{const[s,a,o]=t,l=$o(a);s===this.userId&&e.path.isEqual(l)?n=n.add(o):r.done()}));i.push(a)})),gr.waitFor(i).next((()=>this.pn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,i=n.length+1,r=Qo(this.userId,n),s=IDBKeyRange.lowerBound(r);let a=new Or(ji);return mc(t).J({range:s},((t,e,r)=>{const[s,o,l]=t,c=$o(o);s===this.userId&&n.isPrefixOf(c)?c.length===i&&(a=a.add(l)):r.done()})).next((()=>this.pn(t,a)))}pn(t,e){const n=[],i=[];return e.forEach((e=>{i.push(pc(t).get(e).next((t=>{if(null===t)throw Ii();Ci(t.userId===this.userId),n.push(Rl(this.wt,t))})))})),gr.waitFor(i).next((()=>n))}removeMutationBatch(t,e){return uc(t.ee,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.In(e.batchId)})),gr.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}In(t){delete this.gn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return gr.resolve();const n=IDBKeyRange.lowerBound([this.userId]),i=[];return mc(t).J({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=$o(t[1]);i.push(e)}else n.done()})).next((()=>{Ci(0===i.length)}))}))}containsKey(t,e){return fc(t,this.userId,e)}Tn(t){return gc(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function fc(t,e,n){const i=Qo(e,n.path),r=i[1],s=IDBKeyRange.lowerBound(i);let a=!1;return mc(t).J({range:s,H:!0},((t,n,i)=>{const[s,o,l]=t;s===e&&o===r&&(a=!0),i.done()})).next((()=>a))}function pc(t){return xl(t,"mutations")}function mc(t){return xl(t,"documentMutations")}function gc(t){return xl(t,"mutationQueues")}class vc{constructor(t){this.En=t}next(){return this.En+=2,this.En}static An(){return new vc(0)}static Rn(){return new vc(-1)}}class yc{constructor(t,e){this.referenceDelegate=t,this.wt=e}allocateTargetId(t){return this.bn(t).next((e=>{const n=new vc(e.highestTargetId);return e.highestTargetId=n.next(),this.Pn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.bn(t).next((t=>Yi.fromTimestamp(new $i(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.bn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.bn(t).next((i=>(i.highestListenSequenceNumber=e,n&&(i.lastRemoteSnapshotVersion=n.toTimestamp()),e>i.highestListenSequenceNumber&&(i.highestListenSequenceNumber=e),this.Pn(t,i))))}addTargetData(t,e){return this.vn(t,e).next((()=>this.bn(t).next((n=>(n.targetCount+=1,this.Vn(e,n),this.Pn(t,n))))))}updateTargetData(t,e){return this.vn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>_c(t).delete(e.targetId))).next((()=>this.bn(t))).next((e=>(Ci(e.targetCount>0),e.targetCount-=1,this.Pn(t,e))))}removeTargets(t,e,n){let i=0;const r=[];return _c(t).J(((s,a)=>{const o=Dl(a);o.sequenceNumber<=e&&null===n.get(o.targetId)&&(i++,r.push(this.removeTargetData(t,o)))})).next((()=>gr.waitFor(r))).next((()=>i))}forEachTarget(t,e){return _c(t).J(((t,n)=>{const i=Dl(n);e(i)}))}bn(t){return xc(t).get("targetGlobalKey").next((t=>(Ci(null!==t),t)))}Pn(t,e){return xc(t).put("targetGlobalKey",e)}vn(t,e){return _c(t).put(Ll(this.wt,e))}Vn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.bn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Ts(e),i=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return _c(t).J({range:i,index:"queryTargetsIndex"},((t,n,i)=>{const s=Dl(n);Ms(e,s.target)&&(r=s,i.done())})).next((()=>r))}addMatchingKeys(t,e,n){const i=[],r=wc(t);return e.forEach((e=>{const s=jo(e.path);i.push(r.put({targetId:n,path:s})),i.push(this.referenceDelegate.addReference(t,n,e))})),gr.waitFor(i)}removeMatchingKeys(t,e,n){const i=wc(t);return gr.forEach(e,(e=>{const r=jo(e.path);return gr.waitFor([i.delete([n,r]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=wc(t),i=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(i)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),i=wc(t);let r=no();return i.J({range:n,H:!0},((t,e,n)=>{const i=$o(t[1]),s=new er(i);r=r.add(s)})).next((()=>r))}containsKey(t,e){const n=jo(e.path),i=IDBKeyRange.bound([n],[Ki(n)],!1,!0);let r=0;return wc(t).J({index:"documentTargetsIndex",H:!0,range:i},(([t,e],n,i)=>{0!==t&&(r++,i.done())})).next((()=>r>0))}te(t,e){return _c(t).get(e).next((t=>t?Dl(t):null))}}function _c(t){return xl(t,"targets")}function xc(t){return xl(t,"targetGlobal")}function wc(t){return xl(t,"targetDocuments")}function bc([t,e],[n,i]){const r=ji(t,n);return 0===r?ji(e,i):r}class Sc{constructor(t){this.Sn=t,this.buffer=new Or(bc),this.Dn=0}Cn(){return++this.Dn}xn(t){const e=[t,this.Cn()];if(this.buffer.size<this.Sn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();bc(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Ec{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Nn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.kn(6e4)}stop(){this.Nn&&(this.Nn.cancel(),this.Nn=null)}get started(){return null!==this.Nn}kn(t){Ei("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Nn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Nn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){wr(t)?Ei("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await mr(t)}await this.kn(3e5)}))}}class Tc{constructor(t,e){this.Mn=t,this.params=e}calculateTargetCount(t,e){return this.Mn.On(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return gr.resolve(Ir.ot);const n=new Sc(e);return this.Mn.forEachTarget(t,(t=>n.xn(t.sequenceNumber))).next((()=>this.Mn.Fn(t,(t=>n.xn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.Mn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.Mn.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(Ei("LruGarbageCollector","Garbage collection skipped; disabled"),gr.resolve(lc)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(Ei("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),lc):this.$n(t,e)))}getCacheSize(t){return this.Mn.getCacheSize(t)}$n(t,e){let n,i,r,s,o,l,c;const u=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(Ei("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),i=this.params.maximumSequenceNumbersToCollect):i=e,s=Date.now(),this.nthSequenceNumber(t,i)))).next((i=>(n=i,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(r=e,l=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(c=Date.now(),bi()<=a.in.DEBUG&&Ei("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${s-u}ms\n\tDetermined least recently used ${i} in `+(o-s)+"ms\n"+`\tRemoved ${r} targets in `+(l-o)+"ms\n"+`\tRemoved ${t} documents in `+(c-l)+"ms\n"+`Total Duration: ${c-u}ms`),gr.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:r,documentsRemoved:t}))))}}class Mc{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new Tc(t,e)}(this,e)}On(t){const e=this.Bn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Bn(t){let e=0;return this.Fn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Fn(t,e){return this.Ln(t,((t,n)=>e(n)))}addReference(t,e,n){return Ac(t,n)}removeReference(t,e,n){return Ac(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Ac(t,e)}Un(t,e){return function(t,e){let n=!1;return gc(t).Y((i=>fc(t,i,e).next((t=>(t&&(n=!0),gr.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let r=0;return this.Ln(t,((s,a)=>{if(a<=e){const e=this.Un(t,s).next((e=>{if(!e)return r++,n.getEntry(t,s).next((()=>(n.removeEntry(s,Yi.min()),wc(t).delete([0,jo(s.path)]))))}));i.push(e)}})).next((()=>gr.waitFor(i))).next((()=>n.apply(t))).next((()=>r))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Ac(t,e)}Ln(t,e){const n=wc(t);let i,r=Ir.ot;return n.J({index:"documentTargetsIndex"},(([t,n],{path:s,sequenceNumber:a})=>{0===t?(r!==Ir.ot&&e(new er($o(i)),r),r=a,i=s):r=Ir.ot})).next((()=>{r!==Ir.ot&&e(new er($o(i)),r)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Ac(t,e){return wc(t).put(function(t,e){return{targetId:0,path:jo(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class Ic{constructor(){this.changes=new qa((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,bs.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?gr.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Cc{constructor(t){this.wt=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Pc(t).put(n)}removeEntry(t,e,n){return Pc(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Al(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.qn(t,n))))}getEntry(t,e){let n=bs.newInvalidDocument(e);return Pc(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(Nc(e))},((t,i)=>{n=this.Kn(e,i)})).next((()=>n))}Gn(t,e){let n={size:0,document:bs.newInvalidDocument(e)};return Pc(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(Nc(e))},((t,i)=>{n={document:this.Kn(e,i),size:hc(i)}})).next((()=>n))}getEntries(t,e){let n=Xa();return this.Qn(t,e,((t,e)=>{const i=this.Kn(t,e);n=n.insert(t,i)})).next((()=>n))}jn(t,e){let n=Xa(),i=new Lr(er.comparator);return this.Qn(t,e,((t,e)=>{const r=this.Kn(t,e);n=n.insert(t,r),i=i.insert(t,hc(e))})).next((()=>({documents:n,Wn:i})))}Qn(t,e,n){if(e.isEmpty())return gr.resolve();let i=new Or(Fc);e.forEach((t=>i=i.add(t)));const r=IDBKeyRange.bound(Nc(i.first()),Nc(i.last())),s=i.getIterator();let a=s.getNext();return Pc(t).J({index:"documentKeyIndex",range:r},((t,e,i)=>{const r=er.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;a&&Fc(a,r)<0;)n(a,null),a=s.getNext();a&&a.isEqual(r)&&(n(a,e),a=s.hasNext()?s.getNext():null),a?i.q(Nc(a)):i.done()})).next((()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null}))}getAllFromCollection(t,e,n){const i=[e.popLast().toArray(),e.lastSegment(),Al(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],r=[e.popLast().toArray(),e.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Pc(t).K(IDBKeyRange.bound(i,r,!0)).next((t=>{let e=Xa();for(const n of t){const t=this.Kn(er.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e=e.insert(t.key,t)}return e}))}getAllFromCollectionGroup(t,e,n,i){let r=Xa();const s=Oc(e,n),a=Oc(e,hr.max());return Pc(t).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(s,a,!0)},((t,e,n)=>{const s=this.Kn(er.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);r=r.insert(s.key,s),r.size===i&&n.done()})).next((()=>r))}newChangeBuffer(t){return new Dc(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Lc(t).get("remoteDocumentGlobalKey").next((t=>(Ci(!!t),t)))}qn(t,e){return Lc(t).put("remoteDocumentGlobalKey",e)}Kn(t,e){if(e){const t=function(t,e){let n;if(e.document)n=Do(t.ne,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=er.fromSegments(e.noDocument.path),i=Cl(e.noDocument.readTime);n=bs.newNoDocument(t,i),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Ii();{const t=er.fromSegments(e.unknownDocument.path),i=Cl(e.unknownDocument.version);n=bs.newUnknownDocument(t,i)}}return e.readTime&&n.setReadTime(function(t){const e=new $i(t[0],t[1]);return Yi.fromTimestamp(e)}(e.readTime)),n}(this.wt,e);if(!t.isNoDocument()||!t.version.isEqual(Yi.min()))return t}return bs.newInvalidDocument(t)}}function Rc(t){return new Cc(t)}class Dc extends Ic{constructor(t,e){super(),this.zn=t,this.trackRemovals=e,this.Hn=new qa((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,i=new Or(((t,e)=>ji(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((r,s)=>{const a=this.Hn.get(r);if(e.push(this.zn.removeEntry(t,r,a.readTime)),s.isValidDocument()){const o=Ml(this.zn.wt,s);i=i.add(r.path.popLast());const l=hc(o);n+=l-a.size,e.push(this.zn.addEntry(t,r,o))}else if(n-=a.size,this.trackRemovals){const n=Ml(this.zn.wt,s.convertToNoDocument(Yi.min()));e.push(this.zn.addEntry(t,r,n))}})),i.forEach((n=>{e.push(this.zn.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.zn.updateMetadata(t,n)),gr.waitFor(e)}getFromCache(t,e){return this.zn.Gn(t,e).next((t=>(this.Hn.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.zn.jn(t,e).next((({documents:t,Wn:e})=>(e.forEach(((e,n)=>{this.Hn.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function Lc(t){return xl(t,"remoteDocumentGlobal")}function Pc(t){return xl(t,"remoteDocumentsV14")}function Nc(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Oc(t,e){const n=e.documentKey.path.toArray();return[t,Al(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Fc(t,e){const n=t.path.toArray(),i=e.path.toArray();let r=0;for(let t=0;t<n.length-2&&t<i.length-2;++t)if(r=ji(n[t],i[t]),r)return r;return r=ji(n.length,i.length),r||(r=ji(n[n.length-2],i[i.length-2]),r||ji(n[n.length-1],i[i.length-1]))}class Uc{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class Vc{constructor(t,e,n,i){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=i}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((i=>(n=i,this.getBaseDocument(t,e,n)))).next((t=>(null!==n&&Ra(n.mutation,t,Vr.empty(),$i.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,no()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=no()){const i=Qa();return this.populateOverlays(t,i,e).next((()=>this.computeViews(t,e,i,n).next((t=>{let e=$a();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=Qa();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,no())))}populateOverlays(t,e,n){const i=[];return n.forEach((t=>{e.has(t)||i.push(t)})),this.documentOverlayCache.getOverlays(t,i).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,i){let r=Xa();const s=Za(),a=Za();return e.forEach(((t,e)=>{const a=n.get(e.key);i.has(e.key)&&(void 0===a||a.mutation instanceof Na)?r=r.insert(e.key,e):void 0!==a&&(s.set(e.key,a.mutation.getFieldMask()),Ra(a.mutation,e,a.mutation.getFieldMask(),$i.now()))})),this.recalculateAndSaveOverlays(t,r).next((t=>(t.forEach(((t,e)=>s.set(t,e))),e.forEach(((t,e)=>{var n;return a.set(t,new Uc(e,null!==(n=s.get(t))&&void 0!==n?n:null))})),a)))}recalculateAndSaveOverlays(t,e){const n=Za();let i=new Lr(((t,e)=>t-e)),r=no();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const r of t)r.keys().forEach((t=>{const s=e.get(t);if(null===s)return;let a=n.get(t)||Vr.empty();a=r.applyToLocalView(s,a),n.set(t,a);const o=(i.get(r.batchId)||no()).add(t);i=i.insert(r.batchId,o)}))})).next((()=>{const s=[],a=i.getReverseIterator();for(;a.hasNext();){const i=a.getNext(),o=i.key,l=i.value,c=Ja();l.forEach((t=>{if(!r.has(t)){const i=Ia(e.get(t),n.get(t));null!==i&&c.set(t,i),r=r.add(t)}})),s.push(this.documentOverlayCache.saveOverlays(t,o,c))}return gr.waitFor(s)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n){return function(t){return er.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):Qs(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)}getNextDocuments(t,e,n,i){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,i).next((r=>{const s=i-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,i-r.size):gr.resolve(Qa());let a=-1,o=r;return s.next((e=>gr.forEach(e,((e,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),r.get(e)?gr.resolve():this.getBaseDocument(t,e,n).next((t=>{o=o.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,r))).next((()=>this.computeViews(t,o,e,no()))).next((t=>({batchId:a,changes:Ya(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new er(e)).next((t=>{let e=$a();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n){const i=e.collectionGroup;let r=$a();return this.indexManager.getCollectionParents(t,i).next((s=>gr.forEach(s,(s=>{const a=function(t,e){return new qs(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,s.child(i));return this.getDocumentsMatchingCollectionQuery(t,a,n).next((t=>{t.forEach(((t,e)=>{r=r.insert(t,e)}))}))})).next((()=>r))))}getDocumentsMatchingCollectionQuery(t,e,n){let i;return this.remoteDocumentCache.getAllFromCollection(t,e.path,n).next((r=>(i=r,this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId)))).next((t=>{t.forEach(((t,e)=>{const n=e.getKey();null===i.get(n)&&(i=i.insert(n,bs.newInvalidDocument(n)))}));let n=$a();return i.forEach(((i,r)=>{const s=t.get(i);void 0!==s&&Ra(s.mutation,r,Vr.empty(),$i.now()),ra(e,r)&&(n=n.insert(i,r))})),n}))}getBaseDocument(t,e,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(t,e):gr.resolve(bs.newInvalidDocument(e))}}class kc{constructor(t){this.wt=t,this.Jn=new Map,this.Yn=new Map}getBundleMetadata(t,e){return gr.resolve(this.Jn.get(e))}saveBundleMetadata(t,e){var n;return this.Jn.set(e.id,{id:(n=e).id,version:n.version,createTime:wo(n.createTime)}),gr.resolve()}getNamedQuery(t,e){return gr.resolve(this.Yn.get(e))}saveNamedQuery(t,e){return this.Yn.set(e.name,function(t){return{name:t.name,query:Pl(t.bundledQuery),readTime:wo(t.readTime)}}(e)),gr.resolve()}}class Bc{constructor(){this.overlays=new Lr(er.comparator),this.Xn=new Map}getOverlay(t,e){return gr.resolve(this.overlays.get(e))}getOverlays(t,e){const n=Qa();return gr.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,i)=>{this.ie(t,e,i)})),gr.resolve()}removeOverlaysForBatchId(t,e,n){const i=this.Xn.get(n);return void 0!==i&&(i.forEach((t=>this.overlays=this.overlays.remove(t))),this.Xn.delete(n)),gr.resolve()}getOverlaysForCollection(t,e,n){const i=Qa(),r=e.length+1,s=new er(e.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){const t=a.getNext().value,s=t.getKey();if(!e.isPrefixOf(s.path))break;s.path.length===r&&t.largestBatchId>n&&i.set(t.getKey(),t)}return gr.resolve(i)}getOverlaysForCollectionGroup(t,e,n,i){let r=new Lr(((t,e)=>t-e));const s=this.overlays.getIterator();for(;s.hasNext();){const t=s.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=r.get(t.largestBatchId);null===e&&(e=Qa(),r=r.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=Qa(),o=r.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach(((t,e)=>a.set(t,e))),!(a.size()>=i)););return gr.resolve(a)}ie(t,e,n){const i=this.overlays.get(n.key);if(null!==i){const t=this.Xn.get(i.largestBatchId).delete(n.key);this.Xn.set(i.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new Sl(e,n));let r=this.Xn.get(e);void 0===r&&(r=no(),this.Xn.set(e,r)),this.Xn.set(e,r.add(n.key))}}class zc{constructor(){this.Zn=new Or(Gc.ts),this.es=new Or(Gc.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(t,e){const n=new Gc(t,e);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.rs(new Gc(t,e))}os(t,e){t.forEach((t=>this.removeReference(t,e)))}us(t){const e=new er(new Ji([])),n=new Gc(e,t),i=new Gc(e,t+1),r=[];return this.es.forEachInRange([n,i],(t=>{this.rs(t),r.push(t.key)})),r}cs(){this.Zn.forEach((t=>this.rs(t)))}rs(t){this.Zn=this.Zn.delete(t),this.es=this.es.delete(t)}hs(t){const e=new er(new Ji([])),n=new Gc(e,t),i=new Gc(e,t+1);let r=no();return this.es.forEachInRange([n,i],(t=>{r=r.add(t.key)})),r}containsKey(t){const e=new Gc(t,0),n=this.Zn.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Gc{constructor(t,e){this.key=t,this.ls=e}static ts(t,e){return er.comparator(t.key,e.key)||ji(t.ls,e.ls)}static ns(t,e){return ji(t.ls,e.ls)||er.comparator(t.key,e.key)}}class Hc{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.fs=1,this.ds=new Or(Gc.ts)}checkEmpty(t){return gr.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,i){const r=this.fs;this.fs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const s=new wl(r,e,n,i);this.mutationQueue.push(s);for(const e of i)this.ds=this.ds.add(new Gc(e.key,r)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return gr.resolve(s)}lookupMutationBatch(t,e){return gr.resolve(this._s(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,i=this.ws(n),r=i<0?0:i;return gr.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return gr.resolve(0===this.mutationQueue.length?-1:this.fs-1)}getAllMutationBatches(t){return gr.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Gc(e,0),i=new Gc(e,Number.POSITIVE_INFINITY),r=[];return this.ds.forEachInRange([n,i],(t=>{const e=this._s(t.ls);r.push(e)})),gr.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Or(ji);return e.forEach((t=>{const e=new Gc(t,0),i=new Gc(t,Number.POSITIVE_INFINITY);this.ds.forEachInRange([e,i],(t=>{n=n.add(t.ls)}))})),gr.resolve(this.gs(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,i=n.length+1;let r=n;er.isDocumentKey(r)||(r=r.child(""));const s=new Gc(new er(r),0);let a=new Or(ji);return this.ds.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===i&&(a=a.add(t.ls)),!0)}),s),gr.resolve(this.gs(a))}gs(t){const e=[];return t.forEach((t=>{const n=this._s(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Ci(0===this.ys(e.batchId,"removed")),this.mutationQueue.shift();let n=this.ds;return gr.forEach(e.mutations,(i=>{const r=new Gc(i.key,e.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,i.key)})).next((()=>{this.ds=n}))}In(t){}containsKey(t,e){const n=new Gc(e,0),i=this.ds.firstAfterOrEqual(n);return gr.resolve(e.isEqual(i&&i.key))}performConsistencyCheck(t){return this.mutationQueue.length,gr.resolve()}ys(t,e){return this.ws(t)}ws(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}_s(t){const e=this.ws(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Wc{constructor(t){this.ps=t,this.docs=new Lr(er.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,i=this.docs.get(n),r=i?i.size:0,s=this.ps(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:s}),this.size+=s-r,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return gr.resolve(n?n.document.mutableCopy():bs.newInvalidDocument(e))}getEntries(t,e){let n=Xa();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():bs.newInvalidDocument(t))})),gr.resolve(n)}getAllFromCollection(t,e,n){let i=Xa();const r=new er(e.child("")),s=this.docs.getIteratorFrom(r);for(;s.hasNext();){const{key:t,value:{document:r}}=s.getNext();if(!e.isPrefixOf(t.path))break;t.path.length>e.length+1||dr(ur(r),n)<=0||(i=i.insert(r.key,r.mutableCopy()))}return gr.resolve(i)}getAllFromCollectionGroup(t,e,n,i){Ii()}Is(t,e){return gr.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new qc(this)}getSize(t){return gr.resolve(this.size)}}class qc extends Ic{constructor(t){super(),this.zn=t}applyChanges(t){const e=[];return this.changes.forEach(((n,i)=>{i.isValidDocument()?e.push(this.zn.addEntry(t,i)):this.zn.removeEntry(n)})),gr.waitFor(e)}getFromCache(t,e){return this.zn.getEntry(t,e)}getAllFromCache(t,e){return this.zn.getEntries(t,e)}}class jc{constructor(t){this.persistence=t,this.Ts=new qa((t=>Ts(t)),Ms),this.lastRemoteSnapshotVersion=Yi.min(),this.highestTargetId=0,this.Es=0,this.As=new zc,this.targetCount=0,this.Rs=vc.An()}forEachTarget(t,e){return this.Ts.forEach(((t,n)=>e(n))),gr.resolve()}getLastRemoteSnapshotVersion(t){return gr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return gr.resolve(this.Es)}allocateTargetId(t){return this.highestTargetId=this.Rs.next(),gr.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Es&&(this.Es=e),gr.resolve()}vn(t){this.Ts.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Rs=new vc(e),this.highestTargetId=e),t.sequenceNumber>this.Es&&(this.Es=t.sequenceNumber)}addTargetData(t,e){return this.vn(e),this.targetCount+=1,gr.resolve()}updateTargetData(t,e){return this.vn(e),gr.resolve()}removeTargetData(t,e){return this.Ts.delete(e.target),this.As.us(e.targetId),this.targetCount-=1,gr.resolve()}removeTargets(t,e,n){let i=0;const r=[];return this.Ts.forEach(((s,a)=>{a.sequenceNumber<=e&&null===n.get(a.targetId)&&(this.Ts.delete(s),r.push(this.removeMatchingKeysForTargetId(t,a.targetId)),i++)})),gr.waitFor(r).next((()=>i))}getTargetCount(t){return gr.resolve(this.targetCount)}getTargetData(t,e){const n=this.Ts.get(e)||null;return gr.resolve(n)}addMatchingKeys(t,e,n){return this.As.ss(e,n),gr.resolve()}removeMatchingKeys(t,e,n){this.As.os(e,n);const i=this.persistence.referenceDelegate,r=[];return i&&e.forEach((e=>{r.push(i.markPotentiallyOrphaned(t,e))})),gr.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.As.us(e),gr.resolve()}getMatchingKeysForTargetId(t,e){const n=this.As.hs(e);return gr.resolve(n)}containsKey(t,e){return gr.resolve(this.As.containsKey(e))}}class Xc{constructor(t,e){this.bs={},this.overlays={},this.Ps=new Ir(0),this.vs=!1,this.vs=!0,this.referenceDelegate=t(this),this.Vs=new jc(this),this.indexManager=new Zl,this.remoteDocumentCache=function(t){return new Wc(t)}((t=>this.referenceDelegate.Ss(t))),this.wt=new Tl(e),this.Ds=new kc(this.wt)}start(){return Promise.resolve()}shutdown(){return this.vs=!1,Promise.resolve()}get started(){return this.vs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Bc,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.bs[t.toKey()];return n||(n=new Hc(e,this.referenceDelegate),this.bs[t.toKey()]=n),n}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ds}runTransaction(t,e,n){Ei("MemoryPersistence","Starting transaction:",t);const i=new Kc(this.Ps.next());return this.referenceDelegate.Cs(),n(i).next((t=>this.referenceDelegate.xs(i).next((()=>t)))).toPromise().then((t=>(i.raiseOnCommittedEvent(),t)))}Ns(t,e){return gr.or(Object.values(this.bs).map((n=>()=>n.containsKey(t,e))))}}class Kc extends pr{constructor(t){super(),this.currentSequenceNumber=t}}class $c{constructor(t){this.persistence=t,this.ks=new zc,this.Ms=null}static Os(t){return new $c(t)}get Fs(){if(this.Ms)return this.Ms;throw Ii()}addReference(t,e,n){return this.ks.addReference(n,e),this.Fs.delete(n.toString()),gr.resolve()}removeReference(t,e,n){return this.ks.removeReference(n,e),this.Fs.add(n.toString()),gr.resolve()}markPotentiallyOrphaned(t,e){return this.Fs.add(e.toString()),gr.resolve()}removeTarget(t,e){this.ks.us(e.targetId).forEach((t=>this.Fs.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Fs.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Cs(){this.Ms=new Set}xs(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return gr.forEach(this.Fs,(n=>{const i=er.fromPath(n);return this.$s(t,i).next((t=>{t||e.removeEntry(i,Yi.min())}))})).next((()=>(this.Ms=null,e.apply(t))))}updateLimboDocument(t,e){return this.$s(t,e).next((t=>{t?this.Fs.delete(e.toString()):this.Fs.add(e.toString())}))}Ss(t){return 0}$s(t,e){return gr.or([()=>gr.resolve(this.ks.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ns(t,e)])}}class Yc{constructor(t){this.wt=t}M(t,e,n,i){const r=new vr("createOrUpgrade",e);n<1&&i>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Yo,{unique:!0}),t.createObjectStore("documentMutations")}(t),Qc(t),function(t){t.createObjectStore("remoteDocuments")}(t));let s=gr.resolve();return n<3&&i>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),Qc(t)),s=s.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Yi.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(r)))),n<4&&i>=4&&(0!==n&&(s=s.next((()=>function(t,e){return e.store("mutations").K().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Yo,{unique:!0});const i=e.store("mutations"),r=n.map((t=>i.put(t)));return gr.waitFor(r)}))}(t,r)))),s=s.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&i>=5&&(s=s.next((()=>this.Bs(r)))),n<6&&i>=6&&(s=s.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.Ls(r))))),n<7&&i>=7&&(s=s.next((()=>this.Us(r)))),n<8&&i>=8&&(s=s.next((()=>this.qs(t,r)))),n<9&&i>=9&&(s=s.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&i>=10&&(s=s.next((()=>this.Ks(r)))),n<11&&i>=11&&(s=s.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&i>=12&&(s=s.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:hl});e.createIndex("collectionPathOverlayIndex",dl,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",fl,{unique:!1})}(t)}))),n<13&&i>=13&&(s=s.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:tl});e.createIndex("documentKeyIndex",el),e.createIndex("collectionGroupIndex",nl)}(t))).next((()=>this.Gs(t,r))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&i>=14&&(s=s.next((()=>this.Qs(t,r)))),n<15&&i>=15&&(s=s.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:ol}).createIndex("sequenceNumberIndex",ll,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:cl}).createIndex("documentKeyIndex",ul,{unique:!1})}(t)))),s}Ls(t){let e=0;return t.store("remoteDocuments").J(((t,n)=>{e+=hc(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Bs(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.K().next((e=>gr.forEach(e,(e=>{const i=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.K("userMutationsIndex",i).next((n=>gr.forEach(n,(n=>{Ci(n.userId===e.userId);const i=Rl(this.wt,n);return uc(t,e.userId,i).next((()=>{}))}))))}))))}Us(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const i=[];return n.J(((n,r)=>{const s=new Ji(n),a=function(t){return[0,jo(t)]}(s);i.push(e.get(a).next((n=>n?gr.resolve():(n=>e.put({targetId:0,path:jo(n),sequenceNumber:t.highestListenSequenceNumber}))(s))))})).next((()=>gr.waitFor(i)))}))}qs(t,e){t.createObjectStore("collectionParents",{keyPath:al});const n=e.store("collectionParents"),i=new tc,r=t=>{if(i.add(t)){const e=t.lastSegment(),i=t.popLast();return n.put({collectionId:e,parent:jo(i)})}};return e.store("remoteDocuments").J({H:!0},((t,e)=>{const n=new Ji(t);return r(n.popLast())})).next((()=>e.store("documentMutations").J({H:!0},(([t,e,n],i)=>{const s=$o(e);return r(s.popLast())}))))}Ks(t){const e=t.store("targets");return e.J(((t,n)=>{const i=Dl(n),r=Ll(this.wt,i);return e.put(r)}))}Gs(t,e){const n=e.store("remoteDocuments"),i=[];return n.J(((t,n)=>{const r=e.store("remoteDocumentsV14"),s=(a=n,a.document?new er(Ji.fromString(a.document.name).popFirst(5)):a.noDocument?er.fromSegments(a.noDocument.path):a.unknownDocument?er.fromSegments(a.unknownDocument.path):Ii()).path.toArray();var a;const o={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};i.push(r.put(o))})).next((()=>gr.waitFor(i)))}Qs(t,e){const n=e.store("mutations"),i=Rc(this.wt),r=new Xc($c.Os,this.wt.ne);return n.K().next((t=>{const n=new Map;return t.forEach((t=>{var e;let i=null!==(e=n.get(t.userId))&&void 0!==e?e:no();Rl(this.wt,t).keys().forEach((t=>i=i.add(t))),n.set(t.userId,i)})),gr.forEach(n,((t,n)=>{const s=new _i(n),a=Bl.se(this.wt,s),o=r.getIndexManager(s),l=dc.se(s,this.wt,o,r.referenceDelegate);return new Vc(i,l,a,o).recalculateAndSaveOverlaysForDocumentKeys(new _l(e,Ir.ot),t).next()}))}))}}function Qc(t){t.createObjectStore("targetDocuments",{keyPath:rl}).createIndex("documentTargetsIndex",sl,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",il,{unique:!0}),t.createObjectStore("targetGlobal")}const Jc="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Zc{constructor(t,e,n,i,r,s,a,o,l,c,u=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.js=r,this.window=s,this.document=a,this.Ws=l,this.zs=c,this.Hs=u,this.Ps=null,this.vs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Js=null,this.inForeground=!1,this.Ys=null,this.Xs=null,this.Zs=Number.NEGATIVE_INFINITY,this.ti=t=>Promise.resolve(),!Zc.V())throw new Pi(Li.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Mc(this,i),this.ei=e+"main",this.wt=new Tl(o),this.ni=new yr(this.ei,this.Hs,new Yc(this.wt)),this.Vs=new yc(this.referenceDelegate,this.wt),this.remoteDocumentCache=Rc(this.wt),this.Ds=new Ul,this.window&&this.window.localStorage?this.si=this.window.localStorage:(this.si=null,!1===c&&Ti("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ii().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Pi(Li.FAILED_PRECONDITION,Jc);return this.ri(),this.oi(),this.ui(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Vs.getHighestSequenceNumber(t)))})).then((t=>{this.Ps=new Ir(t,this.Ws)})).then((()=>{this.vs=!0})).catch((t=>(this.ni&&this.ni.close(),Promise.reject(t))))}ci(t){return this.ti=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ni.F((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.js.enqueueAndForget((async()=>{this.started&&await this.ii()})))}ii(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>eu(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.ai(t).next((t=>{t||(this.isPrimary=!1,this.js.enqueueRetryable((()=>this.ti(!1))))}))})).next((()=>this.hi(t))).next((e=>this.isPrimary&&!e?this.li(t).next((()=>!1)):!!e&&this.fi(t).next((()=>!0)))))).catch((t=>{if(wr(t))return Ei("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return Ei("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.js.enqueueRetryable((()=>this.ti(t))),this.isPrimary=t}))}ai(t){return tu(t).get("owner").next((t=>gr.resolve(this.di(t))))}_i(t){return eu(t).delete(this.clientId)}async wi(){if(this.isPrimary&&!this.mi(this.Zs,18e5)){this.Zs=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=xl(t,"clientMetadata");return e.K().next((t=>{const n=this.gi(t,18e5),i=t.filter((t=>-1===n.indexOf(t)));return gr.forEach(i,(t=>e.delete(t.clientId))).next((()=>i))}))})).catch((()=>[]));if(this.si)for(const e of t)this.si.removeItem(this.yi(e.clientId))}}ui(){this.Xs=this.js.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ii().then((()=>this.wi())).then((()=>this.ui()))))}di(t){return!!t&&t.ownerId===this.clientId}hi(t){return this.zs?gr.resolve(!0):tu(t).get("owner").next((e=>{if(null!==e&&this.mi(e.leaseTimestampMs,5e3)&&!this.pi(e.ownerId)){if(this.di(e)&&this.networkEnabled)return!0;if(!this.di(e)){if(!e.allowTabSynchronization)throw new Pi(Li.FAILED_PRECONDITION,Jc);return!1}}return!(!this.networkEnabled||!this.inForeground)||eu(t).K().next((t=>void 0===this.gi(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,i=this.networkEnabled===t.networkEnabled;if(e||n&&i)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&Ei("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.vs=!1,this.Ii(),this.Xs&&(this.Xs.cancel(),this.Xs=null),this.Ti(),this.Ei(),await this.ni.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new _l(t,Ir.ot);return this.li(e).next((()=>this._i(e)))})),this.ni.close(),this.Ai()}gi(t,e){return t.filter((t=>this.mi(t.updateTimeMs,e)&&!this.pi(t.clientId)))}Ri(){return this.runTransaction("getActiveClients","readonly",(t=>eu(t).K().next((t=>this.gi(t,18e5).map((t=>t.clientId))))))}get started(){return this.vs}getMutationQueue(t,e){return dc.se(t,this.wt,e,this.referenceDelegate)}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new nc(t,this.wt.ne.databaseId)}getDocumentOverlayCache(t){return Bl.se(this.wt,t)}getBundleCache(){return this.Ds}runTransaction(t,e,n){Ei("IndexedDbPersistence","Starting transaction:",t);const i="readonly"===e?"readonly":"readwrite",r=15===(s=this.Hs)?yl:14===s?vl:13===s?gl:12===s?ml:11===s?pl:void Ii();var s;let a;return this.ni.runTransaction(t,i,r,(i=>(a=new _l(i,this.Ps?this.Ps.next():Ir.ot),"readwrite-primary"===e?this.ai(a).next((t=>!!t||this.hi(a))).next((e=>{if(!e)throw Ti(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.js.enqueueRetryable((()=>this.ti(!1))),new Pi(Li.FAILED_PRECONDITION,fr);return n(a)})).next((t=>this.fi(a).next((()=>t)))):this.bi(a).next((()=>n(a)))))).then((t=>(a.raiseOnCommittedEvent(),t)))}bi(t){return tu(t).get("owner").next((t=>{if(null!==t&&this.mi(t.leaseTimestampMs,5e3)&&!this.pi(t.ownerId)&&!this.di(t)&&!(this.zs||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Pi(Li.FAILED_PRECONDITION,Jc)}))}fi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tu(t).put("owner",e)}static V(){return yr.V()}li(t){const e=tu(t);return e.get("owner").next((t=>this.di(t)?(Ei("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):gr.resolve()))}mi(t,e){const n=Date.now();return!(t<n-e||t>n&&(Ti(`Detected an update time that is in the future: ${t} > ${n}`),1))}ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ys=()=>{this.js.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ii())))},this.document.addEventListener("visibilitychange",this.Ys),this.inForeground="visible"===this.document.visibilityState)}Ti(){this.Ys&&(this.document.removeEventListener("visibilitychange",this.Ys),this.Ys=null)}oi(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Js=()=>{this.Ii(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.js.enterRestrictedMode(!0),this.js.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Js))}Ei(){this.Js&&(this.window.removeEventListener("pagehide",this.Js),this.Js=null)}pi(t){var e;try{const n=null!==(null===(e=this.si)||void 0===e?void 0:e.getItem(this.yi(t)));return Ei("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return Ti("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}Ii(){if(this.si)try{this.si.setItem(this.yi(this.clientId),String(Date.now()))}catch(t){Ti("Failed to set zombie client id.",t)}}Ai(){if(this.si)try{this.si.removeItem(this.yi(this.clientId))}catch(t){}}yi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function tu(t){return xl(t,"owner")}function eu(t){return xl(t,"clientMetadata")}function nu(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class iu{constructor(t,e,n,i){this.targetId=t,this.fromCache=e,this.Pi=n,this.vi=i}static Vi(t,e){let n=no(),i=no();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:i=i.add(t.doc.key)}return new iu(t,e.fromCache,n,i)}}class ru{constructor(){this.Si=!1}initialize(t,e){this.Di=t,this.indexManager=e,this.Si=!0}getDocumentsMatchingQuery(t,e,n,i){return this.Ci(t,e).next((r=>r||this.xi(t,e,i,n))).next((n=>n||this.Ni(t,e)))}Ci(t,e){if(Ks(e))return gr.resolve(null);let n=Zs(e);return this.indexManager.getIndexType(t,n).next((i=>0===i?null:(null!==e.limit&&1===i&&(e=ta(e,null,"F"),n=Zs(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((i=>{const r=no(...i);return this.Di.getDocuments(t,r).next((i=>this.indexManager.getMinOffset(t,n).next((n=>{const s=this.ki(e,i);return this.Mi(e,s,r,n.readTime)?this.Ci(t,ta(e,null,"F")):this.Oi(t,s,e,n)}))))})))))}xi(t,e,n,i){return Ks(e)||i.isEqual(Yi.min())?this.Ni(t,e):this.Di.getDocuments(t,n).next((r=>{const s=this.ki(e,r);return this.Mi(e,s,n,i)?this.Ni(t,e):(bi()<=a.in.DEBUG&&Ei("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),ia(e)),this.Oi(t,s,e,cr(i,-1)))}))}ki(t,e){let n=new Or(aa(t));return e.forEach(((e,i)=>{ra(t,i)&&(n=n.add(i))})),n}Mi(t,e,n,i){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const r="F"===t.limitType?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(i)>0)}Ni(t,e){return bi()<=a.in.DEBUG&&Ei("QueryEngine","Using full collection scan to execute query:",ia(e)),this.Di.getDocumentsMatchingQuery(t,e,hr.min())}Oi(t,e,n,i){return this.Di.getDocumentsMatchingQuery(t,n,i).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class su{constructor(t,e,n,i){this.persistence=t,this.Fi=e,this.wt=i,this.$i=new Lr(ji),this.Bi=new qa((t=>Ts(t)),Ms),this.Li=new Map,this.Ui=t.getRemoteDocumentCache(),this.Vs=t.getTargetCache(),this.Ds=t.getBundleCache(),this.qi(n)}qi(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Vc(this.Ui,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ui.setIndexManager(this.indexManager),this.Fi.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.$i)))}}function au(t,e,n,i){return new su(t,e,n,i)}async function ou(t,e){const n=Di(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let i;return n.mutationQueue.getAllMutationBatches(t).next((r=>(i=r,n.qi(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const r=[],s=[];let a=no();for(const t of i){r.push(t.batchId);for(const e of t.mutations)a=a.add(e.key)}for(const t of e){s.push(t.batchId);for(const e of t.mutations)a=a.add(e.key)}return n.localDocuments.getDocuments(t,a).next((t=>({Ki:t,removedBatchIds:r,addedBatchIds:s})))}))}))}function lu(t){const e=Di(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Vs.getLastRemoteSnapshotVersion(t)))}function cu(t,e,n){let i=no(),r=no();return n.forEach((t=>i=i.add(t))),e.getEntries(t,i).next((t=>{let i=Xa();return n.forEach(((n,s)=>{const a=t.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(r=r.add(n)),s.isNoDocument()&&s.version.isEqual(Yi.min())?(e.removeEntry(n,s.readTime),i=i.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(e.addEntry(s),i=i.insert(n,s)):Ei("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)})),{Gi:i,Qi:r}}))}function uu(t,e){const n=Di(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function hu(t,e){const n=Di(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let i;return n.Vs.getTargetData(t,e).next((r=>r?(i=r,gr.resolve(i)):n.Vs.allocateTargetId(t).next((r=>(i=new El(e,r,0,t.currentSequenceNumber),n.Vs.addTargetData(t,i).next((()=>i)))))))})).then((t=>{const i=n.$i.get(t.targetId);return(null===i||t.snapshotVersion.compareTo(i.snapshotVersion)>0)&&(n.$i=n.$i.insert(t.targetId,t),n.Bi.set(e,t.targetId)),t}))}async function du(t,e,n){const i=Di(t),r=i.$i.get(e),s=n?"readwrite":"readwrite-primary";try{n||await i.persistence.runTransaction("Release target",s,(t=>i.persistence.referenceDelegate.removeTarget(t,r)))}catch(t){if(!wr(t))throw t;Ei("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}i.$i=i.$i.remove(e),i.Bi.delete(r.target)}function fu(t,e,n){const i=Di(t);let r=Yi.min(),s=no();return i.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const i=Di(t),r=i.Bi.get(n);return void 0!==r?gr.resolve(i.$i.get(r)):i.Vs.getTargetData(e,n)}(i,t,Zs(e)).next((e=>{if(e)return r=e.lastLimboFreeSnapshotVersion,i.Vs.getMatchingKeysForTargetId(t,e.targetId).next((t=>{s=t}))})).next((()=>i.Fi.getDocumentsMatchingQuery(t,e,n?r:Yi.min(),n?s:no()))).next((t=>(gu(i,sa(e),t),{documents:t,ji:s})))))}function pu(t,e){const n=Di(t),i=Di(n.Vs),r=n.$i.get(e);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(t=>i.te(t,e).next((t=>t?t.target:null))))}function mu(t,e){const n=Di(t),i=n.Li.get(e)||Yi.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.Ui.getAllFromCollectionGroup(t,e,cr(i,-1),Number.MAX_SAFE_INTEGER))).then((t=>(gu(n,e,t),t)))}function gu(t,e,n){let i=Yi.min();n.forEach(((t,e)=>{e.readTime.compareTo(i)>0&&(i=e.readTime)})),t.Li.set(e,i)}async function vu(t,e,n=no()){const i=await hu(t,Zs(Pl(e.bundledQuery))),r=Di(t);return r.persistence.runTransaction("Save named query","readwrite",(t=>{const s=wo(e.readTime);if(i.snapshotVersion.compareTo(s)>=0)return r.Ds.saveNamedQuery(t,e);const a=i.withResumeToken(Br.EMPTY_BYTE_STRING,s);return r.$i=r.$i.insert(a.targetId,a),r.Vs.updateTargetData(t,a).next((()=>r.Vs.removeMatchingKeysForTargetId(t,i.targetId))).next((()=>r.Vs.addMatchingKeys(t,n,i.targetId))).next((()=>r.Ds.saveNamedQuery(t,e)))}))}function yu(t,e){return`firestore_clients_${t}_${e}`}function _u(t,e,n){let i=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(i+=`_${e.uid}`),i}function xu(t,e){return`firestore_targets_${t}_${e}`}class wu{constructor(t,e,n,i){this.user=t,this.batchId=e,this.state=n,this.error=i}static Ji(t,e,n){const i=JSON.parse(n);let r,s="object"==typeof i&&-1!==["pending","acknowledged","rejected"].indexOf(i.state)&&(void 0===i.error||"object"==typeof i.error);return s&&i.error&&(s="string"==typeof i.error.message&&"string"==typeof i.error.code,s&&(r=new Pi(i.error.code,i.error.message))),s?new wu(t,e,i.state,r):(Ti("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Yi(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class bu{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Ji(t,e){const n=JSON.parse(e);let i,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(i=new Pi(n.error.code,n.error.message))),r?new bu(t,n.state,i):(Ti("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Yi(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Su{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Ji(t,e){const n=JSON.parse(e);let i="object"==typeof n&&n.activeTargetIds instanceof Array,r=ro();for(let t=0;i&&t<n.activeTargetIds.length;++t)i=Jr(n.activeTargetIds[t]),r=r.add(n.activeTargetIds[t]);return i?new Su(t,r):(Ti("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class Eu{constructor(t,e){this.clientId=t,this.onlineState=e}static Ji(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new Eu(e.clientId,e.onlineState):(Ti("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Tu{constructor(){this.activeTargetIds=ro()}Xi(t){this.activeTargetIds=this.activeTargetIds.add(t)}Zi(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Yi(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Mu{constructor(t,e,n,i,r){this.window=t,this.js=e,this.persistenceKey=n,this.tr=i,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.er=this.nr.bind(this),this.sr=new Lr(ji),this.started=!1,this.ir=[];const s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.rr=yu(this.persistenceKey,this.tr),this.ur=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.sr=this.sr.insert(this.tr,new Tu),this.cr=new RegExp(`^firestore_clients_${s}_([^_]*)$`),this.ar=new RegExp(`^firestore_mutations_${s}_(\\d+)(?:_(.*))?$`),this.hr=new RegExp(`^firestore_targets_${s}_(\\d+)$`),this.lr=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.dr=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.er)}static V(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Ri();for(const e of t){if(e===this.tr)continue;const t=this.getItem(yu(this.persistenceKey,e));if(t){const n=Su.Ji(e,t);n&&(this.sr=this.sr.insert(n.clientId,n))}}this._r();const e=this.storage.getItem(this.lr);if(e){const t=this.wr(e);t&&this.mr(t)}for(const t of this.ir)this.nr(t);this.ir=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.ur,JSON.stringify(t))}getAllActiveQueryTargets(){return this.gr(this.sr)}isActiveQueryTarget(t){let e=!1;return this.sr.forEach(((n,i)=>{i.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.yr(t,"pending")}updateMutationState(t,e,n){this.yr(t,e,n),this.pr(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(xu(this.persistenceKey,t));if(n){const i=bu.Ji(t,n);i&&(e=i.state)}}return this.Ir.Xi(t),this._r(),e}removeLocalQueryTarget(t){this.Ir.Zi(t),this._r()}isLocalQueryTarget(t){return this.Ir.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(xu(this.persistenceKey,t))}updateQueryState(t,e,n){this.Tr(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.pr(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Er(t)}notifyBundleLoaded(t){this.Ar(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.er),this.removeItem(this.rr),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return Ei("SharedClientState","READ",t,e),e}setItem(t,e){Ei("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){Ei("SharedClientState","REMOVE",t),this.storage.removeItem(t)}nr(t){const e=t;if(e.storageArea===this.storage){if(Ei("SharedClientState","EVENT",e.key,e.newValue),e.key===this.rr)return void Ti("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.js.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.cr.test(e.key)){if(null==e.newValue){const t=this.Rr(e.key);return this.br(t,null)}{const t=this.Pr(e.key,e.newValue);if(t)return this.br(t.clientId,t)}}else if(this.ar.test(e.key)){if(null!==e.newValue){const t=this.vr(e.key,e.newValue);if(t)return this.Vr(t)}}else if(this.hr.test(e.key)){if(null!==e.newValue){const t=this.Sr(e.key,e.newValue);if(t)return this.Dr(t)}}else if(e.key===this.lr){if(null!==e.newValue){const t=this.wr(e.newValue);if(t)return this.mr(t)}}else if(e.key===this.ur){const t=function(t){let e=Ir.ot;if(null!=t)try{const n=JSON.parse(t);Ci("number"==typeof n),e=n}catch(t){Ti("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Ir.ot&&this.sequenceNumberHandler(t)}else if(e.key===this.dr){const t=this.Cr(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Nr(t))))}}else this.ir.push(e)}))}}get Ir(){return this.sr.get(this.tr)}_r(){this.setItem(this.rr,this.Ir.Yi())}yr(t,e,n){const i=new wu(this.currentUser,t,e,n),r=_u(this.persistenceKey,this.currentUser,t);this.setItem(r,i.Yi())}pr(t){const e=_u(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Er(t){const e={clientId:this.tr,onlineState:t};this.storage.setItem(this.lr,JSON.stringify(e))}Tr(t,e,n){const i=xu(this.persistenceKey,t),r=new bu(t,e,n);this.setItem(i,r.Yi())}Ar(t){const e=JSON.stringify(Array.from(t));this.setItem(this.dr,e)}Rr(t){const e=this.cr.exec(t);return e?e[1]:null}Pr(t,e){const n=this.Rr(t);return Su.Ji(n,e)}vr(t,e){const n=this.ar.exec(t),i=Number(n[1]),r=void 0!==n[2]?n[2]:null;return wu.Ji(new _i(r),i,e)}Sr(t,e){const n=this.hr.exec(t),i=Number(n[1]);return bu.Ji(i,e)}wr(t){return Eu.Ji(t)}Cr(t){return JSON.parse(t)}async Vr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.kr(t.batchId,t.state,t.error);Ei("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}Dr(t){return this.syncEngine.Mr(t.targetId,t.state,t.error)}br(t,e){const n=e?this.sr.insert(t,e):this.sr.remove(t),i=this.gr(this.sr),r=this.gr(n),s=[],a=[];return r.forEach((t=>{i.has(t)||s.push(t)})),i.forEach((t=>{r.has(t)||a.push(t)})),this.syncEngine.Or(s,a).then((()=>{this.sr=n}))}mr(t){this.sr.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}gr(t){let e=ro();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class Au{constructor(){this.Fr=new Tu,this.$r={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.Fr.Xi(t),this.$r[t]||"not-current"}updateQueryState(t,e,n){this.$r[t]=e}removeLocalQueryTarget(t){this.Fr.Zi(t)}isLocalQueryTarget(t){return this.Fr.activeTargetIds.has(t)}clearQueryState(t){delete this.$r[t]}getAllActiveQueryTargets(){return this.Fr.activeTargetIds}isActiveQueryTarget(t){return this.Fr.activeTargetIds.has(t)}start(){return this.Fr=new Tu,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class Iu{Br(t){}shutdown(){}}class Cu{constructor(){this.Lr=()=>this.Ur(),this.qr=()=>this.Kr(),this.Gr=[],this.Qr()}Br(t){this.Gr.push(t)}shutdown(){window.removeEventListener("online",this.Lr),window.removeEventListener("offline",this.qr)}Qr(){window.addEventListener("online",this.Lr),window.addEventListener("offline",this.qr)}Ur(){Ei("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Gr)t(0)}Kr(){Ei("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Gr)t(1)}static V(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Ru={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Du{constructor(t){this.jr=t.jr,this.Wr=t.Wr}zr(t){this.Hr=t}Jr(t){this.Yr=t}onMessage(t){this.Xr=t}close(){this.Wr()}send(t){this.jr(t)}Zr(){this.Hr()}eo(t){this.Yr(t)}no(t){this.Xr(t)}}class Lu extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.so=e+"://"+t.host,this.io="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}ro(t,e,n,i,r){const s=this.oo(t,e);Ei("RestConnection","Sending: ",s,n);const a={};return this.uo(a,i,r),this.co(t,s,a,n).then((t=>(Ei("RestConnection","Received: ",t),t)),(e=>{throw Mi("RestConnection",`${t} failed with error: `,e,"url: ",s,"request:",n),e}))}ao(t,e,n,i,r,s){return this.ro(t,e,n,i,r)}uo(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+xi,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}oo(t,e){const n=Ru[t];return`${this.so}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}co(t,e,n,i){return new Promise(((r,s)=>{const a=new vi;a.listenOnce(di.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case hi.NO_ERROR:const e=a.getResponseJson();Ei("Connection","XHR received:",JSON.stringify(e)),r(e);break;case hi.TIMEOUT:Ei("Connection",'RPC "'+t+'" timed out'),s(new Pi(Li.DEADLINE_EXCEEDED,"Request time out"));break;case hi.HTTP_ERROR:const n=a.getStatus();if(Ei("Connection",'RPC "'+t+'" failed with status:',n,"response text:",a.getResponseText()),n>0){const t=a.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Li).indexOf(e)>=0?e:Li.UNKNOWN}(t.status);s(new Pi(e,t.message))}else s(new Pi(Li.UNKNOWN,"Server responded with status "+a.getStatus()))}else s(new Pi(Li.UNAVAILABLE,"Connection failed."));break;default:Ii()}}finally{Ei("Connection",'RPC "'+t+'" completed.')}}));const o=JSON.stringify(i);a.send(e,"POST",o,n,15)}))}ho(t,e,n){const i=[this.so,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=ci(),s=ui(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new mi({})),this.uo(a.initMessageHeaders,e,n),(0,o.uI)()||(0,o.b$)()||(0,o.d)()||(0,o.w1)()||(0,o.Mn)()||(0,o.ru)()||(a.httpHeadersOverwriteParam="$httpHeaders");const l=i.join("");Ei("Connection","Creating WebChannel: "+l,a);const c=r.createWebChannel(l,a);let u=!1,h=!1;const d=new Du({jr:t=>{h?Ei("Connection","Not sending because WebChannel is closed:",t):(u||(Ei("Connection","Opening WebChannel transport."),c.open(),u=!0),Ei("Connection","WebChannel sending:",t),c.send(t))},Wr:()=>c.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(c,gi.EventType.OPEN,(()=>{h||Ei("Connection","WebChannel transport opened.")})),f(c,gi.EventType.CLOSE,(()=>{h||(h=!0,Ei("Connection","WebChannel transport closed"),d.eo())})),f(c,gi.EventType.ERROR,(t=>{h||(h=!0,Mi("Connection","WebChannel transport errored:",t),d.eo(new Pi(Li.UNAVAILABLE,"The operation could not be completed")))})),f(c,gi.EventType.MESSAGE,(t=>{var e;if(!h){const n=t.data[0];Ci(!!n);const i=n,r=i.error||(null===(e=i[0])||void 0===e?void 0:e.error);if(r){Ei("Connection","WebChannel received error:",r);const t=r.status;let e=function(t){const e=za[t];if(void 0!==e)return Wa(e)}(t),n=r.message;void 0===e&&(e=Li.INTERNAL,n="Unknown error status: "+t+" with message "+r.message),h=!0,d.eo(new Pi(e,n)),c.close()}else Ei("Connection","WebChannel received:",n),d.no(n)}})),f(s,fi.STAT_EVENT,(t=>{t.stat===pi.PROXY?Ei("Connection","Detected buffering proxy"):t.stat===pi.NOPROXY&&Ei("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.Zr()}),0),d}}function Pu(){return"undefined"!=typeof window?window:null}function Nu(){return"undefined"!=typeof document?document:null}function Ou(t){return new vo(t,!0)}class Fu{constructor(t,e,n=1e3,i=1.5,r=6e4){this.js=t,this.timerId=e,this.lo=n,this.fo=i,this._o=r,this.wo=0,this.mo=null,this.yo=Date.now(),this.reset()}reset(){this.wo=0}po(){this.wo=this._o}Io(t){this.cancel();const e=Math.floor(this.wo+this.To()),n=Math.max(0,Date.now()-this.yo),i=Math.max(0,e-n);i>0&&Ei("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.wo} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.mo=this.js.enqueueAfterDelay(this.timerId,i,(()=>(this.yo=Date.now(),t()))),this.wo*=this.fo,this.wo<this.lo&&(this.wo=this.lo),this.wo>this._o&&(this.wo=this._o)}Eo(){null!==this.mo&&(this.mo.skipDelay(),this.mo=null)}cancel(){null!==this.mo&&(this.mo.cancel(),this.mo=null)}To(){return(Math.random()-.5)*this.wo}}class Uu{constructor(t,e,n,i,r,s,a,o){this.js=t,this.Ao=n,this.Ro=i,this.bo=r,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Po=0,this.vo=null,this.Vo=null,this.stream=null,this.So=new Fu(t,e)}Do(){return 1===this.state||5===this.state||this.Co()}Co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.xo()}async stop(){this.Do()&&await this.close(0)}No(){this.state=0,this.So.reset()}ko(){this.Co()&&null===this.vo&&(this.vo=this.js.enqueueAfterDelay(this.Ao,6e4,(()=>this.Mo())))}Oo(t){this.Fo(),this.stream.send(t)}async Mo(){if(this.Co())return this.close(0)}Fo(){this.vo&&(this.vo.cancel(),this.vo=null)}$o(){this.Vo&&(this.Vo.cancel(),this.Vo=null)}async close(t,e){this.Fo(),this.$o(),this.So.cancel(),this.Po++,4!==t?this.So.reset():e&&e.code===Li.RESOURCE_EXHAUSTED?(Ti(e.toString()),Ti("Using maximum backoff delay to prevent overloading the backend."),this.So.po()):e&&e.code===Li.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Bo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Jr(e)}Bo(){}auth(){this.state=1;const t=this.Lo(this.Po),e=this.Po;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Po===e&&this.Uo(t,n)}),(e=>{t((()=>{const t=new Pi(Li.UNKNOWN,"Fetching auth token failed: "+e.message);return this.qo(t)}))}))}Uo(t,e){const n=this.Lo(this.Po);this.stream=this.Ko(t,e),this.stream.zr((()=>{n((()=>(this.state=2,this.Vo=this.js.enqueueAfterDelay(this.Ro,1e4,(()=>(this.Co()&&(this.state=3),Promise.resolve()))),this.listener.zr())))})),this.stream.Jr((t=>{n((()=>this.qo(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}xo(){this.state=5,this.So.Io((async()=>{this.state=0,this.start()}))}qo(t){return Ei("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Lo(t){return e=>{this.js.enqueueAndForget((()=>this.Po===t?e():(Ei("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Vu extends Uu{constructor(t,e,n,i,r,s){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,i,s),this.wt=r}Ko(t,e){return this.bo.ho("Listen",t,e)}onMessage(t){this.So.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const i=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Ii()}(e.targetChange.targetChangeType||"NO_CHANGE"),r=e.targetChange.targetIds||[],s=function(t,e){return t.dt?(Ci(void 0===e||"string"==typeof e),Br.fromBase64String(e||"")):(Ci(void 0===e||e instanceof Uint8Array),Br.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),a=e.targetChange.cause,o=a&&function(t){const e=void 0===t.code?Li.UNKNOWN:Wa(t.code);return new Pi(e,t.message||"")}(a);n=new co(i,r,s,o||null)}else if("documentChange"in e){e.documentChange;const i=e.documentChange;i.document,i.document.name,i.document.updateTime;const r=To(t,i.document.name),s=wo(i.document.updateTime),a=new xs({mapValue:{fields:i.document.fields}}),o=bs.newFoundDocument(r,s,a),l=i.targetIds||[],c=i.removedTargetIds||[];n=new oo(l,c,o.key,o)}else if("documentDelete"in e){e.documentDelete;const i=e.documentDelete;i.document;const r=To(t,i.document),s=i.readTime?wo(i.readTime):Yi.min(),a=bs.newNoDocument(r,s),o=i.removedTargetIds||[];n=new oo([],o,a.key,a)}else if("documentRemove"in e){e.documentRemove;const i=e.documentRemove;i.document;const r=To(t,i.document),s=i.removedTargetIds||[];n=new oo([],s,r,null)}else{if(!("filter"in e))return Ii();{e.filter;const t=e.filter;t.targetId;const i=t.count||0,r=new Ba(i),s=t.targetId;n=new lo(s,r)}}return n}(this.wt,t),n=function(t){if(!("targetChange"in t))return Yi.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?Yi.min():e.readTime?wo(e.readTime):Yi.min()}(t);return this.listener.Go(e,n)}Qo(t){const e={};e.database=Io(this.wt),e.addTarget=function(t,e){let n;const i=e.target;return n=As(i)?{documents:No(t,i)}:{query:Oo(t,i)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=_o(t,e.resumeToken):e.snapshotVersion.compareTo(Yi.min())>0&&(n.readTime=yo(t,e.snapshotVersion.toTimestamp())),n}(this.wt,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Ii()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.wt,t);n&&(e.labels=n),this.Oo(e)}jo(t){const e={};e.database=Io(this.wt),e.removeTarget=t,this.Oo(e)}}class ku extends Uu{constructor(t,e,n,i,r,s){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,i,s),this.wt=r,this.Wo=!1}get zo(){return this.Wo}start(){this.Wo=!1,this.lastStreamToken=void 0,super.start()}Bo(){this.Wo&&this.Ho([])}Ko(t,e){return this.bo.ho("Write",t,e)}onMessage(t){if(Ci(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Wo){this.So.reset();const e=function(t,e){return t&&t.length>0?(Ci(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?wo(t.updateTime):wo(e);return n.isEqual(Yi.min())&&(n=wo(e)),new Ea(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=wo(t.commitTime);return this.listener.Jo(n,e)}return Ci(!t.writeResults||0===t.writeResults.length),this.Wo=!0,this.listener.Yo()}Xo(){const t={};t.database=Io(this.wt),this.Oo(t)}Ho(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Lo(this.wt,t)))};this.Oo(e)}}class Bu extends class{}{constructor(t,e,n,i){super(),this.authCredentials=t,this.appCheckCredentials=e,this.bo=n,this.wt=i,this.Zo=!1}tu(){if(this.Zo)throw new Pi(Li.FAILED_PRECONDITION,"The client has already been terminated.")}ro(t,e,n){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,r])=>this.bo.ro(t,e,n,i,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Li.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Pi(Li.UNKNOWN,t.toString())}))}ao(t,e,n,i){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.bo.ao(t,e,n,r,s,i))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Li.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Pi(Li.UNKNOWN,t.toString())}))}terminate(){this.Zo=!0}}class zu{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.eu=0,this.nu=null,this.su=!0}iu(){0===this.eu&&(this.ru("Unknown"),this.nu=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.nu=null,this.ou("Backend didn't respond within 10 seconds."),this.ru("Offline"),Promise.resolve()))))}uu(t){"Online"===this.state?this.ru("Unknown"):(this.eu++,this.eu>=1&&(this.cu(),this.ou(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ru("Offline")))}set(t){this.cu(),this.eu=0,"Online"===t&&(this.su=!1),this.ru(t)}ru(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ou(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.su?(Ti(e),this.su=!1):Ei("OnlineStateTracker",e)}cu(){null!==this.nu&&(this.nu.cancel(),this.nu=null)}}class Gu{constructor(t,e,n,i,r){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.au=[],this.hu=new Map,this.lu=new Set,this.fu=[],this.du=r,this.du.Br((t=>{n.enqueueAndForget((async()=>{Qu(this)&&(Ei("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=Di(t);e.lu.add(4),await Wu(e),e._u.set("Unknown"),e.lu.delete(4),await Hu(e)}(this))}))})),this._u=new zu(n,i)}}async function Hu(t){if(Qu(t))for(const e of t.fu)await e(!0)}async function Wu(t){for(const e of t.fu)await e(!1)}function qu(t,e){const n=Di(t);n.hu.has(e.targetId)||(n.hu.set(e.targetId,e),Yu(n)?$u(n):mh(n).Co()&&Xu(n,e))}function ju(t,e){const n=Di(t),i=mh(n);n.hu.delete(e),i.Co()&&Ku(n,e),0===n.hu.size&&(i.Co()?i.ko():Qu(n)&&n._u.set("Unknown"))}function Xu(t,e){t.wu.Nt(e.targetId),mh(t).Qo(e)}function Ku(t,e){t.wu.Nt(e),mh(t).jo(e)}function $u(t){t.wu=new ho({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),te:e=>t.hu.get(e)||null}),mh(t).start(),t._u.iu()}function Yu(t){return Qu(t)&&!mh(t).Do()&&t.hu.size>0}function Qu(t){return 0===Di(t).lu.size}function Ju(t){t.wu=void 0}async function Zu(t){t.hu.forEach(((e,n)=>{Xu(t,e)}))}async function th(t,e){Ju(t),Yu(t)?(t._u.uu(e),$u(t)):t._u.set("Unknown")}async function eh(t,e,n){if(t._u.set("Online"),e instanceof co&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const i of e.targetIds)t.hu.has(i)&&(await t.remoteSyncer.rejectListen(i,n),t.hu.delete(i),t.wu.removeTarget(i))}(t,e)}catch(n){Ei("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await nh(t,n)}else if(e instanceof oo?t.wu.Ut(e):e instanceof lo?t.wu.zt(e):t.wu.Gt(e),!n.isEqual(Yi.min()))try{const e=await lu(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.wu.Yt(e);return n.targetChanges.forEach(((n,i)=>{if(n.resumeToken.approximateByteSize()>0){const r=t.hu.get(i);r&&t.hu.set(i,r.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.hu.get(e);if(!n)return;t.hu.set(e,n.withResumeToken(Br.EMPTY_BYTE_STRING,n.snapshotVersion)),Ku(t,e);const i=new El(n.target,e,1,n.sequenceNumber);Xu(t,i)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){Ei("RemoteStore","Failed to raise snapshot:",e),await nh(t,e)}}async function nh(t,e,n){if(!wr(e))throw e;t.lu.add(1),await Wu(t),t._u.set("Offline"),n||(n=()=>lu(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{Ei("RemoteStore","Retrying IndexedDB access"),await n(),t.lu.delete(1),await Hu(t)}))}function ih(t,e){return e().catch((n=>nh(t,n,e)))}async function rh(t){const e=Di(t),n=gh(e);let i=e.au.length>0?e.au[e.au.length-1].batchId:-1;for(;sh(e);)try{const t=await uu(e.localStore,i);if(null===t){0===e.au.length&&n.ko();break}i=t.batchId,ah(e,t)}catch(t){await nh(e,t)}oh(e)&&lh(e)}function sh(t){return Qu(t)&&t.au.length<10}function ah(t,e){t.au.push(e);const n=gh(t);n.Co()&&n.zo&&n.Ho(e.mutations)}function oh(t){return Qu(t)&&!gh(t).Do()&&t.au.length>0}function lh(t){gh(t).start()}async function ch(t){gh(t).Xo()}async function uh(t){const e=gh(t);for(const n of t.au)e.Ho(n.mutations)}async function hh(t,e,n){const i=t.au.shift(),r=bl.from(i,e,n);await ih(t,(()=>t.remoteSyncer.applySuccessfulWrite(r))),await rh(t)}async function dh(t,e){e&&gh(t).zo&&await async function(t,e){if(Ha(n=e.code)&&n!==Li.ABORTED){const n=t.au.shift();gh(t).No(),await ih(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await rh(t)}var n}(t,e),oh(t)&&lh(t)}async function fh(t,e){const n=Di(t);n.asyncQueue.verifyOperationInProgress(),Ei("RemoteStore","RemoteStore received new credentials");const i=Qu(n);n.lu.add(3),await Wu(n),i&&n._u.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.lu.delete(3),await Hu(n)}async function ph(t,e){const n=Di(t);e?(n.lu.delete(2),await Hu(n)):e||(n.lu.add(2),await Wu(n),n._u.set("Unknown"))}function mh(t){return t.mu||(t.mu=function(t,e,n){const i=Di(t);return i.tu(),new Vu(e,i.bo,i.authCredentials,i.appCheckCredentials,i.wt,n)}(t.datastore,t.asyncQueue,{zr:Zu.bind(null,t),Jr:th.bind(null,t),Go:eh.bind(null,t)}),t.fu.push((async e=>{e?(t.mu.No(),Yu(t)?$u(t):t._u.set("Unknown")):(await t.mu.stop(),Ju(t))}))),t.mu}function gh(t){return t.gu||(t.gu=function(t,e,n){const i=Di(t);return i.tu(),new ku(e,i.bo,i.authCredentials,i.appCheckCredentials,i.wt,n)}(t.datastore,t.asyncQueue,{zr:ch.bind(null,t),Jr:dh.bind(null,t),Yo:uh.bind(null,t),Jo:hh.bind(null,t)}),t.fu.push((async e=>{e?(t.gu.No(),await rh(t)):(await t.gu.stop(),t.au.length>0&&(Ei("RemoteStore",`Stopping write stream with ${t.au.length} pending writes`),t.au=[]))}))),t.gu}class vh{constructor(t,e,n,i,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=i,this.removalCallback=r,this.deferred=new Ni,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,i,r){const s=Date.now()+n,a=new vh(t,e,s,i,r);return a.start(n),a}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Pi(Li.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function yh(t,e){if(Ti("AsyncQueue",`${e}: ${t}`),wr(t))return new Pi(Li.UNAVAILABLE,`${e}: ${t}`);throw t}class _h{constructor(t){this.comparator=t?(e,n)=>t(e,n)||er.comparator(e.key,n.key):(t,e)=>er.comparator(t.key,e.key),this.keyedMap=$a(),this.sortedSet=new Lr(this.comparator)}static emptySet(t){return new _h(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof _h))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,i=n.getNext().key;if(!t.isEqual(i))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new _h;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class xh{constructor(){this.yu=new Lr(er.comparator)}track(t){const e=t.doc.key,n=this.yu.get(e);n?0!==t.type&&3===n.type?this.yu=this.yu.insert(e,t):3===t.type&&1!==n.type?this.yu=this.yu.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.yu=this.yu.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.yu=this.yu.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.yu=this.yu.remove(e):1===t.type&&2===n.type?this.yu=this.yu.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.yu=this.yu.insert(e,{type:2,doc:t.doc}):Ii():this.yu=this.yu.insert(e,t)}pu(){const t=[];return this.yu.inorderTraversal(((e,n)=>{t.push(n)})),t}}class wh{constructor(t,e,n,i,r,s,a,o){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=i,this.mutatedKeys=r,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o}static fromInitialDocuments(t,e,n,i){const r=[];return e.forEach((t=>{r.push({type:0,doc:t})})),new wh(t,e,_h.emptySet(e),r,n,i,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&ea(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class bh{constructor(){this.Iu=void 0,this.listeners=[]}}class Sh{constructor(){this.queries=new qa((t=>na(t)),ea),this.onlineState="Unknown",this.Tu=new Set}}async function Eh(t,e){const n=Di(t),i=e.query;let r=!1,s=n.queries.get(i);if(s||(r=!0,s=new bh),r)try{s.Iu=await n.onListen(i)}catch(t){const n=yh(t,`Initialization of query '${ia(e.query)}' failed`);return void e.onError(n)}n.queries.set(i,s),s.listeners.push(e),e.Eu(n.onlineState),s.Iu&&e.Au(s.Iu)&&Ih(n)}async function Th(t,e){const n=Di(t),i=e.query;let r=!1;const s=n.queries.get(i);if(s){const t=s.listeners.indexOf(e);t>=0&&(s.listeners.splice(t,1),r=0===s.listeners.length)}if(r)return n.queries.delete(i),n.onUnlisten(i)}function Mh(t,e){const n=Di(t);let i=!1;for(const t of e){const e=t.query,r=n.queries.get(e);if(r){for(const e of r.listeners)e.Au(t)&&(i=!0);r.Iu=t}}i&&Ih(n)}function Ah(t,e,n){const i=Di(t),r=i.queries.get(e);if(r)for(const t of r.listeners)t.onError(n);i.queries.delete(e)}function Ih(t){t.Tu.forEach((t=>{t.next()}))}class Ch{constructor(t,e,n){this.query=t,this.Ru=e,this.bu=!1,this.Pu=null,this.onlineState="Unknown",this.options=n||{}}Au(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new wh(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.bu?this.vu(t)&&(this.Ru.next(t),e=!0):this.Vu(t,this.onlineState)&&(this.Su(t),e=!0),this.Pu=t,e}onError(t){this.Ru.error(t)}Eu(t){this.onlineState=t;let e=!1;return this.Pu&&!this.bu&&this.Vu(this.Pu,t)&&(this.Su(this.Pu),e=!0),e}Vu(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return!(this.options.Du&&n||t.docs.isEmpty()&&"Offline"!==e)}vu(t){if(t.docChanges.length>0)return!0;const e=this.Pu&&this.Pu.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Su(t){t=wh.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.bu=!0,this.Ru.next(t)}}class Rh{constructor(t,e){this.payload=t,this.byteLength=e}Cu(){return"metadata"in this.payload}}class Dh{constructor(t){this.wt=t}Wi(t){return To(this.wt,t)}zi(t){return t.metadata.exists?Do(this.wt,t.document,!1):bs.newNoDocument(this.Wi(t.metadata.name),this.Hi(t.metadata.readTime))}Hi(t){return wo(t)}}class Lh{constructor(t,e,n){this.xu=t,this.localStore=e,this.wt=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ph(t)}Nu(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.payload.namedQuery)this.queries.push(t.payload.namedQuery);else if(t.payload.documentMetadata){this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e;const n=Ji.fromString(t.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}ku(t){const e=new Map,n=new Dh(this.wt);for(const i of t)if(i.metadata.queries){const t=n.Wi(i.metadata.name);for(const n of i.metadata.queries){const i=(e.get(n)||no()).add(t);e.set(n,i)}}return e}async complete(){const t=await async function(t,e,n,i){const r=Di(t);let s=no(),a=Xa();for(const t of n){const n=e.Wi(t.metadata.name);t.document&&(s=s.add(n));const i=e.zi(t);i.setReadTime(e.Hi(t.metadata.readTime)),a=a.insert(n,i)}const o=r.Ui.newChangeBuffer({trackRemovals:!0}),l=await hu(r,function(t){return Zs(Xs(Ji.fromString(`__bundle__/docs/${t}`)))}(i));return r.persistence.runTransaction("Apply bundle documents","readwrite",(t=>cu(t,o,a).next((e=>(o.apply(t),e))).next((e=>r.Vs.removeMatchingKeysForTargetId(t,l.targetId).next((()=>r.Vs.addMatchingKeys(t,s,l.targetId))).next((()=>r.localDocuments.getLocalViewOfDocuments(t,e.Gi,e.Qi))).next((()=>e.Gi))))))}(this.localStore,new Dh(this.wt),this.documents,this.xu.id),e=this.ku(this.documents);for(const t of this.queries)await vu(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Mu:this.collectionGroups,Ou:t}}}function Ph(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Nh{constructor(t){this.key=t}}class Oh{constructor(t){this.key=t}}class Fh{constructor(t,e){this.query=t,this.Fu=e,this.$u=null,this.current=!1,this.Bu=no(),this.mutatedKeys=no(),this.Lu=aa(t),this.Uu=new _h(this.Lu)}get qu(){return this.Fu}Ku(t,e){const n=e?e.Gu:new xh,i=e?e.Uu:this.Uu;let r=e?e.mutatedKeys:this.mutatedKeys,s=i,a=!1;const o="F"===this.query.limitType&&i.size===this.query.limit?i.last():null,l="L"===this.query.limitType&&i.size===this.query.limit?i.first():null;if(t.inorderTraversal(((t,e)=>{const c=i.get(t),u=ra(this.query,e)?e:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!u&&(u.hasLocalMutations||this.mutatedKeys.has(u.key)&&u.hasCommittedMutations);let f=!1;c&&u?c.data.isEqual(u.data)?h!==d&&(n.track({type:3,doc:u}),f=!0):this.Qu(c,u)||(n.track({type:2,doc:u}),f=!0,(o&&this.Lu(u,o)>0||l&&this.Lu(u,l)<0)&&(a=!0)):!c&&u?(n.track({type:0,doc:u}),f=!0):c&&!u&&(n.track({type:1,doc:c}),f=!0,(o||l)&&(a=!0)),f&&(u?(s=s.add(u),r=d?r.add(t):r.delete(t)):(s=s.delete(t),r=r.delete(t)))})),null!==this.query.limit)for(;s.size>this.query.limit;){const t="F"===this.query.limitType?s.last():s.first();s=s.delete(t.key),r=r.delete(t.key),n.track({type:1,doc:t})}return{Uu:s,Gu:n,Mi:a,mutatedKeys:r}}Qu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const i=this.Uu;this.Uu=t.Uu,this.mutatedKeys=t.mutatedKeys;const r=t.Gu.pu();r.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Ii()}};return n(t)-n(e)}(t.type,e.type)||this.Lu(t.doc,e.doc))),this.ju(n);const s=e?this.Wu():[],a=0===this.Bu.size&&this.current?1:0,o=a!==this.$u;return this.$u=a,0!==r.length||o?{snapshot:new wh(this.query,t.Uu,i,r,t.mutatedKeys,0===a,o,!1),zu:s}:{zu:s}}Eu(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Uu:this.Uu,Gu:new xh,mutatedKeys:this.mutatedKeys,Mi:!1},!1)):{zu:[]}}Hu(t){return!this.Fu.has(t)&&!!this.Uu.has(t)&&!this.Uu.get(t).hasLocalMutations}ju(t){t&&(t.addedDocuments.forEach((t=>this.Fu=this.Fu.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.Fu=this.Fu.delete(t))),this.current=t.current)}Wu(){if(!this.current)return[];const t=this.Bu;this.Bu=no(),this.Uu.forEach((t=>{this.Hu(t.key)&&(this.Bu=this.Bu.add(t.key))}));const e=[];return t.forEach((t=>{this.Bu.has(t)||e.push(new Oh(t))})),this.Bu.forEach((n=>{t.has(n)||e.push(new Nh(n))})),e}Ju(t){this.Fu=t.ji,this.Bu=no();const e=this.Ku(t.documents);return this.applyChanges(e,!0)}Yu(){return wh.fromInitialDocuments(this.query,this.Uu,this.mutatedKeys,0===this.$u)}}class Uh{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Vh{constructor(t){this.key=t,this.Xu=!1}}class kh{constructor(t,e,n,i,r,s){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=i,this.currentUser=r,this.maxConcurrentLimboResolutions=s,this.Zu={},this.tc=new qa((t=>na(t)),ea),this.ec=new Map,this.nc=new Set,this.sc=new Lr(er.comparator),this.ic=new Map,this.rc=new zc,this.oc={},this.uc=new Map,this.cc=vc.Rn(),this.onlineState="Unknown",this.ac=void 0}get isPrimaryClient(){return!0===this.ac}}async function Bh(t,e){const n=dd(t);let i,r;const s=n.tc.get(e);if(s)i=s.targetId,n.sharedClientState.addLocalQueryTarget(i),r=s.view.Yu();else{const t=await hu(n.localStore,Zs(e));n.isPrimaryClient&&qu(n.remoteStore,t);const s=n.sharedClientState.addLocalQueryTarget(t.targetId);i=t.targetId,r=await zh(n,e,i,"current"===s)}return r}async function zh(t,e,n,i){t.hc=(e,n,i)=>async function(t,e,n,i){let r=e.view.Ku(n);r.Mi&&(r=await fu(t.localStore,e.query,!1).then((({documents:t})=>e.view.Ku(t,r))));const s=i&&i.targetChanges.get(e.targetId),a=e.view.applyChanges(r,t.isPrimaryClient,s);return Jh(t,e.targetId,a.zu),a.snapshot}(t,e,n,i);const r=await fu(t.localStore,e,!0),s=new Fh(e,r.ji),a=s.Ku(r.documents),o=ao.createSynthesizedTargetChangeForCurrentChange(n,i&&"Offline"!==t.onlineState),l=s.applyChanges(a,t.isPrimaryClient,o);Jh(t,n,l.zu);const c=new Uh(e,n,s);return t.tc.set(e,c),t.ec.has(n)?t.ec.get(n).push(e):t.ec.set(n,[e]),l.snapshot}async function Gh(t,e){const n=Di(t),i=n.tc.get(e),r=n.ec.get(i.targetId);if(r.length>1)return n.ec.set(i.targetId,r.filter((t=>!ea(t,e)))),void n.tc.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(i.targetId),n.sharedClientState.isActiveQueryTarget(i.targetId)||await du(n.localStore,i.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(i.targetId),ju(n.remoteStore,i.targetId),Yh(n,i.targetId)})).catch(mr)):(Yh(n,i.targetId),await du(n.localStore,i.targetId,!0))}async function Hh(t,e){const n=Di(t);try{const t=await function(t,e){const n=Di(t),i=e.snapshotVersion;let r=n.$i;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const s=n.Ui.newChangeBuffer({trackRemovals:!0});r=n.$i;const a=[];e.targetChanges.forEach(((s,o)=>{const l=r.get(o);if(!l)return;a.push(n.Vs.removeMatchingKeys(t,s.removedDocuments,o).next((()=>n.Vs.addMatchingKeys(t,s.addedDocuments,o))));let c=l.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(o)?c=c.withResumeToken(Br.EMPTY_BYTE_STRING,Yi.min()).withLastLimboFreeSnapshotVersion(Yi.min()):s.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(s.resumeToken,i)),r=r.insert(o,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(l,c,s)&&a.push(n.Vs.updateTargetData(t,c))}));let o=Xa(),l=no();if(e.documentUpdates.forEach((i=>{e.resolvedLimboDocuments.has(i)&&a.push(n.persistence.referenceDelegate.updateLimboDocument(t,i))})),a.push(cu(t,s,e.documentUpdates).next((t=>{o=t.Gi,l=t.Qi}))),!i.isEqual(Yi.min())){const e=n.Vs.getLastRemoteSnapshotVersion(t).next((e=>n.Vs.setTargetsMetadata(t,t.currentSequenceNumber,i)));a.push(e)}return gr.waitFor(a).next((()=>s.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,o,l))).next((()=>o))})).then((t=>(n.$i=r,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const i=n.ic.get(e);i&&(Ci(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?i.Xu=!0:t.modifiedDocuments.size>0?Ci(i.Xu):t.removedDocuments.size>0&&(Ci(i.Xu),i.Xu=!1))})),await ed(n,t,e)}catch(t){await mr(t)}}function Wh(t,e,n){const i=Di(t);if(i.isPrimaryClient&&0===n||!i.isPrimaryClient&&1===n){const t=[];i.tc.forEach(((n,i)=>{const r=i.view.Eu(e);r.snapshot&&t.push(r.snapshot)})),function(t,e){const n=Di(t);n.onlineState=e;let i=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.Eu(e)&&(i=!0)})),i&&Ih(n)}(i.eventManager,e),t.length&&i.Zu.Go(t),i.onlineState=e,i.isPrimaryClient&&i.sharedClientState.setOnlineState(e)}}async function qh(t,e,n){const i=Di(t);i.sharedClientState.updateQueryState(e,"rejected",n);const r=i.ic.get(e),s=r&&r.key;if(s){let t=new Lr(er.comparator);t=t.insert(s,bs.newNoDocument(s,Yi.min()));const n=no().add(s),r=new so(Yi.min(),new Map,new Or(ji),t,n);await Hh(i,r),i.sc=i.sc.remove(s),i.ic.delete(e),td(i)}else await du(i.localStore,e,!1).then((()=>Yh(i,e,n))).catch(mr)}async function jh(t,e){const n=Di(t),i=e.batch.batchId;try{const t=await function(t,e){const n=Di(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const i=e.batch.keys(),r=n.Ui.newChangeBuffer({trackRemovals:!0});return function(t,e,n,i){const r=n.batch,s=r.keys();let a=gr.resolve();return s.forEach((t=>{a=a.next((()=>i.getEntry(e,t))).next((e=>{const s=n.docVersions.get(t);Ci(null!==s),e.version.compareTo(s)<0&&(r.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),i.addEntry(e)))}))})),a.next((()=>t.mutationQueue.removeMutationBatch(e,r)))}(n,t,e,r).next((()=>r.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,i,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=no();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,i)))}))}(n.localStore,e);$h(n,i,null),Kh(n,i),n.sharedClientState.updateMutationState(i,"acknowledged"),await ed(n,t)}catch(t){await mr(t)}}async function Xh(t,e,n){const i=Di(t);try{const t=await function(t,e){const n=Di(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let i;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(Ci(null!==e),i=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,i,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,i))).next((()=>n.localDocuments.getDocuments(t,i)))}))}(i.localStore,e);$h(i,e,n),Kh(i,e),i.sharedClientState.updateMutationState(e,"rejected",n),await ed(i,t)}catch(n){await mr(n)}}function Kh(t,e){(t.uc.get(e)||[]).forEach((t=>{t.resolve()})),t.uc.delete(e)}function $h(t,e,n){const i=Di(t);let r=i.oc[i.currentUser.toKey()];if(r){const t=r.get(e);t&&(n?t.reject(n):t.resolve(),r=r.remove(e)),i.oc[i.currentUser.toKey()]=r}}function Yh(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const i of t.ec.get(e))t.tc.delete(i),n&&t.Zu.lc(i,n);t.ec.delete(e),t.isPrimaryClient&&t.rc.us(e).forEach((e=>{t.rc.containsKey(e)||Qh(t,e)}))}function Qh(t,e){t.nc.delete(e.path.canonicalString());const n=t.sc.get(e);null!==n&&(ju(t.remoteStore,n),t.sc=t.sc.remove(e),t.ic.delete(n),td(t))}function Jh(t,e,n){for(const i of n)i instanceof Nh?(t.rc.addReference(i.key,e),Zh(t,i)):i instanceof Oh?(Ei("SyncEngine","Document no longer in limbo: "+i.key),t.rc.removeReference(i.key,e),t.rc.containsKey(i.key)||Qh(t,i.key)):Ii()}function Zh(t,e){const n=e.key,i=n.path.canonicalString();t.sc.get(n)||t.nc.has(i)||(Ei("SyncEngine","New document in limbo: "+n),t.nc.add(i),td(t))}function td(t){for(;t.nc.size>0&&t.sc.size<t.maxConcurrentLimboResolutions;){const e=t.nc.values().next().value;t.nc.delete(e);const n=new er(Ji.fromString(e)),i=t.cc.next();t.ic.set(i,new Vh(n)),t.sc=t.sc.insert(n,i),qu(t.remoteStore,new El(Zs(Xs(n.path)),i,2,Ir.ot))}}async function ed(t,e,n){const i=Di(t),r=[],s=[],a=[];i.tc.isEmpty()||(i.tc.forEach(((t,o)=>{a.push(i.hc(o,e,n).then((t=>{if(t){i.isPrimaryClient&&i.sharedClientState.updateQueryState(o.targetId,t.fromCache?"not-current":"current"),r.push(t);const e=iu.Vi(o.targetId,t);s.push(e)}})))})),await Promise.all(a),i.Zu.Go(r),await async function(t,e){const n=Di(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>gr.forEach(e,(e=>gr.forEach(e.Pi,(i=>n.persistence.referenceDelegate.addReference(t,e.targetId,i))).next((()=>gr.forEach(e.vi,(i=>n.persistence.referenceDelegate.removeReference(t,e.targetId,i)))))))))}catch(t){if(!wr(t))throw t;Ei("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.$i.get(e),i=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(i);n.$i=n.$i.insert(e,r)}}}(i.localStore,s))}async function nd(t,e){const n=Di(t);if(!n.currentUser.isEqual(e)){Ei("SyncEngine","User change. New user:",e.toKey());const t=await ou(n.localStore,e);n.currentUser=e,function(t,e){t.uc.forEach((t=>{t.forEach((t=>{t.reject(new Pi(Li.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.uc.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await ed(n,t.Ki)}}function id(t,e){const n=Di(t),i=n.ic.get(e);if(i&&i.Xu)return no().add(i.key);{let t=no();const i=n.ec.get(e);if(!i)return t;for(const e of i){const i=n.tc.get(e);t=t.unionWith(i.view.qu)}return t}}async function rd(t,e){const n=Di(t),i=await fu(n.localStore,e.query,!0),r=e.view.Ju(i);return n.isPrimaryClient&&Jh(n,e.targetId,r.zu),r}async function sd(t,e){const n=Di(t);return mu(n.localStore,e).then((t=>ed(n,t)))}async function ad(t,e,n,i){const r=Di(t),s=await function(t,e){const n=Di(t),i=Di(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>i.yn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):gr.resolve(null)))))}(r.localStore,e);null!==s?("pending"===n?await rh(r.remoteStore):"acknowledged"===n||"rejected"===n?($h(r,e,i||null),Kh(r,e),function(t,e){Di(Di(t).mutationQueue).In(e)}(r.localStore,e)):Ii(),await ed(r,s)):Ei("SyncEngine","Cannot apply mutation batch with id: "+e)}async function od(t,e,n){const i=Di(t),r=[],s=[];for(const t of e){let e;const n=i.ec.get(t);if(n&&0!==n.length){e=await hu(i.localStore,Zs(n[0]));for(const t of n){const e=i.tc.get(t),n=await rd(i,e);n.snapshot&&s.push(n.snapshot)}}else{const n=await pu(i.localStore,t);e=await hu(i.localStore,n),await zh(i,ld(n),t,!1)}r.push(e)}return i.Zu.Go(s),r}function ld(t){return js(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function cd(t){const e=Di(t);return Di(Di(e.localStore).persistence).Ri()}async function ud(t,e,n,i){const r=Di(t);if(r.ac)return void Ei("SyncEngine","Ignoring unexpected query state notification.");const s=r.ec.get(e);if(s&&s.length>0)switch(n){case"current":case"not-current":{const t=await mu(r.localStore,sa(s[0])),i=so.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await ed(r,t,i);break}case"rejected":await du(r.localStore,e,!0),Yh(r,e,i);break;default:Ii()}}async function hd(t,e,n){const i=dd(t);if(i.ac){for(const t of e){if(i.ec.has(t)){Ei("SyncEngine","Adding an already active target "+t);continue}const e=await pu(i.localStore,t),n=await hu(i.localStore,e);await zh(i,ld(e),n.targetId,!1),qu(i.remoteStore,n)}for(const t of n)i.ec.has(t)&&await du(i.localStore,t,!1).then((()=>{ju(i.remoteStore,t),Yh(i,t)})).catch(mr)}}function dd(t){const e=Di(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Hh.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=id.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=qh.bind(null,e),e.Zu.Go=Mh.bind(null,e.eventManager),e.Zu.lc=Ah.bind(null,e.eventManager),e}function fd(t){const e=Di(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=jh.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Xh.bind(null,e),e}class pd{constructor(){this.synchronizeTabs=!1}async initialize(t){this.wt=Ou(t.databaseInfo.databaseId),this.sharedClientState=this.dc(t),this.persistence=this._c(t),await this.persistence.start(),this.localStore=this.wc(t),this.gcScheduler=this.mc(t,this.localStore),this.indexBackfillerScheduler=this.gc(t,this.localStore)}mc(t,e){return null}gc(t,e){return null}wc(t){return au(this.persistence,new ru,t.initialUser,this.wt)}_c(t){return new Xc($c.Os,this.wt)}dc(t){return new Au}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class md extends pd{constructor(t,e,n){super(),this.yc=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.yc.initialize(this,t),await fd(this.yc.syncEngine),await rh(this.yc.remoteStore),await this.persistence.ci((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}wc(t){return au(this.persistence,new ru,t.initialUser,this.wt)}mc(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new Ec(n,t.asyncQueue,e)}gc(t,e){const n=new Ar(e,this.persistence);return new Mr(t.asyncQueue,n)}_c(t){const e=nu(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?cc.withCacheSize(this.cacheSizeBytes):cc.DEFAULT;return new Zc(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Pu(),Nu(),this.wt,this.sharedClientState,!!this.forceOwnership)}dc(t){return new Au}}class gd extends md{constructor(t,e){super(t,e,!1),this.yc=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.yc.syncEngine;this.sharedClientState instanceof Mu&&(this.sharedClientState.syncEngine={kr:ad.bind(null,e),Mr:ud.bind(null,e),Or:hd.bind(null,e),Ri:cd.bind(null,e),Nr:sd.bind(null,e)},await this.sharedClientState.start()),await this.persistence.ci((async t=>{await async function(t,e){const n=Di(t);if(dd(n),fd(n),!0===e&&!0!==n.ac){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await od(n,t.toArray());n.ac=!0,await ph(n.remoteStore,!0);for(const t of e)qu(n.remoteStore,t)}else if(!1===e&&!1!==n.ac){const t=[];let e=Promise.resolve();n.ec.forEach(((i,r)=>{n.sharedClientState.isLocalQueryTarget(r)?t.push(r):e=e.then((()=>(Yh(n,r),du(n.localStore,r,!0)))),ju(n.remoteStore,r)})),await e,await od(n,t),function(t){const e=Di(t);e.ic.forEach(((t,n)=>{ju(e.remoteStore,n)})),e.rc.cs(),e.ic=new Map,e.sc=new Lr(er.comparator)}(n),n.ac=!1,await ph(n.remoteStore,!1)}}(this.yc.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}dc(t){const e=Pu();if(!Mu.V(e))throw new Pi(Li.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=nu(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Mu(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class vd{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Wh(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=nd.bind(null,this.syncEngine),await ph(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Sh}createDatastore(t){const e=Ou(t.databaseInfo.databaseId),n=(i=t.databaseInfo,new Lu(i));var i;return function(t,e,n,i){return new Bu(t,e,n,i)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,i=t.asyncQueue,r=t=>Wh(this.syncEngine,t,0),s=Cu.V()?new Cu:new Iu,new Gu(e,n,i,r,s);var e,n,i,r,s}createSyncEngine(t,e){return function(t,e,n,i,r,s,a){const o=new kh(t,e,n,i,r,s);return a&&(o.ac=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=Di(t);Ei("RemoteStore","RemoteStore shutting down."),e.lu.add(5),await Wu(e),e.du.shutdown(),e._u.set("Unknown")}(this.remoteStore)}}function yd(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const i={value:t.slice(n,n+e),done:!1};return n+=e,i}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class _d{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ic(this.observer.next,t)}error(t){this.observer.error?this.Ic(this.observer.error,t):Ti("Uncaught Error in snapshot listener:",t)}Tc(){this.muted=!0}Ic(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class xd{constructor(t,e){this.Ec=t,this.wt=e,this.metadata=new Ni,this.buffer=new Uint8Array,this.Ac=new TextDecoder("utf-8"),this.Rc().then((t=>{t&&t.Cu()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.Ec.cancel()}async getMetadata(){return this.metadata.promise}async fc(){return await this.getMetadata(),this.Rc()}async Rc(){const t=await this.bc();if(null===t)return null;const e=this.Ac.decode(t),n=Number(e);isNaN(n)&&this.Pc(`length string (${e}) is not valid number`);const i=await this.vc(n);return new Rh(JSON.parse(i),t.length+n)}Vc(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async bc(){for(;this.Vc()<0&&!await this.Sc(););if(0===this.buffer.length)return null;const t=this.Vc();t<0&&this.Pc("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async vc(t){for(;this.buffer.length<t;)await this.Sc()&&this.Pc("Reached the end of bundle when more is expected.");const e=this.Ac.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}Pc(t){throw this.Ec.cancel(),new Error(`Invalid bundle format: ${t}`)}async Sc(){const t=await this.Ec.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class wd{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new Pi(Li.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=Di(t),i=Io(n.wt)+"/documents",r={documents:e.map((t=>Eo(n.wt,t)))},s=await n.ao("BatchGetDocuments",i,r,e.length),a=new Map;s.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Ci(!!e.found),e.found.name,e.found.updateTime;const n=To(t,e.found.name),i=wo(e.found.updateTime),r=new xs({mapValue:{fields:e.found.fields}});return bs.newFoundDocument(n,i,r)}(t,e):"missing"in e?function(t,e){Ci(!!e.missing),Ci(!!e.readTime);const n=To(t,e.missing),i=wo(e.readTime);return bs.newNoDocument(n,i)}(t,e):Ii()}(n.wt,t);a.set(e.key.toString(),e)}));const o=[];return e.forEach((t=>{const e=a.get(t.toString());Ci(!!e),o.push(e)})),o}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Va(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=er.fromPath(e);this.mutations.push(new ka(n,this.precondition(n)))})),await async function(t,e){const n=Di(t),i=Io(n.wt)+"/documents",r={writes:e.map((t=>Lo(n.wt,t)))};await n.ro("Commit",i,r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Ii();e=Yi.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Pi(Li.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?Ta.updateTime(e):Ta.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(Yi.min()))throw new Pi(Li.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Ta.updateTime(e)}return Ta.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class bd{constructor(t,e,n,i,r){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=i,this.deferred=r,this.Dc=n.maxAttempts,this.So=new Fu(this.asyncQueue,"transaction_retry")}run(){this.Dc-=1,this.Cc()}Cc(){this.So.Io((async()=>{const t=new wd(this.datastore),e=this.xc(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Nc(t)}))))})).catch((t=>{this.Nc(t)}))}))}xc(t){try{const e=this.updateFunction(t);return!Yr(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Nc(t){this.Dc>0&&this.kc(t)?(this.Dc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Cc(),Promise.resolve())))):this.deferred.reject(t)}kc(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!Ha(e)}return!1}}class Sd{constructor(t,e,n,i){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=i,this.user=_i.UNAUTHENTICATED,this.clientId=qi.I(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{Ei("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(Ei("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Pi(Li.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Ni;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=yh(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function Ed(t,e){t.asyncQueue.verifyOperationInProgress(),Ei("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let i=n.initialUser;t.setCredentialChangeListener((async t=>{i.isEqual(t)||(await ou(e.localStore,t),i=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function Td(t,e){t.asyncQueue.verifyOperationInProgress();const n=await Md(t);Ei("FirestoreClient","Initializing OnlineComponentProvider");const i=await t.getConfiguration();await e.initialize(n,i),t.setCredentialChangeListener((t=>fh(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>fh(e.remoteStore,n))),t.onlineComponents=e}async function Md(t){return t.offlineComponents||(Ei("FirestoreClient","Using default OfflineComponentProvider"),await Ed(t,new pd)),t.offlineComponents}async function Ad(t){return t.onlineComponents||(Ei("FirestoreClient","Using default OnlineComponentProvider"),await Td(t,new vd)),t.onlineComponents}function Id(t){return Md(t).then((t=>t.persistence))}function Cd(t){return Md(t).then((t=>t.localStore))}function Rd(t){return Ad(t).then((t=>t.remoteStore))}function Dd(t){return Ad(t).then((t=>t.syncEngine))}async function Ld(t){const e=await Ad(t),n=e.eventManager;return n.onListen=Bh.bind(null,e.syncEngine),n.onUnlisten=Gh.bind(null,e.syncEngine),n}function Pd(t,e,n={}){const i=new Ni;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,i,r){const s=new _d({next:s=>{e.enqueueAndForget((()=>Th(t,a)));const o=s.docs.has(n);!o&&s.fromCache?r.reject(new Pi(Li.UNAVAILABLE,"Failed to get document because the client is offline.")):o&&s.fromCache&&i&&"server"===i.source?r.reject(new Pi(Li.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(s)},error:t=>r.reject(t)}),a=new Ch(Xs(n.path),s,{includeMetadataChanges:!0,Du:!0});return Eh(t,a)}(await Ld(t),t.asyncQueue,e,n,i))),i.promise}function Nd(t,e,n={}){const i=new Ni;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,i,r){const s=new _d({next:n=>{e.enqueueAndForget((()=>Th(t,a))),n.fromCache&&"server"===i.source?r.reject(new Pi(Li.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:t=>r.reject(t)}),a=new Ch(n,s,{includeMetadataChanges:!0,Du:!0});return Eh(t,a)}(await Ld(t),t.asyncQueue,e,n,i))),i.promise}const Od=new Map;function Fd(t,e,n){if(!n)throw new Pi(Li.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Ud(t,e,n,i){if(!0===e&&!0===i)throw new Pi(Li.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Vd(t){if(!er.isDocumentKey(t))throw new Pi(Li.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function kd(t){if(er.isDocumentKey(t))throw new Pi(Li.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Bd(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Ii()}function zd(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Pi(Li.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Bd(t);throw new Pi(Li.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Gd(t,e){if(e<=0)throw new Pi(Li.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Hd{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Pi(Li.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Pi(Li.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Ud("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Wd{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Hd({}),this._settingsFrozen=!1,t instanceof $r?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Pi(Li.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new $r(t.options.projectId)}(t))}get app(){if(!this._app)throw new Pi(Li.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Pi(Li.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Hd(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Fi;switch(t.type){case"gapi":const e=t.client;return Ci(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Bi(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new Pi(Li.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Od.get(t);e&&(Ei("ComponentProvider","Removing Datastore"),Od.delete(t),e.terminate())}(this),Promise.resolve()}}function qd(t,e,n,i={}){var r;const s=(t=zd(t,Wd))._getSettings();if("firestore.googleapis.com"!==s.host&&s.host!==e&&Mi("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},s),{host:`${e}:${n}`,ssl:!1})),i.mockUserToken){let e,n;if("string"==typeof i.mockUserToken)e=i.mockUserToken,n=_i.MOCK_USER;else{e=(0,o.Sg)(i.mockUserToken,null===(r=t._app)||void 0===r?void 0:r.options.projectId);const s=i.mockUserToken.sub||i.mockUserToken.user_id;if(!s)throw new Pi(Li.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new _i(s)}t._authCredentials=new Ui(new Oi(e,n))}}class jd{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Kd(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new jd(this.firestore,t,this._key)}}class Xd{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new Xd(this.firestore,t,this._query)}}class Kd extends Xd{constructor(t,e,n){super(t,e,Xs(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new jd(this.firestore,null,new er(t))}withConverter(t){return new Kd(this.firestore,t,this._path)}}function $d(t,e,...n){if(t=(0,o.m9)(t),Fd("collection","path",e),t instanceof Wd){const i=Ji.fromString(e,...n);return kd(i),new Kd(t,null,i)}{if(!(t instanceof jd||t instanceof Kd))throw new Pi(Li.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=t._path.child(Ji.fromString(e,...n));return kd(i),new Kd(t.firestore,null,i)}}function Yd(t,e){if(t=zd(t,Wd),Fd("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Pi(Li.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Xd(t,null,function(t){return new qs(Ji.emptyPath(),t)}(e))}function Qd(t,e,...n){if(t=(0,o.m9)(t),1===arguments.length&&(e=qi.I()),Fd("doc","path",e),t instanceof Wd){const i=Ji.fromString(e,...n);return Vd(i),new jd(t,null,new er(i))}{if(!(t instanceof jd||t instanceof Kd))throw new Pi(Li.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const i=t._path.child(Ji.fromString(e,...n));return Vd(i),new jd(t.firestore,t instanceof Kd?t.converter:null,new er(i))}}function Jd(t,e){return t=(0,o.m9)(t),e=(0,o.m9)(e),(t instanceof jd||t instanceof Kd)&&(e instanceof jd||e instanceof Kd)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Zd(t,e){return t=(0,o.m9)(t),e=(0,o.m9)(e),t instanceof Xd&&e instanceof Xd&&t.firestore===e.firestore&&ea(t._query,e._query)&&t.converter===e.converter}class tf{constructor(){this.Mc=Promise.resolve(),this.Oc=[],this.Fc=!1,this.$c=[],this.Bc=null,this.Lc=!1,this.Uc=!1,this.qc=[],this.So=new Fu(this,"async_queue_retry"),this.Kc=()=>{const t=Nu();t&&Ei("AsyncQueue","Visibility state changed to "+t.visibilityState),this.So.Eo()};const t=Nu();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Kc)}get isShuttingDown(){return this.Fc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Gc(),this.Qc(t)}enterRestrictedMode(t){if(!this.Fc){this.Fc=!0,this.Uc=t||!1;const e=Nu();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Kc)}}enqueue(t){if(this.Gc(),this.Fc)return new Promise((()=>{}));const e=new Ni;return this.Qc((()=>this.Fc&&this.Uc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.Oc.push(t),this.jc())))}async jc(){if(0!==this.Oc.length){try{await this.Oc[0](),this.Oc.shift(),this.So.reset()}catch(t){if(!wr(t))throw t;Ei("AsyncQueue","Operation failed with retryable error: "+t)}this.Oc.length>0&&this.So.Io((()=>this.jc()))}}Qc(t){const e=this.Mc.then((()=>(this.Lc=!0,t().catch((t=>{this.Bc=t,this.Lc=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw Ti("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.Lc=!1,t))))));return this.Mc=e,e}enqueueAfterDelay(t,e,n){this.Gc(),this.qc.indexOf(t)>-1&&(e=0);const i=vh.createAndSchedule(this,t,e,n,(t=>this.Wc(t)));return this.$c.push(i),i}Gc(){this.Bc&&Ii()}verifyOperationInProgress(){}async zc(){let t;do{t=this.Mc,await t}while(t!==this.Mc)}Hc(t){for(const e of this.$c)if(e.timerId===t)return!0;return!1}Jc(t){return this.zc().then((()=>{this.$c.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.$c)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.zc()}))}Yc(t){this.qc.push(t)}Wc(t){const e=this.$c.indexOf(t);this.$c.splice(e,1)}}function ef(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class nf{constructor(){this._progressObserver={},this._taskCompletionResolver=new Ni,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const rf=-1;class sf extends Wd{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new tf,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||cf(this),this._firestoreClient.terminate()}}function af(t,e){const n=(0,r.qX)(t,"firestore");if(n.isInitialized()){const t=n.getImmediate(),i=n.getOptions();if((0,o.vZ)(i,e))return t;throw new Pi(Li.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Pi(Li.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return n.initialize({options:e})}function of(t=(0,r.Mq)()){return(0,r.qX)(t,"firestore").getImmediate()}function lf(t){return t._firestoreClient||cf(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function cf(t){var e;const n=t._freezeSettings(),i=function(t,e,n,i){return new Kr(t,e,n,i.host,i.ssl,i.experimentalForceLongPolling,i.experimentalAutoDetectLongPolling,i.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new Sd(t._authCredentials,t._appCheckCredentials,t._queue,i)}function uf(t,e){xf(t=zd(t,sf));const n=lf(t),i=t._freezeSettings(),r=new vd;return df(n,r,new md(r,i.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function hf(t){xf(t=zd(t,sf));const e=lf(t),n=t._freezeSettings(),i=new vd;return df(e,i,new gd(i,n.cacheSizeBytes))}function df(t,e,n){const i=new Ni;return t.asyncQueue.enqueue((async()=>{try{await Ed(t,n),await Td(t,e),i.resolve()}catch(t){const e=t;if(!function(t){return"FirebaseError"===t.name?t.code===Li.FAILED_PRECONDITION||t.code===Li.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}(e))throw e;Mi("Error enabling offline persistence. Falling back to persistence disabled: "+e),i.reject(e)}})).then((()=>i.promise))}function ff(t){if(t._initialized&&!t._terminated)throw new Pi(Li.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Ni;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!yr.V())return Promise.resolve();const e=t+"main";await yr.delete(e)}(nu(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function pf(t){return function(t){const e=new Ni;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=Di(t);Qu(n.remoteStore)||Ei("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=Di(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const i=n.uc.get(t)||[];i.push(e),n.uc.set(t,i)}catch(t){const n=yh(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await Dd(t),e))),e.promise}(lf(t=zd(t,sf)))}function mf(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Id(t),n=await Rd(t);return e.setNetworkEnabled(!0),function(t){const e=Di(t);return e.lu.delete(0),Hu(e)}(n)}))}(lf(t=zd(t,sf)))}function gf(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Id(t),n=await Rd(t);return e.setNetworkEnabled(!1),async function(t){const e=Di(t);e.lu.add(0),await Wu(e),e._u.set("Offline")}(n)}))}(lf(t=zd(t,sf)))}function vf(t){return(0,r.wN)(t.app,"firestore"),t._delete()}function yf(t,e){const n=lf(t=zd(t,sf)),i=new nf;return function(t,e,n,i){const r=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new xd(t,e)}(function(t,e){if(t instanceof Uint8Array)return yd(t,e);if(t instanceof ArrayBuffer)return yd(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Ou(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const i=Di(t);(async function(t,e,n){try{const i=await e.getMetadata();if(await function(t,e){const n=Di(t),i=wo(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Ds.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(i)>=0))}(t.localStore,i))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(i)),Promise.resolve(new Set);n._updateProgress(Ph(i));const r=new Lh(i,t.localStore,e.wt);let s=await e.fc();for(;s;){const t=await r.Nu(s);t&&n._updateProgress(t),s=await e.fc()}const a=await r.complete();return await ed(t,a.Ou,void 0),await function(t,e){const n=Di(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Ds.saveBundleMetadata(t,e)))}(t.localStore,i),n._completeWith(a.progress),Promise.resolve(a.Mu)}catch(t){return Mi("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(i,e,n).then((t=>{i.sharedClientState.notifyBundleLoaded(t)}))}(await Dd(t),r,i)}))}(n,t._databaseId,e,i),i}function _f(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=Di(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Ds.getNamedQuery(t,e)))}(await Cd(t),e)))}(lf(t=zd(t,sf)),e).then((e=>e?new Xd(t,null,e.query):null))}function xf(t){if(t._initialized||t._terminated)throw new Pi(Li.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class wf{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Pi(Li.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new tr(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function bf(){return new wf("__name__")}class Sf{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Sf(Br.fromBase64String(t))}catch(t){throw new Pi(Li.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new Sf(Br.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class Ef{constructor(t){this._methodName=t}}class Tf{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Pi(Li.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Pi(Li.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return ji(this._lat,t._lat)||ji(this._long,t._long)}}const Mf=/^__.*__$/;class Af{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Na(t,this.data,this.fieldMask,e,this.fieldTransforms):new Pa(t,this.data,e,this.fieldTransforms)}}class If{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Na(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function Cf(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Ii()}}class Rf{constructor(t,e,n,i,r,s){this.settings=t,this.databaseId=e,this.wt=n,this.ignoreUndefinedProperties=i,void 0===r&&this.Xc(),this.fieldTransforms=r||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Zc(){return this.settings.Zc}ta(t){return new Rf(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.wt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ea(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),i=this.ta({path:n,na:!1});return i.sa(t),i}ia(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),i=this.ta({path:n,na:!1});return i.Xc(),i}ra(t){return this.ta({path:void 0,na:!0})}oa(t){return Yf(t,this.settings.methodName,this.settings.ua||!1,this.path,this.settings.ca)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}Xc(){if(this.path)for(let t=0;t<this.path.length;t++)this.sa(this.path.get(t))}sa(t){if(0===t.length)throw this.oa("Document fields must not be empty");if(Cf(this.Zc)&&Mf.test(t))throw this.oa('Document fields cannot begin and end with "__"')}}class Df{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.wt=n||Ou(t)}aa(t,e,n,i=!1){return new Rf({Zc:t,methodName:e,ca:n,path:tr.emptyPath(),na:!1,ua:i},this.databaseId,this.wt,this.ignoreUndefinedProperties)}}function Lf(t){const e=t._freezeSettings(),n=Ou(t._databaseId);return new Df(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Pf(t,e,n,i,r,s={}){const a=t.aa(s.merge||s.mergeFields?2:0,e,n,r);jf("Data must be an object, but it was:",a,i);const o=Wf(i,a);let l,c;if(s.merge)l=new Vr(a.fieldMask),c=a.fieldTransforms;else if(s.mergeFields){const t=[];for(const i of s.mergeFields){const r=Xf(e,i,n);if(!a.contains(r))throw new Pi(Li.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);Qf(t,r)||t.push(r)}l=new Vr(t),c=a.fieldTransforms.filter((t=>l.covers(t.field)))}else l=null,c=a.fieldTransforms;return new Af(new xs(o),l,c)}class Nf extends Ef{_toFieldTransform(t){if(2!==t.Zc)throw 1===t.Zc?t.oa(`${this._methodName}() can only appear at the top level of your update data`):t.oa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Nf}}function Of(t,e,n){return new Rf({Zc:3,ca:e.settings.ca,methodName:t._methodName,na:n},e.databaseId,e.wt,e.ignoreUndefinedProperties)}class Ff extends Ef{_toFieldTransform(t){return new Sa(t.path,new ma)}isEqual(t){return t instanceof Ff}}class Uf extends Ef{constructor(t,e){super(t),this.ha=e}_toFieldTransform(t){const e=Of(this,t,!0),n=this.ha.map((t=>Hf(t,e))),i=new ga(n);return new Sa(t.path,i)}isEqual(t){return this===t}}class Vf extends Ef{constructor(t,e){super(t),this.ha=e}_toFieldTransform(t){const e=Of(this,t,!0),n=this.ha.map((t=>Hf(t,e))),i=new ya(n);return new Sa(t.path,i)}isEqual(t){return this===t}}class kf extends Ef{constructor(t,e){super(t),this.la=e}_toFieldTransform(t){const e=new xa(t.wt,ua(t.wt,this.la));return new Sa(t.path,e)}isEqual(t){return this===t}}function Bf(t,e,n,i){const r=t.aa(1,e,n);jf("Data must be an object, but it was:",r,i);const s=[],a=xs.empty();Rr(i,((t,i)=>{const l=$f(e,t,n);i=(0,o.m9)(i);const c=r.ia(l);if(i instanceof Nf)s.push(l);else{const t=Hf(i,c);null!=t&&(s.push(l),a.set(l,t))}}));const l=new Vr(s);return new If(a,l,r.fieldTransforms)}function zf(t,e,n,i,r,s){const a=t.aa(1,e,n),l=[Xf(e,i,n)],c=[r];if(s.length%2!=0)throw new Pi(Li.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<s.length;t+=2)l.push(Xf(e,s[t])),c.push(s[t+1]);const u=[],h=xs.empty();for(let t=l.length-1;t>=0;--t)if(!Qf(u,l[t])){const e=l[t];let n=c[t];n=(0,o.m9)(n);const i=a.ia(e);if(n instanceof Nf)u.push(e);else{const t=Hf(n,i);null!=t&&(u.push(e),h.set(e,t))}}const d=new Vr(u);return new If(h,d,a.fieldTransforms)}function Gf(t,e,n,i=!1){return Hf(n,t.aa(i?4:3,e))}function Hf(t,e){if(qf(t=(0,o.m9)(t)))return jf("Unsupported field value:",e,t),Wf(t,e);if(t instanceof Ef)return function(t,e){if(!Cf(e.Zc))throw e.oa(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.oa(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.na&&4!==e.Zc)throw e.oa("Nested arrays are not supported");return function(t,e){const n=[];let i=0;for(const r of t){let t=Hf(r,e.ra(i));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),i++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,o.m9)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return ua(e.wt,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=$i.fromDate(t);return{timestampValue:yo(e.wt,n)}}if(t instanceof $i){const n=new $i(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:yo(e.wt,n)}}if(t instanceof Tf)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof Sf)return{bytesValue:_o(e.wt,t._byteString)};if(t instanceof jd){const n=e.databaseId,i=t.firestore._databaseId;if(!i.isEqual(n))throw e.oa(`Document reference is for database ${i.projectId}/${i.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:bo(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.oa(`Unsupported field value: ${Bd(t)}`)}(t,e)}function Wf(t,e){const n={};return Dr(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Rr(t,((t,i)=>{const r=Hf(i,e.ea(t));null!=r&&(n[t]=r)})),{mapValue:{fields:n}}}function qf(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof $i||t instanceof Tf||t instanceof Sf||t instanceof jd||t instanceof Ef)}function jf(t,e,n){if(!qf(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const i=Bd(n);throw"an object"===i?e.oa(t+" a custom object"):e.oa(t+" "+i)}}function Xf(t,e,n){if((e=(0,o.m9)(e))instanceof wf)return e._internalPath;if("string"==typeof e)return $f(t,e);throw Yf("Field path arguments must be of type string or ",t,!1,void 0,n)}const Kf=new RegExp("[~\\*/\\[\\]]");function $f(t,e,n){if(e.search(Kf)>=0)throw Yf(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new wf(...e.split("."))._internalPath}catch(i){throw Yf(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Yf(t,e,n,i,r){const s=i&&!i.isEmpty(),a=void 0!==r;let o=`Function ${e}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${i}`),a&&(l+=` in document ${r}`),l+=")"),new Pi(Li.INVALID_ARGUMENT,o+t+l)}function Qf(t,e){return t.some((t=>t.isEqual(e)))}class Jf{constructor(t,e,n,i,r){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=i,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new jd(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Zf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(tp("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Zf extends Jf{data(){return super.data()}}function tp(t,e){return"string"==typeof e?$f(t,e):e instanceof wf?e._internalPath:e._delegate._internalPath}class ep{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class np extends Jf{constructor(t,e,n,i,r,s){super(t,e,n,i,s),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new ip(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(tp("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class ip extends np{data(t={}){return super.data(t)}}class rp{constructor(t,e,n,i){this._firestore=t,this._userDataWriter=e,this._snapshot=i,this.metadata=new ep(i.hasPendingWrites,i.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new ip(this._firestore,this._userDataWriter,n.key,n,new ep(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Pi(Li.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new ip(t._firestore,t._userDataWriter,n.doc.key,n.doc,new ep(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const i=new ip(t._firestore,t._userDataWriter,e.doc.key,e.doc,new ep(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let r=-1,s=-1;return 0!==e.type&&(r=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),s=n.indexOf(e.doc.key)),{type:sp(e.type),doc:i,oldIndex:r,newIndex:s}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function sp(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Ii()}}function ap(t,e){return t instanceof np&&e instanceof np?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof rp&&e instanceof rp&&t._firestore===e._firestore&&Zd(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function op(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new Pi(Li.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class lp{}function cp(t,...e){for(const n of e)t=n._apply(t);return t}class up extends lp{constructor(t,e,n){super(),this.fa=t,this.da=e,this._a=n,this.type="where"}_apply(t){const e=Lf(t.firestore),n=function(t,e,n,i,r,s,a){let o;if(r.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new Pi(Li.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){Tp(a,s);const e=[];for(const n of a)e.push(Ep(i,t,n));o={arrayValue:{values:e}}}else o=Ep(i,t,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||Tp(a,s),o=Gf(n,"where",a,"in"===s||"not-in"===s);const l=Ds.create(r,s,o);return function(t,e){if(e.ht()){const n=Ys(t);if(null!==n&&!n.isEqual(e.field))throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const i=$s(t);null!==i&&Mp(0,e.field,i)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Pi(Li.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Pi(Li.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,l),l}(t._query,0,e,t.firestore._databaseId,this.fa,this.da,this._a);return new Xd(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function hp(t,e,n){const i=e,r=tp("where",t);return new up(r,i,n)}class dp extends lp{constructor(t,e){super(),this.fa=t,this.wa=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Pi(Li.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Pi(Li.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const i=new zs(e,n);return function(t,e){if(null===$s(t)){const n=Ys(t);null!==n&&Mp(0,n,e.field)}}(t,i),i}(t._query,this.fa,this.wa);return new Xd(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new qs(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function fp(t,e="asc"){const n=e,i=tp("orderBy",t);return new dp(i,n)}class pp extends lp{constructor(t,e,n){super(),this.type=t,this.ma=e,this.ga=n}_apply(t){return new Xd(t.firestore,t.converter,ta(t._query,this.ma,this.ga))}}function mp(t){return Gd("limit",t),new pp("limit",t,"F")}function gp(t){return Gd("limitToLast",t),new pp("limitToLast",t,"L")}class vp extends lp{constructor(t,e,n){super(),this.type=t,this.ya=e,this.pa=n}_apply(t){const e=Sp(t,this.type,this.ya,this.pa);return new Xd(t.firestore,t.converter,function(t,e){return new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function yp(...t){return new vp("startAt",t,!0)}function _p(...t){return new vp("startAfter",t,!1)}class xp extends lp{constructor(t,e,n){super(),this.type=t,this.ya=e,this.pa=n}_apply(t){const e=Sp(t,this.type,this.ya,this.pa);return new Xd(t.firestore,t.converter,function(t,e){return new qs(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function wp(...t){return new xp("endBefore",t,!1)}function bp(...t){return new xp("endAt",t,!0)}function Sp(t,e,n,i){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof Jf)return function(t,e,n,i,r){if(!i)throw new Pi(Li.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const s=[];for(const n of Js(t))if(n.field.isKeyField())s.push(ls(e,i.key));else{const t=i.data.field(n.field);if(qr(t))throw new Pi(Li.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}s.push(t)}return new Bs(s,r)}(t._query,t.firestore._databaseId,e,n[0]._document,i);{const r=Lf(t.firestore);return function(t,e,n,i,r,s){const a=t.explicitOrderBy;if(r.length>a.length)throw new Pi(Li.INVALID_ARGUMENT,`Too many arguments provided to ${i}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const o=[];for(let s=0;s<r.length;s++){const l=r[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${i}(), but got a ${typeof l}`);if(!Qs(t)&&-1!==l.indexOf("/"))throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${i}() must be a plain document ID, but '${l}' contains a slash.`);const n=t.path.child(Ji.fromString(l));if(!er.isDocumentKey(n))throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${i}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const r=new er(n);o.push(ls(e,r))}else{const t=Gf(n,i,l);o.push(t)}}return new Bs(o,s)}(t._query,t.firestore._databaseId,r,e,n,i)}}function Ep(t,e,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new Pi(Li.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Qs(e)&&-1!==n.indexOf("/"))throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const i=e.path.child(Ji.fromString(n));if(!er.isDocumentKey(i))throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${i}' is not because it has an odd number of segments (${i.length}).`);return ls(t,new er(i))}if(n instanceof jd)return ls(t,n._key);throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Bd(n)}.`)}function Tp(t,e){if(!Array.isArray(t)||0===t.length)throw new Pi(Li.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new Pi(Li.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function Mp(t,e,n){if(!n.isEqual(e))throw new Pi(Li.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}const Ap={maxAttempts:5};class Ip{convertValue(t,e="none"){switch(es(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Hr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Wr(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Ii()}}convertObject(t,e){const n={};return Rr(t.fields,((t,i)=>{n[t]=this.convertValue(i,e)})),n}convertGeoPoint(t){return new Tf(Hr(t.latitude),Hr(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=jr(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(Xr(t));default:return null}}convertTimestamp(t){const e=Gr(t);return new $i(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=Ji.fromString(t);Ci(qo(n));const i=new $r(n.get(1),n.get(3)),r=new er(n.popFirst(5));return i.isEqual(e)||Ti(`Document ${r} contains a document reference within a different database (${i.projectId}/${i.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}function Cp(t,e,n){let i;return i=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,i}class Rp extends Ip{constructor(t){super(),this.firestore=t}convertBytes(t){return new Sf(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new jd(this.firestore,null,e)}}class Dp{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Lf(t)}set(t,e,n){this._verifyNotCommitted();const i=Lp(t,this._firestore),r=Cp(i.converter,e,n),s=Pf(this._dataReader,"WriteBatch.set",i._key,r,null!==i.converter,n);return this._mutations.push(s.toMutation(i._key,Ta.none())),this}update(t,e,n,...i){this._verifyNotCommitted();const r=Lp(t,this._firestore);let s;return s="string"==typeof(e=(0,o.m9)(e))||e instanceof wf?zf(this._dataReader,"WriteBatch.update",r._key,e,n,i):Bf(this._dataReader,"WriteBatch.update",r._key,e),this._mutations.push(s.toMutation(r._key,Ta.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Lp(t,this._firestore);return this._mutations=this._mutations.concat(new Va(e._key,Ta.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Pi(Li.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Lp(t,e){if((t=(0,o.m9)(t)).firestore!==e)throw new Pi(Li.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function Pp(t){t=zd(t,jd);const e=zd(t.firestore,sf);return Pd(lf(e),t._key).then((n=>Xp(e,t,n)))}class Np extends Ip{constructor(t){super(),this.firestore=t}convertBytes(t){return new Sf(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new jd(this.firestore,null,e)}}function Op(t){t=zd(t,jd);const e=zd(t.firestore,sf),n=lf(e),i=new Np(e);return function(t,e){const n=new Ni;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const i=await function(t,e){const n=Di(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);i.isFoundDocument()?n.resolve(i):i.isNoDocument()?n.resolve(null):n.reject(new Pi(Li.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const i=yh(t,`Failed to get document '${e} from cache`);n.reject(i)}}(await Cd(t),e,n))),n.promise}(n,t._key).then((n=>new np(e,i,t._key,n,new ep(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Fp(t){t=zd(t,jd);const e=zd(t.firestore,sf);return Pd(lf(e),t._key,{source:"server"}).then((n=>Xp(e,t,n)))}function Up(t){t=zd(t,Xd);const e=zd(t.firestore,sf),n=lf(e),i=new Np(e);return op(t._query),Nd(n,t._query).then((n=>new rp(e,i,t,n)))}function Vp(t){t=zd(t,Xd);const e=zd(t.firestore,sf),n=lf(e),i=new Np(e);return function(t,e){const n=new Ni;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const i=await fu(t,e,!0),r=new Fh(e,i.ji),s=r.Ku(i.documents),a=r.applyChanges(s,!1);n.resolve(a.snapshot)}catch(t){const i=yh(t,`Failed to execute query '${e} against cache`);n.reject(i)}}(await Cd(t),e,n))),n.promise}(n,t._query).then((n=>new rp(e,i,t,n)))}function kp(t){t=zd(t,Xd);const e=zd(t.firestore,sf),n=lf(e),i=new Np(e);return Nd(n,t._query,{source:"server"}).then((n=>new rp(e,i,t,n)))}function Bp(t,e,n){t=zd(t,jd);const i=zd(t.firestore,sf),r=Cp(t.converter,e,n);return jp(i,[Pf(Lf(i),"setDoc",t._key,r,null!==t.converter,n).toMutation(t._key,Ta.none())])}function zp(t,e,n,...i){t=zd(t,jd);const r=zd(t.firestore,sf),s=Lf(r);let a;return a="string"==typeof(e=(0,o.m9)(e))||e instanceof wf?zf(s,"updateDoc",t._key,e,n,i):Bf(s,"updateDoc",t._key,e),jp(r,[a.toMutation(t._key,Ta.exists(!0))])}function Gp(t){return jp(zd(t.firestore,sf),[new Va(t._key,Ta.none())])}function Hp(t,e){const n=zd(t.firestore,sf),i=Qd(t),r=Cp(t.converter,e);return jp(n,[Pf(Lf(t.firestore),"addDoc",i._key,r,null!==t.converter,{}).toMutation(i._key,Ta.exists(!1))]).then((()=>i))}function Wp(t,...e){var n,i,r;t=(0,o.m9)(t);let s={includeMetadataChanges:!1},a=0;"object"!=typeof e[a]||ef(e[a])||(s=e[a],a++);const l={includeMetadataChanges:s.includeMetadataChanges};if(ef(e[a])){const t=e[a];e[a]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[a+1]=null===(i=t.error)||void 0===i?void 0:i.bind(t),e[a+2]=null===(r=t.complete)||void 0===r?void 0:r.bind(t)}let c,u,h;if(t instanceof jd)u=zd(t.firestore,sf),h=Xs(t._key.path),c={next:n=>{e[a]&&e[a](Xp(u,t,n))},error:e[a+1],complete:e[a+2]};else{const n=zd(t,Xd);u=zd(n.firestore,sf),h=n._query;const i=new Np(u);c={next:t=>{e[a]&&e[a](new rp(u,i,n,t))},error:e[a+1],complete:e[a+2]},op(t._query)}return function(t,e,n,i){const r=new _d(i),s=new Ch(e,r,n);return t.asyncQueue.enqueueAndForget((async()=>Eh(await Ld(t),s))),()=>{r.Tc(),t.asyncQueue.enqueueAndForget((async()=>Th(await Ld(t),s)))}}(lf(u),h,l,c)}function qp(t,e){return function(t,e){const n=new _d(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){Di(t).Tu.add(e),e.next()}(await Ld(t),n))),()=>{n.Tc(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){Di(t).Tu.delete(e)}(await Ld(t),n)))}}(lf(t=zd(t,sf)),ef(e)?e:{next:e})}function jp(t,e){return function(t,e){const n=new Ni;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const i=fd(t);try{const t=await function(t,e){const n=Di(t),i=$i.now(),r=e.reduce(((t,e)=>t.add(e.key)),no());let s,a;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let o=Xa(),l=no();return n.Ui.getEntries(t,r).next((t=>{o=t,o.forEach(((t,e)=>{e.isValidDocument()||(l=l.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,o))).next((r=>{s=r;const a=[];for(const t of e){const e=Da(t,s.get(t.key).overlayedDocument);null!=e&&a.push(new Na(t.key,e,ws(e.value.mapValue),Ta.exists(!0)))}return n.mutationQueue.addMutationBatch(t,i,a,e)})).next((e=>{a=e;const i=e.applyToLocalDocumentSet(s,l);return n.documentOverlayCache.saveOverlays(t,e.batchId,i)}))})).then((()=>({batchId:a.batchId,changes:Ya(s)})))}(i.localStore,e);i.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let i=t.oc[t.currentUser.toKey()];i||(i=new Lr(ji)),i=i.insert(e,n),t.oc[t.currentUser.toKey()]=i}(i,t.batchId,n),await ed(i,t.changes),await rh(i.remoteStore)}catch(t){const e=yh(t,"Failed to persist write");n.reject(e)}}(await Dd(t),e,n))),n.promise}(lf(t),e)}function Xp(t,e,n){const i=n.docs.get(e._key),r=new Np(t);return new np(t,r,e._key,i,new ep(n.hasPendingWrites,n.fromCache),e.converter)}class Kp extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Lf(t)}get(t){const e=Lp(t,this._firestore),n=new Rp(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Ii();const i=t[0];if(i.isFoundDocument())return new Jf(this._firestore,n,i.key,i,e.converter);if(i.isNoDocument())return new Jf(this._firestore,n,e._key,null,e.converter);throw Ii()}))}set(t,e,n){const i=Lp(t,this._firestore),r=Cp(i.converter,e,n),s=Pf(this._dataReader,"Transaction.set",i._key,r,null!==i.converter,n);return this._transaction.set(i._key,s),this}update(t,e,n,...i){const r=Lp(t,this._firestore);let s;return s="string"==typeof(e=(0,o.m9)(e))||e instanceof wf?zf(this._dataReader,"Transaction.update",r._key,e,n,i):Bf(this._dataReader,"Transaction.update",r._key,e),this._transaction.update(r._key,s),this}delete(t){const e=Lp(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Lp(t,this._firestore),n=new Np(this._firestore);return super.get(t).then((t=>new np(this._firestore,n,e._key,t._document,new ep(!1,!1),e.converter)))}}function $p(t,e,n){t=zd(t,sf);const i=Object.assign(Object.assign({},Ap),n);return function(t){if(t.maxAttempts<1)throw new Pi(Li.INVALID_ARGUMENT,"Max attempts must be at least 1")}(i),function(t,e,n){const i=new Ni;return t.asyncQueue.enqueueAndForget((async()=>{const r=await function(t){return Ad(t).then((t=>t.datastore))}(t);new bd(t.asyncQueue,r,n,e,i).run()})),i.promise}(lf(t),(n=>e(new Kp(t,n))),i)}function Yp(){return new Nf("deleteField")}function Qp(){return new Ff("serverTimestamp")}function Jp(...t){return new Uf("arrayUnion",t)}function Zp(...t){return new Vf("arrayRemove",t)}function tm(t){return new kf("increment",t)}function em(t){return lf(t=zd(t,sf)),new Dp(t,(e=>jp(t,e)))}function nm(t,e){var n;const i=lf(t=zd(t,sf));if(!(null===(n=i.offlineComponents)||void 0===n?void 0:n.indexBackfillerScheduler))return Mi("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function(t){const e="string"==typeof t?function(t){var e;try{return JSON.parse(t)}catch(t){throw new Pi(Li.INVALID_ARGUMENT,"Failed to parse JSON: "+(null===(e=t)||void 0===e?void 0:e.message))}}(t):t,n=[];if(Array.isArray(e.indexes))for(const t of e.indexes){const e=im(t,"collectionGroup"),i=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=$f("setIndexConfiguration",im(e,"fieldPath"));"CONTAINS"===e.arrayConfig?i.push(new ar(t,2)):"ASCENDING"===e.order?i.push(new ar(t,0)):"DESCENDING"===e.order&&i.push(new ar(t,1))}n.push(new nr(nr.UNKNOWN_ID,e,i,lr.empty()))}return n}(e);return Cd(i).then((t=>async function(t,e){const n=Di(t),i=n.indexManager,r=[];return n.persistence.runTransaction("Configure indexes","readwrite",(t=>i.getFieldIndexes(t).next((n=>function(t,e,n,i,r){t=[...t],e=[...e],t.sort(n),e.sort(n);const s=t.length,a=e.length;let o=0,l=0;for(;o<a&&l<s;){const s=n(t[l],e[o]);s<0?r(t[l++]):s>0?i(e[o++]):(o++,l++)}for(;o<a;)i(e[o++]);for(;l<s;)r(t[l++])}(n,e,sr,(e=>{r.push(i.addFieldIndex(t,e))}),(e=>{r.push(i.deleteFieldIndex(t,e))})))).next((()=>gr.waitFor(r)))))}(t,r)))}function im(t,e){if("string"!=typeof t[e])throw new Pi(Li.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}!function(t,e=!0){!function(t){xi=t}(r.Jn),(0,r.Xd)(new s.wA("firestore",((t,{options:n})=>{const i=t.getProvider("app").getImmediate(),r=new sf(i,new Vi(t.getProvider("auth-internal")),new Gi(t.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:e},n),r._setSettings(n),r}),"PUBLIC")),(0,r.KN)(yi,"3.4.14",t),(0,r.KN)(yi,"3.4.14","esm2017")}()},94:(t,e,n)=>{n.d(e,{V:()=>s});var i=n(1245),r=n(1052);class s extends r.T{constructor(){super(),this.type="Camera",this.matrixWorldInverse=new i.Matrix4,this.projectionMatrix=new i.Matrix4,this.projectionMatrixInverse=new i.Matrix4}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}s.prototype.isCamera=!0},4152:(t,e,n)=>{n.d(e,{i:()=>r});var i=n(94);class r extends i.V{constructor(t=-1,e=1,n=1,i=-1,r=.1,s=2e3){super(),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=n,this.bottom=i,this.near=r,this.far=s,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,n,i,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let r=n-t,s=n+t,a=i+e,o=i-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=t*this.view.offsetX,s=r+t*this.view.width,a-=e*this.view.offsetY,o=a-e*this.view.height}this.projectionMatrix.makeOrthographic(r,s,a,o,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}r.prototype.isOrthographicCamera=!0},2096:(t,e,n)=>{n.r(e),n.d(e,{PerspectiveCamera:()=>s});var i=n(94),r=n(9542);class s extends i.V{constructor(t=50,e=1,n=.1,i=2e3){super(),this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=n,this.far=i,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=2*r.I3*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(.5*r.qW*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*r.I3*Math.atan(Math.tan(.5*r.qW*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(t,e,n,i,r,s){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(.5*r.qW*this.fov)/this.zoom,n=2*e,i=this.aspect*n,s=-.5*i;const a=this.view;if(null!==this.view&&this.view.enabled){const t=a.fullWidth,r=a.fullHeight;s+=a.offsetX*i/t,e-=a.offsetY*n/r,i*=a.width/t,n*=a.height/r}const o=this.filmOffset;0!==o&&(s+=t*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+i,e,e-n,t,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}s.prototype.isPerspectiveCamera=!0},7006:(t,e,n)=>{n.d(e,{BFQ:()=>Vt,BG$:()=>Zt,BVF:()=>F,Bf4:()=>it,CaW:()=>Wt,CdI:()=>$,CtA:()=>Ot,D1R:()=>ft,D9w:()=>Pt,Djp:()=>Jt,E2K:()=>Ft,EoG:()=>K,FUD:()=>se,GG6:()=>ie,GUF:()=>ge,Gih:()=>re,Hy8:()=>L,ILR:()=>Bt,IOt:()=>fe,JQ4:()=>_t,KI_:()=>me,KhW:()=>A,Kz5:()=>yt,LSk:()=>xe,LY2:()=>Q,L_r:()=>we,LgZ:()=>R,LsT:()=>vt,M5h:()=>y,M6v:()=>H,N4l:()=>v,NDo:()=>j,NYV:()=>te,Ns1:()=>W,OTo:()=>Tt,OoA:()=>ot,PA7:()=>pe,PeU:()=>r,RlZ:()=>O,S2y:()=>a,Se2:()=>U,Sm8:()=>E,SvJ:()=>oe,T95:()=>mt,TyD:()=>lt,UCm:()=>Mt,UZH:()=>i,Vdb:()=>P,VzW:()=>xt,W2J:()=>_e,WMw:()=>g,Wbm:()=>w,Wl3:()=>u,Wpd:()=>N,Xaj:()=>_,Y8D:()=>It,YGz:()=>Y,YLQ:()=>ct,Zr5:()=>V,_AM:()=>zt,_Li:()=>h,_iA:()=>o,aH4:()=>ut,av9:()=>Nt,bGH:()=>x,bdR:()=>m,brP:()=>Dt,bsb:()=>le,c8b:()=>T,cLu:()=>wt,cRx:()=>Ct,cum:()=>ye,dSO:()=>nt,dZ3:()=>J,dwk:()=>c,eD:()=>B,eaV:()=>Ht,ehD:()=>d,ekQ:()=>Xt,esl:()=>f,fSK:()=>D,fY$:()=>tt,fto:()=>qt,g8_:()=>rt,ghN:()=>M,gi4:()=>Qt,hEm:()=>Lt,iAb:()=>gt,iWC:()=>I,iiP:()=>ae,irR:()=>St,jFi:()=>p,jZA:()=>$t,k0A:()=>bt,k74:()=>C,knz:()=>ue,ksN:()=>z,l0P:()=>jt,mSO:()=>de,ntZ:()=>l,pKu:()=>ne,ptH:()=>Kt,qhX:()=>q,qkB:()=>Rt,qyh:()=>dt,rOj:()=>b,r_:()=>S,rnI:()=>ce,rpg:()=>st,tm_:()=>s,uL9:()=>X,uWy:()=>at,v3W:()=>kt,vCF:()=>k,vCx:()=>Gt,vxC:()=>et,w$m:()=>G,wJv:()=>Et,wem:()=>ht,wk1:()=>At,wuA:()=>Ut,x5V:()=>ve,xJs:()=>ee,xfE:()=>Z,y2t:()=>Yt,ywz:()=>pt,z81:()=>he});const i="140",r=0,s=1,a=2,o=1,l=2,c=3,u=0,h=1,d=2,f=1,p=0,m=1,g=2,v=3,y=4,_=5,x=100,w=101,b=102,S=103,E=104,T=200,M=201,A=202,I=203,C=204,R=205,D=206,L=207,P=208,N=209,O=210,F=0,U=1,V=2,k=3,B=4,z=5,G=6,H=7,W=0,q=1,j=2,X=0,K=1,$=2,Y=3,Q=4,J=5,Z=300,tt=301,et=302,nt=303,it=304,rt=306,st=1e3,at=1001,ot=1002,lt=1003,ct=1004,ut=1005,ht=1006,dt=1007,ft=1008,pt=1009,mt=1010,gt=1011,vt=1012,yt=1013,_t=1014,xt=1015,wt=1016,bt=1017,St=1018,Et=1020,Tt=1021,Mt=1022,At=1023,It=1024,Ct=1025,Rt=1026,Dt=1027,Lt=1028,Pt=1029,Nt=1030,Ot=1031,Ft=1033,Ut=33776,Vt=33777,kt=33778,Bt=33779,zt=35840,Gt=35841,Ht=35842,Wt=35843,qt=36196,jt=37492,Xt=37496,Kt=37808,$t=37809,Yt=37810,Qt=37811,Jt=37812,Zt=37813,te=37814,ee=37815,ne=37816,ie=37817,re=37818,se=37819,ae=37820,oe=37821,le=36492,ce=3e3,ue=3001,he=3200,de=3201,fe=0,pe=1,me="srgb",ge="srgb-linear",ve=7680,ye=519,_e=35044,xe="300 es",we=1035},4430:(t,e,n)=>{n.r(e),n.d(e,{BufferAttribute:()=>u,Float16BufferAttribute:()=>y,Float32BufferAttribute:()=>_,Float64BufferAttribute:()=>x,Int16BufferAttribute:()=>p,Int32BufferAttribute:()=>g,Int8BufferAttribute:()=>h,Uint16BufferAttribute:()=>m,Uint32BufferAttribute:()=>v,Uint8BufferAttribute:()=>d,Uint8ClampedBufferAttribute:()=>f});var i=n(6980),r=n(4532),s=n(6120),a=n(7282),o=n(7006);const l=new r.Vector3,c=new s.Vector2;class u{constructor(t,e,n){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===n,this.usage=o.W2J,this.updateRange={offset:0,count:-1},this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}setUsage(t){return this.usage=t,this}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this}copyAt(t,e,n){t*=this.itemSize,n*=e.itemSize;for(let i=0,r=this.itemSize;i<r;i++)this.array[t+i]=e.array[n+i];return this}copyArray(t){return this.array.set(t),this}copyColorsArray(t){const e=this.array;let n=0;for(let i=0,r=t.length;i<r;i++){let r=t[i];void 0===r&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",i),r=new a.Color),e[n++]=r.r,e[n++]=r.g,e[n++]=r.b}return this}copyVector2sArray(t){const e=this.array;let n=0;for(let i=0,r=t.length;i<r;i++){let r=t[i];void 0===r&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",i),r=new s.Vector2),e[n++]=r.x,e[n++]=r.y}return this}copyVector3sArray(t){const e=this.array;let n=0;for(let i=0,s=t.length;i<s;i++){let s=t[i];void 0===s&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",i),s=new r.Vector3),e[n++]=s.x,e[n++]=s.y,e[n++]=s.z}return this}copyVector4sArray(t){const e=this.array;let n=0;for(let r=0,s=t.length;r<s;r++){let s=t[r];void 0===s&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",r),s=new i.L),e[n++]=s.x,e[n++]=s.y,e[n++]=s.z,e[n++]=s.w}return this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,n=this.count;e<n;e++)c.fromBufferAttribute(this,e),c.applyMatrix3(t),this.setXY(e,c.x,c.y);else if(3===this.itemSize)for(let e=0,n=this.count;e<n;e++)l.fromBufferAttribute(this,e),l.applyMatrix3(t),this.setXYZ(e,l.x,l.y,l.z);return this}applyMatrix4(t){for(let e=0,n=this.count;e<n;e++)l.fromBufferAttribute(this,e),l.applyMatrix4(t),this.setXYZ(e,l.x,l.y,l.z);return this}applyNormalMatrix(t){for(let e=0,n=this.count;e<n;e++)l.fromBufferAttribute(this,e),l.applyNormalMatrix(t),this.setXYZ(e,l.x,l.y,l.z);return this}transformDirection(t){for(let e=0,n=this.count;e<n;e++)l.fromBufferAttribute(this,e),l.transformDirection(t),this.setXYZ(e,l.x,l.y,l.z);return this}set(t,e=0){return this.array.set(t,e),this}getX(t){return this.array[t*this.itemSize]}setX(t,e){return this.array[t*this.itemSize]=e,this}getY(t){return this.array[t*this.itemSize+1]}setY(t,e){return this.array[t*this.itemSize+1]=e,this}getZ(t){return this.array[t*this.itemSize+2]}setZ(t,e){return this.array[t*this.itemSize+2]=e,this}getW(t){return this.array[t*this.itemSize+3]}setW(t,e){return this.array[t*this.itemSize+3]=e,this}setXY(t,e,n){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=n,this}setXYZ(t,e,n,i){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=n,this.array[t+2]=i,this}setXYZW(t,e,n,i,r){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=n,this.array[t+2]=i,this.array[t+3]=r,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.prototype.slice.call(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==o.W2J&&(t.usage=this.usage),0===this.updateRange.offset&&-1===this.updateRange.count||(t.updateRange=this.updateRange),t}}u.prototype.isBufferAttribute=!0;class h extends u{constructor(t,e,n){super(new Int8Array(t),e,n)}}class d extends u{constructor(t,e,n){super(new Uint8Array(t),e,n)}}class f extends u{constructor(t,e,n){super(new Uint8ClampedArray(t),e,n)}}class p extends u{constructor(t,e,n){super(new Int16Array(t),e,n)}}class m extends u{constructor(t,e,n){super(new Uint16Array(t),e,n)}}class g extends u{constructor(t,e,n){super(new Int32Array(t),e,n)}}class v extends u{constructor(t,e,n){super(new Uint32Array(t),e,n)}}class y extends u{constructor(t,e,n){super(new Uint16Array(t),e,n)}}y.prototype.isFloat16BufferAttribute=!0;class _ extends u{constructor(t,e,n){super(new Float32Array(t),e,n)}}class x extends u{constructor(t,e,n){super(new Float64Array(t),e,n)}}},5699:(t,e,n)=>{n.r(e),n.d(e,{BufferGeometry:()=>w});var i=n(4532),r=n(6120),s=n(7232),a=n(9574),o=n(4430),l=n(9771),c=n(1052),u=n(1245),h=n(4894),d=n(9542),f=n(5042);let p=0;const m=new u.Matrix4,g=new c.T,v=new i.Vector3,y=new s.Box3,_=new s.Box3,x=new i.Vector3;class w extends a.p{constructor(){super(),Object.defineProperty(this,"id",{value:p++}),this.uuid=d.DO(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new((0,f.H7)(t)?o.Uint32BufferAttribute:o.Uint16BufferAttribute)(t,1):this.index=t,this}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,n=0){this.groups.push({start:t,count:e,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const n=this.attributes.normal;if(void 0!==n){const e=(new h.V).getNormalMatrix(t);n.applyNormalMatrix(e),n.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(t),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return m.makeRotationFromQuaternion(t),this.applyMatrix4(m),this}rotateX(t){return m.makeRotationX(t),this.applyMatrix4(m),this}rotateY(t){return m.makeRotationY(t),this.applyMatrix4(m),this}rotateZ(t){return m.makeRotationZ(t),this.applyMatrix4(m),this}translate(t,e,n){return m.makeTranslation(t,e,n),this.applyMatrix4(m),this}scale(t,e,n){return m.makeScale(t,e,n),this.applyMatrix4(m),this}lookAt(t){return g.lookAt(t),g.updateMatrix(),this.applyMatrix4(g.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(v).negate(),this.translate(v.x,v.y,v.z),this}setFromPoints(t){const e=[];for(let n=0,i=t.length;n<i;n++){const i=t[n];e.push(i.x,i.y,i.z||0)}return this.setAttribute("position",new o.Float32BufferAttribute(e,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new s.Box3);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingBox.set(new i.Vector3(-1/0,-1/0,-1/0),new i.Vector3(1/0,1/0,1/0));if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,n=e.length;t<n;t++){const n=e[t];y.setFromBufferAttribute(n),this.morphTargetsRelative?(x.addVectors(this.boundingBox.min,y.min),this.boundingBox.expandByPoint(x),x.addVectors(this.boundingBox.max,y.max),this.boundingBox.expandByPoint(x)):(this.boundingBox.expandByPoint(y.min),this.boundingBox.expandByPoint(y.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new l.Sphere);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error('THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere. Alternatively set "mesh.frustumCulled" to "false".',this),void this.boundingSphere.set(new i.Vector3,1/0);if(t){const n=this.boundingSphere.center;if(y.setFromBufferAttribute(t),e)for(let t=0,n=e.length;t<n;t++){const n=e[t];_.setFromBufferAttribute(n),this.morphTargetsRelative?(x.addVectors(y.min,_.min),y.expandByPoint(x),x.addVectors(y.max,_.max),y.expandByPoint(x)):(y.expandByPoint(_.min),y.expandByPoint(_.max))}y.getCenter(n);let i=0;for(let e=0,r=t.count;e<r;e++)x.fromBufferAttribute(t,e),i=Math.max(i,n.distanceToSquared(x));if(e)for(let r=0,s=e.length;r<s;r++){const s=e[r],a=this.morphTargetsRelative;for(let e=0,r=s.count;e<r;e++)x.fromBufferAttribute(s,e),a&&(v.fromBufferAttribute(t,e),x.add(v)),i=Math.max(i,n.distanceToSquared(x))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const n=t.array,s=e.position.array,a=e.normal.array,l=e.uv.array,c=s.length/3;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new o.BufferAttribute(new Float32Array(4*c),4));const u=this.getAttribute("tangent").array,h=[],d=[];for(let t=0;t<c;t++)h[t]=new i.Vector3,d[t]=new i.Vector3;const f=new i.Vector3,p=new i.Vector3,m=new i.Vector3,g=new r.Vector2,v=new r.Vector2,y=new r.Vector2,_=new i.Vector3,x=new i.Vector3;function w(t,e,n){f.fromArray(s,3*t),p.fromArray(s,3*e),m.fromArray(s,3*n),g.fromArray(l,2*t),v.fromArray(l,2*e),y.fromArray(l,2*n),p.sub(f),m.sub(f),v.sub(g),y.sub(g);const i=1/(v.x*y.y-y.x*v.y);isFinite(i)&&(_.copy(p).multiplyScalar(y.y).addScaledVector(m,-v.y).multiplyScalar(i),x.copy(m).multiplyScalar(v.x).addScaledVector(p,-y.x).multiplyScalar(i),h[t].add(_),h[e].add(_),h[n].add(_),d[t].add(x),d[e].add(x),d[n].add(x))}let b=this.groups;0===b.length&&(b=[{start:0,count:n.length}]);for(let t=0,e=b.length;t<e;++t){const e=b[t],i=e.start;for(let t=i,r=i+e.count;t<r;t+=3)w(n[t+0],n[t+1],n[t+2])}const S=new i.Vector3,E=new i.Vector3,T=new i.Vector3,M=new i.Vector3;function A(t){T.fromArray(a,3*t),M.copy(T);const e=h[t];S.copy(e),S.sub(T.multiplyScalar(T.dot(e))).normalize(),E.crossVectors(M,e);const n=E.dot(d[t])<0?-1:1;u[4*t]=S.x,u[4*t+1]=S.y,u[4*t+2]=S.z,u[4*t+3]=n}for(let t=0,e=b.length;t<e;++t){const e=b[t],i=e.start;for(let t=i,r=i+e.count;t<r;t+=3)A(n[t+0]),A(n[t+1]),A(n[t+2])}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let n=this.getAttribute("normal");if(void 0===n)n=new o.BufferAttribute(new Float32Array(3*e.count),3),this.setAttribute("normal",n);else for(let t=0,e=n.count;t<e;t++)n.setXYZ(t,0,0,0);const r=new i.Vector3,s=new i.Vector3,a=new i.Vector3,l=new i.Vector3,c=new i.Vector3,u=new i.Vector3,h=new i.Vector3,d=new i.Vector3;if(t)for(let i=0,o=t.count;i<o;i+=3){const o=t.getX(i+0),f=t.getX(i+1),p=t.getX(i+2);r.fromBufferAttribute(e,o),s.fromBufferAttribute(e,f),a.fromBufferAttribute(e,p),h.subVectors(a,s),d.subVectors(r,s),h.cross(d),l.fromBufferAttribute(n,o),c.fromBufferAttribute(n,f),u.fromBufferAttribute(n,p),l.add(h),c.add(h),u.add(h),n.setXYZ(o,l.x,l.y,l.z),n.setXYZ(f,c.x,c.y,c.z),n.setXYZ(p,u.x,u.y,u.z)}else for(let t=0,i=e.count;t<i;t+=3)r.fromBufferAttribute(e,t+0),s.fromBufferAttribute(e,t+1),a.fromBufferAttribute(e,t+2),h.subVectors(a,s),d.subVectors(r,s),h.cross(d),n.setXYZ(t+0,h.x,h.y,h.z),n.setXYZ(t+1,h.x,h.y,h.z),n.setXYZ(t+2,h.x,h.y,h.z);this.normalizeNormals(),n.needsUpdate=!0}}merge(t,e){if(!t||!t.isBufferGeometry)return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",t);void 0===e&&(e=0,console.warn("THREE.BufferGeometry.merge(): Overwriting original geometry, starting at offset=0. Use BufferGeometryUtils.mergeBufferGeometries() for lossless merge."));const n=this.attributes;for(const i in n){if(void 0===t.attributes[i])continue;const r=n[i].array,s=t.attributes[i],a=s.array,o=s.itemSize*e,l=Math.min(a.length,r.length-o);for(let t=0,e=o;t<l;t++,e++)r[e]=a[t]}return this}normalizeNormals(){const t=this.attributes.normal;for(let e=0,n=t.count;e<n;e++)x.fromBufferAttribute(t,e),x.normalize(),t.setXYZ(e,x.x,x.y,x.z)}toNonIndexed(){function t(t,e){const n=t.array,i=t.itemSize,r=t.normalized,s=new n.constructor(e.length*i);let a=0,l=0;for(let r=0,o=e.length;r<o;r++){a=t.isInterleavedBufferAttribute?e[r]*t.data.stride+t.offset:e[r]*i;for(let t=0;t<i;t++)s[l++]=n[a++]}return new o.BufferAttribute(s,i,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const e=new w,n=this.index.array,i=this.attributes;for(const r in i){const s=t(i[r],n);e.setAttribute(r,s)}const r=this.morphAttributes;for(const i in r){const s=[],a=r[i];for(let e=0,i=a.length;e<i;e++){const i=t(a[e],n);s.push(i)}e.morphAttributes[i]=s}e.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let t=0,n=s.length;t<n;t++){const n=s[t];e.addGroup(n.start,n.count,n.materialIndex)}return e}toJSON(){const t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const n in e)void 0!==e[n]&&(t[n]=e[n]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const n=this.attributes;for(const e in n){const i=n[e];t.data.attributes[e]=i.toJSON(t.data)}const i={};let r=!1;for(const e in this.morphAttributes){const n=this.morphAttributes[e],s=[];for(let e=0,i=n.length;e<i;e++){const i=n[e];s.push(i.toJSON(t.data))}s.length>0&&(i[e]=s,r=!0)}r&&(t.data.morphAttributes=i,t.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(t.data.groups=JSON.parse(JSON.stringify(s)));const a=this.boundingSphere;return null!==a&&(t.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),t}clone(){return(new this.constructor).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const n=t.index;null!==n&&this.setIndex(n.clone(e));const i=t.attributes;for(const t in i){const n=i[t];this.setAttribute(t,n.clone(e))}const r=t.morphAttributes;for(const t in r){const n=[],i=r[t];for(let t=0,r=i.length;t<r;t++)n.push(i[t].clone(e));this.morphAttributes[t]=n}this.morphTargetsRelative=t.morphTargetsRelative;const s=t.groups;for(let t=0,e=s.length;t<e;t++){const e=s[t];this.addGroup(e.start,e.count,e.materialIndex)}const a=t.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=t.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,void 0!==t.parameters&&(this.parameters=Object.assign({},t.parameters)),this}dispose(){this.dispatchEvent({type:"dispose"})}}w.prototype.isBufferGeometry=!0},9574:(t,e,n)=>{n.d(e,{p:()=>i});class i{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[t]&&(n[t]=[]),-1===n[t].indexOf(e)&&n[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const n=this._listeners;return void 0!==n[t]&&-1!==n[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const n=this._listeners[t];if(void 0!==n){const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const n=e.slice(0);for(let e=0,i=n.length;e<i;e++)n[e].call(this,t);t.target=null}}}},4691:(t,e,n)=>{n.d(e,{S:()=>i});class i{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}isEnabled(t){return 0!=(this.mask&(1<<t|0))}}},1052:(t,e,n)=>{n.d(e,{T:()=>E});var i=n(3163),r=n(4532),s=n(1245),a=n(9574),o=n(1351),l=n(4691),c=n(4894),u=n(9542);let h=0;const d=new r.Vector3,f=new i.Quaternion,p=new s.Matrix4,m=new r.Vector3,g=new r.Vector3,v=new r.Vector3,y=new i.Quaternion,_=new r.Vector3(1,0,0),x=new r.Vector3(0,1,0),w=new r.Vector3(0,0,1),b={type:"added"},S={type:"removed"};class E extends a.p{constructor(){super(),Object.defineProperty(this,"id",{value:h++}),this.uuid=u.DO(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=E.DefaultUp.clone();const t=new r.Vector3,e=new o.Euler,n=new i.Quaternion,a=new r.Vector3(1,1,1);e._onChange((function(){n.setFromEuler(e,!1)})),n._onChange((function(){e.setFromQuaternion(n,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:a},modelViewMatrix:{value:new s.Matrix4},normalMatrix:{value:new c.V}}),this.matrix=new s.Matrix4,this.matrixWorld=new s.Matrix4,this.matrixAutoUpdate=E.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new l.S,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return f.setFromAxisAngle(t,e),this.quaternion.multiply(f),this}rotateOnWorldAxis(t,e){return f.setFromAxisAngle(t,e),this.quaternion.premultiply(f),this}rotateX(t){return this.rotateOnAxis(_,t)}rotateY(t){return this.rotateOnAxis(x,t)}rotateZ(t){return this.rotateOnAxis(w,t)}translateOnAxis(t,e){return d.copy(t).applyQuaternion(this.quaternion),this.position.add(d.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(_,t)}translateY(t){return this.translateOnAxis(x,t)}translateZ(t){return this.translateOnAxis(w,t)}localToWorld(t){return t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return t.applyMatrix4(p.copy(this.matrixWorld).invert())}lookAt(t,e,n){t.isVector3?m.copy(t):m.set(t,e,n);const i=this.parent;this.updateWorldMatrix(!0,!1),g.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?p.lookAt(g,m,this.up):p.lookAt(m,g,this.up),this.quaternion.setFromRotationMatrix(p),i&&(p.extractRotation(i.matrixWorld),f.setFromRotationMatrix(p),this.quaternion.premultiply(f.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(b)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(S)),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){for(let t=0;t<this.children.length;t++){const e=this.children[t];e.parent=null,e.dispatchEvent(S)}return this.children.length=0,this}attach(t){return this.updateWorldMatrix(!0,!1),p.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),p.multiply(t.parent.matrixWorld)),t.applyMatrix4(p),this.add(t),t.updateWorldMatrix(!1,!0),this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let n=0,i=this.children.length;n<i;n++){const i=this.children[n].getObjectByProperty(t,e);if(void 0!==i)return i}}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(g,t,v),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(g,y,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let n=0,i=e.length;n<i;n++)e[n].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let n=0,i=e.length;n<i;n++)e[n].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let n=0,i=e.length;n<i;n++)e[n].updateMatrixWorld(t)}updateWorldMatrix(t,e){const n=this.parent;if(!0===t&&null!==n&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,n=t.length;e<n;e++)t[e].updateWorldMatrix(!1,!0)}}toJSON(t){const e=void 0===t||"string"==typeof t,n={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const i={};function r(e,n){return void 0===e[n.uuid]&&(e[n.uuid]=n.toJSON(t)),n.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&(i.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const n=e.shapes;if(Array.isArray(n))for(let e=0,i=n.length;e<i;e++){const i=n[e];r(t.shapes,i)}else r(t.shapes,n)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let n=0,i=this.material.length;n<i;n++)e.push(r(t.materials,this.material[n]));i.material=e}else i.material=r(t.materials,this.material);if(this.children.length>0){i.children=[];for(let e=0;e<this.children.length;e++)i.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){i.animations=[];for(let e=0;e<this.animations.length;e++){const n=this.animations[e];i.animations.push(r(t.animations,n))}}if(e){const e=s(t.geometries),i=s(t.materials),r=s(t.textures),a=s(t.images),o=s(t.shapes),l=s(t.skeletons),c=s(t.animations),u=s(t.nodes);e.length>0&&(n.geometries=e),i.length>0&&(n.materials=i),r.length>0&&(n.textures=r),a.length>0&&(n.images=a),o.length>0&&(n.shapes=o),l.length>0&&(n.skeletons=l),c.length>0&&(n.animations=c),u.length>0&&(n.nodes=u)}return n.object=i,n;function s(t){const e=[];for(const n in t){const i=t[n];delete i.metadata,e.push(i)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const n=t.children[e];this.add(n.clone())}return this}}E.DefaultUp=new r.Vector3(0,1,0),E.DefaultMatrixAutoUpdate=!0,E.prototype.isObject3D=!0},5579:(t,e,n)=>{n.r(e),n.d(e,{Raycaster:()=>s});var i=n(2081),r=n(4691);class s{constructor(t,e,n=0,s=1/0){this.ray=new i.z(t,e),this.near=n,this.far=s,this.camera=null,this.layers=new r.S,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(t,e){this.ray.set(t,e)}setFromCamera(t,e){e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize(),this.camera=e):e.isOrthographicCamera?(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld),this.camera=e):console.error("THREE.Raycaster: Unsupported camera type: "+e.type)}intersectObject(t,e=!0,n=[]){return o(t,this,n,e),n.sort(a),n}intersectObjects(t,e=!0,n=[]){for(let i=0,r=t.length;i<r;i++)o(t[i],this,n,e);return n.sort(a),n}}function a(t,e){return t.distance-e.distance}function o(t,e,n,i){if(t.layers.test(e.layers)&&t.raycast(e,n),!0===i){const i=t.children;for(let t=0,r=i.length;t<r;t++)o(i[t],e,n,!0)}}},2564:(t,e,n)=>{n.d(e,{P:()=>a});var i=n(5042),r=n(6850);let s;class a{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===s&&(s=(0,i.c)("canvas")),s.width=t.width,s.height=t.height;const n=s.getContext("2d");t instanceof ImageData?n.putImageData(t,0,0):n.drawImage(t,0,0,t.width,t.height),e=s}return e.width>2048||e.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=(0,i.c)("canvas");e.width=t.width,e.height=t.height;const n=e.getContext("2d");n.drawImage(t,0,0,t.width,t.height);const s=n.getImageData(0,0,t.width,t.height),a=s.data;for(let t=0;t<a.length;t++)a[t]=255*(0,r.PB)(a[t]/255);return n.putImageData(s,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*(0,r.PB)(e[t]/255)):e[t]=(0,r.PB)(e[t]);return{data:e,width:t.width,height:t.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}},3827:(t,e,n)=>{n.r(e),n.d(e,{BoxBufferGeometry:()=>a,BoxGeometry:()=>a});var i=n(5699),r=n(4430),s=n(4532);class a extends i.BufferGeometry{constructor(t=1,e=1,n=1,i=1,a=1,o=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:n,widthSegments:i,heightSegments:a,depthSegments:o};const l=this;i=Math.floor(i),a=Math.floor(a),o=Math.floor(o);const c=[],u=[],h=[],d=[];let f=0,p=0;function m(t,e,n,i,r,a,o,m,g,v,y){const _=a/g,x=o/v,w=a/2,b=o/2,S=m/2,E=g+1,T=v+1;let M=0,A=0;const I=new s.Vector3;for(let s=0;s<T;s++){const a=s*x-b;for(let o=0;o<E;o++){const l=o*_-w;I[t]=l*i,I[e]=a*r,I[n]=S,u.push(I.x,I.y,I.z),I[t]=0,I[e]=0,I[n]=m>0?1:-1,h.push(I.x,I.y,I.z),d.push(o/g),d.push(1-s/v),M+=1}}for(let t=0;t<v;t++)for(let e=0;e<g;e++){const n=f+e+E*t,i=f+e+E*(t+1),r=f+(e+1)+E*(t+1),s=f+(e+1)+E*t;c.push(n,i,s),c.push(i,r,s),A+=6}l.addGroup(p,A,y),p+=A,f+=M}m("z","y","x",-1,-1,n,e,t,o,a,0),m("z","y","x",1,-1,n,e,-t,o,a,1),m("x","z","y",1,1,t,n,e,i,o,2),m("x","z","y",1,-1,t,n,-e,i,o,3),m("x","y","z",1,-1,t,e,n,i,a,4),m("x","y","z",-1,-1,t,e,-n,i,a,5),this.setIndex(c),this.setAttribute("position",new r.Float32BufferAttribute(u,3)),this.setAttribute("normal",new r.Float32BufferAttribute(h,3)),this.setAttribute("uv",new r.Float32BufferAttribute(d,2))}static fromJSON(t){return new a(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}},2848:(t,e,n)=>{n.r(e),n.d(e,{PlaneBufferGeometry:()=>s,PlaneGeometry:()=>s});var i=n(5699),r=n(4430);class s extends i.BufferGeometry{constructor(t=1,e=1,n=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:n,heightSegments:i};const s=t/2,a=e/2,o=Math.floor(n),l=Math.floor(i),c=o+1,u=l+1,h=t/o,d=e/l,f=[],p=[],m=[],g=[];for(let t=0;t<u;t++){const e=t*d-a;for(let n=0;n<c;n++){const i=n*h-s;p.push(i,-e,0),m.push(0,0,1),g.push(n/o),g.push(1-t/l)}}for(let t=0;t<l;t++)for(let e=0;e<o;e++){const n=e+c*t,i=e+c*(t+1),r=e+1+c*(t+1),s=e+1+c*t;f.push(n,i,s),f.push(i,r,s)}this.setIndex(f),this.setAttribute("position",new r.Float32BufferAttribute(p,3)),this.setAttribute("normal",new r.Float32BufferAttribute(m,3)),this.setAttribute("uv",new r.Float32BufferAttribute(g,2))}static fromJSON(t){return new s(t.width,t.height,t.widthSegments,t.heightSegments)}}},3603:(t,e,n)=>{n.r(e),n.d(e,{AmbientLight:()=>r});var i=n(7675);class r extends i._{constructor(t,e){super(t,e),this.type="AmbientLight"}}r.prototype.isAmbientLight=!0},3492:(t,e,n)=>{n.r(e),n.d(e,{DirectionalLight:()=>l});var i=n(7675),r=n(6139),s=n(4152);class a extends r.h{constructor(){super(new s.i(-5,5,5,-5,.5,500))}}a.prototype.isDirectionalLightShadow=!0;var o=n(1052);class l extends i._{constructor(t,e){super(t,e),this.type="DirectionalLight",this.position.copy(o.T.DefaultUp),this.updateMatrix(),this.target=new o.T,this.shadow=new a}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}l.prototype.isDirectionalLight=!0},7675:(t,e,n)=>{n.d(e,{_:()=>s});var i=n(1052),r=n(7282);class s extends i.T{constructor(t,e=1){super(),this.type="Light",this.color=new r.Color(t),this.intensity=e}dispose(){}copy(t){return super.copy(t),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){const e=super.toJSON(t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}s.prototype.isLight=!0},6139:(t,e,n)=>{n.d(e,{h:()=>h});var i=n(1245),r=n(6120),s=n(4532),a=n(6980),o=n(3871);const l=new i.Matrix4,c=new s.Vector3,u=new s.Vector3;class h{constructor(t){this.camera=t,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new r.Vector2(512,512),this.map=null,this.mapPass=null,this.matrix=new i.Matrix4,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new o.i,this._frameExtents=new r.Vector2(1,1),this._viewportCount=1,this._viewports=[new a.L(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(t){const e=this.camera,n=this.matrix;c.setFromMatrixPosition(t.matrixWorld),e.position.copy(c),u.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(u),e.updateMatrixWorld(),l.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(l),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply(e.projectionMatrix),n.multiply(e.matrixWorldInverse)}getViewport(t){return this._viewports[t]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const t={};return 0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}},9396:(t,e,n)=>{n.r(e),n.d(e,{PointLight:()=>p});var i=n(7675),r=n(6139),s=n(2096),a=n(1245),o=n(6120),l=n(4532),c=n(6980);const u=new a.Matrix4,h=new l.Vector3,d=new l.Vector3;class f extends r.h{constructor(){super(new s.PerspectiveCamera(90,1,.5,500)),this._frameExtents=new o.Vector2(4,2),this._viewportCount=6,this._viewports=[new c.L(2,1,1,1),new c.L(0,1,1,1),new c.L(3,1,1,1),new c.L(1,1,1,1),new c.L(3,0,1,1),new c.L(1,0,1,1)],this._cubeDirections=[new l.Vector3(1,0,0),new l.Vector3(-1,0,0),new l.Vector3(0,0,1),new l.Vector3(0,0,-1),new l.Vector3(0,1,0),new l.Vector3(0,-1,0)],this._cubeUps=[new l.Vector3(0,1,0),new l.Vector3(0,1,0),new l.Vector3(0,1,0),new l.Vector3(0,1,0),new l.Vector3(0,0,1),new l.Vector3(0,0,-1)]}updateMatrices(t,e=0){const n=this.camera,i=this.matrix,r=t.distance||n.far;r!==n.far&&(n.far=r,n.updateProjectionMatrix()),h.setFromMatrixPosition(t.matrixWorld),n.position.copy(h),d.copy(n.position),d.add(this._cubeDirections[e]),n.up.copy(this._cubeUps[e]),n.lookAt(d),n.updateMatrixWorld(),i.makeTranslation(-h.x,-h.y,-h.z),u.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),this._frustum.setFromProjectionMatrix(u)}}f.prototype.isPointLightShadow=!0;class p extends i._{constructor(t,e,n=0,i=1){super(t,e),this.type="PointLight",this.distance=n,this.decay=i,this.shadow=new f}get power(){return 4*this.intensity*Math.PI}set power(t){this.intensity=t/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(t){return super.copy(t),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}p.prototype.isPointLight=!0},142:(t,e,n)=>{n.r(e),n.d(e,{CubeTextureLoader:()=>a});var i=n(6196),r=n(546),s=n(5489);class a extends s.a{constructor(t){super(t)}load(t,e,n,s){const a=new r.B,o=new i.S(this.manager);o.setCrossOrigin(this.crossOrigin),o.setPath(this.path);let l=0;function c(n){o.load(t[n],(function(t){a.images[n]=t,l++,6===l&&(a.needsUpdate=!0,e&&e(a))}),void 0,s)}for(let e=0;e<t.length;++e)c(e);return a}}},6196:(t,e,n)=>{n.d(e,{S:()=>a});const i={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};var r=n(5489),s=n(5042);class a extends r.a{constructor(t){super(t)}load(t,e,n,r){void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);const a=this,o=i.get(t);if(void 0!==o)return a.manager.itemStart(t),setTimeout((function(){e&&e(o),a.manager.itemEnd(t)}),0),o;const l=(0,s.c)("img");function c(){h(),i.add(t,this),e&&e(this),a.manager.itemEnd(t)}function u(e){h(),r&&r(e),a.manager.itemError(t),a.manager.itemEnd(t)}function h(){l.removeEventListener("load",c,!1),l.removeEventListener("error",u,!1)}return l.addEventListener("load",c,!1),l.addEventListener("error",u,!1),"data:"!==t.slice(0,5)&&void 0!==this.crossOrigin&&(l.crossOrigin=this.crossOrigin),a.manager.itemStart(t),l.src=t,l}}},5489:(t,e,n)=>{n.d(e,{a:()=>r});const i=new class{constructor(t,e,n){const i=this;let r,s=!1,a=0,o=0;const l=[];this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=n,this.itemStart=function(t){o++,!1===s&&void 0!==i.onStart&&i.onStart(t,a,o),s=!0},this.itemEnd=function(t){a++,void 0!==i.onProgress&&i.onProgress(t,a,o),a===o&&(s=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(t){void 0!==i.onError&&i.onError(t)},this.resolveURL=function(t){return r?r(t):t},this.setURLModifier=function(t){return r=t,this},this.addHandler=function(t,e){return l.push(t,e),this},this.removeHandler=function(t){const e=l.indexOf(t);return-1!==e&&l.splice(e,2),this},this.getHandler=function(t){for(let e=0,n=l.length;e<n;e+=2){const n=l[e],i=l[e+1];if(n.global&&(n.lastIndex=0),n.test(t))return i}return null}}};class r{constructor(t){this.manager=void 0!==t?t:i,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(t,e){const n=this;return new Promise((function(i,r){n.load(t,i,e,r)}))}parse(){}setCrossOrigin(t){return this.crossOrigin=t,this}setWithCredentials(t){return this.withCredentials=t,this}setPath(t){return this.path=t,this}setResourcePath(t){return this.resourcePath=t,this}setRequestHeader(t){return this.requestHeader=t,this}}},406:(t,e,n)=>{n.d(e,{F:()=>o});var i=n(9574),r=n(7006),s=n(9542);let a=0;class o extends i.p{constructor(){super(),Object.defineProperty(this,"id",{value:a++}),this.uuid=s.DO(),this.name="",this.type="Material",this.blending=r.bdR,this.side=r.Wl3,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.blendSrc=r.k74,this.blendDst=r.LgZ,this.blendEquation=r.bGH,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=r.vCF,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=r.cum,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=r.x5V,this.stencilZFail=r.x5V,this.stencilZPass=r.x5V,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBuild(){}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(const e in t){const n=t[e];if(void 0===n){console.warn("THREE.Material: '"+e+"' parameter is undefined.");continue}if("shading"===e){console.warn("THREE."+this.type+": .shading has been removed. Use the boolean .flatShading instead."),this.flatShading=n===r.esl;continue}const i=this[e];void 0!==i?i&&i.isColor?i.set(n):i&&i.isVector3&&n&&n.isVector3?i.copy(n):this[e]=n:console.warn("THREE."+this.type+": '"+e+"' is not a property of this material.")}}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const n={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function i(t){const e=[];for(const n in t){const i=t[n];delete i.metadata,e.push(i)}return e}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),void 0!==this.sheen&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),this.emissiveIntensity&&1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearcoat&&(n.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(t).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(t).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(t).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(t).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(t).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(t).uuid,void 0!==this.combine&&(n.combine=this.combine)),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(n.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.transmission&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(t).uuid),void 0!==this.thickness&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(t).uuid),void 0!==this.attenuationDistance&&(n.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(n.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(n.size=this.size),null!==this.shadowSide&&(n.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),this.blending!==r.bdR&&(n.blending=this.blending),this.side!==r.Wl3&&(n.side=this.side),this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=this.transparent),n.depthFunc=this.depthFunc,n.depthTest=this.depthTest,n.depthWrite=this.depthWrite,n.colorWrite=this.colorWrite,n.stencilWrite=this.stencilWrite,n.stencilWriteMask=this.stencilWriteMask,n.stencilFunc=this.stencilFunc,n.stencilRef=this.stencilRef,n.stencilFuncMask=this.stencilFuncMask,n.stencilFail=this.stencilFail,n.stencilZFail=this.stencilZFail,n.stencilZPass=this.stencilZPass,void 0!==this.rotation&&0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.alphaToCoverage&&(n.alphaToCoverage=this.alphaToCoverage),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(n.wireframe=this.wireframe),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(n.flatShading=this.flatShading),!1===this.visible&&(n.visible=!1),!1===this.toneMapped&&(n.toneMapped=!1),!1===this.fog&&(n.fog=!1),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),e){const e=i(t.textures),r=i(t.images);e.length>0&&(n.textures=e),r.length>0&&(n.images=r)}return n}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let n=null;if(null!==e){const t=e.length;n=new Array(t);for(let i=0;i!==t;++i)n[i]=e[i].clone()}return this.clippingPlanes=n,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}}o.prototype.isMaterial=!0,o.fromType=function(){return null}},4033:(t,e,n)=>{n.r(e),n.d(e,{MeshBasicMaterial:()=>a});var i=n(406),r=n(7006),s=n(7282);class a extends i.F{constructor(t){super(),this.type="MeshBasicMaterial",this.color=new s.Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=r.Ns1,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}a.prototype.isMeshBasicMaterial=!0},9624:(t,e,n)=>{n.r(e),n.d(e,{MeshPhongMaterial:()=>o});var i=n(7006),r=n(406),s=n(6120),a=n(7282);class o extends r.F{constructor(t){super(),this.type="MeshPhongMaterial",this.color=new a.Color(16777215),this.specular=new a.Color(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new a.Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=i.IOt,this.normalScale=new s.Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=i.Ns1,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}o.prototype.isMeshPhongMaterial=!0},6997:(t,e,n)=>{n.r(e),n.d(e,{MeshStandardMaterial:()=>o});var i=n(7006),r=n(406),s=n(6120),a=n(7282);class o extends r.F{constructor(t){super(),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new a.Color(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new a.Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=i.IOt,this.normalScale=new s.Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}o.prototype.isMeshStandardMaterial=!0},7613:(t,e,n)=>{n.r(e),n.d(e,{RawShaderMaterial:()=>r});var i=n(407);class r extends i.ShaderMaterial{constructor(t){super(t),this.type="RawShaderMaterial"}}r.prototype.isRawShaderMaterial=!0},407:(t,e,n)=>{n.r(e),n.d(e,{ShaderMaterial:()=>s});var i=n(406),r=n(8369);class s extends i.F{constructor(t){super(),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="\nvoid main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n",this.fragmentShader="\nvoid main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}\n",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&(void 0!==t.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(t))}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=(0,r.dw)(t.uniforms),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.fog=t.fog,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){const e=super.toJSON(t);e.glslVersion=this.glslVersion,e.uniforms={};for(const n in this.uniforms){const i=this.uniforms[n].value;i&&i.isTexture?e.uniforms[n]={type:"t",value:i.toJSON(t).uuid}:i&&i.isColor?e.uniforms[n]={type:"c",value:i.getHex()}:i&&i.isVector2?e.uniforms[n]={type:"v2",value:i.toArray()}:i&&i.isVector3?e.uniforms[n]={type:"v3",value:i.toArray()}:i&&i.isVector4?e.uniforms[n]={type:"v4",value:i.toArray()}:i&&i.isMatrix3?e.uniforms[n]={type:"m3",value:i.toArray()}:i&&i.isMatrix4?e.uniforms[n]={type:"m4",value:i.toArray()}:e.uniforms[n]={value:i}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader;const n={};for(const t in this.extensions)!0===this.extensions[t]&&(n[t]=!0);return Object.keys(n).length>0&&(e.extensions=n),e}}s.prototype.isShaderMaterial=!0},7232:(t,e,n)=>{n.r(e),n.d(e,{Box3:()=>r});var i=n(4532);class r{constructor(t=new i.Vector3(1/0,1/0,1/0),e=new i.Vector3(-1/0,-1/0,-1/0)){this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){let e=1/0,n=1/0,i=1/0,r=-1/0,s=-1/0,a=-1/0;for(let o=0,l=t.length;o<l;o+=3){const l=t[o],c=t[o+1],u=t[o+2];l<e&&(e=l),c<n&&(n=c),u<i&&(i=u),l>r&&(r=l),c>s&&(s=c),u>a&&(a=u)}return this.min.set(e,n,i),this.max.set(r,s,a),this}setFromBufferAttribute(t){let e=1/0,n=1/0,i=1/0,r=-1/0,s=-1/0,a=-1/0;for(let o=0,l=t.count;o<l;o++){const l=t.getX(o),c=t.getY(o),u=t.getZ(o);l<e&&(e=l),c<n&&(n=c),u<i&&(i=u),l>r&&(r=l),c>s&&(s=c),u>a&&(a=u)}return this.min.set(e,n,i),this.max.set(r,s,a),this}setFromPoints(t){this.makeEmpty();for(let e=0,n=t.length;e<n;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const n=a.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const n=t.geometry;if(void 0!==n)if(e&&null!=n.attributes&&void 0!==n.attributes.position){const e=n.attributes.position;for(let n=0,i=e.count;n<i;n++)a.fromBufferAttribute(e,n).applyMatrix4(t.matrixWorld),this.expandByPoint(a)}else null===n.boundingBox&&n.computeBoundingBox(),o.copy(n.boundingBox),o.applyMatrix4(t.matrixWorld),this.union(o);const i=t.children;for(let t=0,n=i.length;t<n;t++)this.expandByObject(i[t],e);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,a),a.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,n;return t.normal.x>0?(e=t.normal.x*this.min.x,n=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,n=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,n+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,n+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,n+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,n+=t.normal.z*this.min.z),e<=-t.constant&&n>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(p),m.subVectors(this.max,p),l.subVectors(t.a,p),c.subVectors(t.b,p),u.subVectors(t.c,p),h.subVectors(c,l),d.subVectors(u,c),f.subVectors(l,u);let e=[0,-h.z,h.y,0,-d.z,d.y,0,-f.z,f.y,h.z,0,-h.x,d.z,0,-d.x,f.z,0,-f.x,-h.y,h.x,0,-d.y,d.x,0,-f.y,f.x,0];return!!y(e,l,c,u,m)&&(e=[1,0,0,0,1,0,0,0,1],!!y(e,l,c,u,m)&&(g.crossVectors(h,d),e=[g.x,g.y,g.z],y(e,l,c,u,m)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return a.copy(t).clamp(this.min,this.max).sub(t).length()}getBoundingSphere(t){return this.getCenter(t.center),t.radius=.5*this.getSize(a).length(),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(s[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),s[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),s[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),s[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),s[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),s[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),s[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),s[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(s)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}r.prototype.isBox3=!0;const s=[new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3,new i.Vector3],a=new i.Vector3,o=new r,l=new i.Vector3,c=new i.Vector3,u=new i.Vector3,h=new i.Vector3,d=new i.Vector3,f=new i.Vector3,p=new i.Vector3,m=new i.Vector3,g=new i.Vector3,v=new i.Vector3;function y(t,e,n,i,r){for(let s=0,a=t.length-3;s<=a;s+=3){v.fromArray(t,s);const a=r.x*Math.abs(v.x)+r.y*Math.abs(v.y)+r.z*Math.abs(v.z),o=e.dot(v),l=n.dot(v),c=i.dot(v);if(Math.max(-Math.max(o,l,c),Math.min(o,l,c))>a)return!1}return!0}},7282:(t,e,n)=>{n.r(e),n.d(e,{Color:()=>d,SRGBToLinear:()=>r.PB});var i=n(9542),r=n(6850),s=n(7006);const a={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},o={r:0,g:0,b:0},l={h:0,s:0,l:0},c={h:0,s:0,l:0};function u(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+6*(e-t)*n:n<.5?e:n<2/3?t+6*(e-t)*(2/3-n):t}function h(t,e){return e.r=t.r,e.g=t.g,e.b=t.b,e}class d{constructor(t,e,n){return void 0===e&&void 0===n?this.set(t):this.setRGB(t,e,n)}set(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=s.KI_){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,r.ep.toWorkingColorSpace(this,e),this}setRGB(t,e,n,i=s.GUF){return this.r=t,this.g=e,this.b=n,r.ep.toWorkingColorSpace(this,i),this}setHSL(t,e,n,a=s.GUF){if(t=(0,i.kz)(t,1),e=(0,i.uZ)(e,0,1),n=(0,i.uZ)(n,0,1),0===e)this.r=this.g=this.b=n;else{const i=n<=.5?n*(1+e):n+e-n*e,r=2*n-i;this.r=u(r,i,t+1/3),this.g=u(r,i,t),this.b=u(r,i,t-1/3)}return r.ep.toWorkingColorSpace(this,a),this}setStyle(t,e=s.KI_){function n(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let i;if(i=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(t)){let t;const s=i[1],a=i[2];switch(s){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,r.ep.toWorkingColorSpace(this,e),n(t[4]),this;if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,r.ep.toWorkingColorSpace(this,e),n(t[4]),this;break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a)){const i=parseFloat(t[1])/360,r=parseInt(t[2],10)/100,s=parseInt(t[3],10)/100;return n(t[4]),this.setHSL(i,r,s,e)}}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=i[1],n=t.length;if(3===n)return this.r=parseInt(t.charAt(0)+t.charAt(0),16)/255,this.g=parseInt(t.charAt(1)+t.charAt(1),16)/255,this.b=parseInt(t.charAt(2)+t.charAt(2),16)/255,r.ep.toWorkingColorSpace(this,e),this;if(6===n)return this.r=parseInt(t.charAt(0)+t.charAt(1),16)/255,this.g=parseInt(t.charAt(2)+t.charAt(3),16)/255,this.b=parseInt(t.charAt(4)+t.charAt(5),16)/255,r.ep.toWorkingColorSpace(this,e),this}return t&&t.length>0?this.setColorName(t,e):this}setColorName(t,e=s.KI_){const n=a[t.toLowerCase()];return void 0!==n?this.setHex(n,e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=(0,r.PB)(t.r),this.g=(0,r.PB)(t.g),this.b=(0,r.PB)(t.b),this}copyLinearToSRGB(t){return this.r=(0,r.QP)(t.r),this.g=(0,r.QP)(t.g),this.b=(0,r.QP)(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=s.KI_){return r.ep.fromWorkingColorSpace(h(this,o),t),(0,i.uZ)(255*o.r,0,255)<<16^(0,i.uZ)(255*o.g,0,255)<<8^(0,i.uZ)(255*o.b,0,255)<<0}getHexString(t=s.KI_){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=s.GUF){r.ep.fromWorkingColorSpace(h(this,o),e);const n=o.r,i=o.g,a=o.b,l=Math.max(n,i,a),c=Math.min(n,i,a);let u,d;const f=(c+l)/2;if(c===l)u=0,d=0;else{const t=l-c;switch(d=f<=.5?t/(l+c):t/(2-l-c),l){case n:u=(i-a)/t+(i<a?6:0);break;case i:u=(a-n)/t+2;break;case a:u=(n-i)/t+4}u/=6}return t.h=u,t.s=d,t.l=f,t}getRGB(t,e=s.GUF){return r.ep.fromWorkingColorSpace(h(this,o),e),t.r=o.r,t.g=o.g,t.b=o.b,t}getStyle(t=s.KI_){return r.ep.fromWorkingColorSpace(h(this,o),t),t!==s.KI_?`color(${t} ${o.r} ${o.g} ${o.b})`:`rgb(${255*o.r|0},${255*o.g|0},${255*o.b|0})`}offsetHSL(t,e,n){return this.getHSL(l),l.h+=t,l.s+=e,l.l+=n,this.setHSL(l.h,l.s,l.l),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,n){return this.r=t.r+(e.r-t.r)*n,this.g=t.g+(e.g-t.g)*n,this.b=t.b+(e.b-t.b)*n,this}lerpHSL(t,e){this.getHSL(l),t.getHSL(c);const n=(0,i.t7)(l.h,c.h,e),r=(0,i.t7)(l.s,c.s,e),s=(0,i.t7)(l.l,c.l,e);return this.setHSL(n,r,s),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),!0===t.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}d.NAMES=a,d.prototype.isColor=!0,d.prototype.r=1,d.prototype.g=1,d.prototype.b=1},6850:(t,e,n)=>{n.d(e,{PB:()=>r,QP:()=>s,ep:()=>o});var i=n(7006);function r(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function s(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}const a={[i.KI_]:{[i.GUF]:r},[i.GUF]:{[i.KI_]:s}},o={legacyMode:!0,get workingColorSpace(){return i.GUF},set workingColorSpace(t){console.warn("THREE.ColorManagement: .workingColorSpace is readonly.")},convert:function(t,e,n){if(this.legacyMode||e===n||!e||!n)return t;if(a[e]&&void 0!==a[e][n]){const i=a[e][n];return t.r=i(t.r),t.g=i(t.g),t.b=i(t.b),t}throw new Error("Unsupported color space conversion.")},fromWorkingColorSpace:function(t,e){return this.convert(t,this.workingColorSpace,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this.workingColorSpace)}}},3871:(t,e,n)=>{n.d(e,{i:()=>l});var i=n(4532),r=n(9771),s=n(2158);const a=new r.Sphere,o=new i.Vector3;class l{constructor(t=new s.J,e=new s.J,n=new s.J,i=new s.J,r=new s.J,a=new s.J){this.planes=[t,e,n,i,r,a]}set(t,e,n,i,r,s){const a=this.planes;return a[0].copy(t),a[1].copy(e),a[2].copy(n),a[3].copy(i),a[4].copy(r),a[5].copy(s),this}copy(t){const e=this.planes;for(let n=0;n<6;n++)e[n].copy(t.planes[n]);return this}setFromProjectionMatrix(t){const e=this.planes,n=t.elements,i=n[0],r=n[1],s=n[2],a=n[3],o=n[4],l=n[5],c=n[6],u=n[7],h=n[8],d=n[9],f=n[10],p=n[11],m=n[12],g=n[13],v=n[14],y=n[15];return e[0].setComponents(a-i,u-o,p-h,y-m).normalize(),e[1].setComponents(a+i,u+o,p+h,y+m).normalize(),e[2].setComponents(a+r,u+l,p+d,y+g).normalize(),e[3].setComponents(a-r,u-l,p-d,y-g).normalize(),e[4].setComponents(a-s,u-c,p-f,y-v).normalize(),e[5].setComponents(a+s,u+c,p+f,y+v).normalize(),this}intersectsObject(t){const e=t.geometry;return null===e.boundingSphere&&e.computeBoundingSphere(),a.copy(e.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(a)}intersectsSprite(t){return a.center.set(0,0,0),a.radius=.7071067811865476,a.applyMatrix4(t.matrixWorld),this.intersectsSphere(a)}intersectsSphere(t){const e=this.planes,n=t.center,i=-t.radius;for(let t=0;t<6;t++)if(e[t].distanceToPoint(n)<i)return!1;return!0}intersectsBox(t){const e=this.planes;for(let n=0;n<6;n++){const i=e[n];if(o.x=i.normal.x>0?t.max.x:t.min.x,o.y=i.normal.y>0?t.max.y:t.min.y,o.z=i.normal.z>0?t.max.z:t.min.z,i.distanceToPoint(o)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let n=0;n<6;n++)if(e[n].distanceToPoint(t)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}},9542:(t,e,n)=>{n.d(e,{DO:()=>a,I3:()=>s,gy:()=>h,kz:()=>l,qW:()=>r,t7:()=>c,uZ:()=>o,wt:()=>u});const i=[];for(let t=0;t<256;t++)i[t]=(t<16?"0":"")+t.toString(16);const r=Math.PI/180,s=180/Math.PI;function a(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,n=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return(i[255&t]+i[t>>8&255]+i[t>>16&255]+i[t>>24&255]+"-"+i[255&e]+i[e>>8&255]+"-"+i[e>>16&15|64]+i[e>>24&255]+"-"+i[63&n|128]+i[n>>8&255]+"-"+i[n>>16&255]+i[n>>24&255]+i[255&r]+i[r>>8&255]+i[r>>16&255]+i[r>>24&255]).toLowerCase()}function o(t,e,n){return Math.max(e,Math.min(n,t))}function l(t,e){return(t%e+e)%e}function c(t,e,n){return(1-n)*t+n*e}function u(t){return 0==(t&t-1)&&0!==t}function h(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}},4894:(t,e,n)=>{n.d(e,{V:()=>i});class i{constructor(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(t,e,n,i,r,s,a,o,l){const c=this.elements;return c[0]=t,c[1]=i,c[2]=a,c[3]=e,c[4]=r,c[5]=o,c[6]=n,c[7]=s,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,n=t.elements;return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],this}extractBasis(t,e,n){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const n=t.elements,i=e.elements,r=this.elements,s=n[0],a=n[3],o=n[6],l=n[1],c=n[4],u=n[7],h=n[2],d=n[5],f=n[8],p=i[0],m=i[3],g=i[6],v=i[1],y=i[4],_=i[7],x=i[2],w=i[5],b=i[8];return r[0]=s*p+a*v+o*x,r[3]=s*m+a*y+o*w,r[6]=s*g+a*_+o*b,r[1]=l*p+c*v+u*x,r[4]=l*m+c*y+u*w,r[7]=l*g+c*_+u*b,r[2]=h*p+d*v+f*x,r[5]=h*m+d*y+f*w,r[8]=h*g+d*_+f*b,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],n=t[1],i=t[2],r=t[3],s=t[4],a=t[5],o=t[6],l=t[7],c=t[8];return e*s*c-e*a*l-n*r*c+n*a*o+i*r*l-i*s*o}invert(){const t=this.elements,e=t[0],n=t[1],i=t[2],r=t[3],s=t[4],a=t[5],o=t[6],l=t[7],c=t[8],u=c*s-a*l,h=a*o-c*r,d=l*r-s*o,f=e*u+n*h+i*d;if(0===f)return this.set(0,0,0,0,0,0,0,0,0);const p=1/f;return t[0]=u*p,t[1]=(i*l-c*n)*p,t[2]=(a*n-i*s)*p,t[3]=h*p,t[4]=(c*e-i*o)*p,t[5]=(i*r-a*e)*p,t[6]=d*p,t[7]=(n*o-l*e)*p,t[8]=(s*e-n*r)*p,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,n,i,r,s,a){const o=Math.cos(r),l=Math.sin(r);return this.set(n*o,n*l,-n*(o*s+l*a)+s+t,-i*l,i*o,-i*(-l*s+o*a)+a+e,0,0,1),this}scale(t,e){const n=this.elements;return n[0]*=t,n[3]*=t,n[6]*=t,n[1]*=e,n[4]*=e,n[7]*=e,this}rotate(t){const e=Math.cos(t),n=Math.sin(t),i=this.elements,r=i[0],s=i[3],a=i[6],o=i[1],l=i[4],c=i[7];return i[0]=e*r+n*o,i[3]=e*s+n*l,i[6]=e*a+n*c,i[1]=-n*r+e*o,i[4]=-n*s+e*l,i[7]=-n*a+e*c,this}translate(t,e){const n=this.elements;return n[0]+=t*n[2],n[3]+=t*n[5],n[6]+=t*n[8],n[1]+=e*n[2],n[4]+=e*n[5],n[7]+=e*n[8],this}equals(t){const e=this.elements,n=t.elements;for(let t=0;t<9;t++)if(e[t]!==n[t])return!1;return!0}fromArray(t,e=0){for(let n=0;n<9;n++)this.elements[n]=t[n+e];return this}toArray(t=[],e=0){const n=this.elements;return t[e]=n[0],t[e+1]=n[1],t[e+2]=n[2],t[e+3]=n[3],t[e+4]=n[4],t[e+5]=n[5],t[e+6]=n[6],t[e+7]=n[7],t[e+8]=n[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}i.prototype.isMatrix3=!0},2158:(t,e,n)=>{n.d(e,{J:()=>l});var i=n(4894),r=n(4532);const s=new r.Vector3,a=new r.Vector3,o=new i.V;class l{constructor(t=new r.Vector3(1,0,0),e=0){this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,n,i){return this.normal.set(t,e,n),this.constant=i,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,n){const i=s.subVectors(n,e).cross(a.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(i,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)}intersectLine(t,e){const n=t.delta(s),i=this.normal.dot(n);if(0===i)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const r=-(t.start.dot(this.normal)+this.constant)/i;return r<0||r>1?null:e.copy(n).multiplyScalar(r).add(t.start)}intersectsLine(t){const e=this.distanceToPoint(t.start),n=this.distanceToPoint(t.end);return e<0&&n>0||n<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const n=e||o.getNormalMatrix(t),i=this.coplanarPoint(s).applyMatrix4(t),r=this.normal.applyMatrix3(n).normalize();return this.constant=-i.dot(r),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}l.prototype.isPlane=!0},3163:(t,e,n)=>{n.r(e),n.d(e,{Quaternion:()=>r});var i=n(9542);class r{constructor(t=0,e=0,n=0,i=1){this._x=t,this._y=e,this._z=n,this._w=i}static slerp(t,e,n,i){return console.warn("THREE.Quaternion: Static .slerp() has been deprecated. Use qm.slerpQuaternions( qa, qb, t ) instead."),n.slerpQuaternions(t,e,i)}static slerpFlat(t,e,n,i,r,s,a){let o=n[i+0],l=n[i+1],c=n[i+2],u=n[i+3];const h=r[s+0],d=r[s+1],f=r[s+2],p=r[s+3];if(0===a)return t[e+0]=o,t[e+1]=l,t[e+2]=c,void(t[e+3]=u);if(1===a)return t[e+0]=h,t[e+1]=d,t[e+2]=f,void(t[e+3]=p);if(u!==p||o!==h||l!==d||c!==f){let t=1-a;const e=o*h+l*d+c*f+u*p,n=e>=0?1:-1,i=1-e*e;if(i>Number.EPSILON){const r=Math.sqrt(i),s=Math.atan2(r,e*n);t=Math.sin(t*s)/r,a=Math.sin(a*s)/r}const r=a*n;if(o=o*t+h*r,l=l*t+d*r,c=c*t+f*r,u=u*t+p*r,t===1-a){const t=1/Math.sqrt(o*o+l*l+c*c+u*u);o*=t,l*=t,c*=t,u*=t}}t[e]=o,t[e+1]=l,t[e+2]=c,t[e+3]=u}static multiplyQuaternionsFlat(t,e,n,i,r,s){const a=n[i],o=n[i+1],l=n[i+2],c=n[i+3],u=r[s],h=r[s+1],d=r[s+2],f=r[s+3];return t[e]=a*f+c*u+o*d-l*h,t[e+1]=o*f+c*h+l*u-a*d,t[e+2]=l*f+c*d+a*h-o*u,t[e+3]=c*f-a*u-o*h-l*d,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,n,i){return this._x=t,this._y=e,this._z=n,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const n=t._x,i=t._y,r=t._z,s=t._order,a=Math.cos,o=Math.sin,l=a(n/2),c=a(i/2),u=a(r/2),h=o(n/2),d=o(i/2),f=o(r/2);switch(s){case"XYZ":this._x=h*c*u+l*d*f,this._y=l*d*u-h*c*f,this._z=l*c*f+h*d*u,this._w=l*c*u-h*d*f;break;case"YXZ":this._x=h*c*u+l*d*f,this._y=l*d*u-h*c*f,this._z=l*c*f-h*d*u,this._w=l*c*u+h*d*f;break;case"ZXY":this._x=h*c*u-l*d*f,this._y=l*d*u+h*c*f,this._z=l*c*f+h*d*u,this._w=l*c*u-h*d*f;break;case"ZYX":this._x=h*c*u-l*d*f,this._y=l*d*u+h*c*f,this._z=l*c*f-h*d*u,this._w=l*c*u+h*d*f;break;case"YZX":this._x=h*c*u+l*d*f,this._y=l*d*u+h*c*f,this._z=l*c*f-h*d*u,this._w=l*c*u-h*d*f;break;case"XZY":this._x=h*c*u-l*d*f,this._y=l*d*u-h*c*f,this._z=l*c*f+h*d*u,this._w=l*c*u+h*d*f;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const n=e/2,i=Math.sin(n);return this._x=t.x*i,this._y=t.y*i,this._z=t.z*i,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,n=e[0],i=e[4],r=e[8],s=e[1],a=e[5],o=e[9],l=e[2],c=e[6],u=e[10],h=n+a+u;if(h>0){const t=.5/Math.sqrt(h+1);this._w=.25/t,this._x=(c-o)*t,this._y=(r-l)*t,this._z=(s-i)*t}else if(n>a&&n>u){const t=2*Math.sqrt(1+n-a-u);this._w=(c-o)/t,this._x=.25*t,this._y=(i+s)/t,this._z=(r+l)/t}else if(a>u){const t=2*Math.sqrt(1+a-n-u);this._w=(r-l)/t,this._x=(i+s)/t,this._y=.25*t,this._z=(o+c)/t}else{const t=2*Math.sqrt(1+u-n-a);this._w=(s-i)/t,this._x=(r+l)/t,this._y=(o+c)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let n=t.dot(e)+1;return n<Number.EPSILON?(n=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=n):(this._x=0,this._y=-t.z,this._z=t.y,this._w=n)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=n),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(i.uZ(this.dot(t),-1,1)))}rotateTowards(t,e){const n=this.angleTo(t);if(0===n)return this;const i=Math.min(1,e/n);return this.slerp(t,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const n=t._x,i=t._y,r=t._z,s=t._w,a=e._x,o=e._y,l=e._z,c=e._w;return this._x=n*c+s*a+i*l-r*o,this._y=i*c+s*o+r*a-n*l,this._z=r*c+s*l+n*o-i*a,this._w=s*c-n*a-i*o-r*l,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const n=this._x,i=this._y,r=this._z,s=this._w;let a=s*t._w+n*t._x+i*t._y+r*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=s,this._x=n,this._y=i,this._z=r,this;const o=1-a*a;if(o<=Number.EPSILON){const t=1-e;return this._w=t*s+e*this._w,this._x=t*n+e*this._x,this._y=t*i+e*this._y,this._z=t*r+e*this._z,this.normalize(),this._onChangeCallback(),this}const l=Math.sqrt(o),c=Math.atan2(l,a),u=Math.sin((1-e)*c)/l,h=Math.sin(e*c)/l;return this._w=s*u+this._w*h,this._x=n*u+this._x*h,this._y=i*u+this._y*h,this._z=r*u+this._z*h,this._onChangeCallback(),this}slerpQuaternions(t,e,n){return this.copy(t).slerp(e,n)}random(){const t=Math.random(),e=Math.sqrt(1-t),n=Math.sqrt(t),i=2*Math.PI*Math.random(),r=2*Math.PI*Math.random();return this.set(e*Math.cos(i),n*Math.sin(r),n*Math.cos(r),e*Math.sin(i))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}r.prototype.isQuaternion=!0},2081:(t,e,n)=>{n.d(e,{z:()=>h});var i=n(4532);const r=new i.Vector3,s=new i.Vector3,a=new i.Vector3,o=new i.Vector3,l=new i.Vector3,c=new i.Vector3,u=new i.Vector3;class h{constructor(t=new i.Vector3,e=new i.Vector3(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,r)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const n=e.dot(this.direction);return n<0?e.copy(this.origin):e.copy(this.direction).multiplyScalar(n).add(this.origin)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=r.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(r.copy(this.direction).multiplyScalar(e).add(this.origin),r.distanceToSquared(t))}distanceSqToSegment(t,e,n,i){s.copy(t).add(e).multiplyScalar(.5),a.copy(e).sub(t).normalize(),o.copy(this.origin).sub(s);const r=.5*t.distanceTo(e),l=-this.direction.dot(a),c=o.dot(this.direction),u=-o.dot(a),h=o.lengthSq(),d=Math.abs(1-l*l);let f,p,m,g;if(d>0)if(f=l*u-c,p=l*c-u,g=r*d,f>=0)if(p>=-g)if(p<=g){const t=1/d;f*=t,p*=t,m=f*(f+l*p+2*c)+p*(l*f+p+2*u)+h}else p=r,f=Math.max(0,-(l*p+c)),m=-f*f+p*(p+2*u)+h;else p=-r,f=Math.max(0,-(l*p+c)),m=-f*f+p*(p+2*u)+h;else p<=-g?(f=Math.max(0,-(-l*r+c)),p=f>0?-r:Math.min(Math.max(-r,-u),r),m=-f*f+p*(p+2*u)+h):p<=g?(f=0,p=Math.min(Math.max(-r,-u),r),m=p*(p+2*u)+h):(f=Math.max(0,-(l*r+c)),p=f>0?r:Math.min(Math.max(-r,-u),r),m=-f*f+p*(p+2*u)+h);else p=l>0?-r:r,f=Math.max(0,-(l*p+c)),m=-f*f+p*(p+2*u)+h;return n&&n.copy(this.direction).multiplyScalar(f).add(this.origin),i&&i.copy(a).multiplyScalar(p).add(s),m}intersectSphere(t,e){r.subVectors(t.center,this.origin);const n=r.dot(this.direction),i=r.dot(r)-n*n,s=t.radius*t.radius;if(i>s)return null;const a=Math.sqrt(s-i),o=n-a,l=n+a;return o<0&&l<0?null:o<0?this.at(l,e):this.at(o,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const n=-(this.origin.dot(t.normal)+t.constant)/e;return n>=0?n:null}intersectPlane(t,e){const n=this.distanceToPlane(t);return null===n?null:this.at(n,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);return 0===e||t.normal.dot(this.direction)*e<0}intersectBox(t,e){let n,i,r,s,a,o;const l=1/this.direction.x,c=1/this.direction.y,u=1/this.direction.z,h=this.origin;return l>=0?(n=(t.min.x-h.x)*l,i=(t.max.x-h.x)*l):(n=(t.max.x-h.x)*l,i=(t.min.x-h.x)*l),c>=0?(r=(t.min.y-h.y)*c,s=(t.max.y-h.y)*c):(r=(t.max.y-h.y)*c,s=(t.min.y-h.y)*c),n>s||r>i?null:((r>n||n!=n)&&(n=r),(s<i||i!=i)&&(i=s),u>=0?(a=(t.min.z-h.z)*u,o=(t.max.z-h.z)*u):(a=(t.max.z-h.z)*u,o=(t.min.z-h.z)*u),n>o||a>i?null:((a>n||n!=n)&&(n=a),(o<i||i!=i)&&(i=o),i<0?null:this.at(n>=0?n:i,e)))}intersectsBox(t){return null!==this.intersectBox(t,r)}intersectTriangle(t,e,n,i,r){l.subVectors(e,t),c.subVectors(n,t),u.crossVectors(l,c);let s,a=this.direction.dot(u);if(a>0){if(i)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}o.subVectors(this.origin,t);const h=s*this.direction.dot(c.crossVectors(o,c));if(h<0)return null;const d=s*this.direction.dot(l.cross(o));if(d<0)return null;if(h+d>a)return null;const f=-s*o.dot(u);return f<0?null:this.at(f/a,r)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}},9771:(t,e,n)=>{n.r(e),n.d(e,{Sphere:()=>c});var i=n(7232),r=n(4532);const s=new i.Box3,a=new r.Vector3,o=new r.Vector3,l=new r.Vector3;class c{constructor(t=new r.Vector3,e=-1){this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const n=this.center;void 0!==e?n.copy(e):s.setFromPoints(t).getCenter(n);let i=0;for(let e=0,r=t.length;e<r;e++)i=Math.max(i,n.distanceToSquared(t[e]));return this.radius=Math.sqrt(i),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const n=this.center.distanceToSquared(t);return e.copy(t),n>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){l.subVectors(t,this.center);const e=l.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),n=.5*(t-this.radius);this.center.add(l.multiplyScalar(n/t)),this.radius+=n}return this}union(t){return!0===this.center.equals(t.center)?o.set(0,0,1).multiplyScalar(t.radius):o.subVectors(t.center,this.center).normalize().multiplyScalar(t.radius),this.expandByPoint(a.copy(t.center).add(o)),this.expandByPoint(a.copy(t.center).sub(o)),this}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}},6120:(t,e,n)=>{n.r(e),n.d(e,{Vector2:()=>i});class i{constructor(t=0,e=0){this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this)}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this)}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,n=this.y,i=t.elements;return this.x=i[0]*e+i[3]*n+i[6],this.y=i[1]*e+i[4]*n+i[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,n=this.y-t.y;return e*e+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e,n){return void 0!==n&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const n=Math.cos(e),i=Math.sin(e),r=this.x-t.x,s=this.y-t.y;return this.x=r*n-s*i+t.x,this.y=r*i+s*n+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}i.prototype.isVector2=!0},4532:(t,e,n)=>{n.r(e),n.d(e,{Vector3:()=>s});var i=n(9542),r=n(3163);class s{constructor(t=0,e=0,n=0){this.x=t,this.y=e,this.z=n}set(t,e,n){return void 0===n&&(n=this.z),this.x=t,this.y=e,this.z=n,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(o.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(o.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[3]*n+r[6]*i,this.y=r[1]*e+r[4]*n+r[7]*i,this.z=r[2]*e+r[5]*n+r[8]*i,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,n=this.y,i=this.z,r=t.elements,s=1/(r[3]*e+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*e+r[4]*n+r[8]*i+r[12])*s,this.y=(r[1]*e+r[5]*n+r[9]*i+r[13])*s,this.z=(r[2]*e+r[6]*n+r[10]*i+r[14])*s,this}applyQuaternion(t){const e=this.x,n=this.y,i=this.z,r=t.x,s=t.y,a=t.z,o=t.w,l=o*e+s*i-a*n,c=o*n+a*e-r*i,u=o*i+r*n-s*e,h=-r*e-s*n-a*i;return this.x=l*o+h*-r+c*-a-u*-s,this.y=c*o+h*-s+u*-r-l*-a,this.z=u*o+h*-a+l*-s-c*-r,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,n=this.y,i=this.z,r=t.elements;return this.x=r[0]*e+r[4]*n+r[8]*i,this.y=r[1]*e+r[5]*n+r[9]*i,this.z=r[2]*e+r[6]*n+r[10]*i,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this.z=t.z+(e.z-t.z)*n,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const n=t.x,i=t.y,r=t.z,s=e.x,a=e.y,o=e.z;return this.x=i*o-r*a,this.y=r*s-n*o,this.z=n*a-i*s,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const n=t.dot(this)/e;return this.copy(t).multiplyScalar(n)}projectOnPlane(t){return a.copy(this).projectOnVector(t),this.sub(a)}reflect(t){return this.sub(a.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const n=this.dot(t)/e;return Math.acos(i.uZ(n,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,n=this.y-t.y,i=this.z-t.z;return e*e+n*n+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,n){const i=Math.sin(e)*t;return this.x=i*Math.sin(n),this.y=Math.cos(e)*t,this.z=i*Math.cos(n),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,n){return this.x=t*Math.sin(e),this.y=n,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),n=this.setFromMatrixColumn(t,1).length(),i=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=n,this.z=i,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e,n){return void 0!==n&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=2*(Math.random()-.5),e=Math.random()*Math.PI*2,n=Math.sqrt(1-t**2);return this.x=n*Math.cos(e),this.y=n*Math.sin(e),this.z=t,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}s.prototype.isVector3=!0;const a=new s,o=new r.Quaternion},6980:(t,e,n)=>{n.d(e,{L:()=>i});class i{constructor(t=0,e=0,n=0,i=1){this.x=t,this.y=e,this.z=n,this.w=i}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,n,i){return this.x=t,this.y=e,this.z=n,this.w=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,n=this.y,i=this.z,r=this.w,s=t.elements;return this.x=s[0]*e+s[4]*n+s[8]*i+s[12]*r,this.y=s[1]*e+s[5]*n+s[9]*i+s[13]*r,this.z=s[2]*e+s[6]*n+s[10]*i+s[14]*r,this.w=s[3]*e+s[7]*n+s[11]*i+s[15]*r,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,n,i,r;const s=.01,a=.1,o=t.elements,l=o[0],c=o[4],u=o[8],h=o[1],d=o[5],f=o[9],p=o[2],m=o[6],g=o[10];if(Math.abs(c-h)<s&&Math.abs(u-p)<s&&Math.abs(f-m)<s){if(Math.abs(c+h)<a&&Math.abs(u+p)<a&&Math.abs(f+m)<a&&Math.abs(l+d+g-3)<a)return this.set(1,0,0,0),this;e=Math.PI;const t=(l+1)/2,o=(d+1)/2,v=(g+1)/2,y=(c+h)/4,_=(u+p)/4,x=(f+m)/4;return t>o&&t>v?t<s?(n=0,i=.707106781,r=.707106781):(n=Math.sqrt(t),i=y/n,r=_/n):o>v?o<s?(n=.707106781,i=0,r=.707106781):(i=Math.sqrt(o),n=y/i,r=x/i):v<s?(n=.707106781,i=.707106781,r=0):(r=Math.sqrt(v),n=_/r,i=x/r),this.set(n,i,r,e),this}let v=Math.sqrt((m-f)*(m-f)+(u-p)*(u-p)+(h-c)*(h-c));return Math.abs(v)<.001&&(v=1),this.x=(m-f)/v,this.y=(u-p)/v,this.z=(h-c)/v,this.w=Math.acos((l+d+g-1)/2),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this.z=t.z+(e.z-t.z)*n,this.w=t.w+(e.w-t.w)*n,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e,n){return void 0!==n&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}i.prototype.isVector4=!0},2658:(t,e,n)=>{n.r(e),n.d(e,{Group:()=>r});var i=n(1052);class r extends i.T{constructor(){super(),this.type="Group"}}r.prototype.isGroup=!0},9150:(t,e,n)=>{n.r(e),n.d(e,{Mesh:()=>B});var i=n(4532),r=n(6120),s=n(9771),a=n(2081),o=n(1245),l=n(1052);const c=new i.Vector3,u=new i.Vector3,h=new i.Vector3,d=new i.Vector3,f=new i.Vector3,p=new i.Vector3,m=new i.Vector3,g=new i.Vector3,v=new i.Vector3,y=new i.Vector3;class _{constructor(t=new i.Vector3,e=new i.Vector3,n=new i.Vector3){this.a=t,this.b=e,this.c=n}static getNormal(t,e,n,i){i.subVectors(n,e),c.subVectors(t,e),i.cross(c);const r=i.lengthSq();return r>0?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)}static getBarycoord(t,e,n,i,r){c.subVectors(i,e),u.subVectors(n,e),h.subVectors(t,e);const s=c.dot(c),a=c.dot(u),o=c.dot(h),l=u.dot(u),d=u.dot(h),f=s*l-a*a;if(0===f)return r.set(-2,-1,-1);const p=1/f,m=(l*o-a*d)*p,g=(s*d-a*o)*p;return r.set(1-m-g,g,m)}static containsPoint(t,e,n,i){return this.getBarycoord(t,e,n,i,d),d.x>=0&&d.y>=0&&d.x+d.y<=1}static getUV(t,e,n,i,r,s,a,o){return this.getBarycoord(t,e,n,i,d),o.set(0,0),o.addScaledVector(r,d.x),o.addScaledVector(s,d.y),o.addScaledVector(a,d.z),o}static isFrontFacing(t,e,n,i){return c.subVectors(n,e),u.subVectors(t,e),c.cross(u).dot(i)<0}set(t,e,n){return this.a.copy(t),this.b.copy(e),this.c.copy(n),this}setFromPointsAndIndices(t,e,n,i){return this.a.copy(t[e]),this.b.copy(t[n]),this.c.copy(t[i]),this}setFromAttributeAndIndices(t,e,n,i){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,n),this.c.fromBufferAttribute(t,i),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return c.subVectors(this.c,this.b),u.subVectors(this.a,this.b),.5*c.cross(u).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return _.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return _.getBarycoord(t,this.a,this.b,this.c,e)}getUV(t,e,n,i,r){return _.getUV(t,this.a,this.b,this.c,e,n,i,r)}containsPoint(t){return _.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return _.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const n=this.a,i=this.b,r=this.c;let s,a;f.subVectors(i,n),p.subVectors(r,n),g.subVectors(t,n);const o=f.dot(g),l=p.dot(g);if(o<=0&&l<=0)return e.copy(n);v.subVectors(t,i);const c=f.dot(v),u=p.dot(v);if(c>=0&&u<=c)return e.copy(i);const h=o*u-c*l;if(h<=0&&o>=0&&c<=0)return s=o/(o-c),e.copy(n).addScaledVector(f,s);y.subVectors(t,r);const d=f.dot(y),_=p.dot(y);if(_>=0&&d<=_)return e.copy(r);const x=d*l-o*_;if(x<=0&&l>=0&&_<=0)return a=l/(l-_),e.copy(n).addScaledVector(p,a);const w=c*_-d*u;if(w<=0&&u-c>=0&&d-_>=0)return m.subVectors(r,i),a=(u-c)/(u-c+(d-_)),e.copy(i).addScaledVector(m,a);const b=1/(w+x+h);return s=x*b,a=h*b,e.copy(n).addScaledVector(f,s).addScaledVector(p,a)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}var x=n(7006),w=n(4033),b=n(5699);const S=new o.Matrix4,E=new a.z,T=new s.Sphere,M=new i.Vector3,A=new i.Vector3,I=new i.Vector3,C=new i.Vector3,R=new i.Vector3,D=new i.Vector3,L=new i.Vector3,P=new i.Vector3,N=new i.Vector3,O=new r.Vector2,F=new r.Vector2,U=new r.Vector2,V=new i.Vector3,k=new i.Vector3;class B extends l.T{constructor(t=new b.BufferGeometry,e=new w.MeshBasicMaterial){super(),this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t){return super.copy(t),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=t.material,this.geometry=t.geometry,this}updateMorphTargets(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,n=Object.keys(e);if(n.length>0){const t=e[n[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,n=t.length;e<n;e++){const n=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[n]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Mesh.updateMorphTargets() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}raycast(t,e){const n=this.geometry,i=this.material,r=this.matrixWorld;if(void 0===i)return;if(null===n.boundingSphere&&n.computeBoundingSphere(),T.copy(n.boundingSphere),T.applyMatrix4(r),!1===t.ray.intersectsSphere(T))return;if(S.copy(r).invert(),E.copy(t.ray).applyMatrix4(S),null!==n.boundingBox&&!1===E.intersectsBox(n.boundingBox))return;let s;if(n.isBufferGeometry){const r=n.index,a=n.attributes.position,o=n.morphAttributes.position,l=n.morphTargetsRelative,c=n.attributes.uv,u=n.attributes.uv2,h=n.groups,d=n.drawRange;if(null!==r)if(Array.isArray(i))for(let n=0,f=h.length;n<f;n++){const f=h[n],p=i[f.materialIndex];for(let n=Math.max(f.start,d.start),i=Math.min(r.count,Math.min(f.start+f.count,d.start+d.count));n<i;n+=3){const i=r.getX(n),h=r.getX(n+1),d=r.getX(n+2);s=z(this,p,t,E,a,o,l,c,u,i,h,d),s&&(s.faceIndex=Math.floor(n/3),s.face.materialIndex=f.materialIndex,e.push(s))}}else for(let n=Math.max(0,d.start),h=Math.min(r.count,d.start+d.count);n<h;n+=3){const h=r.getX(n),d=r.getX(n+1),f=r.getX(n+2);s=z(this,i,t,E,a,o,l,c,u,h,d,f),s&&(s.faceIndex=Math.floor(n/3),e.push(s))}else if(void 0!==a)if(Array.isArray(i))for(let n=0,r=h.length;n<r;n++){const r=h[n],f=i[r.materialIndex];for(let n=Math.max(r.start,d.start),i=Math.min(a.count,Math.min(r.start+r.count,d.start+d.count));n<i;n+=3)s=z(this,f,t,E,a,o,l,c,u,n,n+1,n+2),s&&(s.faceIndex=Math.floor(n/3),s.face.materialIndex=r.materialIndex,e.push(s))}else for(let n=Math.max(0,d.start),r=Math.min(a.count,d.start+d.count);n<r;n+=3)s=z(this,i,t,E,a,o,l,c,u,n,n+1,n+2),s&&(s.faceIndex=Math.floor(n/3),e.push(s))}else n.isGeometry&&console.error("THREE.Mesh.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}}function z(t,e,n,s,a,o,l,c,u,h,d,f){M.fromBufferAttribute(a,h),A.fromBufferAttribute(a,d),I.fromBufferAttribute(a,f);const p=t.morphTargetInfluences;if(o&&p){L.set(0,0,0),P.set(0,0,0),N.set(0,0,0);for(let t=0,e=o.length;t<e;t++){const e=p[t],n=o[t];0!==e&&(C.fromBufferAttribute(n,h),R.fromBufferAttribute(n,d),D.fromBufferAttribute(n,f),l?(L.addScaledVector(C,e),P.addScaledVector(R,e),N.addScaledVector(D,e)):(L.addScaledVector(C.sub(M),e),P.addScaledVector(R.sub(A),e),N.addScaledVector(D.sub(I),e)))}M.add(L),A.add(P),I.add(N)}t.isSkinnedMesh&&(t.boneTransform(h,M),t.boneTransform(d,A),t.boneTransform(f,I));const m=function(t,e,n,i,r,s,a,o){let l;if(l=e.side===x._Li?i.intersectTriangle(a,s,r,!0,o):i.intersectTriangle(r,s,a,e.side!==x.ehD,o),null===l)return null;k.copy(o),k.applyMatrix4(t.matrixWorld);const c=n.ray.origin.distanceTo(k);return c<n.near||c>n.far?null:{distance:c,point:k.clone(),object:t}}(t,e,n,s,M,A,I,V);if(m){c&&(O.fromBufferAttribute(c,h),F.fromBufferAttribute(c,d),U.fromBufferAttribute(c,f),m.uv=_.getUV(V,M,A,I,O,F,U,new r.Vector2)),u&&(O.fromBufferAttribute(u,h),F.fromBufferAttribute(u,d),U.fromBufferAttribute(u,f),m.uv2=_.getUV(V,M,A,I,O,F,U,new r.Vector2));const t={a:h,b:d,c:f,normal:new i.Vector3,materialIndex:0};_.getNormal(M,A,I,t.normal),m.face=t}return m}B.prototype.isMesh=!0},394:(t,e,n)=>{n.r(e),n.d(e,{Points:()=>g});var i=n(9771),r=n(2081),s=n(1245),a=n(1052),o=n(4532),l=n(406),c=n(7282);class u extends l.F{constructor(t){super(),this.type="PointsMaterial",this.color=new c.Color(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}u.prototype.isPointsMaterial=!0;var h=n(5699);const d=new s.Matrix4,f=new r.z,p=new i.Sphere,m=new o.Vector3;class g extends a.T{constructor(t=new h.BufferGeometry,e=new u){super(),this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t){return super.copy(t),this.material=t.material,this.geometry=t.geometry,this}raycast(t,e){const n=this.geometry,i=this.matrixWorld,r=t.params.Points.threshold,s=n.drawRange;if(null===n.boundingSphere&&n.computeBoundingSphere(),p.copy(n.boundingSphere),p.applyMatrix4(i),p.radius+=r,!1===t.ray.intersectsSphere(p))return;d.copy(i).invert(),f.copy(t.ray).applyMatrix4(d);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a;if(n.isBufferGeometry){const r=n.index,a=n.attributes.position;if(null!==r)for(let n=Math.max(0,s.start),l=Math.min(r.count,s.start+s.count);n<l;n++){const s=r.getX(n);m.fromBufferAttribute(a,s),v(m,s,o,i,t,e,this)}else for(let n=Math.max(0,s.start),r=Math.min(a.count,s.start+s.count);n<r;n++)m.fromBufferAttribute(a,n),v(m,n,o,i,t,e,this)}else console.error("THREE.Points.raycast() no longer supports THREE.Geometry. Use THREE.BufferGeometry instead.")}updateMorphTargets(){const t=this.geometry;if(t.isBufferGeometry){const e=t.morphAttributes,n=Object.keys(e);if(n.length>0){const t=e[n[0]];if(void 0!==t){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,n=t.length;e<n;e++){const n=t[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[n]=e}}}}else{const e=t.morphTargets;void 0!==e&&e.length>0&&console.error("THREE.Points.updateMorphTargets() does not support THREE.Geometry. Use THREE.BufferGeometry instead.")}}}function v(t,e,n,i,r,s,a){const l=f.distanceSqToPoint(t);if(l<n){const n=new o.Vector3;f.closestPointToPoint(t,n),n.applyMatrix4(i);const c=r.ray.origin.distanceTo(n);if(c<r.near||c>r.far)return;s.push({distance:c,distanceToRay:Math.sqrt(l),point:n,index:e,face:null,object:a})}}g.prototype.isPoints=!0},6481:(t,e,n)=>{n.r(e),n.d(e,{WebGLRenderer:()=>pn});var i=n(7006),r=n(9542),s=n(3871),a=n(1245),o=n(6120),l=n(4532),c=n(6980);function u(){let t=null,e=!1,n=null,i=null;function r(e,s){n(e,s),i=t.requestAnimationFrame(r)}return{start:function(){!0!==e&&null!==n&&(i=t.requestAnimationFrame(r),e=!0)},stop:function(){t.cancelAnimationFrame(i),e=!1},setAnimationLoop:function(t){n=t},setContext:function(e){t=e}}}function h(t,e){const n=e.isWebGL2,i=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),i.get(t)},remove:function(e){e.isInterleavedBufferAttribute&&(e=e.data);const n=i.get(e);n&&(t.deleteBuffer(n.buffer),i.delete(e))},update:function(e,r){if(e.isGLBufferAttribute){const t=i.get(e);return void((!t||t.version<e.version)&&i.set(e,{buffer:e.buffer,type:e.type,bytesPerElement:e.elementSize,version:e.version}))}e.isInterleavedBufferAttribute&&(e=e.data);const s=i.get(e);void 0===s?i.set(e,function(e,i){const r=e.array,s=e.usage,a=t.createBuffer();let o;if(t.bindBuffer(i,a),t.bufferData(i,r,s),e.onUploadCallback(),r instanceof Float32Array)o=t.FLOAT;else if(r instanceof Uint16Array)if(e.isFloat16BufferAttribute){if(!n)throw new Error("THREE.WebGLAttributes: Usage of Float16BufferAttribute requires WebGL2.");o=t.HALF_FLOAT}else o=t.UNSIGNED_SHORT;else if(r instanceof Int16Array)o=t.SHORT;else if(r instanceof Uint32Array)o=t.UNSIGNED_INT;else if(r instanceof Int32Array)o=t.INT;else if(r instanceof Int8Array)o=t.BYTE;else if(r instanceof Uint8Array)o=t.UNSIGNED_BYTE;else{if(!(r instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+r);o=t.UNSIGNED_BYTE}return{buffer:a,type:o,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version}}(e,r)):s.version<e.version&&(function(e,i,r){const s=i.array,a=i.updateRange;t.bindBuffer(r,e),-1===a.count?t.bufferSubData(r,0,s):(n?t.bufferSubData(r,a.offset*s.BYTES_PER_ELEMENT,s,a.offset,a.count):t.bufferSubData(r,a.offset*s.BYTES_PER_ELEMENT,s.subarray(a.offset,a.offset+a.count)),a.count=-1)}(s.buffer,e,r),s.version=e.version)}}}var d=n(3827),f=n(2848),p=n(407),m=n(7282),g=n(9150);const v={alphamap_fragment:"\n#ifdef USE_ALPHAMAP\n\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n\n#endif\n",alphamap_pars_fragment:"\n#ifdef USE_ALPHAMAP\n\n\tuniform sampler2D alphaMap;\n\n#endif\n",alphatest_fragment:"\n#ifdef USE_ALPHATEST\n\n\tif ( diffuseColor.a < alphaTest ) discard;\n\n#endif\n",alphatest_pars_fragment:"\n#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif\n",aomap_fragment:"\n#ifdef USE_AOMAP\n\n\t// reads channel R, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\n\t#endif\n\n#endif\n",aomap_pars_fragment:"\n#ifdef USE_AOMAP\n\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n\n#endif\n",begin_vertex:"\nvec3 transformed = vec3( position );\n",beginnormal_vertex:"\nvec3 objectNormal = vec3( normal );\n\n#ifdef USE_TANGENT\n\n\tvec3 objectTangent = vec3( tangent.xyz );\n\n#endif\n",bsdfs:'\n\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\n\treturn RECIPROCAL_PI * diffuseColor;\n\n} // validated\n\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\n\t// Original approximation by Christophe Schlick \'94\n\t// float fresnel = pow( 1.0 - dotVH, 5.0 );\n\n\t// Optimized variant (presented by Epic at SIGGRAPH \'13)\n\t// https://cdn2.unrealengine.com/Resources/files/2013SiggraphPresentationsNotes-26915738.pdf\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n\n} // validated\n\n// Moving Frostbite to Physically Based Rendering 3.0 - page 12, listing 2\n// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\n\tfloat a2 = pow2( alpha );\n\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\n\treturn 0.5 / max( gv + gl, EPSILON );\n\n}\n\n// Microfacet Models for Refraction through Rough Surfaces - equation (33)\n// http://graphicrants.blogspot.com/2013/08/specular-brdf-reference.html\n// alpha is "roughness squared" in Disney’s reparameterization\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\n\tfloat a2 = pow2( alpha );\n\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0; // avoid alpha = 0 with dotNH = 1\n\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n\n}\n\n// GGX Distribution, Schlick Fresnel, GGX_SmithCorrelated Visibility\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 f0, const in float f90, const in float roughness ) {\n\n\tfloat alpha = pow2( roughness ); // UE4\'s roughness\n\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\n\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\n\tfloat D = D_GGX( alpha, dotNH );\n\n\treturn F * ( V * D );\n\n}\n\n// Rect Area Light\n\n// Real-Time Polygonal-Light Shading with Linearly Transformed Cosines\n// by Eric Heitz, Jonathan Dupuy, Stephen Hill and David Neubelt\n// code: https://github.com/selfshadow/ltc_code/\n\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\n\tfloat dotNV = saturate( dot( N, V ) );\n\n\t// texture parameterized by sqrt( GGX alpha ) and sqrt( 1 - cos( theta ) )\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\n\treturn uv;\n\n}\n\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\n\t// Real-Time Area Lighting: a Journey from Research to Production (p.102)\n\t// An approximation of the form factor of a horizon-clipped rectangle.\n\n\tfloat l = length( f );\n\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n\n}\n\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\n\tfloat x = dot( v1, v2 );\n\n\tfloat y = abs( x );\n\n\t// rational polynomial approximation to theta / sin( theta ) / 2PI\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\n\treturn cross( v1, v2 ) * theta_sintheta;\n\n}\n\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\n\t// bail if point is on back side of plane of light\n\t// assumes ccw winding order of light vertices\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\n\t// construct orthonormal basis around N\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 ); // negated from paper; possibly due to a different handedness of world coordinate system\n\n\t// compute transform\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\n\t// transform rect\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\n\t// project rect onto sphere\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\n\t// calculate vector form factor\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\n\t// adjust for horizon clipping\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\n/*\n\t// alternate method of adjusting for horizon clipping (see referece)\n\t// refactoring required\n\tfloat len = length( vectorFormFactor );\n\tfloat z = vectorFormFactor.z / len;\n\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\n\t// tabulated horizon-clipped sphere, apparently...\n\tvec2 uv = vec2( z * 0.5 + 0.5, len );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\n\tfloat scale = texture2D( ltc_2, uv ).w;\n\n\tfloat result = len * scale;\n*/\n\n\treturn vec3( result );\n\n}\n\n// End Rect Area Light\n\n\nfloat G_BlinnPhong_Implicit( /* const in float dotNL, const in float dotNV */ ) {\n\n\t// geometry term is (n dot l)(n dot v) / 4(n dot l)(n dot v)\n\treturn 0.25;\n\n}\n\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n\n}\n\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\n\tfloat G = G_BlinnPhong_Implicit( /* dotNL, dotNV */ );\n\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\n\treturn F * ( G * D );\n\n} // validated\n\n#if defined( USE_SHEEN )\n\n// https://github.com/google/filament/blob/master/shaders/src/brdf.fs\nfloat D_Charlie( float roughness, float dotNH ) {\n\n\tfloat alpha = pow2( roughness );\n\n\t// Estevez and Kulla 2017, "Production Friendly Microfacet Sheen BRDF"\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 ); // 2^(-14/2), so sin2h^2 > 0 in fp16\n\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n\n}\n\n// https://github.com/google/filament/blob/master/shaders/src/brdf.fs\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\n\t// Neubelt and Pettineo 2013, "Crafting a Next-gen Material Pipeline for The Order: 1886"\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n\n}\n\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\n\treturn sheenColor * ( D * V );\n\n}\n\n#endif\n',bumpmap_pars_fragment:"\n#ifdef USE_BUMPMAP\n\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\n\t// Bump Mapping Unparametrized Surfaces on the GPU by Morten S. Mikkelsen\n\t// https://mmikk.github.io/papers3d/mm_sfgrad_bump.pdf\n\n\t// Evaluate the derivative of the height w.r.t. screen-space using forward differencing (listing 2)\n\n\tvec2 dHdxy_fwd() {\n\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\n\t\treturn vec2( dBx, dBy );\n\n\t}\n\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\n\t\t// Workaround for Adreno 3XX dFd*( vec3 ) bug. See #9988\n\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\t\t// normalized\n\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\n\t}\n\n#endif\n",clipping_planes_fragment:"\n#if NUM_CLIPPING_PLANES > 0\n\n\tvec4 plane;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\n\t\tbool clipped = true;\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t\tif ( clipped ) discard;\n\n\t#endif\n\n#endif\n",clipping_planes_pars_fragment:"\n#if NUM_CLIPPING_PLANES > 0\n\n\tvarying vec3 vClipPosition;\n\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n\n#endif\n",clipping_planes_pars_vertex:"\n#if NUM_CLIPPING_PLANES > 0\n\n\tvarying vec3 vClipPosition;\n\n#endif\n",clipping_planes_vertex:"\n#if NUM_CLIPPING_PLANES > 0\n\n\tvClipPosition = - mvPosition.xyz;\n\n#endif\n",color_fragment:"\n#if defined( USE_COLOR_ALPHA )\n\n\tdiffuseColor *= vColor;\n\n#elif defined( USE_COLOR )\n\n\tdiffuseColor.rgb *= vColor;\n\n#endif\n",color_pars_fragment:"\n#if defined( USE_COLOR_ALPHA )\n\n\tvarying vec4 vColor;\n\n#elif defined( USE_COLOR )\n\n\tvarying vec3 vColor;\n\n#endif\n",color_pars_vertex:"\n#if defined( USE_COLOR_ALPHA )\n\n\tvarying vec4 vColor;\n\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\n\tvarying vec3 vColor;\n\n#endif\n",color_vertex:"\n#if defined( USE_COLOR_ALPHA )\n\n\tvColor = vec4( 1.0 );\n\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR )\n\n\tvColor = vec3( 1.0 );\n\n#endif\n\n#ifdef USE_COLOR\n\n\tvColor *= color;\n\n#endif\n\n#ifdef USE_INSTANCING_COLOR\n\n\tvColor.xyz *= instanceColor.xyz;\n\n#endif\n",common:"\n#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n\n#ifndef saturate\n// <tonemapping_pars_fragment> may have defined saturate() already\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\n\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\n\n// expects values in the range of [0,1]x[0,1], returns values in the [0,1] range.\n// do not collapse into a single function per: http://byteblacksmith.com/improvements-to-the-canonical-one-liner-glsl-rand-for-opengl-es-2-0/\nhighp float rand( const in vec2 uv ) {\n\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\n\treturn fract( sin( sn ) * c );\n\n}\n\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\n\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\n\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal;\n#endif\n};\n\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n}\n\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t// dir can be either a direction vector or a normal vector\n\t// upper-left 3x3 of matrix is assumed to be orthogonal\n\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n\n}\n\nmat3 transposeMat3( const in mat3 m ) {\n\n\tmat3 tmp;\n\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\n\treturn tmp;\n\n}\n\n// https://en.wikipedia.org/wiki/Relative_luminance\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\n\treturn dot( weights, color.rgb );\n\n}\n\nbool isPerspectiveMatrix( mat4 m ) {\n\n\treturn m[ 2 ][ 3 ] == - 1.0;\n\n}\n\nvec2 equirectUv( in vec3 dir ) {\n\n\t// dir is assumed to be unit length\n\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\n\treturn vec2( u, v );\n\n}\n",cube_uv_reflection_fragment:"\n#ifdef ENVMAP_TYPE_CUBE_UV\n\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\n\t// These shader functions convert between the UV coordinates of a single face of\n\t// a cubemap, the 0-5 integer index of a cube face, and the direction vector for\n\t// sampling a textureCube (not generally normalized ).\n\n\tfloat getFace( vec3 direction ) {\n\n\t\tvec3 absDirection = abs( direction );\n\n\t\tfloat face = - 1.0;\n\n\t\tif ( absDirection.x > absDirection.z ) {\n\n\t\t\tif ( absDirection.x > absDirection.y )\n\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\n\t\t\telse\n\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\n\t\t} else {\n\n\t\t\tif ( absDirection.z > absDirection.y )\n\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\n\t\t\telse\n\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\n\t\t}\n\n\t\treturn face;\n\n\t}\n\n\t// RH coordinate system; PMREM face-indexing convention\n\tvec2 getUV( vec3 direction, float face ) {\n\n\t\tvec2 uv;\n\n\t\tif ( face == 0.0 ) {\n\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x ); // pos x\n\n\t\t} else if ( face == 1.0 ) {\n\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y ); // pos y\n\n\t\t} else if ( face == 2.0 ) {\n\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z ); // pos z\n\n\t\t} else if ( face == 3.0 ) {\n\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x ); // neg x\n\n\t\t} else if ( face == 4.0 ) {\n\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y ); // neg y\n\n\t\t} else {\n\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z ); // neg z\n\n\t\t}\n\n\t\treturn 0.5 * ( uv + 1.0 );\n\n\t}\n\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\n\t\tfloat face = getFace( direction );\n\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\n\t\tfloat faceSize = exp2( mipInt );\n\n\t\tvec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\n\t\tif ( face > 2.0 ) {\n\n\t\t\tuv.y += faceSize;\n\n\t\t\tface -= 3.0;\n\n\t\t}\n\n\t\tuv.x += face * faceSize;\n\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\n\t\t#ifdef texture2DGradEXT\n\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb; // disable anisotropic filtering\n\n\t\t#else\n\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\n\t\t#endif\n\n\t}\n\n\t// These defines must match with PMREMGenerator\n\n\t#define r0 1.0\n\t#define v0 0.339\n\t#define m0 - 2.0\n\t#define r1 0.8\n\t#define v1 0.276\n\t#define m1 - 1.0\n\t#define r4 0.4\n\t#define v4 0.046\n\t#define m4 2.0\n\t#define r5 0.305\n\t#define v5 0.016\n\t#define m5 3.0\n\t#define r6 0.21\n\t#define v6 0.0038\n\t#define m6 4.0\n\n\tfloat roughnessToMip( float roughness ) {\n\n\t\tfloat mip = 0.0;\n\n\t\tif ( roughness >= r1 ) {\n\n\t\t\tmip = ( r0 - roughness ) * ( m1 - m0 ) / ( r0 - r1 ) + m0;\n\n\t\t} else if ( roughness >= r4 ) {\n\n\t\t\tmip = ( r1 - roughness ) * ( m4 - m1 ) / ( r1 - r4 ) + m1;\n\n\t\t} else if ( roughness >= r5 ) {\n\n\t\t\tmip = ( r4 - roughness ) * ( m5 - m4 ) / ( r4 - r5 ) + m4;\n\n\t\t} else if ( roughness >= r6 ) {\n\n\t\t\tmip = ( r5 - roughness ) * ( m6 - m5 ) / ( r5 - r6 ) + m5;\n\n\t\t} else {\n\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness ); // 1.16 = 1.79^0.25\n\t\t}\n\n\t\treturn mip;\n\n\t}\n\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\n\t\tfloat mip = clamp( roughnessToMip( roughness ), m0, CUBEUV_MAX_MIP );\n\n\t\tfloat mipF = fract( mip );\n\n\t\tfloat mipInt = floor( mip );\n\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\n\t\tif ( mipF == 0.0 ) {\n\n\t\t\treturn vec4( color0, 1.0 );\n\n\t\t} else {\n\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\n\t\t}\n\n\t}\n\n#endif\n",defaultnormal_vertex:"\nvec3 transformedNormal = objectNormal;\n\n#ifdef USE_INSTANCING\n\n\t// this is in lieu of a per-instance normal-matrix\n\t// shear transforms in the instance matrix are not supported\n\n\tmat3 m = mat3( instanceMatrix );\n\n\ttransformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n\n\ttransformedNormal = m * transformedNormal;\n\n#endif\n\ntransformedNormal = normalMatrix * transformedNormal;\n\n#ifdef FLIP_SIDED\n\n\ttransformedNormal = - transformedNormal;\n\n#endif\n\n#ifdef USE_TANGENT\n\n\tvec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\n\t#ifdef FLIP_SIDED\n\n\t\ttransformedTangent = - transformedTangent;\n\n\t#endif\n\n#endif\n",displacementmap_pars_vertex:"\n#ifdef USE_DISPLACEMENTMAP\n\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n\n#endif\n",displacementmap_vertex:"\n#ifdef USE_DISPLACEMENTMAP\n\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vUv ).x * displacementScale + displacementBias );\n\n#endif\n",emissivemap_fragment:"\n#ifdef USE_EMISSIVEMAP\n\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n\n#endif\n",emissivemap_pars_fragment:"\n#ifdef USE_EMISSIVEMAP\n\n\tuniform sampler2D emissiveMap;\n\n#endif\n",encodings_fragment:"\ngl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment:"\n\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\n\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}\n\n",envmap_fragment:"\n#ifdef USE_ENVMAP\n\n\t#ifdef ENV_WORLDPOS\n\n\t\tvec3 cameraToFrag;\n\n\t\tif ( isOrthographic ) {\n\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\n\t\t} else {\n\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\n\t\t}\n\n\t\t// Transforming Normal Vectors with the Inverse Transformation\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\n\t\t#else\n\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\n\t\t#endif\n\n\t#else\n\n\t\tvec3 reflectVec = vReflect;\n\n\t#endif\n\n\t#ifdef ENVMAP_TYPE_CUBE\n\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\tvec4 envColor = textureCubeUV( envMap, reflectVec, 0.0 );\n\n\t#else\n\n\t\tvec4 envColor = vec4( 0.0 );\n\n\t#endif\n\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\n\t#endif\n\n#endif\n",envmap_common_pars_fragment:"\n#ifdef USE_ENVMAP\n\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif\n",envmap_pars_fragment:"\n#ifdef USE_ENVMAP\n\n\tuniform float reflectivity;\n\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\n\t\t#define ENV_WORLDPOS\n\n\t#endif\n\n\t#ifdef ENV_WORLDPOS\n\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n\n#endif\n",envmap_pars_vertex:"\n#ifdef USE_ENVMAP\n\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) ||defined( PHONG )\n\n\t\t#define ENV_WORLDPOS\n\n\t#endif\n\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\n\t#else\n\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\n\t#endif\n\n#endif\n",envmap_physical_pars_fragment:"\n#if defined( USE_ENVMAP )\n\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\n\t\t#if defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );\n\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\n\t\t#else\n\n\t\t\treturn vec3( 0.0 );\n\n\t\t#endif\n\n\t}\n\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\n\t\t#if defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\n\t\t\t// Mixing the reflection with the normal is more accurate and keeps rough objects from gathering light from behind their tangent plane.\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );\n\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\n\t\t#else\n\n\t\t\treturn vec3( 0.0 );\n\n\t\t#endif\n\n\t}\n\n#endif\n",envmap_vertex:"\n#ifdef USE_ENVMAP\n\n\t#ifdef ENV_WORLDPOS\n\n\t\tvWorldPosition = worldPosition.xyz;\n\n\t#else\n\n\t\tvec3 cameraToVertex;\n\n\t\tif ( isOrthographic ) {\n\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\n\t\t} else {\n\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\n\t\t}\n\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\n\t\t#else\n\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\n\t\t#endif\n\n\t#endif\n\n#endif\n",fog_vertex:"\n#ifdef USE_FOG\n\n\tvFogDepth = - mvPosition.z;\n\n#endif\n",fog_pars_vertex:"\n#ifdef USE_FOG\n\n\tvarying float vFogDepth;\n\n#endif\n",fog_fragment:"\n#ifdef USE_FOG\n\n\t#ifdef FOG_EXP2\n\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\n\t#else\n\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\n\t#endif\n\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n\n#endif\n",fog_pars_fragment:"\n#ifdef USE_FOG\n\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\n\t#ifdef FOG_EXP2\n\n\t\tuniform float fogDensity;\n\n\t#else\n\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\n\t#endif\n\n#endif\n",gradientmap_pars_fragment:"\n\n#ifdef USE_GRADIENTMAP\n\n\tuniform sampler2D gradientMap;\n\n#endif\n\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\n\t// dotNL will be from -1.0 to 1.0\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\n\t#ifdef USE_GRADIENTMAP\n\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\n\t#else\n\n\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\n\t#endif\n\n}\n",lightmap_fragment:"\n#ifdef USE_LIGHTMAP\n\n\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\n\treflectedLight.indirectDiffuse += lightMapIrradiance;\n\n#endif\n",lightmap_pars_fragment:"\n#ifdef USE_LIGHTMAP\n\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n\n#endif\n",lights_lambert_vertex:"\nvec3 diffuse = vec3( 1.0 );\n\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( -mvPosition.xyz );\n\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\n\nvLightFront = vec3( 0.0 );\nvIndirectFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n\tvIndirectBack = vec3( 0.0 );\n#endif\n\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n\nvIndirectFront += getAmbientLightIrradiance( ambientLightColor );\n\nvIndirectFront += getLightProbeIrradiance( lightProbe, geometry.normal );\n\n#ifdef DOUBLE_SIDED\n\n\tvIndirectBack += getAmbientLightIrradiance( ambientLightColor );\n\n\tvIndirectBack += getLightProbeIrradiance( lightProbe, backGeometry.normal );\n\n#endif\n\n#if NUM_POINT_LIGHTS > 0\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tgetPointLightInfo( pointLights[ i ], geometry, directLight );\n\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = directLight.color;\n\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tvLightBack += saturate( - dotNL ) * directLightColor_Diffuse;\n\n\t\t#endif\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if NUM_SPOT_LIGHTS > 0\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tgetSpotLightInfo( spotLights[ i ], geometry, directLight );\n\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = directLight.color;\n\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tvLightBack += saturate( - dotNL ) * directLightColor_Diffuse;\n\n\t\t#endif\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if NUM_DIR_LIGHTS > 0\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tgetDirectionalLightInfo( directionalLights[ i ], geometry, directLight );\n\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = directLight.color;\n\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tvLightBack += saturate( - dotNL ) * directLightColor_Diffuse;\n\n\t\t#endif\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if NUM_HEMI_LIGHTS > 0\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\tvIndirectFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry.normal );\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\tvIndirectBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry.normal );\n\n\t\t#endif\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n",lights_pars_begin:"\nuniform bool receiveShadow;\nuniform vec3 ambientLightColor;\nuniform vec3 lightProbe[ 9 ];\n\n// get the irradiance (radiance convolved with cosine lobe) at the point 'normal' on the unit sphere\n// source: https://graphics.stanford.edu/papers/envmap/envmap.pdf\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\n\t// normal is assumed to have unit length\n\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\n\t// band 0\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\n\t// band 1\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\n\t// band 2\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\n\treturn result;\n\n}\n\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\n\treturn irradiance;\n\n}\n\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\n\tvec3 irradiance = ambientLightColor;\n\n\treturn irradiance;\n\n}\n\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\n\t#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\n\t\t// based upon Frostbite 3 Moving to Physically-based Rendering\n\t\t// page 32, equation 26: E[window1]\n\t\t// https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\n\t\tif ( cutoffDistance > 0.0 ) {\n\n\t\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\n\t\t}\n\n\t\treturn distanceFalloff;\n\n\t#else\n\n\t\tif ( cutoffDistance > 0.0 && decayExponent > 0.0 ) {\n\n\t\t\treturn pow( saturate( - lightDistance / cutoffDistance + 1.0 ), decayExponent );\n\n\t\t}\n\n\t\treturn 1.0;\n\n\t#endif\n\n}\n\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n\n}\n\n#if NUM_DIR_LIGHTS > 0\n\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight light ) {\n\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\n\t}\n\n#endif\n\n\n#if NUM_POINT_LIGHTS > 0\n\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\n\t// light is an out parameter as having it as a return value caused compiler errors on some devices\n\tvoid getPointLightInfo( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight light ) {\n\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\n\t\tlight.direction = normalize( lVector );\n\n\t\tfloat lightDistance = length( lVector );\n\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\n\t}\n\n#endif\n\n\n#if NUM_SPOT_LIGHTS > 0\n\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\n\t// light is an out parameter as having it as a return value caused compiler errors on some devices\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight light ) {\n\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\n\t\tlight.direction = normalize( lVector );\n\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\n\t\tif ( spotAttenuation > 0.0 ) {\n\n\t\t\tfloat lightDistance = length( lVector );\n\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\n\t\t} else {\n\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\n\t\t}\n\n\t}\n\n#endif\n\n\n#if NUM_RECT_AREA_LIGHTS > 0\n\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\n\t// Pre-computed values of LinearTransformedCosine approximation of BRDF\n\t// BRDF approximation Texture is 64x64\n\tuniform sampler2D ltc_1; // RGBA Float\n\tuniform sampler2D ltc_2; // RGBA Float\n\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n\n#endif\n\n\n#if NUM_HEMI_LIGHTS > 0\n\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\n\t\treturn irradiance;\n\n\t}\n\n#endif\n",lights_toon_fragment:"\nToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\n",lights_toon_pars_fragment:"\nvarying vec3 vViewPosition;\n\nstruct ToonMaterial {\n\n\tvec3 diffuseColor;\n\n};\n\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\n\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\n}\n\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in GeometricContext geometry, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\n}\n\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon\n\n#define Material_LightProbeLOD( material )\t(0)\n",lights_phong_fragment:"\nBlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment:"\nvarying vec3 vViewPosition;\n\nstruct BlinnPhongMaterial {\n\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n\n};\n\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularShininess ) * material.specularStrength;\n\n}\n\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\n}\n\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment:"\nPhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\n\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\n\nmaterial.roughness = max( roughnessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.\nmaterial.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n\n#ifdef IOR\n\n\t#ifdef SPECULAR\n\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\n\t\t#ifdef USE_SPECULARINTENSITYMAP\n\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vUv ).a;\n\n\t\t#endif\n\n\t\t#ifdef USE_SPECULARCOLORMAP\n\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vUv ).rgb;\n\n\t\t#endif\n\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\n\t#else\n\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\n\t#endif\n\n\tmaterial.specularColor = mix( min( pow2( ( ior - 1.0 ) / ( ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n\n#else\n\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n\n#endif\n\n#ifdef USE_CLEARCOAT\n\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\n\t#ifdef USE_CLEARCOATMAP\n\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vUv ).x;\n\n\t#endif\n\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vUv ).y;\n\n\t#endif\n\n\tmaterial.clearcoat = saturate( material.clearcoat ); // Burley clearcoat model\n\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n\n#endif\n\n#ifdef USE_SHEEN\n\n\tmaterial.sheenColor = sheenColor;\n\n\t#ifdef USE_SHEENCOLORMAP\n\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vUv ).rgb;\n\n\t#endif\n\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\n\t#ifdef USE_SHEENROUGHNESSMAP\n\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vUv ).a;\n\n\t#endif\n\n#endif\n",lights_physical_pars_fragment:'\nstruct PhysicalMaterial {\n\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\n};\n\n// temporary\nvec3 clearcoatSpecular = vec3( 0.0 );\nvec3 sheenSpecular = vec3( 0.0 );\n\n// This is a curve-fit approxmation to the "Charlie sheen" BRDF integrated over the hemisphere from \n// Estevez and Kulla 2017, "Production Friendly Microfacet Sheen BRDF". The analysis can be found\n// in the Sheen section of https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness) {\n\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\n\tfloat r2 = roughness * roughness;\n\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\n\treturn saturate( DG * RECIPROCAL_PI );\n\n}\n\n// Analytical approximation of the DFG LUT, one half of the\n// split-sum approximation used in indirect specular lighting.\n// via \'environmentBRDF\' from "Physically Based Shading on Mobile"\n// https://www.unrealengine.com/blog/physically-based-shading-on-mobile\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\n\tvec4 r = roughness * c0 + c1;\n\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\n\treturn fab;\n\n}\n\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\n\treturn specularColor * fab.x + specularF90 * fab.y;\n\n}\n\n// Fdez-Agüera\'s "Multiple-Scattering Microfacet Model for Real-Time Image Based Lighting"\n// Approximates multiscattering in order to preserve energy.\n// http://www.jcgt.org/published/0008/01/03/\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\n\tvec3 FssEss = specularColor * fab.x + specularF90 * fab.y;\n\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\n\tvec3 Favg = specularColor + ( 1.0 - specularColor ) * 0.047619; // 1/21\n\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n\n}\n\n#if NUM_RECT_AREA_LIGHTS > 0\n\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight; // counterclockwise; light shines in local neg z direction\n\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\n\t\t// LTC Fresnel Approximation by Stephen Hill\n\t\t// http://blog.selfshadow.com/publications/s2016-advances/s2016_ltc_fresnel.pdf\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\n\t}\n\n#endif\n\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\n\tvec3 irradiance = dotNL * directLight.color;\n\n\t#ifdef USE_CLEARCOAT\n\n\t\tfloat dotNLcc = saturate( dot( geometry.clearcoatNormal, directLight.direction ) );\n\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\n\t\tclearcoatSpecular += ccIrradiance * BRDF_GGX( directLight.direction, geometry.viewDir, geometry.clearcoatNormal, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\n\t#endif\n\n\t#ifdef USE_SHEEN\n\n\t\tsheenSpecular += irradiance * BRDF_Sheen( directLight.direction, geometry.viewDir, geometry.normal, material.sheenColor, material.sheenRoughness );\n\n\t#endif\n\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometry.viewDir, geometry.normal, material.specularColor, material.specularF90, material.roughness );\n\n\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\n}\n\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\n\t#ifdef USE_CLEARCOAT\n\n\t\tclearcoatSpecular += clearcoatRadiance * EnvironmentBRDF( geometry.clearcoatNormal, geometry.viewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\n\t#endif\n\n\t#ifdef USE_SHEEN\n\n\t\tsheenSpecular += irradiance * material.sheenColor * IBLSheenBRDF( geometry.normal, geometry.viewDir, material.sheenRoughness );\n\n\t#endif\n\n\t// Both indirect specular and indirect diffuse light accumulate here\n\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\n\tcomputeMultiscattering( geometry.normal, geometry.viewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - ( singleScattering + multiScattering ) );\n\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n\n}\n\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n\n// ref: https://seblagarde.files.wordpress.com/2015/07/course_notes_moving_frostbite_to_pbr_v32.pdf\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n\n}\n',lights_fragment_begin:"\n/**\n * This is a template that can be used to light a material, it uses pluggable\n * RenderEquations (RE)for specific lighting scenarios.\n *\n * Instructions for use:\n * - Ensure that both RE_Direct, RE_IndirectDiffuse and RE_IndirectSpecular are defined\n * - If you have defined an RE_IndirectSpecular, you need to also provide a Material_LightProbeLOD. <---- ???\n * - Create a material parameter that is to be passed as the third parameter to your lighting functions.\n *\n * TODO:\n * - Add area light support.\n * - Add sphere light support.\n * - Add diffuse light probe (irradiance cubemap) support.\n */\n\nGeometricContext geometry;\n\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\n\n#ifdef USE_CLEARCOAT\n\n\tgeometry.clearcoatNormal = clearcoatNormal;\n\n#endif\n\nIncidentLight directLight;\n\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\n\t\tpointLight = pointLights[ i ];\n\n\t\tgetPointLightInfo( pointLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tSpotLight spotLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\n\t\tspotLight = spotLights[ i ];\n\n\t\tgetSpotLightInfo( spotLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\n\t\tdirectionalLight = directionalLights[ i ];\n\n\t\tgetDirectionalLightInfo( directionalLight, geometry, directLight );\n\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= all( bvec2( directLight.visible, receiveShadow ) ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\n\tRectAreaLight rectAreaLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\n\t}\n\t#pragma unroll_loop_end\n\n#endif\n\n#if defined( RE_IndirectDiffuse )\n\n\tvec3 iblIrradiance = vec3( 0.0 );\n\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\n\tirradiance += getLightProbeIrradiance( lightProbe, geometry.normal );\n\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry.normal );\n\n\t\t}\n\t\t#pragma unroll_loop_end\n\n\t#endif\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n\n#endif\n",lights_fragment_maps:"\n#if defined( RE_IndirectDiffuse )\n\n\t#ifdef USE_LIGHTMAP\n\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\n\t\tirradiance += lightMapIrradiance;\n\n\t#endif\n\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\n\t\tiblIrradiance += getIBLIrradiance( geometry.normal );\n\n\t#endif\n\n#endif\n\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\n\tradiance += getIBLRadiance( geometry.viewDir, geometry.normal, material.roughness );\n\n\t#ifdef USE_CLEARCOAT\n\n\t\tclearcoatRadiance += getIBLRadiance( geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness );\n\n\t#endif\n\n#endif\n",lights_fragment_end:"\n#if defined( RE_IndirectDiffuse )\n\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n\n#endif\n\n#if defined( RE_IndirectSpecular )\n\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometry, material, reflectedLight );\n\n#endif\n",logdepthbuf_fragment:"\n#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\n\t// Doing a strict comparison with == 1.0 can cause noise artifacts\n\t// on some platforms. See issue #17623.\n\tgl_FragDepthEXT = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n\n#endif\n",logdepthbuf_pars_fragment:"\n#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n\n#endif\n",logdepthbuf_pars_vertex:"\n#ifdef USE_LOGDEPTHBUF\n\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\n\t\tvarying float vFragDepth;\n\t\tvarying float vIsPerspective;\n\n\t#else\n\n\t\tuniform float logDepthBufFC;\n\n\t#endif\n\n#endif\n",logdepthbuf_vertex:"\n#ifdef USE_LOGDEPTHBUF\n\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n\n\t#else\n\n\t\tif ( isPerspectiveMatrix( projectionMatrix ) ) {\n\n\t\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\n\t\t\tgl_Position.z *= gl_Position.w;\n\n\t\t}\n\n\t#endif\n\n#endif\n",map_fragment:"\n#ifdef USE_MAP\n\n\tvec4 sampledDiffuseColor = texture2D( map, vUv );\n\n\t#ifdef DECODE_VIDEO_TEXTURE\n\n\t\t// inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)\n\n\t\tsampledDiffuseColor = vec4( mix( pow( sampledDiffuseColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), sampledDiffuseColor.rgb * 0.0773993808, vec3( lessThanEqual( sampledDiffuseColor.rgb, vec3( 0.04045 ) ) ) ), sampledDiffuseColor.w );\n\n\t#endif\n\n\tdiffuseColor *= sampledDiffuseColor;\n\n#endif\n",map_pars_fragment:"\n#ifdef USE_MAP\n\n\tuniform sampler2D map;\n\n#endif\n",map_particle_fragment:"\n#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\n#endif\n\n#ifdef USE_MAP\n\n\tdiffuseColor *= texture2D( map, uv );\n\n#endif\n\n#ifdef USE_ALPHAMAP\n\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n\n#endif\n",map_particle_pars_fragment:"\n#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\n\tuniform mat3 uvTransform;\n\n#endif\n\n#ifdef USE_MAP\n\n\tuniform sampler2D map;\n\n#endif\n\n#ifdef USE_ALPHAMAP\n\n\tuniform sampler2D alphaMap;\n\n#endif\n",metalnessmap_fragment:"\nfloat metalnessFactor = metalness;\n\n#ifdef USE_METALNESSMAP\n\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\n\t// reads channel B, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n\tmetalnessFactor *= texelMetalness.b;\n\n#endif\n",metalnessmap_pars_fragment:"\n#ifdef USE_METALNESSMAP\n\n\tuniform sampler2D metalnessMap;\n\n#endif\n",morphcolor_vertex:"\n#if defined( USE_MORPHCOLORS ) && defined( MORPHTARGETS_TEXTURE )\n\n\t// morphTargetBaseInfluence is set based on BufferGeometry.morphTargetsRelative value:\n\t// When morphTargetsRelative is false, this is set to 1 - sum(influences); this results in normal = sum((target - base) * influence)\n\t// When morphTargetsRelative is true, this is set to 1; as a result, all morph targets are simply added to the base after weighting\n\tvColor *= morphTargetBaseInfluence;\n\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\n\t\t#if defined( USE_COLOR_ALPHA )\n\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\n\t\t#elif defined( USE_COLOR )\n\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\n\t\t#endif\n\n\t}\n\n#endif\n",morphnormal_vertex:"\n#ifdef USE_MORPHNORMALS\n\n\t// morphTargetBaseInfluence is set based on BufferGeometry.morphTargetsRelative value:\n\t// When morphTargetsRelative is false, this is set to 1 - sum(influences); this results in normal = sum((target - base) * influence)\n\t// When morphTargetsRelative is true, this is set to 1; as a result, all morph targets are simply added to the base after weighting\n\tobjectNormal *= morphTargetBaseInfluence;\n\n\t#ifdef MORPHTARGETS_TEXTURE\n\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\n\t\t}\n\n\t#else\n\n\t\tobjectNormal += morphNormal0 * morphTargetInfluences[ 0 ];\n\t\tobjectNormal += morphNormal1 * morphTargetInfluences[ 1 ];\n\t\tobjectNormal += morphNormal2 * morphTargetInfluences[ 2 ];\n\t\tobjectNormal += morphNormal3 * morphTargetInfluences[ 3 ];\n\n\t#endif\n\n#endif\n",morphtarget_pars_vertex:"\n#ifdef USE_MORPHTARGETS\n\n\tuniform float morphTargetBaseInfluence;\n\n\t#ifdef MORPHTARGETS_TEXTURE\n\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t\tuniform sampler2DArray morphTargetsTexture;\n\t\tuniform ivec2 morphTargetsTextureSize;\n\n\t\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\n\t\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\n\t\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\n\t\t}\n\n\t#else\n\n\t\t#ifndef USE_MORPHNORMALS\n\n\t\t\tuniform float morphTargetInfluences[ 8 ];\n\n\t\t#else\n\n\t\t\tuniform float morphTargetInfluences[ 4 ];\n\n\t\t#endif\n\n\t#endif\n\n#endif\n",morphtarget_vertex:"\n#ifdef USE_MORPHTARGETS\n\n\t// morphTargetBaseInfluence is set based on BufferGeometry.morphTargetsRelative value:\n\t// When morphTargetsRelative is false, this is set to 1 - sum(influences); this results in position = sum((target - base) * influence)\n\t// When morphTargetsRelative is true, this is set to 1; as a result, all morph targets are simply added to the base after weighting\n\ttransformed *= morphTargetBaseInfluence;\n\n\t#ifdef MORPHTARGETS_TEXTURE\n\n\t\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\n\t\t}\n\n\t#else\n\n\t\ttransformed += morphTarget0 * morphTargetInfluences[ 0 ];\n\t\ttransformed += morphTarget1 * morphTargetInfluences[ 1 ];\n\t\ttransformed += morphTarget2 * morphTargetInfluences[ 2 ];\n\t\ttransformed += morphTarget3 * morphTargetInfluences[ 3 ];\n\n\t\t#ifndef USE_MORPHNORMALS\n\n\t\t\ttransformed += morphTarget4 * morphTargetInfluences[ 4 ];\n\t\t\ttransformed += morphTarget5 * morphTargetInfluences[ 5 ];\n\t\t\ttransformed += morphTarget6 * morphTargetInfluences[ 6 ];\n\t\t\ttransformed += morphTarget7 * morphTargetInfluences[ 7 ];\n\n\t\t#endif\n\n\t#endif\n\n#endif\n",normal_fragment_begin:"\nfloat faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n\n#ifdef FLAT_SHADED\n\n\t// Workaround for Adreno GPUs not able to do dFdx( vViewPosition )\n\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n\n#else\n\n\tvec3 normal = normalize( vNormal );\n\n\t#ifdef DOUBLE_SIDED\n\n\t\tnormal = normal * faceDirection;\n\n\t#endif\n\n\t#ifdef USE_TANGENT\n\n\t\tvec3 tangent = normalize( vTangent );\n\t\tvec3 bitangent = normalize( vBitangent );\n\n\t\t#ifdef DOUBLE_SIDED\n\n\t\t\ttangent = tangent * faceDirection;\n\t\t\tbitangent = bitangent * faceDirection;\n\n\t\t#endif\n\n\t\t#if defined( TANGENTSPACE_NORMALMAP ) || defined( USE_CLEARCOAT_NORMALMAP )\n\n\t\t\tmat3 vTBN = mat3( tangent, bitangent, normal );\n\n\t\t#endif\n\n\t#endif\n\n#endif\n\n// non perturbed normal for clearcoat among others\n\nvec3 geometryNormal = normal;\n\n",normal_fragment_maps:"\n\n#ifdef OBJECTSPACE_NORMALMAP\n\n\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0; // overrides both flatShading and attribute normals\n\n\t#ifdef FLIP_SIDED\n\n\t\tnormal = - normal;\n\n\t#endif\n\n\t#ifdef DOUBLE_SIDED\n\n\t\tnormal = normal * faceDirection;\n\n\t#endif\n\n\tnormal = normalize( normalMatrix * normal );\n\n#elif defined( TANGENTSPACE_NORMALMAP )\n\n\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\n\t#ifdef USE_TANGENT\n\n\t\tnormal = normalize( vTBN * mapN );\n\n\t#else\n\n\t\tnormal = perturbNormal2Arb( - vViewPosition, normal, mapN, faceDirection );\n\n\t#endif\n\n#elif defined( USE_BUMPMAP )\n\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n\n#endif\n",normal_pars_fragment:"\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n\t#ifdef USE_TANGENT\n\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\n\t#endif\n\n#endif\n",normal_pars_vertex:"\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n\t#ifdef USE_TANGENT\n\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\n\t#endif\n\n#endif\n",normal_vertex:"\n#ifndef FLAT_SHADED // normal is computed with derivatives when FLAT_SHADED\n\n\tvNormal = normalize( transformedNormal );\n\n\t#ifdef USE_TANGENT\n\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\n\t#endif\n\n#endif\n",normalmap_pars_fragment:"\n#ifdef USE_NORMALMAP\n\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\n#endif\n\n#ifdef OBJECTSPACE_NORMALMAP\n\n\tuniform mat3 normalMatrix;\n\n#endif\n\n#if ! defined ( USE_TANGENT ) && ( defined ( TANGENTSPACE_NORMALMAP ) || defined ( USE_CLEARCOAT_NORMALMAP ) )\n\n\t// Normal Mapping Without Precomputed Tangents\n\t// http://www.thetenthplanet.de/archives/1180\n\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm, vec3 mapN, float faceDirection ) {\n\n\t\t// Workaround for Adreno 3XX dFd*( vec3 ) bug. See #9988\n\n\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\n\t\tvec3 N = surf_norm; // normalized\n\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : faceDirection * inversesqrt( det );\n\n\t\treturn normalize( T * ( mapN.x * scale ) + B * ( mapN.y * scale ) + N * mapN.z );\n\n\t}\n\n#endif\n",clearcoat_normal_fragment_begin:"\n#ifdef USE_CLEARCOAT\n\n\tvec3 clearcoatNormal = geometryNormal;\n\n#endif\n",clearcoat_normal_fragment_maps:"\n#ifdef USE_CLEARCOAT_NORMALMAP\n\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\n\t#ifdef USE_TANGENT\n\n\t\tclearcoatNormal = normalize( vTBN * clearcoatMapN );\n\n\t#else\n\n\t\tclearcoatNormal = perturbNormal2Arb( - vViewPosition, clearcoatNormal, clearcoatMapN, faceDirection );\n\n\t#endif\n\n#endif\n",clearcoat_pars_fragment:"\n\n#ifdef USE_CLEARCOATMAP\n\n\tuniform sampler2D clearcoatMap;\n\n#endif\n\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\n\tuniform sampler2D clearcoatRoughnessMap;\n\n#endif\n\n#ifdef USE_CLEARCOAT_NORMALMAP\n\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n\n#endif\n",output_fragment:"\n#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n\n// https://github.com/mrdoob/three.js/pull/22425\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= transmissionAlpha + 0.1;\n#endif\n\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );\n",packing:"\nvec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\n\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\n\nconst float PackUpscale = 256. / 255.; // fraction -> 0..1 (including 1)\nconst float UnpackDownscale = 255. / 256.; // 0..1 -> fraction (excluding 1)\n\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\nconst float ShiftRight8 = 1. / 256.;\n\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8; // tidy overflow\n\treturn r * PackUpscale;\n}\n\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\n\nvec4 pack2HalfToRGBA( vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\n\nvec2 unpackRGBATo2Half( vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\n\n// NOTE: viewZ/eyeZ is < 0 when in front of the camera per OpenGL conventions\n\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\n\n// NOTE: https://twitter.com/gonnavis/status/1377183786949959682\n\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment:"\n#ifdef PREMULTIPLIED_ALPHA\n\n\t// Get get normal blending with premultipled, use with CustomBlending, OneFactor, OneMinusSrcAlphaFactor, AddEquation.\n\tgl_FragColor.rgb *= gl_FragColor.a;\n\n#endif\n",project_vertex:"\nvec4 mvPosition = vec4( transformed, 1.0 );\n\n#ifdef USE_INSTANCING\n\n\tmvPosition = instanceMatrix * mvPosition;\n\n#endif\n\nmvPosition = modelViewMatrix * mvPosition;\n\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment:"\n#ifdef DITHERING\n\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n\n#endif\n",dithering_pars_fragment:"\n#ifdef DITHERING\n\n\t// based on https://www.shadertoy.com/view/MslGR8\n\tvec3 dithering( vec3 color ) {\n\t\t//Calculate grid position\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\n\t\t//Shift the individual colors differently, thus making it even harder to see the dithering pattern\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\n\t\t//modify shift according to grid position.\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\n\t\t//shift the color by dither_shift\n\t\treturn color + dither_shift_RGB;\n\t}\n\n#endif\n",roughnessmap_fragment:"\nfloat roughnessFactor = roughness;\n\n#ifdef USE_ROUGHNESSMAP\n\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\n\t// reads channel G, compatible with a combined OcclusionRoughnessMetallic (RGB) texture\n\troughnessFactor *= texelRoughness.g;\n\n#endif\n",roughnessmap_pars_fragment:"\n#ifdef USE_ROUGHNESSMAP\n\n\tuniform sampler2D roughnessMap;\n\n#endif\n",shadowmap_pars_fragment:"\n#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t/*\n\t#if NUM_RECT_AREA_LIGHTS > 0\n\n\t\t// TODO (abelnation): create uniforms for area light shadows\n\n\t#endif\n\t*/\n\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\n\t}\n\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\n\t}\n\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\n\t\tfloat occlusion = 1.0;\n\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\n\t\tfloat hard_shadow = step( compare , distribution.x ); // Hard Shadow\n\n\t\tif (hard_shadow != 1.0 ) {\n\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance ); // Chebeyshevs inequality\n\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 ); // 0.3 reduces light bleed\n\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\n\t\t}\n\t\treturn occlusion;\n\n\t}\n\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\n\t\tfloat shadow = 1.0;\n\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\n\t\t// if ( something && something ) breaks ATI OpenGL shader compiler\n\t\t// if ( all( something, something ) ) using this instead\n\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\n\t\tbool frustumTest = all( frustumTestVec );\n\n\t\tif ( frustumTest ) {\n\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ), \n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n\t\t#else // no percentage-closer filtering:\n\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\n\t\t#endif\n\n\t\t}\n\n\t\treturn shadow;\n\n\t}\n\n\t// cubeToUV() maps a 3D direction vector suitable for cube texture mapping to a 2D\n\t// vector suitable for 2D texture mapping. This code uses the following layout for the\n\t// 2D texture:\n\t//\n\t// xzXZ\n\t//  y Y\n\t//\n\t// Y - Positive y direction\n\t// y - Negative y direction\n\t// X - Positive x direction\n\t// x - Negative x direction\n\t// Z - Positive z direction\n\t// z - Negative z direction\n\t//\n\t// Source and test bed:\n\t// https://gist.github.com/tschw/da10c43c467ce8afd0c4\n\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\n\t\t// Number of texels to avoid at the edge of each square\n\n\t\tvec3 absV = abs( v );\n\n\t\t// Intersect unit cube\n\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\n\t\t// Apply scale to avoid seams\n\n\t\t// two texels less per square (one texel will do for NEAREST)\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\n\t\t// Unwrap\n\n\t\t// space: -1 ... 1 range for each square\n\t\t//\n\t\t// #X##\t\tdim    := ( 4 , 2 )\n\t\t//  # #\t\tcenter := ( 1 , 1 )\n\n\t\tvec2 planar = v.xy;\n\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\n\t\tif ( absV.z >= almostOne ) {\n\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\n\t\t} else if ( absV.x >= almostOne ) {\n\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\n\t\t} else if ( absV.y >= almostOne ) {\n\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\n\t\t}\n\n\t\t// Transform to UV space\n\n\t\t// scale := 0.5 / dim\n\t\t// translate := ( center + 0.5 ) / dim\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\n\t}\n\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\n\t\t// for point lights, the uniform @vShadowCoord is re-purposed to hold\n\t\t// the vector from the light to the world-space position of the fragment.\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\n\t\t// dp = normalized distance from light to fragment position\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear ); // need to clamp?\n\t\tdp += shadowBias;\n\n\t\t// bd3D = base direction 3D\n\t\tvec3 bd3D = normalize( lightToPosition );\n\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\n\t\t#else // no percentage-closer filtering\n\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\n\t\t#endif\n\n\t}\n\n#endif\n",shadowmap_pars_vertex:"\n#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHT_SHADOWS ];\n\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\n\t#endif\n\n\t/*\n\t#if NUM_RECT_AREA_LIGHTS > 0\n\n\t\t// TODO (abelnation): uniforms for area light shadows\n\n\t#endif\n\t*/\n\n#endif\n",shadowmap_vertex:"\n#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHT_SHADOWS > 0 || NUM_SPOT_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0\n\n\t\t// Offsetting the position used for querying occlusion along the world normal can be used to reduce shadow acne.\n\t\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\tvec4 shadowWorldPosition;\n\n\t#endif\n\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * shadowWorldPosition;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\n\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n\t/*\n\t#if NUM_RECT_AREA_LIGHTS > 0\n\n\t\t// TODO (abelnation): update vAreaShadowCoord with area light info\n\n\t#endif\n\t*/\n\n#endif\n",shadowmask_pars_fragment:"\nfloat getShadowMask() {\n\n\tfloat shadow = 1.0;\n\n\t#ifdef USE_SHADOWMAP\n\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\n\tDirectionalLightShadow directionalLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\n\tSpotLightShadow spotLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\n\tPointLightShadow pointLight;\n\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\n\t}\n\t#pragma unroll_loop_end\n\n\t#endif\n\n\t/*\n\t#if NUM_RECT_AREA_LIGHTS > 0\n\n\t\t// TODO (abelnation): update shadow for Area light\n\n\t#endif\n\t*/\n\n\t#endif\n\n\treturn shadow;\n\n}\n",skinbase_vertex:"\n#ifdef USE_SKINNING\n\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n\n#endif\n",skinning_pars_vertex:"\n#ifdef USE_SKINNING\n\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\n\tuniform highp sampler2D boneTexture;\n\tuniform int boneTextureSize;\n\n\tmat4 getBoneMatrix( const in float i ) {\n\n\t\tfloat j = i * 4.0;\n\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\tfloat y = floor( j / float( boneTextureSize ) );\n\n\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\tfloat dy = 1.0 / float( boneTextureSize );\n\n\t\ty = dy * ( y + 0.5 );\n\n\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\n\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\n\t\treturn bone;\n\n\t}\n\n#endif\n",skinning_vertex:"\n#ifdef USE_SKINNING\n\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n\n#endif\n",skinnormal_vertex:"\n#ifdef USE_SKINNING\n\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\n\t#ifdef USE_TANGENT\n\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\n\t#endif\n\n#endif\n",specularmap_fragment:"\nfloat specularStrength;\n\n#ifdef USE_SPECULARMAP\n\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n\n#else\n\n\tspecularStrength = 1.0;\n\n#endif\n",specularmap_pars_fragment:"\n#ifdef USE_SPECULARMAP\n\n\tuniform sampler2D specularMap;\n\n#endif\n",tonemapping_fragment:"\n#if defined( TONE_MAPPING )\n\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n\n#endif\n",tonemapping_pars_fragment:"\n#ifndef saturate\n// <common> may have defined saturate() already\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n\nuniform float toneMappingExposure;\n\n// exposure only\nvec3 LinearToneMapping( vec3 color ) {\n\n\treturn toneMappingExposure * color;\n\n}\n\n// source: https://www.cs.utah.edu/docs/techreports/2002/pdf/UUCS-02-001.pdf\nvec3 ReinhardToneMapping( vec3 color ) {\n\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n\n}\n\n// source: http://filmicworlds.com/blog/filmic-tonemapping-operators/\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\n\t// optimized filmic operator by Jim Hejl and Richard Burgess-Dawson\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n\n}\n\n// source: https://github.com/selfshadow/ltc_code/blob/master/webgl/shaders/ltc/ltc_blit.fs\nvec3 RRTAndODTFit( vec3 v ) {\n\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n\n}\n\n// this implementation of ACES is modified to accommodate a brighter viewing environment.\n// the scale factor of 1/0.6 is subjective. see discussion in #19621.\n\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\n\t// sRGB => XYZ => D65_2_D60 => AP1 => RRT_SAT\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ), // transposed from source\n\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\n\t// ODT_SAT => XYZ => D60_2_D65 => sRGB\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ), // transposed from source\n\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\n\tcolor *= toneMappingExposure / 0.6;\n\n\tcolor = ACESInputMat * color;\n\n\t// Apply RRT and ODT\n\tcolor = RRTAndODTFit( color );\n\n\tcolor = ACESOutputMat * color;\n\n\t// Clamp to [0, 1]\n\treturn saturate( color );\n\n}\n\nvec3 CustomToneMapping( vec3 color ) { return color; }\n",transmission_fragment:"\n#ifdef USE_TRANSMISSION\n\n\tfloat transmissionAlpha = 1.0;\n\tfloat transmissionFactor = transmission;\n\tfloat thicknessFactor = thickness;\n\n\t#ifdef USE_TRANSMISSIONMAP\n\n\t\ttransmissionFactor *= texture2D( transmissionMap, vUv ).r;\n\n\t#endif\n\n\t#ifdef USE_THICKNESSMAP\n\n\t\tthicknessFactor *= texture2D( thicknessMap, vUv ).g;\n\n\t#endif\n\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\n\tvec4 transmission = getIBLVolumeRefraction(\n\t\tn, v, roughnessFactor, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, ior, thicknessFactor,\n\t\tattenuationColor, attenuationDistance );\n\n\ttotalDiffuse = mix( totalDiffuse, transmission.rgb, transmissionFactor );\n\ttransmissionAlpha = mix( transmissionAlpha, transmission.a, transmissionFactor );\n#endif\n",transmission_pars_fragment:"\n#ifdef USE_TRANSMISSION\n\n\t// Transmission code is based on glTF-Sampler-Viewer\n\t// https://github.com/KhronosGroup/glTF-Sample-Viewer\n\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\n\t#ifdef USE_TRANSMISSIONMAP\n\n\t\tuniform sampler2D transmissionMap;\n\n\t#endif\n\n\t#ifdef USE_THICKNESSMAP\n\n\t\tuniform sampler2D thicknessMap;\n\n\t#endif\n\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\n\tvarying vec3 vWorldPosition;\n\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\n\t\t// Direction of refracted light.\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\n\t\t// Compute rotation-independant scaling of the model matrix.\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\n\t\t// The thickness is specified in local space.\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\n\t}\n\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\n\t\t// Scale roughness with IOR so that an IOR of 1.0 results in no microfacet refraction and\n\t\t// an IOR of 1.5 results in the default amount of microfacet refraction.\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\n\t}\n\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\n\t\tfloat framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\n\t\t#ifdef texture2DLodEXT\n\n\t\t\treturn texture2DLodEXT( transmissionSamplerMap, fragCoord.xy, framebufferLod );\n\n\t\t#else\n\n\t\t\treturn texture2D( transmissionSamplerMap, fragCoord.xy, framebufferLod );\n\n\t\t#endif\n\n\t}\n\n\tvec3 applyVolumeAttenuation( const in vec3 radiance, const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\n\t\tif ( attenuationDistance == 0.0 ) {\n\n\t\t\t// Attenuation distance is +∞ (which we indicate by zero), i.e. the transmitted color is not attenuated at all.\n\t\t\treturn radiance;\n\n\t\t} else {\n\n\t\t\t// Compute light attenuation using Beer's law.\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance ); // Beer's law\n\t\t\treturn transmittance * radiance;\n\n\t\t}\n\n\t}\n\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\n\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\tvec3 refractedRayExit = position + transmissionRay;\n\n\t\t// Project refracted vector on the framebuffer, while mapping to normalized device coordinates.\n\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\trefractionCoords += 1.0;\n\t\trefractionCoords /= 2.0;\n\n\t\t// Sample framebuffer to get pixel the refracted ray hits.\n\t\tvec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\n\t\tvec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );\n\n\t\t// Get the specular component.\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );\n\n\t}\n#endif\n",uv_pars_fragment:"\n#if ( defined( USE_UV ) && ! defined( UVS_VERTEX_ONLY ) )\n\n\tvarying vec2 vUv;\n\n#endif\n",uv_pars_vertex:"\n#ifdef USE_UV\n\n\t#ifdef UVS_VERTEX_ONLY\n\n\t\tvec2 vUv;\n\n\t#else\n\n\t\tvarying vec2 vUv;\n\n\t#endif\n\n\tuniform mat3 uvTransform;\n\n#endif\n",uv_vertex:"\n#ifdef USE_UV\n\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\n#endif\n",uv2_pars_fragment:"\n#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n\tvarying vec2 vUv2;\n\n#endif\n",uv2_pars_vertex:"\n#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n\n\tuniform mat3 uv2Transform;\n\n#endif\n",uv2_vertex:"\n#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\n\tvUv2 = ( uv2Transform * vec3( uv2, 1 ) ).xy;\n\n#endif\n",worldpos_vertex:"\n#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION )\n\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\n\t#ifdef USE_INSTANCING\n\n\t\tworldPosition = instanceMatrix * worldPosition;\n\n\t#endif\n\n\tworldPosition = modelMatrix * worldPosition;\n\n#endif\n",background_vert:"\nvarying vec2 vUv;\nuniform mat3 uvTransform;\n\nvoid main() {\n\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n\n}\n",background_frag:"\nuniform sampler2D t2D;\n\nvarying vec2 vUv;\n\nvoid main() {\n\n\tgl_FragColor = texture2D( t2D, vUv );\n\n\t#ifdef DECODE_VIDEO_TEXTURE\n\n\t\t// inline sRGB decode (TODO: Remove this code when https://crbug.com/1256340 is solved)\n\n\t\tgl_FragColor = vec4( mix( pow( gl_FragColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), gl_FragColor.rgb * 0.0773993808, vec3( lessThanEqual( gl_FragColor.rgb, vec3( 0.04045 ) ) ) ), gl_FragColor.w );\n\n\t#endif\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\n}\n",cube_vert:"\nvarying vec3 vWorldDirection;\n\n#include <common>\n\nvoid main() {\n\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\n\tgl_Position.z = gl_Position.w; // set z to camera.far\n\n}\n",cube_frag:"\n#include <envmap_common_pars_fragment>\nuniform float opacity;\n\nvarying vec3 vWorldDirection;\n\n#include <cube_uv_reflection_fragment>\n\nvoid main() {\n\n\tvec3 vReflect = vWorldDirection;\n\t#include <envmap_fragment>\n\n\tgl_FragColor = envColor;\n\tgl_FragColor.a *= opacity;\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\n}\n",depth_vert:"\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\n// This is used for computing an equivalent of gl_FragCoord.z that is as high precision as possible.\n// Some platforms compute gl_FragCoord at a lower precision which makes the manually computed value better for\n// depth-based postprocessing effects. Reproduced on iPad with A10 processor / iPadOS 13.3.1.\nvarying vec2 vHighPrecisionZW;\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\t#include <skinbase_vertex>\n\n\t#ifdef USE_DISPLACEMENTMAP\n\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\n\t#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvHighPrecisionZW = gl_Position.zw;\n\n}\n",depth_frag:"\n#if DEPTH_PACKING == 3200\n\n\tuniform float opacity;\n\n#endif\n\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvarying vec2 vHighPrecisionZW;\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( 1.0 );\n\n\t#if DEPTH_PACKING == 3200\n\n\t\tdiffuseColor.a = opacity;\n\n\t#endif\n\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\n\t#include <logdepthbuf_fragment>\n\n\t// Higher precision equivalent of gl_FragCoord.z. This assumes depthRange has been left to its default values.\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\n\t#if DEPTH_PACKING == 3200\n\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\n\t#elif DEPTH_PACKING == 3201\n\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\n\t#endif\n\n}\n",distanceRGBA_vert:"\n#define DISTANCE\n\nvarying vec3 vWorldPosition;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\t#include <skinbase_vertex>\n\n\t#ifdef USE_DISPLACEMENTMAP\n\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\n\t#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvWorldPosition = worldPosition.xyz;\n\n}\n",distanceRGBA_frag:"\n#define DISTANCE\n\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main () {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( 1.0 );\n\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist ); // clamp to [ 0, 1 ]\n\n\tgl_FragColor = packDepthToRGBA( dist );\n\n}\n",equirect_vert:"\nvarying vec3 vWorldDirection;\n\n#include <common>\n\nvoid main() {\n\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\n}\n",equirect_frag:"\nuniform sampler2D tEquirect;\n\nvarying vec3 vWorldDirection;\n\n#include <common>\n\nvoid main() {\n\n\tvec3 direction = normalize( vWorldDirection );\n\n\tvec2 sampleUV = equirectUv( direction );\n\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\n}\n",linedashed_vert:"\nuniform float scale;\nattribute float lineDistance;\n\nvarying float vLineDistance;\n\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\tvLineDistance = scale * lineDistance;\n\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\n}\n",linedashed_frag:"\nuniform vec3 diffuse;\nuniform float opacity;\n\nuniform float dashSize;\nuniform float totalSize;\n\nvarying float vLineDistance;\n\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\n\t\tdiscard;\n\n\t}\n\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\n\toutgoingLight = diffuseColor.rgb; // simple shader\n\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\n}\n",meshbasic_vert:"\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\n\t#endif\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n\n}\n",meshbasic_frag:"\nuniform vec3 diffuse;\nuniform float opacity;\n\n#ifndef FLAT_SHADED\n\n\tvarying vec3 vNormal;\n\n#endif\n\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\n\t// accumulation (baked indirect lighting only)\n\t#ifdef USE_LIGHTMAP\n\n\t\tvec4 lightMapTexel = texture2D( lightMap, vUv2 );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\n\t#else\n\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\n\t#endif\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\n\t#include <envmap_fragment>\n\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",meshlambert_vert:"\n#define LAMBERT\n\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshlambert_frag:"\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n\tvarying vec3 vIndirectBack;\n#endif\n\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\n\t#ifdef DOUBLE_SIDED\n\n\t\treflectedLight.indirectDiffuse += ( gl_FrontFacing ) ? vIndirectFront : vIndirectBack;\n\n\t#else\n\n\t\treflectedLight.indirectDiffuse += vIndirectFront;\n\n\t#endif\n\n\t#include <lightmap_fragment>\n\n\treflectedLight.indirectDiffuse *= BRDF_Lambert( diffuseColor.rgb );\n\n\t#ifdef DOUBLE_SIDED\n\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\n\t#else\n\n\t\treflectedLight.directDiffuse = vLightFront;\n\n\t#endif\n\n\treflectedLight.directDiffuse *= BRDF_Lambert( diffuseColor.rgb ) * getShadowMask();\n\n\t// modulation\n\n\t#include <aomap_fragment>\n\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\n\t#include <envmap_fragment>\n\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshmatcap_vert:"\n#define MATCAP\n\nvarying vec3 vViewPosition;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n}\n",meshmatcap_frag:"\n#define MATCAP\n\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\n\nvarying vec3 vViewPosition;\n\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5; // 0.495 to remove artifacts caused by undersized matcap disks\n\n\t#ifdef USE_MATCAP\n\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\n\t#else\n\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 ); // default if matcap is missing\n\n\t#endif\n\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",meshnormal_vert:"\n#define NORMAL\n\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\n\tvarying vec3 vViewPosition;\n\n#endif\n\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\n\tvViewPosition = - mvPosition.xyz;\n\n#endif\n\n}\n",meshnormal_frag:"\n#define NORMAL\n\nuniform float opacity;\n\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( TANGENTSPACE_NORMALMAP )\n\n\tvarying vec3 vViewPosition;\n\n#endif\n\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n\n\t#ifdef OPAQUE\n\n\t\tgl_FragColor.a = 1.0;\n\n\t#endif\n\n}\n",meshphong_vert:"\n#define PHONG\n\nvarying vec3 vViewPosition;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n\n}\n",meshphong_frag:"\n#define PHONG\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\n\t#include <envmap_fragment>\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",meshphysical_vert:"\n#define STANDARD\n\nvarying vec3 vViewPosition;\n\n#ifdef USE_TRANSMISSION\n\n\tvarying vec3 vWorldPosition;\n\n#endif\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n\n#ifdef USE_TRANSMISSION\n\n\tvWorldPosition = worldPosition.xyz;\n\n#endif\n}\n",meshphysical_frag:"\n#define STANDARD\n\n#ifdef PHYSICAL\n\t#define IOR\n\t#define SPECULAR\n#endif\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n\n#ifdef IOR\n\tuniform float ior;\n#endif\n\n#ifdef SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\n\t#ifdef USE_SPECULARINTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n\n\t#ifdef USE_SPECULARCOLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n#endif\n\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\n\t#ifdef USE_SHEENCOLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\n\t#ifdef USE_SHEENROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n\nvarying vec3 vViewPosition;\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\n\t#include <transmission_fragment>\n\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\n\t#ifdef USE_SHEEN\n\n\t\t// Sheen energy compensation approximation calculation can be found at the end of\n\t\t// https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n\n\t#endif\n\n\t#ifdef USE_CLEARCOAT\n\n\t\tfloat dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n\n\t#endif\n\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",meshtoon_vert:"\n#define TOON\n\nvarying vec3 vViewPosition;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n\tvViewPosition = - mvPosition.xyz;\n\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n\n}\n",meshtoon_frag:"\n#define TOON\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\n\t// accumulation\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\n\t// modulation\n\t#include <aomap_fragment>\n\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}\n",points_vert:"\nuniform float size;\nuniform float scale;\n\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\n\tgl_PointSize = size;\n\n\t#ifdef USE_SIZEATTENUATION\n\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\n\t#endif\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n\n}\n",points_frag:"\nuniform vec3 diffuse;\nuniform float opacity;\n\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\n\toutgoingLight = diffuseColor.rgb;\n\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\n}\n",shadow_vert:"\n#include <common>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n\nvoid main() {\n\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n\n}\n",shadow_frag:"\nuniform vec3 color;\nuniform float opacity;\n\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n\nvoid main() {\n\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\n}\n",sprite_vert:"\nuniform float rotation;\nuniform vec2 center;\n\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n\n\t#include <uv_vertex>\n\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\n\t#ifndef USE_SIZEATTENUATION\n\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\n\t#endif\n\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\n\tmvPosition.xy += rotatedPosition;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\n}\n",sprite_frag:"\nuniform vec3 diffuse;\nuniform float opacity;\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n\n\t#include <clipping_planes_fragment>\n\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\n\toutgoingLight = diffuseColor.rgb;\n\n\t#include <output_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\n}\n"};var y=n(8369),_=n(4894);const x={common:{diffuse:{value:new m.Color(16777215)},opacity:{value:1},map:{value:null},uvTransform:{value:new _.V},uv2Transform:{value:new _.V},alphaMap:{value:null},alphaTest:{value:0}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new o.Vector2(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new m.Color(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new m.Color(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new _.V}},sprite:{diffuse:{value:new m.Color(16777215)},opacity:{value:1},center:{value:new o.Vector2(.5,.5)},rotation:{value:0},map:{value:null},alphaMap:{value:null},alphaTest:{value:0},uvTransform:{value:new _.V}}},w={basic:{uniforms:(0,y.Rh)([x.common,x.specularmap,x.envmap,x.aomap,x.lightmap,x.fog]),vertexShader:v.meshbasic_vert,fragmentShader:v.meshbasic_frag},lambert:{uniforms:(0,y.Rh)([x.common,x.specularmap,x.envmap,x.aomap,x.lightmap,x.emissivemap,x.fog,x.lights,{emissive:{value:new m.Color(0)}}]),vertexShader:v.meshlambert_vert,fragmentShader:v.meshlambert_frag},phong:{uniforms:(0,y.Rh)([x.common,x.specularmap,x.envmap,x.aomap,x.lightmap,x.emissivemap,x.bumpmap,x.normalmap,x.displacementmap,x.fog,x.lights,{emissive:{value:new m.Color(0)},specular:{value:new m.Color(1118481)},shininess:{value:30}}]),vertexShader:v.meshphong_vert,fragmentShader:v.meshphong_frag},standard:{uniforms:(0,y.Rh)([x.common,x.envmap,x.aomap,x.lightmap,x.emissivemap,x.bumpmap,x.normalmap,x.displacementmap,x.roughnessmap,x.metalnessmap,x.fog,x.lights,{emissive:{value:new m.Color(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:v.meshphysical_vert,fragmentShader:v.meshphysical_frag},toon:{uniforms:(0,y.Rh)([x.common,x.aomap,x.lightmap,x.emissivemap,x.bumpmap,x.normalmap,x.displacementmap,x.gradientmap,x.fog,x.lights,{emissive:{value:new m.Color(0)}}]),vertexShader:v.meshtoon_vert,fragmentShader:v.meshtoon_frag},matcap:{uniforms:(0,y.Rh)([x.common,x.bumpmap,x.normalmap,x.displacementmap,x.fog,{matcap:{value:null}}]),vertexShader:v.meshmatcap_vert,fragmentShader:v.meshmatcap_frag},points:{uniforms:(0,y.Rh)([x.points,x.fog]),vertexShader:v.points_vert,fragmentShader:v.points_frag},dashed:{uniforms:(0,y.Rh)([x.common,x.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:v.linedashed_vert,fragmentShader:v.linedashed_frag},depth:{uniforms:(0,y.Rh)([x.common,x.displacementmap]),vertexShader:v.depth_vert,fragmentShader:v.depth_frag},normal:{uniforms:(0,y.Rh)([x.common,x.bumpmap,x.normalmap,x.displacementmap,{opacity:{value:1}}]),vertexShader:v.meshnormal_vert,fragmentShader:v.meshnormal_frag},sprite:{uniforms:(0,y.Rh)([x.sprite,x.fog]),vertexShader:v.sprite_vert,fragmentShader:v.sprite_frag},background:{uniforms:{uvTransform:{value:new _.V},t2D:{value:null}},vertexShader:v.background_vert,fragmentShader:v.background_frag},cube:{uniforms:(0,y.Rh)([x.envmap,{opacity:{value:1}}]),vertexShader:v.cube_vert,fragmentShader:v.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:v.equirect_vert,fragmentShader:v.equirect_frag},distanceRGBA:{uniforms:(0,y.Rh)([x.common,x.displacementmap,{referencePosition:{value:new l.Vector3},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:v.distanceRGBA_vert,fragmentShader:v.distanceRGBA_frag},shadow:{uniforms:(0,y.Rh)([x.lights,x.fog,{color:{value:new m.Color(0)},opacity:{value:1}}]),vertexShader:v.shadow_vert,fragmentShader:v.shadow_frag}};function b(t,e,n,r,s,a){const o=new m.Color(0);let l,c,u=!0===s?0:1,h=null,v=0,_=null;function x(t,e){n.buffers.color.setClear(t.r,t.g,t.b,e,a)}return{getClearColor:function(){return o},setClearColor:function(t,e=1){o.set(t),u=e,x(o,u)},getClearAlpha:function(){return u},setClearAlpha:function(t){u=t,x(o,u)},render:function(n,s){let a=!1,m=!0===s.isScene?s.background:null;m&&m.isTexture&&(m=e.get(m));const b=t.xr,S=b.getSession&&b.getSession();S&&"additive"===S.environmentBlendMode&&(m=null),null===m?x(o,u):m&&m.isColor&&(x(m,1),a=!0),(t.autoClear||a)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),m&&(m.isCubeTexture||m.mapping===i.g8_)?(void 0===c&&(c=new g.Mesh(new d.BoxGeometry(1,1,1),new p.ShaderMaterial({name:"BackgroundCubeMaterial",uniforms:(0,y.dw)(w.cube.uniforms),vertexShader:w.cube.vertexShader,fragmentShader:w.cube.fragmentShader,side:i._Li,depthTest:!1,depthWrite:!1,fog:!1})),c.geometry.deleteAttribute("normal"),c.geometry.deleteAttribute("uv"),c.onBeforeRender=function(t,e,n){this.matrixWorld.copyPosition(n.matrixWorld)},Object.defineProperty(c.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),r.update(c)),c.material.uniforms.envMap.value=m,c.material.uniforms.flipEnvMap.value=m.isCubeTexture&&!1===m.isRenderTargetTexture?-1:1,h===m&&v===m.version&&_===t.toneMapping||(c.material.needsUpdate=!0,h=m,v=m.version,_=t.toneMapping),c.layers.enableAll(),n.unshift(c,c.geometry,c.material,0,0,null)):m&&m.isTexture&&(void 0===l&&(l=new g.Mesh(new f.PlaneGeometry(2,2),new p.ShaderMaterial({name:"BackgroundMaterial",uniforms:(0,y.dw)(w.background.uniforms),vertexShader:w.background.vertexShader,fragmentShader:w.background.fragmentShader,side:i.Wl3,depthTest:!1,depthWrite:!1,fog:!1})),l.geometry.deleteAttribute("normal"),Object.defineProperty(l.material,"map",{get:function(){return this.uniforms.t2D.value}}),r.update(l)),l.material.uniforms.t2D.value=m,!0===m.matrixAutoUpdate&&m.updateMatrix(),l.material.uniforms.uvTransform.value.copy(m.matrix),h===m&&v===m.version&&_===t.toneMapping||(l.material.needsUpdate=!0,h=m,v=m.version,_=t.toneMapping),l.layers.enableAll(),n.unshift(l,l.geometry,l.material,0,0,null))}}}function S(t,e,n,i){const r=t.getParameter(t.MAX_VERTEX_ATTRIBS),s=i.isWebGL2?null:e.get("OES_vertex_array_object"),a=i.isWebGL2||null!==s,o={},l=f(null);let c=l,u=!1;function h(e){return i.isWebGL2?t.bindVertexArray(e):s.bindVertexArrayOES(e)}function d(e){return i.isWebGL2?t.deleteVertexArray(e):s.deleteVertexArrayOES(e)}function f(t){const e=[],n=[],i=[];for(let t=0;t<r;t++)e[t]=0,n[t]=0,i[t]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:e,enabledAttributes:n,attributeDivisors:i,object:t,attributes:{},index:null}}function p(){const t=c.newAttributes;for(let e=0,n=t.length;e<n;e++)t[e]=0}function m(t){g(t,0)}function g(n,r){const s=c.newAttributes,a=c.enabledAttributes,o=c.attributeDivisors;s[n]=1,0===a[n]&&(t.enableVertexAttribArray(n),a[n]=1),o[n]!==r&&((i.isWebGL2?t:e.get("ANGLE_instanced_arrays"))[i.isWebGL2?"vertexAttribDivisor":"vertexAttribDivisorANGLE"](n,r),o[n]=r)}function v(){const e=c.newAttributes,n=c.enabledAttributes;for(let i=0,r=n.length;i<r;i++)n[i]!==e[i]&&(t.disableVertexAttribArray(i),n[i]=0)}function y(e,n,r,s,a,o){!0!==i.isWebGL2||r!==t.INT&&r!==t.UNSIGNED_INT?t.vertexAttribPointer(e,n,r,s,a,o):t.vertexAttribIPointer(e,n,r,a,o)}function _(){x(),u=!0,c!==l&&(c=l,h(c.object))}function x(){l.geometry=null,l.program=null,l.wireframe=!1}return{setup:function(r,l,d,_,x){let w=!1;if(a){const e=function(e,n,r){const a=!0===r.wireframe;let l=o[e.id];void 0===l&&(l={},o[e.id]=l);let c=l[n.id];void 0===c&&(c={},l[n.id]=c);let u=c[a];return void 0===u&&(u=f(i.isWebGL2?t.createVertexArray():s.createVertexArrayOES()),c[a]=u),u}(_,d,l);c!==e&&(c=e,h(c.object)),w=function(t,e,n,i){const r=c.attributes,s=e.attributes;let a=0;const o=n.getAttributes();for(const e in o)if(o[e].location>=0){const n=r[e];let i=s[e];if(void 0===i&&("instanceMatrix"===e&&t.instanceMatrix&&(i=t.instanceMatrix),"instanceColor"===e&&t.instanceColor&&(i=t.instanceColor)),void 0===n)return!0;if(n.attribute!==i)return!0;if(i&&n.data!==i.data)return!0;a++}return c.attributesNum!==a||c.index!==i}(r,_,d,x),w&&function(t,e,n,i){const r={},s=e.attributes;let a=0;const o=n.getAttributes();for(const e in o)if(o[e].location>=0){let n=s[e];void 0===n&&("instanceMatrix"===e&&t.instanceMatrix&&(n=t.instanceMatrix),"instanceColor"===e&&t.instanceColor&&(n=t.instanceColor));const i={};i.attribute=n,n&&n.data&&(i.data=n.data),r[e]=i,a++}c.attributes=r,c.attributesNum=a,c.index=i}(r,_,d,x)}else{const t=!0===l.wireframe;c.geometry===_.id&&c.program===d.id&&c.wireframe===t||(c.geometry=_.id,c.program=d.id,c.wireframe=t,w=!0)}null!==x&&n.update(x,t.ELEMENT_ARRAY_BUFFER),(w||u)&&(u=!1,function(r,s,a,o){if(!1===i.isWebGL2&&(r.isInstancedMesh||o.isInstancedBufferGeometry)&&null===e.get("ANGLE_instanced_arrays"))return;p();const l=o.attributes,c=a.getAttributes(),u=s.defaultAttributeValues;for(const e in c){const i=c[e];if(i.location>=0){let s=l[e];if(void 0===s&&("instanceMatrix"===e&&r.instanceMatrix&&(s=r.instanceMatrix),"instanceColor"===e&&r.instanceColor&&(s=r.instanceColor)),void 0!==s){const e=s.normalized,a=s.itemSize,l=n.get(s);if(void 0===l)continue;const c=l.buffer,u=l.type,h=l.bytesPerElement;if(s.isInterleavedBufferAttribute){const n=s.data,l=n.stride,d=s.offset;if(n.isInstancedInterleavedBuffer){for(let t=0;t<i.locationSize;t++)g(i.location+t,n.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=n.meshPerAttribute*n.count)}else for(let t=0;t<i.locationSize;t++)m(i.location+t);t.bindBuffer(t.ARRAY_BUFFER,c);for(let t=0;t<i.locationSize;t++)y(i.location+t,a/i.locationSize,u,e,l*h,(d+a/i.locationSize*t)*h)}else{if(s.isInstancedBufferAttribute){for(let t=0;t<i.locationSize;t++)g(i.location+t,s.meshPerAttribute);!0!==r.isInstancedMesh&&void 0===o._maxInstanceCount&&(o._maxInstanceCount=s.meshPerAttribute*s.count)}else for(let t=0;t<i.locationSize;t++)m(i.location+t);t.bindBuffer(t.ARRAY_BUFFER,c);for(let t=0;t<i.locationSize;t++)y(i.location+t,a/i.locationSize,u,e,a*h,a/i.locationSize*t*h)}}else if(void 0!==u){const n=u[e];if(void 0!==n)switch(n.length){case 2:t.vertexAttrib2fv(i.location,n);break;case 3:t.vertexAttrib3fv(i.location,n);break;case 4:t.vertexAttrib4fv(i.location,n);break;default:t.vertexAttrib1fv(i.location,n)}}}}v()}(r,l,d,_),null!==x&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,n.get(x).buffer))},reset:_,resetDefaultState:x,dispose:function(){_();for(const t in o){const e=o[t];for(const t in e){const n=e[t];for(const t in n)d(n[t].object),delete n[t];delete e[t]}delete o[t]}},releaseStatesOfGeometry:function(t){if(void 0===o[t.id])return;const e=o[t.id];for(const t in e){const n=e[t];for(const t in n)d(n[t].object),delete n[t];delete e[t]}delete o[t.id]},releaseStatesOfProgram:function(t){for(const e in o){const n=o[e];if(void 0===n[t.id])continue;const i=n[t.id];for(const t in i)d(i[t].object),delete i[t];delete n[t.id]}},initAttributes:p,enableAttribute:m,disableUnusedAttributes:v}}function E(t,e,n,i){const r=i.isWebGL2;let s;this.setMode=function(t){s=t},this.render=function(e,i){t.drawArrays(s,e,i),n.update(i,s,1)},this.renderInstances=function(i,a,o){if(0===o)return;let l,c;if(r)l=t,c="drawArraysInstanced";else if(l=e.get("ANGLE_instanced_arrays"),c="drawArraysInstancedANGLE",null===l)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");l[c](s,i,a,o),n.update(a,s,o)}}function T(t,e,n){let i;function r(e){if("highp"===e){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}const s="undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext||"undefined"!=typeof WebGL2ComputeRenderingContext&&t instanceof WebGL2ComputeRenderingContext;let a=void 0!==n.precision?n.precision:"highp";const o=r(a);o!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",o,"instead."),a=o);const l=s||e.has("WEBGL_draw_buffers"),c=!0===n.logarithmicDepthBuffer,u=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),h=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),d=t.getParameter(t.MAX_TEXTURE_SIZE),f=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),p=t.getParameter(t.MAX_VERTEX_ATTRIBS),m=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),g=t.getParameter(t.MAX_VARYING_VECTORS),v=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),y=h>0,_=s||e.has("OES_texture_float");return{isWebGL2:s,drawBuffers:l,getMaxAnisotropy:function(){if(void 0!==i)return i;if(!0===e.has("EXT_texture_filter_anisotropic")){const n=e.get("EXT_texture_filter_anisotropic");i=t.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else i=0;return i},getMaxPrecision:r,precision:a,logarithmicDepthBuffer:c,maxTextures:u,maxVertexTextures:h,maxTextureSize:d,maxCubemapSize:f,maxAttributes:p,maxVertexUniforms:m,maxVaryings:g,maxFragmentUniforms:v,vertexTextures:y,floatFragmentTextures:_,floatVertexTextures:y&&_,maxSamples:s?t.getParameter(t.MAX_SAMPLES):0}}w.physical={uniforms:(0,y.Rh)([w.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatNormalScale:{value:new o.Vector2(1,1)},clearcoatNormalMap:{value:null},sheen:{value:0},sheenColor:{value:new m.Color(0)},sheenColorMap:{value:null},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},transmission:{value:0},transmissionMap:{value:null},transmissionSamplerSize:{value:new o.Vector2},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:0},attenuationColor:{value:new m.Color(0)},specularIntensity:{value:1},specularIntensityMap:{value:null},specularColor:{value:new m.Color(1,1,1)},specularColorMap:{value:null}}]),vertexShader:v.meshphysical_vert,fragmentShader:v.meshphysical_frag};var M=n(2158);function A(t){const e=this;let n=null,i=0,r=!1,s=!1;const a=new M.J,o=new _.V,l={value:null,needsUpdate:!1};function c(){l.value!==n&&(l.value=n,l.needsUpdate=i>0),e.numPlanes=i,e.numIntersection=0}function u(t,n,i,r){const s=null!==t?t.length:0;let c=null;if(0!==s){if(c=l.value,!0!==r||null===c){const e=i+4*s,r=n.matrixWorldInverse;o.getNormalMatrix(r),(null===c||c.length<e)&&(c=new Float32Array(e));for(let e=0,n=i;e!==s;++e,n+=4)a.copy(t[e]).applyMatrix4(r,o),a.normal.toArray(c,n),c[n+3]=a.constant}l.value=c,l.needsUpdate=!0}return e.numPlanes=s,e.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(t,e,s){const a=0!==t.length||e||0!==i||r;return r=e,n=u(t,s,0),i=t.length,a},this.beginShadows=function(){s=!0,u(null)},this.endShadows=function(){s=!1,c()},this.setState=function(e,a,o){const h=e.clippingPlanes,d=e.clipIntersection,f=e.clipShadows,p=t.get(e);if(!r||null===h||0===h.length||s&&!f)s?u(null):c();else{const t=s?0:i,e=4*t;let r=p.clippingState||null;l.value=r,r=u(h,a,e,o);for(let t=0;t!==e;++t)r[t]=n[t];p.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=t}}}var I=n(9574),C=n(5593),R=n(5817);class D extends I.p{constructor(t,e,n={}){super(),this.width=t,this.height=e,this.depth=1,this.scissor=new c.L(0,0,t,e),this.scissorTest=!1,this.viewport=new c.L(0,0,t,e);const r={width:t,height:e,depth:1};this.texture=new C.x(r,n.mapping,n.wrapS,n.wrapT,n.magFilter,n.minFilter,n.format,n.type,n.anisotropy,n.encoding),this.texture.isRenderTargetTexture=!0,this.texture.flipY=!1,this.texture.generateMipmaps=void 0!==n.generateMipmaps&&n.generateMipmaps,this.texture.internalFormat=void 0!==n.internalFormat?n.internalFormat:null,this.texture.minFilter=void 0!==n.minFilter?n.minFilter:i.wem,this.depthBuffer=void 0===n.depthBuffer||n.depthBuffer,this.stencilBuffer=void 0!==n.stencilBuffer&&n.stencilBuffer,this.depthTexture=void 0!==n.depthTexture?n.depthTexture:null,this.samples=void 0!==n.samples?n.samples:0}setSize(t,e,n=1){this.width===t&&this.height===e&&this.depth===n||(this.width=t,this.height=e,this.depth=n,this.texture.image.width=t,this.texture.image.height=e,this.texture.image.depth=n,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)}clone(){return(new this.constructor).copy(this)}copy(t){this.width=t.width,this.height=t.height,this.depth=t.depth,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.texture.isRenderTargetTexture=!0;const e=Object.assign({},t.texture.image);return this.texture.source=new R.H(e),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,null!==t.depthTexture&&(this.depthTexture=t.depthTexture.clone()),this.samples=t.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}D.prototype.isWebGLRenderTarget=!0;var L=n(1052),P=n(2096);const N=90;class O extends L.T{constructor(t,e,n){if(super(),this.type="CubeCamera",!0!==n.isWebGLCubeRenderTarget)return void console.error("THREE.CubeCamera: The constructor now expects an instance of WebGLCubeRenderTarget as third parameter.");this.renderTarget=n;const i=new P.PerspectiveCamera(N,1,t,e);i.layers=this.layers,i.up.set(0,-1,0),i.lookAt(new l.Vector3(1,0,0)),this.add(i);const r=new P.PerspectiveCamera(N,1,t,e);r.layers=this.layers,r.up.set(0,-1,0),r.lookAt(new l.Vector3(-1,0,0)),this.add(r);const s=new P.PerspectiveCamera(N,1,t,e);s.layers=this.layers,s.up.set(0,0,1),s.lookAt(new l.Vector3(0,1,0)),this.add(s);const a=new P.PerspectiveCamera(N,1,t,e);a.layers=this.layers,a.up.set(0,0,-1),a.lookAt(new l.Vector3(0,-1,0)),this.add(a);const o=new P.PerspectiveCamera(N,1,t,e);o.layers=this.layers,o.up.set(0,-1,0),o.lookAt(new l.Vector3(0,0,1)),this.add(o);const c=new P.PerspectiveCamera(N,1,t,e);c.layers=this.layers,c.up.set(0,-1,0),c.lookAt(new l.Vector3(0,0,-1)),this.add(c)}update(t,e){null===this.parent&&this.updateMatrixWorld();const n=this.renderTarget,[r,s,a,o,l,c]=this.children,u=t.getRenderTarget(),h=t.toneMapping,d=t.xr.enabled;t.toneMapping=i.uL9,t.xr.enabled=!1;const f=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,t.setRenderTarget(n,0),t.render(e,r),t.setRenderTarget(n,1),t.render(e,s),t.setRenderTarget(n,2),t.render(e,a),t.setRenderTarget(n,3),t.render(e,o),t.setRenderTarget(n,4),t.render(e,l),n.texture.generateMipmaps=f,t.setRenderTarget(n,5),t.render(e,c),t.setRenderTarget(u),t.toneMapping=h,t.xr.enabled=d,n.texture.needsPMREMUpdate=!0}}var F=n(546);class U extends D{constructor(t,e={}){super(t,t,e);const n={width:t,height:t,depth:1},r=[n,n,n,n,n,n];this.texture=new F.B(r,e.mapping,e.wrapS,e.wrapT,e.magFilter,e.minFilter,e.format,e.type,e.anisotropy,e.encoding),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==e.generateMipmaps&&e.generateMipmaps,this.texture.minFilter=void 0!==e.minFilter?e.minFilter:i.wem}fromEquirectangularTexture(t,e){this.texture.type=e.type,this.texture.encoding=e.encoding,this.texture.generateMipmaps=e.generateMipmaps,this.texture.minFilter=e.minFilter,this.texture.magFilter=e.magFilter;const n={tEquirect:{value:null}},r="\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",s="\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t",a=new d.BoxGeometry(5,5,5),o=new p.ShaderMaterial({name:"CubemapFromEquirect",uniforms:(0,y.dw)(n),vertexShader:r,fragmentShader:s,side:i._Li,blending:i.jFi});o.uniforms.tEquirect.value=e;const l=new g.Mesh(a,o),c=e.minFilter;return e.minFilter===i.D1R&&(e.minFilter=i.wem),new O(1,10,this).update(t,l),e.minFilter=c,l.geometry.dispose(),l.material.dispose(),this}clear(t,e,n,i){const r=t.getRenderTarget();for(let r=0;r<6;r++)t.setRenderTarget(this,r),t.clear(e,n,i);t.setRenderTarget(r)}}function V(t){let e=new WeakMap;function n(t,e){return e===i.dSO?t.mapping=i.fY$:e===i.Bf4&&(t.mapping=i.vxC),t}function r(t){const n=t.target;n.removeEventListener("dispose",r);const i=e.get(n);void 0!==i&&(e.delete(n),i.dispose())}return{get:function(s){if(s&&s.isTexture&&!1===s.isRenderTargetTexture){const a=s.mapping;if(a===i.dSO||a===i.Bf4){if(e.has(s))return n(e.get(s).texture,s.mapping);{const i=s.image;if(i&&i.height>0){const a=new U(i.height/2);return a.fromEquirectangularTexture(t,s),e.set(s,a),s.addEventListener("dispose",r),n(a.texture,s.mapping)}return null}}}return s},dispose:function(){e=new WeakMap}}}U.prototype.isWebGLCubeRenderTarget=!0;var k=n(4430),B=n(5699),z=n(4152),G=n(4033);const H=[.125,.215,.35,.446,.526,.582],W=new z.i,q=new m.Color;let j=null;const X=(1+Math.sqrt(5))/2,K=1/X,$=[new l.Vector3(1,1,1),new l.Vector3(-1,1,1),new l.Vector3(1,1,-1),new l.Vector3(-1,1,-1),new l.Vector3(0,X,K),new l.Vector3(0,X,-K),new l.Vector3(K,0,X),new l.Vector3(-K,0,X),new l.Vector3(X,K,0),new l.Vector3(-X,K,0)];class Y{constructor(t){this._renderer=t,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(t,e=0,n=.1,i=100){j=this._renderer.getRenderTarget(),this._setSize(256);const r=this._allocateTargets();return r.depthBuffer=!0,this._sceneToCubeUV(t,n,i,r),e>0&&this._blur(r,0,0,e),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(t,e=null){return this._fromTexture(t,e)}fromCubemap(t,e=null){return this._fromTexture(t,e)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=tt(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=Z(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(t){this._lodMax=Math.floor(Math.log2(t)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let t=0;t<this._lodPlanes.length;t++)this._lodPlanes[t].dispose()}_cleanup(t){this._renderer.setRenderTarget(j),t.scissorTest=!1,J(t,0,0,t.width,t.height)}_fromTexture(t,e){t.mapping===i.fY$||t.mapping===i.vxC?this._setSize(0===t.image.length?16:t.image[0].width||t.image[0].image.width):this._setSize(t.image.width/4),j=this._renderer.getRenderTarget();const n=e||this._allocateTargets();return this._textureToCubeUV(t,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const t=3*Math.max(this._cubeSize,112),e=4*this._cubeSize,n={magFilter:i.wem,minFilter:i.wem,generateMipmaps:!1,type:i.cLu,format:i.wk1,encoding:i.rnI,depthBuffer:!1},r=Q(t,e,n);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=Q(t,e,n);const{_lodMax:r}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(t){const e=[],n=[],i=[];let r=t;const s=t-4+1+H.length;for(let a=0;a<s;a++){const s=Math.pow(2,r);n.push(s);let o=1/s;a>t-4?o=H[a-t+4-1]:0===a&&(o=0),i.push(o);const l=1/(s-2),c=-l,u=1+l,h=[c,c,u,c,u,u,c,c,u,u,c,u],d=6,f=6,p=3,m=2,g=1,v=new Float32Array(p*f*d),y=new Float32Array(m*f*d),_=new Float32Array(g*f*d);for(let t=0;t<d;t++){const e=t%3*2/3-1,n=t>2?0:-1,i=[e,n,0,e+2/3,n,0,e+2/3,n+1,0,e,n,0,e+2/3,n+1,0,e,n+1,0];v.set(i,p*f*t),y.set(h,m*f*t);const r=[t,t,t,t,t,t];_.set(r,g*f*t)}const x=new B.BufferGeometry;x.setAttribute("position",new k.BufferAttribute(v,p)),x.setAttribute("uv",new k.BufferAttribute(y,m)),x.setAttribute("faceIndex",new k.BufferAttribute(_,g)),e.push(x),r>4&&r--}return{lodPlanes:e,sizeLods:n,sigmas:i}}(r)),this._blurMaterial=function(t,e,n){const r=new Float32Array(20),s=new l.Vector3(0,1,0);return new p.ShaderMaterial({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/e,CUBEUV_TEXEL_HEIGHT:1/n,CUBEUV_MAX_MIP:`${t}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:r},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:s}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:i.jFi,depthTest:!1,depthWrite:!1})}(r,t,e)}return r}_compileMaterial(t){const e=new g.Mesh(this._lodPlanes[0],t);this._renderer.compile(e,W)}_sceneToCubeUV(t,e,n,r){const s=new P.PerspectiveCamera(90,1,e,n),a=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],l=this._renderer,c=l.autoClear,u=l.toneMapping;l.getClearColor(q),l.toneMapping=i.uL9,l.autoClear=!1;const h=new G.MeshBasicMaterial({name:"PMREM.Background",side:i._Li,depthWrite:!1,depthTest:!1}),f=new g.Mesh(new d.BoxGeometry,h);let p=!1;const m=t.background;m?m.isColor&&(h.color.copy(m),t.background=null,p=!0):(h.color.copy(q),p=!0);for(let e=0;e<6;e++){const n=e%3;0===n?(s.up.set(0,a[e],0),s.lookAt(o[e],0,0)):1===n?(s.up.set(0,0,a[e]),s.lookAt(0,o[e],0)):(s.up.set(0,a[e],0),s.lookAt(0,0,o[e]));const i=this._cubeSize;J(r,n*i,e>2?i:0,i,i),l.setRenderTarget(r),p&&l.render(f,s),l.render(t,s)}f.geometry.dispose(),f.material.dispose(),l.toneMapping=u,l.autoClear=c,t.background=m}_textureToCubeUV(t,e){const n=this._renderer,r=t.mapping===i.fY$||t.mapping===i.vxC;r?(null===this._cubemapMaterial&&(this._cubemapMaterial=tt()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===t.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=Z());const s=r?this._cubemapMaterial:this._equirectMaterial,a=new g.Mesh(this._lodPlanes[0],s);s.uniforms.envMap.value=t;const o=this._cubeSize;J(e,0,0,3*o,2*o),n.setRenderTarget(e),n.render(a,W)}_applyPMREM(t){const e=this._renderer,n=e.autoClear;e.autoClear=!1;for(let e=1;e<this._lodPlanes.length;e++){const n=Math.sqrt(this._sigmas[e]*this._sigmas[e]-this._sigmas[e-1]*this._sigmas[e-1]),i=$[(e-1)%$.length];this._blur(t,e-1,e,n,i)}e.autoClear=n}_blur(t,e,n,i,r){const s=this._pingPongRenderTarget;this._halfBlur(t,s,e,n,i,"latitudinal",r),this._halfBlur(s,t,n,n,i,"longitudinal",r)}_halfBlur(t,e,n,i,r,s,a){const o=this._renderer,l=this._blurMaterial;"latitudinal"!==s&&"longitudinal"!==s&&console.error("blur direction must be either latitudinal or longitudinal!");const c=new g.Mesh(this._lodPlanes[i],l),u=l.uniforms,h=this._sizeLods[n]-1,d=isFinite(r)?Math.PI/(2*h):2*Math.PI/39,f=r/d,p=isFinite(r)?1+Math.floor(3*f):20;p>20&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${p} samples when the maximum is set to 20`);const m=[];let v=0;for(let t=0;t<20;++t){const e=t/f,n=Math.exp(-e*e/2);m.push(n),0===t?v+=n:t<p&&(v+=2*n)}for(let t=0;t<m.length;t++)m[t]=m[t]/v;u.envMap.value=t.texture,u.samples.value=p,u.weights.value=m,u.latitudinal.value="latitudinal"===s,a&&(u.poleAxis.value=a);const{_lodMax:y}=this;u.dTheta.value=d,u.mipInt.value=y-n;const _=this._sizeLods[i];J(e,3*_*(i>y-4?i-y+4:0),4*(this._cubeSize-_),3*_,2*_),o.setRenderTarget(e),o.render(c,W)}}function Q(t,e,n){const r=new D(t,e,n);return r.texture.mapping=i.g8_,r.texture.name="PMREM.cubeUv",r.scissorTest=!0,r}function J(t,e,n,i,r){t.viewport.set(e,n,i,r),t.scissor.set(e,n,i,r)}function Z(){return new p.ShaderMaterial({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:i.jFi,depthTest:!1,depthWrite:!1})}function tt(){return new p.ShaderMaterial({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:i.jFi,depthTest:!1,depthWrite:!1})}function et(t){let e=new WeakMap,n=null;function r(t){const n=t.target;n.removeEventListener("dispose",r);const i=e.get(n);void 0!==i&&(e.delete(n),i.dispose())}return{get:function(s){if(s&&s.isTexture){const a=s.mapping,o=a===i.dSO||a===i.Bf4,l=a===i.fY$||a===i.vxC;if(o||l){if(s.isRenderTargetTexture&&!0===s.needsPMREMUpdate){s.needsPMREMUpdate=!1;let i=e.get(s);return null===n&&(n=new Y(t)),i=o?n.fromEquirectangular(s,i):n.fromCubemap(s,i),e.set(s,i),i.texture}if(e.has(s))return e.get(s).texture;{const i=s.image;if(o&&i&&i.height>0||l&&i&&function(t){let e=0;for(let n=0;n<6;n++)void 0!==t[n]&&e++;return 6===e}(i)){null===n&&(n=new Y(t));const i=o?n.fromEquirectangular(s):n.fromCubemap(s);return e.set(s,i),s.addEventListener("dispose",r),i.texture}return null}}}return s},dispose:function(){e=new WeakMap,null!==n&&(n.dispose(),n=null)}}}function nt(t){const e={};function n(n){if(void 0!==e[n])return e[n];let i;switch(n){case"WEBGL_depth_texture":i=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=t.getExtension(n)}return e[n]=i,i}return{has:function(t){return null!==n(t)},init:function(t){t.isWebGL2?n("EXT_color_buffer_float"):(n("WEBGL_depth_texture"),n("OES_texture_float"),n("OES_texture_half_float"),n("OES_texture_half_float_linear"),n("OES_standard_derivatives"),n("OES_element_index_uint"),n("OES_vertex_array_object"),n("ANGLE_instanced_arrays")),n("OES_texture_float_linear"),n("EXT_color_buffer_half_float"),n("WEBGL_multisampled_render_to_texture")},get:function(t){const e=n(t);return null===e&&console.warn("THREE.WebGLRenderer: "+t+" extension not supported."),e}}}var it=n(5042);function rt(t,e,n,i){const r={},s=new WeakMap;function a(t){const o=t.target;null!==o.index&&e.remove(o.index);for(const t in o.attributes)e.remove(o.attributes[t]);o.removeEventListener("dispose",a),delete r[o.id];const l=s.get(o);l&&(e.remove(l),s.delete(o)),i.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,n.memory.geometries--}function o(t){const n=[],i=t.index,r=t.attributes.position;let a=0;if(null!==i){const t=i.array;a=i.version;for(let e=0,i=t.length;e<i;e+=3){const i=t[e+0],r=t[e+1],s=t[e+2];n.push(i,r,r,s,s,i)}}else{const t=r.array;a=r.version;for(let e=0,i=t.length/3-1;e<i;e+=3){const t=e+0,i=e+1,r=e+2;n.push(t,i,i,r,r,t)}}const o=new((0,it.H7)(n)?k.Uint32BufferAttribute:k.Uint16BufferAttribute)(n,1);o.version=a;const l=s.get(t);l&&e.remove(l),s.set(t,o)}return{get:function(t,e){return!0===r[e.id]||(e.addEventListener("dispose",a),r[e.id]=!0,n.memory.geometries++),e},update:function(n){const i=n.attributes;for(const n in i)e.update(i[n],t.ARRAY_BUFFER);const r=n.morphAttributes;for(const n in r){const i=r[n];for(let n=0,r=i.length;n<r;n++)e.update(i[n],t.ARRAY_BUFFER)}},getWireframeAttribute:function(t){const e=s.get(t);if(e){const n=t.index;null!==n&&e.version<n.version&&o(t)}else o(t);return s.get(t)}}}function st(t,e,n,i){const r=i.isWebGL2;let s,a,o;this.setMode=function(t){s=t},this.setIndex=function(t){a=t.type,o=t.bytesPerElement},this.render=function(e,i){t.drawElements(s,i,a,e*o),n.update(i,s,1)},this.renderInstances=function(i,l,c){if(0===c)return;let u,h;if(r)u=t,h="drawElementsInstanced";else if(u=e.get("ANGLE_instanced_arrays"),h="drawElementsInstancedANGLE",null===u)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");u[h](s,l,a,i*o,c),n.update(l,s,c)}}function at(t){const e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.frame++,e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(n,i,r){switch(e.calls++,i){case t.TRIANGLES:e.triangles+=r*(n/3);break;case t.LINES:e.lines+=r*(n/2);break;case t.LINE_STRIP:e.lines+=r*(n-1);break;case t.LINE_LOOP:e.lines+=r*n;break;case t.POINTS:e.points+=r*n;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}class ot extends C.x{constructor(t=null,e=1,n=1,r=1){super(null),this.image={data:t,width:e,height:n,depth:r},this.magFilter=i.TyD,this.minFilter=i.TyD,this.wrapR=i.uWy,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}function lt(t,e){return t[0]-e[0]}function ct(t,e){return Math.abs(e[1])-Math.abs(t[1])}function ut(t,e){let n=1;const i=e.isInterleavedBufferAttribute?e.data.array:e.array;i instanceof Int8Array?n=127:i instanceof Int16Array?n=32767:i instanceof Int32Array?n=2147483647:console.error("THREE.WebGLMorphtargets: Unsupported morph attribute data type: ",i),t.divideScalar(n)}function ht(t,e,n){const r={},s=new Float32Array(8),a=new WeakMap,l=new c.L,u=[];for(let t=0;t<8;t++)u[t]=[t,0];return{update:function(c,h,d,f){const p=c.morphTargetInfluences;if(!0===e.isWebGL2){const m=h.morphAttributes.position||h.morphAttributes.normal||h.morphAttributes.color,g=void 0!==m?m.length:0;let v=a.get(h);if(void 0===v||v.count!==g){void 0!==v&&v.texture.dispose();const x=void 0!==h.morphAttributes.position,w=void 0!==h.morphAttributes.normal,b=void 0!==h.morphAttributes.color,S=h.morphAttributes.position||[],E=h.morphAttributes.normal||[],T=h.morphAttributes.color||[];let M=0;!0===x&&(M=1),!0===w&&(M=2),!0===b&&(M=3);let A=h.attributes.position.count*M,I=1;A>e.maxTextureSize&&(I=Math.ceil(A/e.maxTextureSize),A=e.maxTextureSize);const C=new Float32Array(A*I*4*g),R=new ot(C,A,I,g);R.type=i.VzW,R.needsUpdate=!0;const D=4*M;for(let P=0;P<g;P++){const N=S[P],O=E[P],F=T[P],U=A*I*4*P;for(let V=0;V<N.count;V++){const k=V*D;!0===x&&(l.fromBufferAttribute(N,V),!0===N.normalized&&ut(l,N),C[U+k+0]=l.x,C[U+k+1]=l.y,C[U+k+2]=l.z,C[U+k+3]=0),!0===w&&(l.fromBufferAttribute(O,V),!0===O.normalized&&ut(l,O),C[U+k+4]=l.x,C[U+k+5]=l.y,C[U+k+6]=l.z,C[U+k+7]=0),!0===b&&(l.fromBufferAttribute(F,V),!0===F.normalized&&ut(l,F),C[U+k+8]=l.x,C[U+k+9]=l.y,C[U+k+10]=l.z,C[U+k+11]=4===F.itemSize?l.w:1)}}function L(){R.dispose(),a.delete(h),h.removeEventListener("dispose",L)}v={count:g,texture:R,size:new o.Vector2(A,I)},a.set(h,v),h.addEventListener("dispose",L)}let y=0;for(let B=0;B<p.length;B++)y+=p[B];const _=h.morphTargetsRelative?1:1-y;f.getUniforms().setValue(t,"morphTargetBaseInfluence",_),f.getUniforms().setValue(t,"morphTargetInfluences",p),f.getUniforms().setValue(t,"morphTargetsTexture",v.texture,n),f.getUniforms().setValue(t,"morphTargetsTextureSize",v.size)}else{const z=void 0===p?0:p.length;let G=r[h.id];if(void 0===G||G.length!==z){G=[];for(let X=0;X<z;X++)G[X]=[X,0];r[h.id]=G}for(let K=0;K<z;K++){const $=G[K];$[0]=K,$[1]=p[K]}G.sort(ct);for(let Y=0;Y<8;Y++)Y<z&&G[Y][1]?(u[Y][0]=G[Y][0],u[Y][1]=G[Y][1]):(u[Y][0]=Number.MAX_SAFE_INTEGER,u[Y][1]=0);u.sort(lt);const H=h.morphAttributes.position,W=h.morphAttributes.normal;let q=0;for(let Q=0;Q<8;Q++){const J=u[Q],Z=J[0],tt=J[1];Z!==Number.MAX_SAFE_INTEGER&&tt?(H&&h.getAttribute("morphTarget"+Q)!==H[Z]&&h.setAttribute("morphTarget"+Q,H[Z]),W&&h.getAttribute("morphNormal"+Q)!==W[Z]&&h.setAttribute("morphNormal"+Q,W[Z]),s[Q]=tt,q+=tt):(H&&!0===h.hasAttribute("morphTarget"+Q)&&h.deleteAttribute("morphTarget"+Q),W&&!0===h.hasAttribute("morphNormal"+Q)&&h.deleteAttribute("morphNormal"+Q),s[Q]=0)}const j=h.morphTargetsRelative?1:1-q;f.getUniforms().setValue(t,"morphTargetBaseInfluence",j),f.getUniforms().setValue(t,"morphTargetInfluences",s)}}}}function dt(t,e,n,i){let r=new WeakMap;function s(t){const e=t.target;e.removeEventListener("dispose",s),n.remove(e.instanceMatrix),null!==e.instanceColor&&n.remove(e.instanceColor)}return{update:function(a){const o=i.render.frame,l=a.geometry,c=e.get(a,l);return r.get(c)!==o&&(e.update(c),r.set(c,o)),a.isInstancedMesh&&(!1===a.hasEventListener("dispose",s)&&a.addEventListener("dispose",s),n.update(a.instanceMatrix,t.ARRAY_BUFFER),null!==a.instanceColor&&n.update(a.instanceColor,t.ARRAY_BUFFER)),c},dispose:function(){r=new WeakMap}}}ot.prototype.isDataArrayTexture=!0;var ft=n(4691);class pt extends C.x{constructor(t=null,e=1,n=1,r=1){super(null),this.image={data:t,width:e,height:n,depth:r},this.magFilter=i.TyD,this.minFilter=i.TyD,this.wrapR=i.uWy,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}pt.prototype.isData3DTexture=!0;const mt=new C.x,gt=new ot,vt=new pt,yt=new F.B,_t=[],xt=[],wt=new Float32Array(16),bt=new Float32Array(9),St=new Float32Array(4);function Et(t,e,n){const i=t[0];if(i<=0||i>0)return t;const r=e*n;let s=_t[r];if(void 0===s&&(s=new Float32Array(r),_t[r]=s),0!==e){i.toArray(s,0);for(let i=1,r=0;i!==e;++i)r+=n,t[i].toArray(s,r)}return s}function Tt(t,e){if(t.length!==e.length)return!1;for(let n=0,i=t.length;n<i;n++)if(t[n]!==e[n])return!1;return!0}function Mt(t,e){for(let n=0,i=e.length;n<i;n++)t[n]=e[n]}function At(t,e){let n=xt[e];void 0===n&&(n=new Int32Array(e),xt[e]=n);for(let i=0;i!==e;++i)n[i]=t.allocateTextureUnit();return n}function It(t,e){const n=this.cache;n[0]!==e&&(t.uniform1f(this.addr,e),n[0]=e)}function Ct(t,e){const n=this.cache;if(void 0!==e.x)n[0]===e.x&&n[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),n[0]=e.x,n[1]=e.y);else{if(Tt(n,e))return;t.uniform2fv(this.addr,e),Mt(n,e)}}function Rt(t,e){const n=this.cache;if(void 0!==e.x)n[0]===e.x&&n[1]===e.y&&n[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),n[0]=e.x,n[1]=e.y,n[2]=e.z);else if(void 0!==e.r)n[0]===e.r&&n[1]===e.g&&n[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),n[0]=e.r,n[1]=e.g,n[2]=e.b);else{if(Tt(n,e))return;t.uniform3fv(this.addr,e),Mt(n,e)}}function Dt(t,e){const n=this.cache;if(void 0!==e.x)n[0]===e.x&&n[1]===e.y&&n[2]===e.z&&n[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),n[0]=e.x,n[1]=e.y,n[2]=e.z,n[3]=e.w);else{if(Tt(n,e))return;t.uniform4fv(this.addr,e),Mt(n,e)}}function Lt(t,e){const n=this.cache,i=e.elements;if(void 0===i){if(Tt(n,e))return;t.uniformMatrix2fv(this.addr,!1,e),Mt(n,e)}else{if(Tt(n,i))return;St.set(i),t.uniformMatrix2fv(this.addr,!1,St),Mt(n,i)}}function Pt(t,e){const n=this.cache,i=e.elements;if(void 0===i){if(Tt(n,e))return;t.uniformMatrix3fv(this.addr,!1,e),Mt(n,e)}else{if(Tt(n,i))return;bt.set(i),t.uniformMatrix3fv(this.addr,!1,bt),Mt(n,i)}}function Nt(t,e){const n=this.cache,i=e.elements;if(void 0===i){if(Tt(n,e))return;t.uniformMatrix4fv(this.addr,!1,e),Mt(n,e)}else{if(Tt(n,i))return;wt.set(i),t.uniformMatrix4fv(this.addr,!1,wt),Mt(n,i)}}function Ot(t,e){const n=this.cache;n[0]!==e&&(t.uniform1i(this.addr,e),n[0]=e)}function Ft(t,e){const n=this.cache;Tt(n,e)||(t.uniform2iv(this.addr,e),Mt(n,e))}function Ut(t,e){const n=this.cache;Tt(n,e)||(t.uniform3iv(this.addr,e),Mt(n,e))}function Vt(t,e){const n=this.cache;Tt(n,e)||(t.uniform4iv(this.addr,e),Mt(n,e))}function kt(t,e){const n=this.cache;n[0]!==e&&(t.uniform1ui(this.addr,e),n[0]=e)}function Bt(t,e){const n=this.cache;Tt(n,e)||(t.uniform2uiv(this.addr,e),Mt(n,e))}function zt(t,e){const n=this.cache;Tt(n,e)||(t.uniform3uiv(this.addr,e),Mt(n,e))}function Gt(t,e){const n=this.cache;Tt(n,e)||(t.uniform4uiv(this.addr,e),Mt(n,e))}function Ht(t,e,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(t.uniform1i(this.addr,r),i[0]=r),n.setTexture2D(e||mt,r)}function Wt(t,e,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(t.uniform1i(this.addr,r),i[0]=r),n.setTexture3D(e||vt,r)}function qt(t,e,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(t.uniform1i(this.addr,r),i[0]=r),n.setTextureCube(e||yt,r)}function jt(t,e,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(t.uniform1i(this.addr,r),i[0]=r),n.setTexture2DArray(e||gt,r)}function Xt(t,e){t.uniform1fv(this.addr,e)}function Kt(t,e){const n=Et(e,this.size,2);t.uniform2fv(this.addr,n)}function $t(t,e){const n=Et(e,this.size,3);t.uniform3fv(this.addr,n)}function Yt(t,e){const n=Et(e,this.size,4);t.uniform4fv(this.addr,n)}function Qt(t,e){const n=Et(e,this.size,4);t.uniformMatrix2fv(this.addr,!1,n)}function Jt(t,e){const n=Et(e,this.size,9);t.uniformMatrix3fv(this.addr,!1,n)}function Zt(t,e){const n=Et(e,this.size,16);t.uniformMatrix4fv(this.addr,!1,n)}function te(t,e){t.uniform1iv(this.addr,e)}function ee(t,e){t.uniform2iv(this.addr,e)}function ne(t,e){t.uniform3iv(this.addr,e)}function ie(t,e){t.uniform4iv(this.addr,e)}function re(t,e){t.uniform1uiv(this.addr,e)}function se(t,e){t.uniform2uiv(this.addr,e)}function ae(t,e){t.uniform3uiv(this.addr,e)}function oe(t,e){t.uniform4uiv(this.addr,e)}function le(t,e,n){const i=e.length,r=At(n,i);t.uniform1iv(this.addr,r);for(let t=0;t!==i;++t)n.setTexture2D(e[t]||mt,r[t])}function ce(t,e,n){const i=e.length,r=At(n,i);t.uniform1iv(this.addr,r);for(let t=0;t!==i;++t)n.setTexture3D(e[t]||vt,r[t])}function ue(t,e,n){const i=e.length,r=At(n,i);t.uniform1iv(this.addr,r);for(let t=0;t!==i;++t)n.setTextureCube(e[t]||yt,r[t])}function he(t,e,n){const i=e.length,r=At(n,i);t.uniform1iv(this.addr,r);for(let t=0;t!==i;++t)n.setTexture2DArray(e[t]||gt,r[t])}function de(t,e,n){this.id=t,this.addr=n,this.cache=[],this.setValue=function(t){switch(t){case 5126:return It;case 35664:return Ct;case 35665:return Rt;case 35666:return Dt;case 35674:return Lt;case 35675:return Pt;case 35676:return Nt;case 5124:case 35670:return Ot;case 35667:case 35671:return Ft;case 35668:case 35672:return Ut;case 35669:case 35673:return Vt;case 5125:return kt;case 36294:return Bt;case 36295:return zt;case 36296:return Gt;case 35678:case 36198:case 36298:case 36306:case 35682:return Ht;case 35679:case 36299:case 36307:return Wt;case 35680:case 36300:case 36308:case 36293:return qt;case 36289:case 36303:case 36311:case 36292:return jt}}(e.type)}function fe(t,e,n){this.id=t,this.addr=n,this.cache=[],this.size=e.size,this.setValue=function(t){switch(t){case 5126:return Xt;case 35664:return Kt;case 35665:return $t;case 35666:return Yt;case 35674:return Qt;case 35675:return Jt;case 35676:return Zt;case 5124:case 35670:return te;case 35667:case 35671:return ee;case 35668:case 35672:return ne;case 35669:case 35673:return ie;case 5125:return re;case 36294:return se;case 36295:return ae;case 36296:return oe;case 35678:case 36198:case 36298:case 36306:case 35682:return le;case 35679:case 36299:case 36307:return ce;case 35680:case 36300:case 36308:case 36293:return ue;case 36289:case 36303:case 36311:case 36292:return he}}(e.type)}function pe(t){this.id=t,this.seq=[],this.map={}}pe.prototype.setValue=function(t,e,n){const i=this.seq;for(let r=0,s=i.length;r!==s;++r){const s=i[r];s.setValue(t,e[s.id],n)}};const me=/(\w+)(\])?(\[|\.)?/g;function ge(t,e){t.seq.push(e),t.map[e.id]=e}function ve(t,e,n){const i=t.name,r=i.length;for(me.lastIndex=0;;){const s=me.exec(i),a=me.lastIndex;let o=s[1];const l="]"===s[2],c=s[3];if(l&&(o|=0),void 0===c||"["===c&&a+2===r){ge(n,void 0===c?new de(o,t,e):new fe(o,t,e));break}{let t=n.map[o];void 0===t&&(t=new pe(o),ge(n,t)),n=t}}}function ye(t,e){this.seq=[],this.map={};const n=t.getProgramParameter(e,t.ACTIVE_UNIFORMS);for(let i=0;i<n;++i){const n=t.getActiveUniform(e,i);ve(n,t.getUniformLocation(e,n.name),this)}}function _e(t,e,n){const i=t.createShader(e);return t.shaderSource(i,n),t.compileShader(i),i}ye.prototype.setValue=function(t,e,n,i){const r=this.map[e];void 0!==r&&r.setValue(t,n,i)},ye.prototype.setOptional=function(t,e,n){const i=e[n];void 0!==i&&this.setValue(t,n,i)},ye.upload=function(t,e,n,i){for(let r=0,s=e.length;r!==s;++r){const s=e[r],a=n[s.id];!1!==a.needsUpdate&&s.setValue(t,a.value,i)}},ye.seqWithValue=function(t,e){const n=[];for(let i=0,r=t.length;i!==r;++i){const r=t[i];r.id in e&&n.push(r)}return n};let xe=0;function we(t,e,n){const i=t.getShaderParameter(e,t.COMPILE_STATUS),r=t.getShaderInfoLog(e).trim();if(i&&""===r)return"";const s=/ERROR: 0:(\d+)/.exec(r);if(s){const i=parseInt(s[0]);return n.toUpperCase()+"\n\n"+r+"\n\n"+function(t,e){const n=t.split("\n"),i=[],r=Math.max(e-6,0),s=Math.min(e+6,n.length);for(let t=r;t<s;t++)i.push(t+1+": "+n[t]);return i.join("\n")}(t.getShaderSource(e),i)}return r}function be(t,e){const n=function(t){switch(t){case i.rnI:return["Linear","( value )"];case i.knz:return["sRGB","( value )"];default:return console.warn("THREE.WebGLProgram: Unsupported encoding:",t),["Linear","( value )"]}}(e);return"vec4 "+t+"( vec4 value ) { return LinearTo"+n[0]+n[1]+"; }"}function Se(t,e){let n;switch(e){case i.EoG:n="Linear";break;case i.CdI:n="Reinhard";break;case i.YGz:n="OptimizedCineon";break;case i.LY2:n="ACESFilmic";break;case i.dZ3:n="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",e),n="Linear"}return"vec3 "+t+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}function Ee(t){return""!==t}function Te(t,e){return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,e.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS/g,e.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,e.numPointLightShadows)}function Me(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}const Ae=/^[ \t]*#include +<([\w\d./]+)>/gm;function Ie(t){return t.replace(Ae,Ce)}function Ce(t,e){const n=v[e];if(void 0===n)throw new Error("Can not resolve #include <"+e+">");return Ie(n)}const Re=/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,De=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function Le(t){return t.replace(De,Ne).replace(Re,Pe)}function Pe(t,e,n,i){return console.warn("WebGLProgram: #pragma unroll_loop shader syntax is deprecated. Please use #pragma unroll_loop_start syntax instead."),Ne(0,e,n,i)}function Ne(t,e,n,i){let r="";for(let t=parseInt(e);t<parseInt(n);t++)r+=i.replace(/\[\s*i\s*\]/g,"[ "+t+" ]").replace(/UNROLLED_LOOP_INDEX/g,t);return r}function Oe(t){let e="precision "+t.precision+" float;\nprecision "+t.precision+" int;";return"highp"===t.precision?e+="\n#define HIGH_PRECISION":"mediump"===t.precision?e+="\n#define MEDIUM_PRECISION":"lowp"===t.precision&&(e+="\n#define LOW_PRECISION"),e}function Fe(t,e,n,r){const s=t.getContext(),a=n.defines;let o=n.vertexShader,l=n.fragmentShader;const c=function(t){let e="SHADOWMAP_TYPE_BASIC";return t.shadowMapType===i._iA?e="SHADOWMAP_TYPE_PCF":t.shadowMapType===i.ntZ?e="SHADOWMAP_TYPE_PCF_SOFT":t.shadowMapType===i.dwk&&(e="SHADOWMAP_TYPE_VSM"),e}(n),u=function(t){let e="ENVMAP_TYPE_CUBE";if(t.envMap)switch(t.envMapMode){case i.fY$:case i.vxC:e="ENVMAP_TYPE_CUBE";break;case i.g8_:e="ENVMAP_TYPE_CUBE_UV"}return e}(n),h=function(t){let e="ENVMAP_MODE_REFLECTION";return t.envMap&&t.envMapMode===i.vxC&&(e="ENVMAP_MODE_REFRACTION"),e}(n),d=function(t){let e="ENVMAP_BLENDING_NONE";if(t.envMap)switch(t.combine){case i.Ns1:e="ENVMAP_BLENDING_MULTIPLY";break;case i.qhX:e="ENVMAP_BLENDING_MIX";break;case i.NDo:e="ENVMAP_BLENDING_ADD"}return e}(n),f=function(t){const e=t.envMapCubeUVHeight;if(null===e)return null;const n=Math.log2(e)-2,i=1/e;return{texelWidth:1/(3*Math.max(Math.pow(2,n),112)),texelHeight:i,maxMip:n}}(n),p=n.isWebGL2?"":function(t){return[t.extensionDerivatives||t.envMapCubeUVHeight||t.bumpMap||t.tangentSpaceNormalMap||t.clearcoatNormalMap||t.flatShading||"physical"===t.shaderID?"#extension GL_OES_standard_derivatives : enable":"",(t.extensionFragDepth||t.logarithmicDepthBuffer)&&t.rendererExtensionFragDepth?"#extension GL_EXT_frag_depth : enable":"",t.extensionDrawBuffers&&t.rendererExtensionDrawBuffers?"#extension GL_EXT_draw_buffers : require":"",(t.extensionShaderTextureLOD||t.envMap||t.transmission)&&t.rendererExtensionShaderTextureLod?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Ee).join("\n")}(n),m=function(t){const e=[];for(const n in t){const i=t[n];!1!==i&&e.push("#define "+n+" "+i)}return e.join("\n")}(a),g=s.createProgram();let y,_,x=n.glslVersion?"#version "+n.glslVersion+"\n":"";n.isRawShaderMaterial?(y=[m].filter(Ee).join("\n"),y.length>0&&(y+="\n"),_=[p,m].filter(Ee).join("\n"),_.length>0&&(_+="\n")):(y=[Oe(n),"#define SHADER_NAME "+n.shaderName,m,n.instancing?"#define USE_INSTANCING":"",n.instancingColor?"#define USE_INSTANCING_COLOR":"",n.supportsVertexTextures?"#define VERTEX_TEXTURES":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+h:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMap&&n.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",n.normalMap&&n.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.displacementMap&&n.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",n.specularColorMap?"#define USE_SPECULARCOLORMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.sheenColorMap?"#define USE_SHEENCOLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEENROUGHNESSMAP":"",n.vertexTangents?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUvs?"#define USE_UV":"",n.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.morphColors&&n.isWebGL2?"#define USE_MORPHCOLORS":"",n.morphTargetsCount>0&&n.isWebGL2?"#define MORPHTARGETS_TEXTURE":"",n.morphTargetsCount>0&&n.isWebGL2?"#define MORPHTARGETS_TEXTURE_STRIDE "+n.morphTextureStride:"",n.morphTargetsCount>0&&n.isWebGL2?"#define MORPHTARGETS_COUNT "+n.morphTargetsCount:"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+c:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#if ( defined( USE_MORPHTARGETS ) && ! defined( MORPHTARGETS_TEXTURE ) )","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Ee).join("\n"),_=[p,Oe(n),"#define SHADER_NAME "+n.shaderName,m,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.matcap?"#define USE_MATCAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+u:"",n.envMap?"#define "+h:"",n.envMap?"#define "+d:"",f?"#define CUBEUV_TEXEL_WIDTH "+f.texelWidth:"",f?"#define CUBEUV_TEXEL_HEIGHT "+f.texelHeight:"",f?"#define CUBEUV_MAX_MIP "+f.maxMip+".0":"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMap&&n.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",n.normalMap&&n.tangentSpaceNormalMap?"#define TANGENTSPACE_NORMALMAP":"",n.clearcoat?"#define USE_CLEARCOAT":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularIntensityMap?"#define USE_SPECULARINTENSITYMAP":"",n.specularColorMap?"#define USE_SPECULARCOLORMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaTest?"#define USE_ALPHATEST":"",n.sheen?"#define USE_SHEEN":"",n.sheenColorMap?"#define USE_SHEENCOLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEENROUGHNESSMAP":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",n.vertexTangents?"#define USE_TANGENT":"",n.vertexColors||n.instancingColor?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUvs?"#define USE_UV":"",n.uvsVertexOnly?"#define UVS_VERTEX_ONLY":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+c:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&n.rendererExtensionFragDepth?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",n.toneMapping!==i.uL9?"#define TONE_MAPPING":"",n.toneMapping!==i.uL9?v.tonemapping_pars_fragment:"",n.toneMapping!==i.uL9?Se("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",n.opaque?"#define OPAQUE":"",v.encodings_pars_fragment,be("linearToOutputTexel",n.outputEncoding),n.useDepthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(Ee).join("\n")),o=Ie(o),o=Te(o,n),o=Me(o,n),l=Ie(l),l=Te(l,n),l=Me(l,n),o=Le(o),l=Le(l),n.isWebGL2&&!0!==n.isRawShaderMaterial&&(x="#version 300 es\n",y=["precision mediump sampler2DArray;","#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+y,_=["#define varying in",n.glslVersion===i.LSk?"":"layout(location = 0) out highp vec4 pc_fragColor;",n.glslVersion===i.LSk?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+_);const w=x+y+o,b=x+_+l,S=_e(s,s.VERTEX_SHADER,w),E=_e(s,s.FRAGMENT_SHADER,b);if(s.attachShader(g,S),s.attachShader(g,E),void 0!==n.index0AttributeName?s.bindAttribLocation(g,0,n.index0AttributeName):!0===n.morphTargets&&s.bindAttribLocation(g,0,"position"),s.linkProgram(g),t.debug.checkShaderErrors){const t=s.getProgramInfoLog(g).trim(),e=s.getShaderInfoLog(S).trim(),n=s.getShaderInfoLog(E).trim();let i=!0,r=!0;if(!1===s.getProgramParameter(g,s.LINK_STATUS)){i=!1;const e=we(s,S,"vertex"),n=we(s,E,"fragment");console.error("THREE.WebGLProgram: Shader Error "+s.getError()+" - VALIDATE_STATUS "+s.getProgramParameter(g,s.VALIDATE_STATUS)+"\n\nProgram Info Log: "+t+"\n"+e+"\n"+n)}else""!==t?console.warn("THREE.WebGLProgram: Program Info Log:",t):""!==e&&""!==n||(r=!1);r&&(this.diagnostics={runnable:i,programLog:t,vertexShader:{log:e,prefix:y},fragmentShader:{log:n,prefix:_}})}let T,M;return s.deleteShader(S),s.deleteShader(E),this.getUniforms=function(){return void 0===T&&(T=new ye(s,g)),T},this.getAttributes=function(){return void 0===M&&(M=function(t,e){const n={},i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES);for(let r=0;r<i;r++){const i=t.getActiveAttrib(e,r),s=i.name;let a=1;i.type===t.FLOAT_MAT2&&(a=2),i.type===t.FLOAT_MAT3&&(a=3),i.type===t.FLOAT_MAT4&&(a=4),n[s]={type:i.type,location:t.getAttribLocation(e,s),locationSize:a}}return n}(s,g)),M},this.destroy=function(){r.releaseStatesOfProgram(this),s.deleteProgram(g),this.program=void 0},this.name=n.shaderName,this.id=xe++,this.cacheKey=e,this.usedTimes=1,this.program=g,this.vertexShader=S,this.fragmentShader=E,this}let Ue=0;class Ve{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(t){const e=t.vertexShader,n=t.fragmentShader,i=this._getShaderStage(e),r=this._getShaderStage(n),s=this._getShaderCacheForMaterial(t);return!1===s.has(i)&&(s.add(i),i.usedTimes++),!1===s.has(r)&&(s.add(r),r.usedTimes++),this}remove(t){const e=this.materialCache.get(t);for(const t of e)t.usedTimes--,0===t.usedTimes&&this.shaderCache.delete(t.code);return this.materialCache.delete(t),this}getVertexShaderID(t){return this._getShaderStage(t.vertexShader).id}getFragmentShaderID(t){return this._getShaderStage(t.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(t){const e=this.materialCache;return!1===e.has(t)&&e.set(t,new Set),e.get(t)}_getShaderStage(t){const e=this.shaderCache;if(!1===e.has(t)){const n=new ke(t);e.set(t,n)}return e.get(t)}}class ke{constructor(t){this.id=Ue++,this.code=t,this.usedTimes=0}}function Be(t,e,n,r,s,a,o){const l=new ft.S,c=new Ve,u=[],h=s.isWebGL2,d=s.logarithmicDepthBuffer,f=s.vertexTextures;let p=s.precision;const m={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};return{getParameters:function(a,l,u,g,v){const y=g.fog,_=v.geometry,x=a.isMeshStandardMaterial?g.environment:null,b=(a.isMeshStandardMaterial?n:e).get(a.envMap||x),S=b&&b.mapping===i.g8_?b.image.height:null,E=m[a.type];null!==a.precision&&(p=s.getMaxPrecision(a.precision),p!==a.precision&&console.warn("THREE.WebGLProgram.getParameters:",a.precision,"not supported, using",p,"instead."));const T=_.morphAttributes.position||_.morphAttributes.normal||_.morphAttributes.color,M=void 0!==T?T.length:0;let A,I,C,R,D=0;if(void 0!==_.morphAttributes.position&&(D=1),void 0!==_.morphAttributes.normal&&(D=2),void 0!==_.morphAttributes.color&&(D=3),E){const t=w[E];A=t.vertexShader,I=t.fragmentShader}else A=a.vertexShader,I=a.fragmentShader,c.update(a),C=c.getVertexShaderID(a),R=c.getFragmentShaderID(a);const L=t.getRenderTarget(),P=a.alphaTest>0,N=a.clearcoat>0;return{isWebGL2:h,shaderID:E,shaderName:a.type,vertexShader:A,fragmentShader:I,defines:a.defines,customVertexShaderID:C,customFragmentShaderID:R,isRawShaderMaterial:!0===a.isRawShaderMaterial,glslVersion:a.glslVersion,precision:p,instancing:!0===v.isInstancedMesh,instancingColor:!0===v.isInstancedMesh&&null!==v.instanceColor,supportsVertexTextures:f,outputEncoding:null===L?t.outputEncoding:!0===L.isXRRenderTarget?L.texture.encoding:i.rnI,map:!!a.map,matcap:!!a.matcap,envMap:!!b,envMapMode:b&&b.mapping,envMapCubeUVHeight:S,lightMap:!!a.lightMap,aoMap:!!a.aoMap,emissiveMap:!!a.emissiveMap,bumpMap:!!a.bumpMap,normalMap:!!a.normalMap,objectSpaceNormalMap:a.normalMapType===i.PA7,tangentSpaceNormalMap:a.normalMapType===i.IOt,decodeVideoTexture:!!a.map&&!0===a.map.isVideoTexture&&a.map.encoding===i.knz,clearcoat:N,clearcoatMap:N&&!!a.clearcoatMap,clearcoatRoughnessMap:N&&!!a.clearcoatRoughnessMap,clearcoatNormalMap:N&&!!a.clearcoatNormalMap,displacementMap:!!a.displacementMap,roughnessMap:!!a.roughnessMap,metalnessMap:!!a.metalnessMap,specularMap:!!a.specularMap,specularIntensityMap:!!a.specularIntensityMap,specularColorMap:!!a.specularColorMap,opaque:!1===a.transparent&&a.blending===i.bdR,alphaMap:!!a.alphaMap,alphaTest:P,gradientMap:!!a.gradientMap,sheen:a.sheen>0,sheenColorMap:!!a.sheenColorMap,sheenRoughnessMap:!!a.sheenRoughnessMap,transmission:a.transmission>0,transmissionMap:!!a.transmissionMap,thicknessMap:!!a.thicknessMap,combine:a.combine,vertexTangents:!!a.normalMap&&!!_.attributes.tangent,vertexColors:a.vertexColors,vertexAlphas:!0===a.vertexColors&&!!_.attributes.color&&4===_.attributes.color.itemSize,vertexUvs:!!(a.map||a.bumpMap||a.normalMap||a.specularMap||a.alphaMap||a.emissiveMap||a.roughnessMap||a.metalnessMap||a.clearcoatMap||a.clearcoatRoughnessMap||a.clearcoatNormalMap||a.displacementMap||a.transmissionMap||a.thicknessMap||a.specularIntensityMap||a.specularColorMap||a.sheenColorMap||a.sheenRoughnessMap),uvsVertexOnly:!(a.map||a.bumpMap||a.normalMap||a.specularMap||a.alphaMap||a.emissiveMap||a.roughnessMap||a.metalnessMap||a.clearcoatNormalMap||a.transmission>0||a.transmissionMap||a.thicknessMap||a.specularIntensityMap||a.specularColorMap||a.sheen>0||a.sheenColorMap||a.sheenRoughnessMap||!a.displacementMap),fog:!!y,useFog:!0===a.fog,fogExp2:y&&y.isFogExp2,flatShading:!!a.flatShading,sizeAttenuation:a.sizeAttenuation,logarithmicDepthBuffer:d,skinning:!0===v.isSkinnedMesh,morphTargets:void 0!==_.morphAttributes.position,morphNormals:void 0!==_.morphAttributes.normal,morphColors:void 0!==_.morphAttributes.color,morphTargetsCount:M,morphTextureStride:D,numDirLights:l.directional.length,numPointLights:l.point.length,numSpotLights:l.spot.length,numRectAreaLights:l.rectArea.length,numHemiLights:l.hemi.length,numDirLightShadows:l.directionalShadowMap.length,numPointLightShadows:l.pointShadowMap.length,numSpotLightShadows:l.spotShadowMap.length,numClippingPlanes:o.numPlanes,numClipIntersection:o.numIntersection,dithering:a.dithering,shadowMapEnabled:t.shadowMap.enabled&&u.length>0,shadowMapType:t.shadowMap.type,toneMapping:a.toneMapped?t.toneMapping:i.uL9,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:a.premultipliedAlpha,doubleSided:a.side===i.ehD,flipSided:a.side===i._Li,useDepthPacking:!!a.depthPacking,depthPacking:a.depthPacking||0,index0AttributeName:a.index0AttributeName,extensionDerivatives:a.extensions&&a.extensions.derivatives,extensionFragDepth:a.extensions&&a.extensions.fragDepth,extensionDrawBuffers:a.extensions&&a.extensions.drawBuffers,extensionShaderTextureLOD:a.extensions&&a.extensions.shaderTextureLOD,rendererExtensionFragDepth:h||r.has("EXT_frag_depth"),rendererExtensionDrawBuffers:h||r.has("WEBGL_draw_buffers"),rendererExtensionShaderTextureLod:h||r.has("EXT_shader_texture_lod"),customProgramCacheKey:a.customProgramCacheKey()}},getProgramCacheKey:function(e){const n=[];if(e.shaderID?n.push(e.shaderID):(n.push(e.customVertexShaderID),n.push(e.customFragmentShaderID)),void 0!==e.defines)for(const t in e.defines)n.push(t),n.push(e.defines[t]);return!1===e.isRawShaderMaterial&&(function(t,e){t.push(e.precision),t.push(e.outputEncoding),t.push(e.envMapMode),t.push(e.envMapCubeUVHeight),t.push(e.combine),t.push(e.vertexUvs),t.push(e.fogExp2),t.push(e.sizeAttenuation),t.push(e.morphTargetsCount),t.push(e.morphAttributeCount),t.push(e.numDirLights),t.push(e.numPointLights),t.push(e.numSpotLights),t.push(e.numHemiLights),t.push(e.numRectAreaLights),t.push(e.numDirLightShadows),t.push(e.numPointLightShadows),t.push(e.numSpotLightShadows),t.push(e.shadowMapType),t.push(e.toneMapping),t.push(e.numClippingPlanes),t.push(e.numClipIntersection),t.push(e.depthPacking)}(n,e),function(t,e){l.disableAll(),e.isWebGL2&&l.enable(0),e.supportsVertexTextures&&l.enable(1),e.instancing&&l.enable(2),e.instancingColor&&l.enable(3),e.map&&l.enable(4),e.matcap&&l.enable(5),e.envMap&&l.enable(6),e.lightMap&&l.enable(7),e.aoMap&&l.enable(8),e.emissiveMap&&l.enable(9),e.bumpMap&&l.enable(10),e.normalMap&&l.enable(11),e.objectSpaceNormalMap&&l.enable(12),e.tangentSpaceNormalMap&&l.enable(13),e.clearcoat&&l.enable(14),e.clearcoatMap&&l.enable(15),e.clearcoatRoughnessMap&&l.enable(16),e.clearcoatNormalMap&&l.enable(17),e.displacementMap&&l.enable(18),e.specularMap&&l.enable(19),e.roughnessMap&&l.enable(20),e.metalnessMap&&l.enable(21),e.gradientMap&&l.enable(22),e.alphaMap&&l.enable(23),e.alphaTest&&l.enable(24),e.vertexColors&&l.enable(25),e.vertexAlphas&&l.enable(26),e.vertexUvs&&l.enable(27),e.vertexTangents&&l.enable(28),e.uvsVertexOnly&&l.enable(29),e.fog&&l.enable(30),t.push(l.mask),l.disableAll(),e.useFog&&l.enable(0),e.flatShading&&l.enable(1),e.logarithmicDepthBuffer&&l.enable(2),e.skinning&&l.enable(3),e.morphTargets&&l.enable(4),e.morphNormals&&l.enable(5),e.morphColors&&l.enable(6),e.premultipliedAlpha&&l.enable(7),e.shadowMapEnabled&&l.enable(8),e.physicallyCorrectLights&&l.enable(9),e.doubleSided&&l.enable(10),e.flipSided&&l.enable(11),e.useDepthPacking&&l.enable(12),e.dithering&&l.enable(13),e.specularIntensityMap&&l.enable(14),e.specularColorMap&&l.enable(15),e.transmission&&l.enable(16),e.transmissionMap&&l.enable(17),e.thicknessMap&&l.enable(18),e.sheen&&l.enable(19),e.sheenColorMap&&l.enable(20),e.sheenRoughnessMap&&l.enable(21),e.decodeVideoTexture&&l.enable(22),e.opaque&&l.enable(23),t.push(l.mask)}(n,e),n.push(t.outputEncoding)),n.push(e.customProgramCacheKey),n.join()},getUniforms:function(t){const e=m[t.type];let n;if(e){const t=w[e];n=y.rD.clone(t.uniforms)}else n=t.uniforms;return n},acquireProgram:function(e,n){let i;for(let t=0,e=u.length;t<e;t++){const e=u[t];if(e.cacheKey===n){i=e,++i.usedTimes;break}}return void 0===i&&(i=new Fe(t,n,e,a),u.push(i)),i},releaseProgram:function(t){if(0==--t.usedTimes){const e=u.indexOf(t);u[e]=u[u.length-1],u.pop(),t.destroy()}},releaseShaderCache:function(t){c.remove(t)},programs:u,dispose:function(){c.dispose()}}}function ze(){let t=new WeakMap;return{get:function(e){let n=t.get(e);return void 0===n&&(n={},t.set(e,n)),n},remove:function(e){t.delete(e)},update:function(e,n,i){t.get(e)[n]=i},dispose:function(){t=new WeakMap}}}function Ge(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function He(t,e){return t.groupOrder!==e.groupOrder?t.groupOrder-e.groupOrder:t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function We(){const t=[];let e=0;const n=[],i=[],r=[];function s(n,i,r,s,a,o){let l=t[e];return void 0===l?(l={id:n.id,object:n,geometry:i,material:r,groupOrder:s,renderOrder:n.renderOrder,z:a,group:o},t[e]=l):(l.id=n.id,l.object=n,l.geometry=i,l.material=r,l.groupOrder=s,l.renderOrder=n.renderOrder,l.z=a,l.group=o),e++,l}return{opaque:n,transmissive:i,transparent:r,init:function(){e=0,n.length=0,i.length=0,r.length=0},push:function(t,e,a,o,l,c){const u=s(t,e,a,o,l,c);a.transmission>0?i.push(u):!0===a.transparent?r.push(u):n.push(u)},unshift:function(t,e,a,o,l,c){const u=s(t,e,a,o,l,c);a.transmission>0?i.unshift(u):!0===a.transparent?r.unshift(u):n.unshift(u)},finish:function(){for(let n=e,i=t.length;n<i;n++){const e=t[n];if(null===e.id)break;e.id=null,e.object=null,e.geometry=null,e.material=null,e.group=null}},sort:function(t,e){n.length>1&&n.sort(t||Ge),i.length>1&&i.sort(e||He),r.length>1&&r.sort(e||He)}}}function qe(){let t=new WeakMap;return{get:function(e,n){let i;return!1===t.has(e)?(i=new We,t.set(e,[i])):n>=t.get(e).length?(i=new We,t.get(e).push(i)):i=t.get(e)[n],i},dispose:function(){t=new WeakMap}}}function je(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let n;switch(e.type){case"DirectionalLight":n={direction:new l.Vector3,color:new m.Color};break;case"SpotLight":n={position:new l.Vector3,direction:new l.Vector3,color:new m.Color,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":n={position:new l.Vector3,color:new m.Color,distance:0,decay:0};break;case"HemisphereLight":n={direction:new l.Vector3,skyColor:new m.Color,groundColor:new m.Color};break;case"RectAreaLight":n={color:new m.Color,position:new l.Vector3,halfWidth:new l.Vector3,halfHeight:new l.Vector3}}return t[e.id]=n,n}}}let Xe=0;function Ke(t,e){return(e.castShadow?1:0)-(t.castShadow?1:0)}function $e(t,e){const n=new je,i=function(){const t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];let n;switch(e.type){case"DirectionalLight":case"SpotLight":n={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new o.Vector2};break;case"PointLight":n={shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new o.Vector2,shadowCameraNear:1,shadowCameraFar:1e3}}return t[e.id]=n,n}}}(),r={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadow:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]};for(let t=0;t<9;t++)r.probe.push(new l.Vector3);const s=new l.Vector3,c=new a.Matrix4,u=new a.Matrix4;return{setup:function(s,a){let o=0,l=0,c=0;for(let t=0;t<9;t++)r.probe[t].set(0,0,0);let u=0,h=0,d=0,f=0,p=0,m=0,g=0,v=0;s.sort(Ke);const y=!0!==a?Math.PI:1;for(let t=0,e=s.length;t<e;t++){const e=s[t],a=e.color,_=e.intensity,x=e.distance,w=e.shadow&&e.shadow.map?e.shadow.map.texture:null;if(e.isAmbientLight)o+=a.r*_*y,l+=a.g*_*y,c+=a.b*_*y;else if(e.isLightProbe)for(let t=0;t<9;t++)r.probe[t].addScaledVector(e.sh.coefficients[t],_);else if(e.isDirectionalLight){const t=n.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity*y),e.castShadow){const t=e.shadow,n=i.get(e);n.shadowBias=t.bias,n.shadowNormalBias=t.normalBias,n.shadowRadius=t.radius,n.shadowMapSize=t.mapSize,r.directionalShadow[u]=n,r.directionalShadowMap[u]=w,r.directionalShadowMatrix[u]=e.shadow.matrix,m++}r.directional[u]=t,u++}else if(e.isSpotLight){const t=n.get(e);if(t.position.setFromMatrixPosition(e.matrixWorld),t.color.copy(a).multiplyScalar(_*y),t.distance=x,t.coneCos=Math.cos(e.angle),t.penumbraCos=Math.cos(e.angle*(1-e.penumbra)),t.decay=e.decay,e.castShadow){const t=e.shadow,n=i.get(e);n.shadowBias=t.bias,n.shadowNormalBias=t.normalBias,n.shadowRadius=t.radius,n.shadowMapSize=t.mapSize,r.spotShadow[d]=n,r.spotShadowMap[d]=w,r.spotShadowMatrix[d]=e.shadow.matrix,v++}r.spot[d]=t,d++}else if(e.isRectAreaLight){const t=n.get(e);t.color.copy(a).multiplyScalar(_),t.halfWidth.set(.5*e.width,0,0),t.halfHeight.set(0,.5*e.height,0),r.rectArea[f]=t,f++}else if(e.isPointLight){const t=n.get(e);if(t.color.copy(e.color).multiplyScalar(e.intensity*y),t.distance=e.distance,t.decay=e.decay,e.castShadow){const t=e.shadow,n=i.get(e);n.shadowBias=t.bias,n.shadowNormalBias=t.normalBias,n.shadowRadius=t.radius,n.shadowMapSize=t.mapSize,n.shadowCameraNear=t.camera.near,n.shadowCameraFar=t.camera.far,r.pointShadow[h]=n,r.pointShadowMap[h]=w,r.pointShadowMatrix[h]=e.shadow.matrix,g++}r.point[h]=t,h++}else if(e.isHemisphereLight){const t=n.get(e);t.skyColor.copy(e.color).multiplyScalar(_*y),t.groundColor.copy(e.groundColor).multiplyScalar(_*y),r.hemi[p]=t,p++}}f>0&&(e.isWebGL2||!0===t.has("OES_texture_float_linear")?(r.rectAreaLTC1=x.LTC_FLOAT_1,r.rectAreaLTC2=x.LTC_FLOAT_2):!0===t.has("OES_texture_half_float_linear")?(r.rectAreaLTC1=x.LTC_HALF_1,r.rectAreaLTC2=x.LTC_HALF_2):console.error("THREE.WebGLRenderer: Unable to use RectAreaLight. Missing WebGL extensions.")),r.ambient[0]=o,r.ambient[1]=l,r.ambient[2]=c;const _=r.hash;_.directionalLength===u&&_.pointLength===h&&_.spotLength===d&&_.rectAreaLength===f&&_.hemiLength===p&&_.numDirectionalShadows===m&&_.numPointShadows===g&&_.numSpotShadows===v||(r.directional.length=u,r.spot.length=d,r.rectArea.length=f,r.point.length=h,r.hemi.length=p,r.directionalShadow.length=m,r.directionalShadowMap.length=m,r.pointShadow.length=g,r.pointShadowMap.length=g,r.spotShadow.length=v,r.spotShadowMap.length=v,r.directionalShadowMatrix.length=m,r.pointShadowMatrix.length=g,r.spotShadowMatrix.length=v,_.directionalLength=u,_.pointLength=h,_.spotLength=d,_.rectAreaLength=f,_.hemiLength=p,_.numDirectionalShadows=m,_.numPointShadows=g,_.numSpotShadows=v,r.version=Xe++)},setupView:function(t,e){let n=0,i=0,a=0,o=0,l=0;const h=e.matrixWorldInverse;for(let e=0,d=t.length;e<d;e++){const d=t[e];if(d.isDirectionalLight){const t=r.directional[n];t.direction.setFromMatrixPosition(d.matrixWorld),s.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(h),n++}else if(d.isSpotLight){const t=r.spot[a];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(h),t.direction.setFromMatrixPosition(d.matrixWorld),s.setFromMatrixPosition(d.target.matrixWorld),t.direction.sub(s),t.direction.transformDirection(h),a++}else if(d.isRectAreaLight){const t=r.rectArea[o];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(h),u.identity(),c.copy(d.matrixWorld),c.premultiply(h),u.extractRotation(c),t.halfWidth.set(.5*d.width,0,0),t.halfHeight.set(0,.5*d.height,0),t.halfWidth.applyMatrix4(u),t.halfHeight.applyMatrix4(u),o++}else if(d.isPointLight){const t=r.point[i];t.position.setFromMatrixPosition(d.matrixWorld),t.position.applyMatrix4(h),i++}else if(d.isHemisphereLight){const t=r.hemi[l];t.direction.setFromMatrixPosition(d.matrixWorld),t.direction.transformDirection(h),l++}}},state:r}}function Ye(t,e){const n=new $e(t,e),i=[],r=[];return{init:function(){i.length=0,r.length=0},state:{lightsArray:i,shadowsArray:r,lights:n},setupLights:function(t){n.setup(i,t)},setupLightsView:function(t){n.setupView(i,t)},pushLight:function(t){i.push(t)},pushShadow:function(t){r.push(t)}}}function Qe(t,e){let n=new WeakMap;return{get:function(i,r=0){let s;return!1===n.has(i)?(s=new Ye(t,e),n.set(i,[s])):r>=n.get(i).length?(s=new Ye(t,e),n.get(i).push(s)):s=n.get(i)[r],s},dispose:function(){n=new WeakMap}}}var Je=n(406);class Ze extends Je.F{constructor(t){super(),this.type="MeshDepthMaterial",this.depthPacking=i.z81,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(t)}copy(t){return super.copy(t),this.depthPacking=t.depthPacking,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this}}Ze.prototype.isMeshDepthMaterial=!0;class tn extends Je.F{constructor(t){super(),this.type="MeshDistanceMaterial",this.referencePosition=new l.Vector3,this.nearDistance=1,this.farDistance=1e3,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(t)}copy(t){return super.copy(t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this}}function en(t,e,n){let r=new s.i;const a=new o.Vector2,l=new o.Vector2,u=new c.L,h=new Ze({depthPacking:i.mSO}),d=new tn,f={},m=n.maxTextureSize,v={0:i._Li,1:i.Wl3,2:i.ehD},y=new p.ShaderMaterial({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new o.Vector2},radius:{value:4}},vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}\n",fragmentShader:"\nuniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n\n#include <packing>\n\nvoid main() {\n\n\tconst float samples = float( VSM_SAMPLES );\n\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\n\t// This seems totally useless but it's a crazy work around for a Adreno compiler bug\n\t// float depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy ) / resolution ) );\n\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\n\t\t#ifdef HORIZONTAL_PASS\n\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\n\t\t#else\n\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\n\t\t#endif\n\n\t}\n\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n\n}\n"}),_=y.clone();_.defines.HORIZONTAL_PASS=1;const x=new B.BufferGeometry;x.setAttribute("position",new k.BufferAttribute(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const w=new g.Mesh(x,y),b=this;function S(n,i){const r=e.update(w);y.defines.VSM_SAMPLES!==n.blurSamples&&(y.defines.VSM_SAMPLES=n.blurSamples,_.defines.VSM_SAMPLES=n.blurSamples,y.needsUpdate=!0,_.needsUpdate=!0),y.uniforms.shadow_pass.value=n.map.texture,y.uniforms.resolution.value=n.mapSize,y.uniforms.radius.value=n.radius,t.setRenderTarget(n.mapPass),t.clear(),t.renderBufferDirect(i,null,r,y,w,null),_.uniforms.shadow_pass.value=n.mapPass.texture,_.uniforms.resolution.value=n.mapSize,_.uniforms.radius.value=n.radius,t.setRenderTarget(n.map),t.clear(),t.renderBufferDirect(i,null,r,_,w,null)}function E(e,n,r,s,a,o){let l=null;const c=!0===r.isPointLight?e.customDistanceMaterial:e.customDepthMaterial;if(l=void 0!==c?c:!0===r.isPointLight?d:h,t.localClippingEnabled&&!0===n.clipShadows&&0!==n.clippingPlanes.length||n.displacementMap&&0!==n.displacementScale||n.alphaMap&&n.alphaTest>0){const t=l.uuid,e=n.uuid;let i=f[t];void 0===i&&(i={},f[t]=i);let r=i[e];void 0===r&&(r=l.clone(),i[e]=r),l=r}return l.visible=n.visible,l.wireframe=n.wireframe,o===i.dwk?l.side=null!==n.shadowSide?n.shadowSide:n.side:l.side=null!==n.shadowSide?n.shadowSide:v[n.side],l.alphaMap=n.alphaMap,l.alphaTest=n.alphaTest,l.clipShadows=n.clipShadows,l.clippingPlanes=n.clippingPlanes,l.clipIntersection=n.clipIntersection,l.displacementMap=n.displacementMap,l.displacementScale=n.displacementScale,l.displacementBias=n.displacementBias,l.wireframeLinewidth=n.wireframeLinewidth,l.linewidth=n.linewidth,!0===r.isPointLight&&!0===l.isMeshDistanceMaterial&&(l.referencePosition.setFromMatrixPosition(r.matrixWorld),l.nearDistance=s,l.farDistance=a),l}function T(n,s,a,o,l){if(!1===n.visible)return;if(n.layers.test(s.layers)&&(n.isMesh||n.isLine||n.isPoints)&&(n.castShadow||n.receiveShadow&&l===i.dwk)&&(!n.frustumCulled||r.intersectsObject(n))){n.modelViewMatrix.multiplyMatrices(a.matrixWorldInverse,n.matrixWorld);const i=e.update(n),r=n.material;if(Array.isArray(r)){const e=i.groups;for(let s=0,c=e.length;s<c;s++){const c=e[s],u=r[c.materialIndex];if(u&&u.visible){const e=E(n,u,o,a.near,a.far,l);t.renderBufferDirect(a,null,i,e,n,c)}}}else if(r.visible){const e=E(n,r,o,a.near,a.far,l);t.renderBufferDirect(a,null,i,e,n,null)}}const c=n.children;for(let t=0,e=c.length;t<e;t++)T(c[t],s,a,o,l)}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=i._iA,this.render=function(e,n,s){if(!1===b.enabled)return;if(!1===b.autoUpdate&&!1===b.needsUpdate)return;if(0===e.length)return;const o=t.getRenderTarget(),c=t.getActiveCubeFace(),h=t.getActiveMipmapLevel(),d=t.state;d.setBlending(i.jFi),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(let o=0,c=e.length;o<c;o++){const c=e[o],h=c.shadow;if(void 0===h){console.warn("THREE.WebGLShadowMap:",c,"has no shadow.");continue}if(!1===h.autoUpdate&&!1===h.needsUpdate)continue;a.copy(h.mapSize);const f=h.getFrameExtents();if(a.multiply(f),l.copy(h.mapSize),(a.x>m||a.y>m)&&(a.x>m&&(l.x=Math.floor(m/f.x),a.x=l.x*f.x,h.mapSize.x=l.x),a.y>m&&(l.y=Math.floor(m/f.y),a.y=l.y*f.y,h.mapSize.y=l.y)),null!==h.map||h.isPointLightShadow||this.type!==i.dwk||(h.map=new D(a.x,a.y),h.map.texture.name=c.name+".shadowMap",h.mapPass=new D(a.x,a.y),h.camera.updateProjectionMatrix()),null===h.map){const t={minFilter:i.TyD,magFilter:i.TyD,format:i.wk1};h.map=new D(a.x,a.y,t),h.map.texture.name=c.name+".shadowMap",h.camera.updateProjectionMatrix()}t.setRenderTarget(h.map),t.clear();const p=h.getViewportCount();for(let t=0;t<p;t++){const e=h.getViewport(t);u.set(l.x*e.x,l.y*e.y,l.x*e.z,l.y*e.w),d.viewport(u),h.updateMatrices(c,t),r=h.getFrustum(),T(n,s,h.camera,c,this.type)}h.isPointLightShadow||this.type!==i.dwk||S(h,s),h.needsUpdate=!1}b.needsUpdate=!1,t.setRenderTarget(o,c,h)}}function nn(t,e,n){const r=n.isWebGL2,s=new function(){let e=!1;const n=new c.L;let i=null;const r=new c.L(0,0,0,0);return{setMask:function(n){i===n||e||(t.colorMask(n,n,n,n),i=n)},setLocked:function(t){e=t},setClear:function(e,i,s,a,o){!0===o&&(e*=a,i*=a,s*=a),n.set(e,i,s,a),!1===r.equals(n)&&(t.clearColor(e,i,s,a),r.copy(n))},reset:function(){e=!1,i=null,r.set(-1,0,0,0)}}},a=new function(){let e=!1,n=null,r=null,s=null;return{setTest:function(e){e?B(t.DEPTH_TEST):z(t.DEPTH_TEST)},setMask:function(i){n===i||e||(t.depthMask(i),n=i)},setFunc:function(e){if(r!==e){if(e)switch(e){case i.BVF:t.depthFunc(t.NEVER);break;case i.Se2:t.depthFunc(t.ALWAYS);break;case i.Zr5:t.depthFunc(t.LESS);break;case i.vCF:t.depthFunc(t.LEQUAL);break;case i.eD:t.depthFunc(t.EQUAL);break;case i.ksN:t.depthFunc(t.GEQUAL);break;case i.w$m:t.depthFunc(t.GREATER);break;case i.M6v:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}else t.depthFunc(t.LEQUAL);r=e}},setLocked:function(t){e=t},setClear:function(e){s!==e&&(t.clearDepth(e),s=e)},reset:function(){e=!1,n=null,r=null,s=null}}},o=new function(){let e=!1,n=null,i=null,r=null,s=null,a=null,o=null,l=null,c=null;return{setTest:function(n){e||(n?B(t.STENCIL_TEST):z(t.STENCIL_TEST))},setMask:function(i){n===i||e||(t.stencilMask(i),n=i)},setFunc:function(e,n,a){i===e&&r===n&&s===a||(t.stencilFunc(e,n,a),i=e,r=n,s=a)},setOp:function(e,n,i){a===e&&o===n&&l===i||(t.stencilOp(e,n,i),a=e,o=n,l=i)},setLocked:function(t){e=t},setClear:function(e){c!==e&&(t.clearStencil(e),c=e)},reset:function(){e=!1,n=null,i=null,r=null,s=null,a=null,o=null,l=null,c=null}}};let l={},u={},h=new WeakMap,d=[],f=null,p=!1,m=null,g=null,v=null,y=null,_=null,x=null,w=null,b=!1,S=null,E=null,T=null,M=null,A=null;const I=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let C=!1,R=0;const D=t.getParameter(t.VERSION);-1!==D.indexOf("WebGL")?(R=parseFloat(/^WebGL (\d)/.exec(D)[1]),C=R>=1):-1!==D.indexOf("OpenGL ES")&&(R=parseFloat(/^OpenGL ES (\d)/.exec(D)[1]),C=R>=2);let L=null,P={};const N=t.getParameter(t.SCISSOR_BOX),O=t.getParameter(t.VIEWPORT),F=(new c.L).fromArray(N),U=(new c.L).fromArray(O);function V(e,n,i){const r=new Uint8Array(4),s=t.createTexture();t.bindTexture(e,s),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.NEAREST);for(let e=0;e<i;e++)t.texImage2D(n+e,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,r);return s}const k={};function B(e){!0!==l[e]&&(t.enable(e),l[e]=!0)}function z(e){!1!==l[e]&&(t.disable(e),l[e]=!1)}k[t.TEXTURE_2D]=V(t.TEXTURE_2D,t.TEXTURE_2D,1),k[t.TEXTURE_CUBE_MAP]=V(t.TEXTURE_CUBE_MAP,t.TEXTURE_CUBE_MAP_POSITIVE_X,6),s.setClear(0,0,0,1),a.setClear(1),o.setClear(0),B(t.DEPTH_TEST),a.setFunc(i.vCF),q(!1),j(i.tm_),B(t.CULL_FACE),W(i.jFi);const G={[i.bGH]:t.FUNC_ADD,[i.Wbm]:t.FUNC_SUBTRACT,[i.rOj]:t.FUNC_REVERSE_SUBTRACT};if(r)G[i.r_]=t.MIN,G[i.Sm8]=t.MAX;else{const t=e.get("EXT_blend_minmax");null!==t&&(G[i.r_]=t.MIN_EXT,G[i.Sm8]=t.MAX_EXT)}const H={[i.c8b]:t.ZERO,[i.ghN]:t.ONE,[i.KhW]:t.SRC_COLOR,[i.k74]:t.SRC_ALPHA,[i.RlZ]:t.SRC_ALPHA_SATURATE,[i.Vdb]:t.DST_COLOR,[i.fSK]:t.DST_ALPHA,[i.iWC]:t.ONE_MINUS_SRC_COLOR,[i.LgZ]:t.ONE_MINUS_SRC_ALPHA,[i.Wpd]:t.ONE_MINUS_DST_COLOR,[i.Hy8]:t.ONE_MINUS_DST_ALPHA};function W(e,n,r,s,a,o,l,c){if(e!==i.jFi){if(!1===p&&(B(t.BLEND),p=!0),e===i.Xaj)a=a||n,o=o||r,l=l||s,n===g&&a===_||(t.blendEquationSeparate(G[n],G[a]),g=n,_=a),r===v&&s===y&&o===x&&l===w||(t.blendFuncSeparate(H[r],H[s],H[o],H[l]),v=r,y=s,x=o,w=l),m=e,b=null;else if(e!==m||c!==b){if(g===i.bGH&&_===i.bGH||(t.blendEquation(t.FUNC_ADD),g=i.bGH,_=i.bGH),c)switch(e){case i.bdR:t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case i.WMw:t.blendFunc(t.ONE,t.ONE);break;case i.N4l:t.blendFuncSeparate(t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ZERO,t.ONE);break;case i.M5h:t.blendFuncSeparate(t.ZERO,t.SRC_COLOR,t.ZERO,t.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}else switch(e){case i.bdR:t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA);break;case i.WMw:t.blendFunc(t.SRC_ALPHA,t.ONE);break;case i.N4l:t.blendFuncSeparate(t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ZERO,t.ONE);break;case i.M5h:t.blendFunc(t.ZERO,t.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",e)}v=null,y=null,x=null,w=null,m=e,b=c}}else!0===p&&(z(t.BLEND),p=!1)}function q(e){S!==e&&(e?t.frontFace(t.CW):t.frontFace(t.CCW),S=e)}function j(e){e!==i.PeU?(B(t.CULL_FACE),e!==E&&(e===i.tm_?t.cullFace(t.BACK):e===i.S2y?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):z(t.CULL_FACE),E=e}function X(e,n,i){e?(B(t.POLYGON_OFFSET_FILL),M===n&&A===i||(t.polygonOffset(n,i),M=n,A=i)):z(t.POLYGON_OFFSET_FILL)}function K(e){void 0===e&&(e=t.TEXTURE0+I-1),L!==e&&(t.activeTexture(e),L=e)}return{buffers:{color:s,depth:a,stencil:o},enable:B,disable:z,bindFramebuffer:function(e,n){return u[e]!==n&&(t.bindFramebuffer(e,n),u[e]=n,r&&(e===t.DRAW_FRAMEBUFFER&&(u[t.FRAMEBUFFER]=n),e===t.FRAMEBUFFER&&(u[t.DRAW_FRAMEBUFFER]=n)),!0)},drawBuffers:function(i,r){let s=d,a=!1;if(i)if(s=h.get(r),void 0===s&&(s=[],h.set(r,s)),i.isWebGLMultipleRenderTargets){const e=i.texture;if(s.length!==e.length||s[0]!==t.COLOR_ATTACHMENT0){for(let n=0,i=e.length;n<i;n++)s[n]=t.COLOR_ATTACHMENT0+n;s.length=e.length,a=!0}}else s[0]!==t.COLOR_ATTACHMENT0&&(s[0]=t.COLOR_ATTACHMENT0,a=!0);else s[0]!==t.BACK&&(s[0]=t.BACK,a=!0);a&&(n.isWebGL2?t.drawBuffers(s):e.get("WEBGL_draw_buffers").drawBuffersWEBGL(s))},useProgram:function(e){return f!==e&&(t.useProgram(e),f=e,!0)},setBlending:W,setMaterial:function(e,n){e.side===i.ehD?z(t.CULL_FACE):B(t.CULL_FACE);let r=e.side===i._Li;n&&(r=!r),q(r),e.blending===i.bdR&&!1===e.transparent?W(i.jFi):W(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),a.setFunc(e.depthFunc),a.setTest(e.depthTest),a.setMask(e.depthWrite),s.setMask(e.colorWrite);const l=e.stencilWrite;o.setTest(l),l&&(o.setMask(e.stencilWriteMask),o.setFunc(e.stencilFunc,e.stencilRef,e.stencilFuncMask),o.setOp(e.stencilFail,e.stencilZFail,e.stencilZPass)),X(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits),!0===e.alphaToCoverage?B(t.SAMPLE_ALPHA_TO_COVERAGE):z(t.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:q,setCullFace:j,setLineWidth:function(e){e!==T&&(C&&t.lineWidth(e),T=e)},setPolygonOffset:X,setScissorTest:function(e){e?B(t.SCISSOR_TEST):z(t.SCISSOR_TEST)},activeTexture:K,bindTexture:function(e,n){null===L&&K();let i=P[L];void 0===i&&(i={type:void 0,texture:void 0},P[L]=i),i.type===e&&i.texture===n||(t.bindTexture(e,n||k[e]),i.type=e,i.texture=n)},unbindTexture:function(){const e=P[L];void 0!==e&&void 0!==e.type&&(t.bindTexture(e.type,null),e.type=void 0,e.texture=void 0)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texImage3D:function(){try{t.texImage3D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texStorage2D:function(){try{t.texStorage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texStorage3D:function(){try{t.texStorage3D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texSubImage2D:function(){try{t.texSubImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},texSubImage3D:function(){try{t.texSubImage3D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},compressedTexSubImage2D:function(){try{t.compressedTexSubImage2D.apply(t,arguments)}catch(t){console.error("THREE.WebGLState:",t)}},scissor:function(e){!1===F.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),F.copy(e))},viewport:function(e){!1===U.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),U.copy(e))},reset:function(){t.disable(t.BLEND),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.disable(t.POLYGON_OFFSET_FILL),t.disable(t.SCISSOR_TEST),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ONE,t.ZERO),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.clearColor(0,0,0,0),t.depthMask(!0),t.depthFunc(t.LESS),t.clearDepth(1),t.stencilMask(4294967295),t.stencilFunc(t.ALWAYS,0,4294967295),t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.clearStencil(0),t.cullFace(t.BACK),t.frontFace(t.CCW),t.polygonOffset(0,0),t.activeTexture(t.TEXTURE0),t.bindFramebuffer(t.FRAMEBUFFER,null),!0===r&&(t.bindFramebuffer(t.DRAW_FRAMEBUFFER,null),t.bindFramebuffer(t.READ_FRAMEBUFFER,null)),t.useProgram(null),t.lineWidth(1),t.scissor(0,0,t.canvas.width,t.canvas.height),t.viewport(0,0,t.canvas.width,t.canvas.height),l={},L=null,P={},u={},h=new WeakMap,d=[],f=null,p=!1,m=null,g=null,v=null,y=null,_=null,x=null,w=null,b=!1,S=null,E=null,T=null,M=null,A=null,F.set(0,0,t.canvas.width,t.canvas.height),U.set(0,0,t.canvas.width,t.canvas.height),s.reset(),a.reset(),o.reset()}}}tn.prototype.isMeshDistanceMaterial=!0;var rn=n(2564);function sn(t,e,n,s,a,o,l){const c=a.isWebGL2,u=a.maxTextures,h=a.maxCubemapSize,d=a.maxTextureSize,f=a.maxSamples,p=e.has("WEBGL_multisampled_render_to_texture")?e.get("WEBGL_multisampled_render_to_texture"):null,m=/OculusBrowser/g.test(navigator.userAgent),g=new WeakMap;let v;const y=new WeakMap;let _=!1;try{_="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(t){}function x(t,e){return _?new OffscreenCanvas(t,e):(0,it.c)("canvas")}function w(t,e,n,i){let s=1;if((t.width>i||t.height>i)&&(s=i/Math.max(t.width,t.height)),s<1||!0===e){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const i=e?r.gy:Math.floor,a=i(s*t.width),o=i(s*t.height);void 0===v&&(v=x(a,o));const l=n?x(a,o):v;return l.width=a,l.height=o,l.getContext("2d").drawImage(t,0,0,a,o),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+t.width+"x"+t.height+") to ("+a+"x"+o+")."),l}return"data"in t&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+t.width+"x"+t.height+")."),t}return t}function b(t){return r.wt(t.width)&&r.wt(t.height)}function S(t,e){return t.generateMipmaps&&e&&t.minFilter!==i.TyD&&t.minFilter!==i.wem}function E(e){t.generateMipmap(e)}function T(n,r,s,a,o=!1){if(!1===c)return r;if(null!==n){if(void 0!==t[n])return t[n];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+n+"'")}let l=r;return r===t.RED&&(s===t.FLOAT&&(l=t.R32F),s===t.HALF_FLOAT&&(l=t.R16F),s===t.UNSIGNED_BYTE&&(l=t.R8)),r===t.RG&&(s===t.FLOAT&&(l=t.RG32F),s===t.HALF_FLOAT&&(l=t.RG16F),s===t.UNSIGNED_BYTE&&(l=t.RG8)),r===t.RGBA&&(s===t.FLOAT&&(l=t.RGBA32F),s===t.HALF_FLOAT&&(l=t.RGBA16F),s===t.UNSIGNED_BYTE&&(l=a===i.knz&&!1===o?t.SRGB8_ALPHA8:t.RGBA8),s===t.UNSIGNED_SHORT_4_4_4_4&&(l=t.RGBA4),s===t.UNSIGNED_SHORT_5_5_5_1&&(l=t.RGB5_A1)),l!==t.R16F&&l!==t.R32F&&l!==t.RG16F&&l!==t.RG32F&&l!==t.RGBA16F&&l!==t.RGBA32F||e.get("EXT_color_buffer_float"),l}function M(t,e,n){return!0===S(t,n)||t.isFramebufferTexture&&t.minFilter!==i.TyD&&t.minFilter!==i.wem?Math.log2(Math.max(e.width,e.height))+1:void 0!==t.mipmaps&&t.mipmaps.length>0?t.mipmaps.length:t.isCompressedTexture&&Array.isArray(t.image)?e.mipmaps.length:1}function A(e){return e===i.TyD||e===i.YLQ||e===i.aH4?t.NEAREST:t.LINEAR}function I(t){const e=t.target;e.removeEventListener("dispose",I),function(t){const e=s.get(t);if(void 0===e.__webglInit)return;const n=t.source,i=y.get(n);if(i){const r=i[e.__cacheKey];r.usedTimes--,0===r.usedTimes&&R(t),0===Object.keys(i).length&&y.delete(n)}s.remove(t)}(e),e.isVideoTexture&&g.delete(e)}function C(e){const n=e.target;n.removeEventListener("dispose",C),function(e){const n=e.texture,i=s.get(e),r=s.get(n);if(void 0!==r.__webglTexture&&(t.deleteTexture(r.__webglTexture),l.memory.textures--),e.depthTexture&&e.depthTexture.dispose(),e.isWebGLCubeRenderTarget)for(let e=0;e<6;e++)t.deleteFramebuffer(i.__webglFramebuffer[e]),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer[e]);else t.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer),i.__webglMultisampledFramebuffer&&t.deleteFramebuffer(i.__webglMultisampledFramebuffer),i.__webglColorRenderbuffer&&t.deleteRenderbuffer(i.__webglColorRenderbuffer),i.__webglDepthRenderbuffer&&t.deleteRenderbuffer(i.__webglDepthRenderbuffer);if(e.isWebGLMultipleRenderTargets)for(let e=0,i=n.length;e<i;e++){const i=s.get(n[e]);i.__webglTexture&&(t.deleteTexture(i.__webglTexture),l.memory.textures--),s.remove(n[e])}s.remove(n),s.remove(e)}(n)}function R(e){const n=s.get(e);t.deleteTexture(n.__webglTexture);const i=e.source;delete y.get(i)[n.__cacheKey],l.memory.textures--}let D=0;function L(e,i){const r=s.get(e);if(e.isVideoTexture&&function(t){const e=l.render.frame;g.get(t)!==e&&(g.set(t,e),t.update())}(e),!1===e.isRenderTargetTexture&&e.version>0&&r.__version!==e.version){const t=e.image;if(null===t)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==t.complete)return void U(r,e,i);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}n.activeTexture(t.TEXTURE0+i),n.bindTexture(t.TEXTURE_2D,r.__webglTexture)}const P={[i.rpg]:t.REPEAT,[i.uWy]:t.CLAMP_TO_EDGE,[i.OoA]:t.MIRRORED_REPEAT},N={[i.TyD]:t.NEAREST,[i.YLQ]:t.NEAREST_MIPMAP_NEAREST,[i.aH4]:t.NEAREST_MIPMAP_LINEAR,[i.wem]:t.LINEAR,[i.qyh]:t.LINEAR_MIPMAP_NEAREST,[i.D1R]:t.LINEAR_MIPMAP_LINEAR};function O(n,r,o){if(o?(t.texParameteri(n,t.TEXTURE_WRAP_S,P[r.wrapS]),t.texParameteri(n,t.TEXTURE_WRAP_T,P[r.wrapT]),n!==t.TEXTURE_3D&&n!==t.TEXTURE_2D_ARRAY||t.texParameteri(n,t.TEXTURE_WRAP_R,P[r.wrapR]),t.texParameteri(n,t.TEXTURE_MAG_FILTER,N[r.magFilter]),t.texParameteri(n,t.TEXTURE_MIN_FILTER,N[r.minFilter])):(t.texParameteri(n,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(n,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),n!==t.TEXTURE_3D&&n!==t.TEXTURE_2D_ARRAY||t.texParameteri(n,t.TEXTURE_WRAP_R,t.CLAMP_TO_EDGE),r.wrapS===i.uWy&&r.wrapT===i.uWy||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping."),t.texParameteri(n,t.TEXTURE_MAG_FILTER,A(r.magFilter)),t.texParameteri(n,t.TEXTURE_MIN_FILTER,A(r.minFilter)),r.minFilter!==i.TyD&&r.minFilter!==i.wem&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.")),!0===e.has("EXT_texture_filter_anisotropic")){const o=e.get("EXT_texture_filter_anisotropic");if(r.type===i.VzW&&!1===e.has("OES_texture_float_linear"))return;if(!1===c&&r.type===i.cLu&&!1===e.has("OES_texture_half_float_linear"))return;(r.anisotropy>1||s.get(r).__currentAnisotropy)&&(t.texParameterf(n,o.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(r.anisotropy,a.getMaxAnisotropy())),s.get(r).__currentAnisotropy=r.anisotropy)}}function F(e,n){let i=!1;void 0===e.__webglInit&&(e.__webglInit=!0,n.addEventListener("dispose",I));const r=n.source;let s=y.get(r);void 0===s&&(s={},y.set(r,s));const a=function(t){const e=[];return e.push(t.wrapS),e.push(t.wrapT),e.push(t.magFilter),e.push(t.minFilter),e.push(t.anisotropy),e.push(t.internalFormat),e.push(t.format),e.push(t.type),e.push(t.generateMipmaps),e.push(t.premultiplyAlpha),e.push(t.flipY),e.push(t.unpackAlignment),e.push(t.encoding),e.join()}(n);if(a!==e.__cacheKey){void 0===s[a]&&(s[a]={texture:t.createTexture(),usedTimes:0},l.memory.textures++,i=!0),s[a].usedTimes++;const r=s[e.__cacheKey];void 0!==r&&(s[e.__cacheKey].usedTimes--,0===r.usedTimes&&R(n)),e.__cacheKey=a,e.__webglTexture=s[a].texture}return i}function U(e,r,s){let a=t.TEXTURE_2D;r.isDataArrayTexture&&(a=t.TEXTURE_2D_ARRAY),r.isData3DTexture&&(a=t.TEXTURE_3D);const l=F(e,r),u=r.source;if(n.activeTexture(t.TEXTURE0+s),n.bindTexture(a,e.__webglTexture),u.version!==u.__currentVersion||!0===l){t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,r.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE);const s=function(t){return!c&&(t.wrapS!==i.uWy||t.wrapT!==i.uWy||t.minFilter!==i.TyD&&t.minFilter!==i.wem)}(r)&&!1===b(r.image);let h=w(r.image,s,!1,d);h=H(r,h);const f=b(h)||c,p=o.convert(r.format,r.encoding);let m,g=o.convert(r.type),v=T(r.internalFormat,p,g,r.encoding,r.isVideoTexture);O(a,r,f);const y=r.mipmaps,_=c&&!0!==r.isVideoTexture,x=void 0===e.__version||!0===l,A=M(r,h,f);if(r.isDepthTexture)v=t.DEPTH_COMPONENT,c?v=r.type===i.VzW?t.DEPTH_COMPONENT32F:r.type===i.JQ4?t.DEPTH_COMPONENT24:r.type===i.wJv?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT16:r.type===i.VzW&&console.error("WebGLRenderer: Floating point depth texture requires WebGL2."),r.format===i.qkB&&v===t.DEPTH_COMPONENT&&r.type!==i.LsT&&r.type!==i.JQ4&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),r.type=i.LsT,g=o.convert(r.type)),r.format===i.brP&&v===t.DEPTH_COMPONENT&&(v=t.DEPTH_STENCIL,r.type!==i.wJv&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),r.type=i.wJv,g=o.convert(r.type))),x&&(_?n.texStorage2D(t.TEXTURE_2D,1,v,h.width,h.height):n.texImage2D(t.TEXTURE_2D,0,v,h.width,h.height,0,p,g,null));else if(r.isDataTexture)if(y.length>0&&f){_&&x&&n.texStorage2D(t.TEXTURE_2D,A,v,y[0].width,y[0].height);for(let e=0,i=y.length;e<i;e++)m=y[e],_?n.texSubImage2D(t.TEXTURE_2D,e,0,0,m.width,m.height,p,g,m.data):n.texImage2D(t.TEXTURE_2D,e,v,m.width,m.height,0,p,g,m.data);r.generateMipmaps=!1}else _?(x&&n.texStorage2D(t.TEXTURE_2D,A,v,h.width,h.height),n.texSubImage2D(t.TEXTURE_2D,0,0,0,h.width,h.height,p,g,h.data)):n.texImage2D(t.TEXTURE_2D,0,v,h.width,h.height,0,p,g,h.data);else if(r.isCompressedTexture){_&&x&&n.texStorage2D(t.TEXTURE_2D,A,v,y[0].width,y[0].height);for(let e=0,s=y.length;e<s;e++)m=y[e],r.format!==i.wk1?null!==p?_?n.compressedTexSubImage2D(t.TEXTURE_2D,e,0,0,m.width,m.height,p,m.data):n.compressedTexImage2D(t.TEXTURE_2D,e,v,m.width,m.height,0,m.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):_?n.texSubImage2D(t.TEXTURE_2D,e,0,0,m.width,m.height,p,g,m.data):n.texImage2D(t.TEXTURE_2D,e,v,m.width,m.height,0,p,g,m.data)}else if(r.isDataArrayTexture)_?(x&&n.texStorage3D(t.TEXTURE_2D_ARRAY,A,v,h.width,h.height,h.depth),n.texSubImage3D(t.TEXTURE_2D_ARRAY,0,0,0,0,h.width,h.height,h.depth,p,g,h.data)):n.texImage3D(t.TEXTURE_2D_ARRAY,0,v,h.width,h.height,h.depth,0,p,g,h.data);else if(r.isData3DTexture)_?(x&&n.texStorage3D(t.TEXTURE_3D,A,v,h.width,h.height,h.depth),n.texSubImage3D(t.TEXTURE_3D,0,0,0,0,h.width,h.height,h.depth,p,g,h.data)):n.texImage3D(t.TEXTURE_3D,0,v,h.width,h.height,h.depth,0,p,g,h.data);else if(r.isFramebufferTexture){if(x)if(_)n.texStorage2D(t.TEXTURE_2D,A,v,h.width,h.height);else{let e=h.width,i=h.height;for(let r=0;r<A;r++)n.texImage2D(t.TEXTURE_2D,r,v,e,i,0,p,g,null),e>>=1,i>>=1}}else if(y.length>0&&f){_&&x&&n.texStorage2D(t.TEXTURE_2D,A,v,y[0].width,y[0].height);for(let e=0,i=y.length;e<i;e++)m=y[e],_?n.texSubImage2D(t.TEXTURE_2D,e,0,0,p,g,m):n.texImage2D(t.TEXTURE_2D,e,v,p,g,m);r.generateMipmaps=!1}else _?(x&&n.texStorage2D(t.TEXTURE_2D,A,v,h.width,h.height),n.texSubImage2D(t.TEXTURE_2D,0,0,0,p,g,h)):n.texImage2D(t.TEXTURE_2D,0,v,p,g,h);S(r,f)&&E(a),u.__currentVersion=u.version,r.onUpdate&&r.onUpdate(r)}e.__version=r.version}function V(e,i,r,a,l){const c=o.convert(r.format,r.encoding),u=o.convert(r.type),h=T(r.internalFormat,c,u,r.encoding);s.get(i).__hasExternalTextures||(l===t.TEXTURE_3D||l===t.TEXTURE_2D_ARRAY?n.texImage3D(l,0,h,i.width,i.height,i.depth,0,c,u,null):n.texImage2D(l,0,h,i.width,i.height,0,c,u,null)),n.bindFramebuffer(t.FRAMEBUFFER,e),G(i)?p.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,a,l,s.get(r).__webglTexture,0,z(i)):t.framebufferTexture2D(t.FRAMEBUFFER,a,l,s.get(r).__webglTexture,0),n.bindFramebuffer(t.FRAMEBUFFER,null)}function k(e,n,r){if(t.bindRenderbuffer(t.RENDERBUFFER,e),n.depthBuffer&&!n.stencilBuffer){let s=t.DEPTH_COMPONENT16;if(r||G(n)){const e=n.depthTexture;e&&e.isDepthTexture&&(e.type===i.VzW?s=t.DEPTH_COMPONENT32F:e.type===i.JQ4&&(s=t.DEPTH_COMPONENT24));const r=z(n);G(n)?p.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,r,s,n.width,n.height):t.renderbufferStorageMultisample(t.RENDERBUFFER,r,s,n.width,n.height)}else t.renderbufferStorage(t.RENDERBUFFER,s,n.width,n.height);t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e)}else if(n.depthBuffer&&n.stencilBuffer){const i=z(n);r&&!1===G(n)?t.renderbufferStorageMultisample(t.RENDERBUFFER,i,t.DEPTH24_STENCIL8,n.width,n.height):G(n)?p.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,i,t.DEPTH24_STENCIL8,n.width,n.height):t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,n.width,n.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e)}else{const e=!0===n.isWebGLMultipleRenderTargets?n.texture[0]:n.texture,i=o.convert(e.format,e.encoding),s=o.convert(e.type),a=T(e.internalFormat,i,s,e.encoding),l=z(n);r&&!1===G(n)?t.renderbufferStorageMultisample(t.RENDERBUFFER,l,a,n.width,n.height):G(n)?p.renderbufferStorageMultisampleEXT(t.RENDERBUFFER,l,a,n.width,n.height):t.renderbufferStorage(t.RENDERBUFFER,a,n.width,n.height)}t.bindRenderbuffer(t.RENDERBUFFER,null)}function B(e){const r=s.get(e),a=!0===e.isWebGLCubeRenderTarget;if(e.depthTexture&&!r.__autoAllocateDepthBuffer){if(a)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(n.bindFramebuffer(t.FRAMEBUFFER,e),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");s.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),L(r.depthTexture,0);const a=s.get(r.depthTexture).__webglTexture,o=z(r);if(r.depthTexture.format===i.qkB)G(r)?p.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,a,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,a,0);else{if(r.depthTexture.format!==i.brP)throw new Error("Unknown depthTexture format");G(r)?p.framebufferTexture2DMultisampleEXT(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,a,0,o):t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,a,0)}}(r.__webglFramebuffer,e)}else if(a){r.__webglDepthbuffer=[];for(let i=0;i<6;i++)n.bindFramebuffer(t.FRAMEBUFFER,r.__webglFramebuffer[i]),r.__webglDepthbuffer[i]=t.createRenderbuffer(),k(r.__webglDepthbuffer[i],e,!1)}else n.bindFramebuffer(t.FRAMEBUFFER,r.__webglFramebuffer),r.__webglDepthbuffer=t.createRenderbuffer(),k(r.__webglDepthbuffer,e,!1);n.bindFramebuffer(t.FRAMEBUFFER,null)}function z(t){return Math.min(f,t.samples)}function G(t){const n=s.get(t);return c&&t.samples>0&&!0===e.has("WEBGL_multisampled_render_to_texture")&&!1!==n.__useRenderToTexture}function H(t,n){const r=t.encoding,s=t.format,a=t.type;return!0===t.isCompressedTexture||!0===t.isVideoTexture||t.format===i.L_r||r!==i.rnI&&(r===i.knz?!1===c?!0===e.has("EXT_sRGB")&&s===i.wk1?(t.format=i.L_r,t.minFilter=i.wem,t.generateMipmaps=!1):n=rn.P.sRGBToLinear(n):s===i.wk1&&a===i.ywz||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture encoding:",r)),n}this.allocateTextureUnit=function(){const t=D;return t>=u&&console.warn("THREE.WebGLTextures: Trying to use "+t+" texture units while this GPU supports only "+u),D+=1,t},this.resetTextureUnits=function(){D=0},this.setTexture2D=L,this.setTexture2DArray=function(e,i){const r=s.get(e);e.version>0&&r.__version!==e.version?U(r,e,i):(n.activeTexture(t.TEXTURE0+i),n.bindTexture(t.TEXTURE_2D_ARRAY,r.__webglTexture))},this.setTexture3D=function(e,i){const r=s.get(e);e.version>0&&r.__version!==e.version?U(r,e,i):(n.activeTexture(t.TEXTURE0+i),n.bindTexture(t.TEXTURE_3D,r.__webglTexture))},this.setTextureCube=function(e,r){const a=s.get(e);e.version>0&&a.__version!==e.version?function(e,r,s){if(6!==r.image.length)return;const a=F(e,r),l=r.source;if(n.activeTexture(t.TEXTURE0+s),n.bindTexture(t.TEXTURE_CUBE_MAP,e.__webglTexture),l.version!==l.__currentVersion||!0===a){t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,r.unpackAlignment),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE);const s=r.isCompressedTexture||r.image[0].isCompressedTexture,a=r.image[0]&&r.image[0].isDataTexture,u=[];for(let t=0;t<6;t++)u[t]=s||a?a?r.image[t].image:r.image[t]:w(r.image[t],!1,!0,h),u[t]=H(r,u[t]);const d=u[0],f=b(d)||c,p=o.convert(r.format,r.encoding),m=o.convert(r.type),g=T(r.internalFormat,p,m,r.encoding),v=c&&!0!==r.isVideoTexture,y=void 0===e.__version;let _,x=M(r,d,f);if(O(t.TEXTURE_CUBE_MAP,r,f),s){v&&y&&n.texStorage2D(t.TEXTURE_CUBE_MAP,x,g,d.width,d.height);for(let e=0;e<6;e++){_=u[e].mipmaps;for(let s=0;s<_.length;s++){const a=_[s];r.format!==i.wk1?null!==p?v?n.compressedTexSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,s,0,0,a.width,a.height,p,a.data):n.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,s,g,a.width,a.height,0,a.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):v?n.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,s,0,0,a.width,a.height,p,m,a.data):n.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,s,g,a.width,a.height,0,p,m,a.data)}}}else{_=r.mipmaps,v&&y&&(_.length>0&&x++,n.texStorage2D(t.TEXTURE_CUBE_MAP,x,g,u[0].width,u[0].height));for(let e=0;e<6;e++)if(a){v?n.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,u[e].width,u[e].height,p,m,u[e].data):n.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,g,u[e].width,u[e].height,0,p,m,u[e].data);for(let i=0;i<_.length;i++){const r=_[i].image[e].image;v?n.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,i+1,0,0,r.width,r.height,p,m,r.data):n.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,i+1,g,r.width,r.height,0,p,m,r.data)}}else{v?n.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,0,0,p,m,u[e]):n.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,g,p,m,u[e]);for(let i=0;i<_.length;i++){const r=_[i];v?n.texSubImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,i+1,0,0,p,m,r.image[e]):n.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+e,i+1,g,p,m,r.image[e])}}}S(r,f)&&E(t.TEXTURE_CUBE_MAP),l.__currentVersion=l.version,r.onUpdate&&r.onUpdate(r)}e.__version=r.version}(a,e,r):(n.activeTexture(t.TEXTURE0+r),n.bindTexture(t.TEXTURE_CUBE_MAP,a.__webglTexture))},this.rebindTextures=function(e,n,i){const r=s.get(e);void 0!==n&&V(r.__webglFramebuffer,e,e.texture,t.COLOR_ATTACHMENT0,t.TEXTURE_2D),void 0!==i&&B(e)},this.setupRenderTarget=function(e){const i=e.texture,r=s.get(e),u=s.get(i);e.addEventListener("dispose",C),!0!==e.isWebGLMultipleRenderTargets&&(void 0===u.__webglTexture&&(u.__webglTexture=t.createTexture()),u.__version=i.version,l.memory.textures++);const h=!0===e.isWebGLCubeRenderTarget,d=!0===e.isWebGLMultipleRenderTargets,f=b(e)||c;if(h){r.__webglFramebuffer=[];for(let e=0;e<6;e++)r.__webglFramebuffer[e]=t.createFramebuffer()}else if(r.__webglFramebuffer=t.createFramebuffer(),d)if(a.drawBuffers){const n=e.texture;for(let e=0,i=n.length;e<i;e++){const i=s.get(n[e]);void 0===i.__webglTexture&&(i.__webglTexture=t.createTexture(),l.memory.textures++)}}else console.warn("THREE.WebGLRenderer: WebGLMultipleRenderTargets can only be used with WebGL2 or WEBGL_draw_buffers extension.");else if(c&&e.samples>0&&!1===G(e)){r.__webglMultisampledFramebuffer=t.createFramebuffer(),r.__webglColorRenderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(t.RENDERBUFFER,r.__webglColorRenderbuffer);const s=o.convert(i.format,i.encoding),a=o.convert(i.type),l=T(i.internalFormat,s,a,i.encoding),c=z(e);t.renderbufferStorageMultisample(t.RENDERBUFFER,c,l,e.width,e.height),n.bindFramebuffer(t.FRAMEBUFFER,r.__webglMultisampledFramebuffer),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.RENDERBUFFER,r.__webglColorRenderbuffer),t.bindRenderbuffer(t.RENDERBUFFER,null),e.depthBuffer&&(r.__webglDepthRenderbuffer=t.createRenderbuffer(),k(r.__webglDepthRenderbuffer,e,!0)),n.bindFramebuffer(t.FRAMEBUFFER,null)}if(h){n.bindTexture(t.TEXTURE_CUBE_MAP,u.__webglTexture),O(t.TEXTURE_CUBE_MAP,i,f);for(let n=0;n<6;n++)V(r.__webglFramebuffer[n],e,i,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+n);S(i,f)&&E(t.TEXTURE_CUBE_MAP),n.unbindTexture()}else if(d){const i=e.texture;for(let a=0,o=i.length;a<o;a++){const o=i[a],l=s.get(o);n.bindTexture(t.TEXTURE_2D,l.__webglTexture),O(t.TEXTURE_2D,o,f),V(r.__webglFramebuffer,e,o,t.COLOR_ATTACHMENT0+a,t.TEXTURE_2D),S(o,f)&&E(t.TEXTURE_2D)}n.unbindTexture()}else{let s=t.TEXTURE_2D;(e.isWebGL3DRenderTarget||e.isWebGLArrayRenderTarget)&&(c?s=e.isWebGL3DRenderTarget?t.TEXTURE_3D:t.TEXTURE_2D_ARRAY:console.error("THREE.WebGLTextures: THREE.Data3DTexture and THREE.DataArrayTexture only supported with WebGL2.")),n.bindTexture(s,u.__webglTexture),O(s,i,f),V(r.__webglFramebuffer,e,i,t.COLOR_ATTACHMENT0,s),S(i,f)&&E(s),n.unbindTexture()}e.depthBuffer&&B(e)},this.updateRenderTargetMipmap=function(e){const i=b(e)||c,r=!0===e.isWebGLMultipleRenderTargets?e.texture:[e.texture];for(let a=0,o=r.length;a<o;a++){const o=r[a];if(S(o,i)){const i=e.isWebGLCubeRenderTarget?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D,r=s.get(o).__webglTexture;n.bindTexture(i,r),E(i),n.unbindTexture()}}},this.updateMultisampleRenderTarget=function(e){if(c&&e.samples>0&&!1===G(e)){const i=e.width,r=e.height;let a=t.COLOR_BUFFER_BIT;const o=[t.COLOR_ATTACHMENT0],l=e.stencilBuffer?t.DEPTH_STENCIL_ATTACHMENT:t.DEPTH_ATTACHMENT;e.depthBuffer&&o.push(l);const c=s.get(e),u=void 0!==c.__ignoreDepthValues&&c.__ignoreDepthValues;!1===u&&(e.depthBuffer&&(a|=t.DEPTH_BUFFER_BIT),e.stencilBuffer&&(a|=t.STENCIL_BUFFER_BIT)),n.bindFramebuffer(t.READ_FRAMEBUFFER,c.__webglMultisampledFramebuffer),n.bindFramebuffer(t.DRAW_FRAMEBUFFER,c.__webglFramebuffer),!0===u&&(t.invalidateFramebuffer(t.READ_FRAMEBUFFER,[l]),t.invalidateFramebuffer(t.DRAW_FRAMEBUFFER,[l])),t.blitFramebuffer(0,0,i,r,0,0,i,r,a,t.NEAREST),m&&t.invalidateFramebuffer(t.READ_FRAMEBUFFER,o),n.bindFramebuffer(t.READ_FRAMEBUFFER,null),n.bindFramebuffer(t.DRAW_FRAMEBUFFER,c.__webglMultisampledFramebuffer)}},this.setupDepthRenderbuffer=B,this.setupFrameBufferTexture=V,this.useMultisampledRTT=G}function an(t,e,n){const r=n.isWebGL2;return{convert:function(n,s=null){let a;if(n===i.ywz)return t.UNSIGNED_BYTE;if(n===i.k0A)return t.UNSIGNED_SHORT_4_4_4_4;if(n===i.irR)return t.UNSIGNED_SHORT_5_5_5_1;if(n===i.T95)return t.BYTE;if(n===i.iAb)return t.SHORT;if(n===i.LsT)return t.UNSIGNED_SHORT;if(n===i.Kz5)return t.INT;if(n===i.JQ4)return t.UNSIGNED_INT;if(n===i.VzW)return t.FLOAT;if(n===i.cLu)return r?t.HALF_FLOAT:(a=e.get("OES_texture_half_float"),null!==a?a.HALF_FLOAT_OES:null);if(n===i.OTo)return t.ALPHA;if(n===i.wk1)return t.RGBA;if(n===i.Y8D)return t.LUMINANCE;if(n===i.cRx)return t.LUMINANCE_ALPHA;if(n===i.qkB)return t.DEPTH_COMPONENT;if(n===i.brP)return t.DEPTH_STENCIL;if(n===i.hEm)return t.RED;if(n===i.UCm)return console.warn("THREE.WebGLRenderer: THREE.RGBFormat has been removed. Use THREE.RGBAFormat instead. https://github.com/mrdoob/three.js/pull/23228"),t.RGBA;if(n===i.L_r)return a=e.get("EXT_sRGB"),null!==a?a.SRGB_ALPHA_EXT:null;if(n===i.D9w)return t.RED_INTEGER;if(n===i.av9)return t.RG;if(n===i.CtA)return t.RG_INTEGER;if(n===i.E2K)return t.RGBA_INTEGER;if(n===i.wuA||n===i.BFQ||n===i.v3W||n===i.ILR)if(s===i.knz){if(a=e.get("WEBGL_compressed_texture_s3tc_srgb"),null===a)return null;if(n===i.wuA)return a.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(n===i.BFQ)return a.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(n===i.v3W)return a.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(n===i.ILR)return a.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(a=e.get("WEBGL_compressed_texture_s3tc"),null===a)return null;if(n===i.wuA)return a.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===i.BFQ)return a.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===i.v3W)return a.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===i.ILR)return a.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(n===i._AM||n===i.vCx||n===i.eaV||n===i.CaW){if(a=e.get("WEBGL_compressed_texture_pvrtc"),null===a)return null;if(n===i._AM)return a.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(n===i.vCx)return a.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(n===i.eaV)return a.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(n===i.CaW)return a.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(n===i.fto)return a=e.get("WEBGL_compressed_texture_etc1"),null!==a?a.COMPRESSED_RGB_ETC1_WEBGL:null;if(n===i.l0P||n===i.ekQ){if(a=e.get("WEBGL_compressed_texture_etc"),null===a)return null;if(n===i.l0P)return s===i.knz?a.COMPRESSED_SRGB8_ETC2:a.COMPRESSED_RGB8_ETC2;if(n===i.ekQ)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:a.COMPRESSED_RGBA8_ETC2_EAC}if(n===i.ptH||n===i.jZA||n===i.y2t||n===i.gi4||n===i.Djp||n===i.BG$||n===i.NYV||n===i.xJs||n===i.pKu||n===i.GG6||n===i.Gih||n===i.FUD||n===i.iiP||n===i.SvJ){if(a=e.get("WEBGL_compressed_texture_astc"),null===a)return null;if(n===i.ptH)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:a.COMPRESSED_RGBA_ASTC_4x4_KHR;if(n===i.jZA)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:a.COMPRESSED_RGBA_ASTC_5x4_KHR;if(n===i.y2t)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:a.COMPRESSED_RGBA_ASTC_5x5_KHR;if(n===i.gi4)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:a.COMPRESSED_RGBA_ASTC_6x5_KHR;if(n===i.Djp)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:a.COMPRESSED_RGBA_ASTC_6x6_KHR;if(n===i.BG$)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:a.COMPRESSED_RGBA_ASTC_8x5_KHR;if(n===i.NYV)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:a.COMPRESSED_RGBA_ASTC_8x6_KHR;if(n===i.xJs)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:a.COMPRESSED_RGBA_ASTC_8x8_KHR;if(n===i.pKu)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:a.COMPRESSED_RGBA_ASTC_10x5_KHR;if(n===i.GG6)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:a.COMPRESSED_RGBA_ASTC_10x6_KHR;if(n===i.Gih)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:a.COMPRESSED_RGBA_ASTC_10x8_KHR;if(n===i.FUD)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:a.COMPRESSED_RGBA_ASTC_10x10_KHR;if(n===i.iiP)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:a.COMPRESSED_RGBA_ASTC_12x10_KHR;if(n===i.SvJ)return s===i.knz?a.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:a.COMPRESSED_RGBA_ASTC_12x12_KHR}if(n===i.bsb){if(a=e.get("EXT_texture_compression_bptc"),null===a)return null;if(n===i.bsb)return s===i.knz?a.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:a.COMPRESSED_RGBA_BPTC_UNORM_EXT}return n===i.wJv?r?t.UNSIGNED_INT_24_8:(a=e.get("WEBGL_depth_texture"),null!==a?a.UNSIGNED_INT_24_8_WEBGL:null):void 0!==t[n]?t[n]:null}}}class on extends P.PerspectiveCamera{constructor(t=[]){super(),this.cameras=t}}on.prototype.isArrayCamera=!0;var ln=n(2658);const cn={type:"move"};class un{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new ln.Group,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new ln.Group,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new l.Vector3,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new l.Vector3),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new ln.Group,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new l.Vector3,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new l.Vector3),this._grip}dispatchEvent(t){return null!==this._targetRay&&this._targetRay.dispatchEvent(t),null!==this._grip&&this._grip.dispatchEvent(t),null!==this._hand&&this._hand.dispatchEvent(t),this}disconnect(t){return this.dispatchEvent({type:"disconnected",data:t}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(t,e,n){let i=null,r=null,s=null;const a=this._targetRay,o=this._grip,l=this._hand;if(t&&"visible-blurred"!==e.session.visibilityState)if(null!==a&&(i=e.getPose(t.targetRaySpace,n),null!==i&&(a.matrix.fromArray(i.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),i.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(i.linearVelocity)):a.hasLinearVelocity=!1,i.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(i.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(cn))),l&&t.hand){s=!0;for(const i of t.hand.values()){const t=e.getJointPose(i,n);if(void 0===l.joints[i.jointName]){const t=new ln.Group;t.matrixAutoUpdate=!1,t.visible=!1,l.joints[i.jointName]=t,l.add(t)}const r=l.joints[i.jointName];null!==t&&(r.matrix.fromArray(t.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.jointRadius=t.radius),r.visible=null!==t}const i=l.joints["index-finger-tip"],r=l.joints["thumb-tip"],a=i.position.distanceTo(r.position),o=.02,c=.005;l.inputState.pinching&&a>o+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:t.handedness,target:this})):!l.inputState.pinching&&a<=o-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:t.handedness,target:this}))}else null!==o&&t.gripSpace&&(r=e.getPose(t.gripSpace,n),null!==r&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),r.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(r.linearVelocity)):o.hasLinearVelocity=!1,r.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(r.angularVelocity)):o.hasAngularVelocity=!1));return null!==a&&(a.visible=null!==i),null!==o&&(o.visible=null!==r),null!==l&&(l.visible=null!==s),this}}class hn extends C.x{constructor(t,e,n,r,s,a,o,l,c,u){if((u=void 0!==u?u:i.qkB)!==i.qkB&&u!==i.brP)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===n&&u===i.qkB&&(n=i.LsT),void 0===n&&u===i.brP&&(n=i.wJv),super(null,r,s,a,o,l,u,n,c),this.image={width:t,height:e},this.magFilter=void 0!==o?o:i.TyD,this.minFilter=void 0!==l?l:i.TyD,this.flipY=!1,this.generateMipmaps=!1}}hn.prototype.isDepthTexture=!0;class dn extends I.p{constructor(t,e){super();const n=this;let r=null,s=1,a=null,o="local-floor",h=null,d=null,f=null,p=null,m=null,g=null;const v=e.getContextAttributes();let y=null,_=null;const x=[],w=new Map,b=new P.PerspectiveCamera;b.layers.enable(1),b.viewport=new c.L;const S=new P.PerspectiveCamera;S.layers.enable(2),S.viewport=new c.L;const E=[b,S],T=new on;T.layers.enable(1),T.layers.enable(2);let M=null,A=null;function I(t){const e=w.get(t.inputSource);e&&e.dispatchEvent({type:t.type,data:t.inputSource})}function C(){w.forEach((function(t,e){t.disconnect(e)})),w.clear(),M=null,A=null,t.setRenderTarget(y),m=null,p=null,f=null,r=null,_=null,U.stop(),n.isPresenting=!1,n.dispatchEvent({type:"sessionend"})}function R(t){const e=r.inputSources;for(let t=0;t<e.length;t++){const n="right"===e[t].handedness?1:0;w.set(e[t],x[n])}for(let e=0;e<t.removed.length;e++){const n=t.removed[e],i=w.get(n);i&&(i.dispatchEvent({type:"disconnected",data:n}),w.delete(n))}for(let e=0;e<t.added.length;e++){const n=t.added[e],i=w.get(n);i&&i.dispatchEvent({type:"connected",data:n})}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(t){let e=x[t];return void 0===e&&(e=new un,x[t]=e),e.getTargetRaySpace()},this.getControllerGrip=function(t){let e=x[t];return void 0===e&&(e=new un,x[t]=e),e.getGripSpace()},this.getHand=function(t){let e=x[t];return void 0===e&&(e=new un,x[t]=e),e.getHandSpace()},this.setFramebufferScaleFactor=function(t){s=t,!0===n.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(t){o=t,!0===n.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return h||a},this.setReferenceSpace=function(t){h=t},this.getBaseLayer=function(){return null!==p?p:m},this.getBinding=function(){return f},this.getFrame=function(){return g},this.getSession=function(){return r},this.setSession=async function(l){if(r=l,null!==r){if(y=t.getRenderTarget(),r.addEventListener("select",I),r.addEventListener("selectstart",I),r.addEventListener("selectend",I),r.addEventListener("squeeze",I),r.addEventListener("squeezestart",I),r.addEventListener("squeezeend",I),r.addEventListener("end",C),r.addEventListener("inputsourceschange",R),!0!==v.xrCompatible&&await e.makeXRCompatible(),void 0===r.renderState.layers||!1===t.capabilities.isWebGL2){const n={antialias:void 0!==r.renderState.layers||v.antialias,alpha:v.alpha,depth:v.depth,stencil:v.stencil,framebufferScaleFactor:s};m=new XRWebGLLayer(r,e,n),r.updateRenderState({baseLayer:m}),_=new D(m.framebufferWidth,m.framebufferHeight,{format:i.wk1,type:i.ywz,encoding:t.outputEncoding})}else{let n=null,a=null,o=null;v.depth&&(o=v.stencil?e.DEPTH24_STENCIL8:e.DEPTH_COMPONENT24,n=v.stencil?i.brP:i.qkB,a=v.stencil?i.wJv:i.LsT);const l={colorFormat:t.outputEncoding===i.knz?e.SRGB8_ALPHA8:e.RGBA8,depthFormat:o,scaleFactor:s};f=new XRWebGLBinding(r,e),p=f.createProjectionLayer(l),r.updateRenderState({layers:[p]}),_=new D(p.textureWidth,p.textureHeight,{format:i.wk1,type:i.ywz,depthTexture:new hn(p.textureWidth,p.textureHeight,a,void 0,void 0,void 0,void 0,void 0,void 0,n),stencilBuffer:v.stencil,encoding:t.outputEncoding,samples:v.antialias?4:0}),t.properties.get(_).__ignoreDepthValues=p.ignoreDepthValues}_.isXRRenderTarget=!0,this.setFoveation(1),a=await r.requestReferenceSpace(o),U.setContext(r),U.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}};const L=new l.Vector3,N=new l.Vector3;function O(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.copy(t.matrixWorld).invert()}this.updateCamera=function(t){if(null===r)return;T.near=S.near=b.near=t.near,T.far=S.far=b.far=t.far,M===T.near&&A===T.far||(r.updateRenderState({depthNear:T.near,depthFar:T.far}),M=T.near,A=T.far);const e=t.parent,n=T.cameras;O(T,e);for(let t=0;t<n.length;t++)O(n[t],e);T.matrixWorld.decompose(T.position,T.quaternion,T.scale),t.position.copy(T.position),t.quaternion.copy(T.quaternion),t.scale.copy(T.scale),t.matrix.copy(T.matrix),t.matrixWorld.copy(T.matrixWorld);const i=t.children;for(let t=0,e=i.length;t<e;t++)i[t].updateMatrixWorld(!0);2===n.length?function(t,e,n){L.setFromMatrixPosition(e.matrixWorld),N.setFromMatrixPosition(n.matrixWorld);const i=L.distanceTo(N),r=e.projectionMatrix.elements,s=n.projectionMatrix.elements,a=r[14]/(r[10]-1),o=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],u=(r[8]-1)/r[0],h=(s[8]+1)/s[0],d=a*u,f=a*h,p=i/(-u+h),m=p*-u;e.matrixWorld.decompose(t.position,t.quaternion,t.scale),t.translateX(m),t.translateZ(p),t.matrixWorld.compose(t.position,t.quaternion,t.scale),t.matrixWorldInverse.copy(t.matrixWorld).invert();const g=a+p,v=o+p,y=d-m,_=f+(i-m),x=l*o/v*g,w=c*o/v*g;t.projectionMatrix.makePerspective(y,_,x,w,g,v)}(T,b,S):T.projectionMatrix.copy(b.projectionMatrix)},this.getCamera=function(){return T},this.getFoveation=function(){return null!==p?p.fixedFoveation:null!==m?m.fixedFoveation:void 0},this.setFoveation=function(t){null!==p&&(p.fixedFoveation=t),null!==m&&void 0!==m.fixedFoveation&&(m.fixedFoveation=t)};let F=null;const U=new u;U.setAnimationLoop((function(e,n){if(d=n.getViewerPose(h||a),g=n,null!==d){const e=d.views;null!==m&&(t.setRenderTargetFramebuffer(_,m.framebuffer),t.setRenderTarget(_));let n=!1;e.length!==T.cameras.length&&(T.cameras.length=0,n=!0);for(let i=0;i<e.length;i++){const r=e[i];let s=null;if(null!==m)s=m.getViewport(r);else{const e=f.getViewSubImage(p,r);s=e.viewport,0===i&&(t.setRenderTargetTextures(_,e.colorTexture,p.ignoreDepthValues?void 0:e.depthStencilTexture),t.setRenderTarget(_))}const a=E[i];a.matrix.fromArray(r.transform.matrix),a.projectionMatrix.fromArray(r.projectionMatrix),a.viewport.set(s.x,s.y,s.width,s.height),0===i&&T.matrix.copy(a.matrix),!0===n&&T.cameras.push(a)}}const i=r.inputSources;for(let t=0;t<x.length;t++){const e=i[t],r=w.get(e);void 0!==r&&r.update(e,n,h||a)}F&&F(e,n),g=null})),this.setAnimationLoop=function(t){F=t},this.dispose=function(){}}}function fn(t,e){function n(n,r){n.opacity.value=r.opacity,r.color&&n.diffuse.value.copy(r.color),r.emissive&&n.emissive.value.copy(r.emissive).multiplyScalar(r.emissiveIntensity),r.map&&(n.map.value=r.map),r.alphaMap&&(n.alphaMap.value=r.alphaMap),r.bumpMap&&(n.bumpMap.value=r.bumpMap,n.bumpScale.value=r.bumpScale,r.side===i._Li&&(n.bumpScale.value*=-1)),r.displacementMap&&(n.displacementMap.value=r.displacementMap,n.displacementScale.value=r.displacementScale,n.displacementBias.value=r.displacementBias),r.emissiveMap&&(n.emissiveMap.value=r.emissiveMap),r.normalMap&&(n.normalMap.value=r.normalMap,n.normalScale.value.copy(r.normalScale),r.side===i._Li&&n.normalScale.value.negate()),r.specularMap&&(n.specularMap.value=r.specularMap),r.alphaTest>0&&(n.alphaTest.value=r.alphaTest);const s=e.get(r).envMap;if(s&&(n.envMap.value=s,n.flipEnvMap.value=s.isCubeTexture&&!1===s.isRenderTargetTexture?-1:1,n.reflectivity.value=r.reflectivity,n.ior.value=r.ior,n.refractionRatio.value=r.refractionRatio),r.lightMap){n.lightMap.value=r.lightMap;const e=!0!==t.physicallyCorrectLights?Math.PI:1;n.lightMapIntensity.value=r.lightMapIntensity*e}let a,o;r.aoMap&&(n.aoMap.value=r.aoMap,n.aoMapIntensity.value=r.aoMapIntensity),r.map?a=r.map:r.specularMap?a=r.specularMap:r.displacementMap?a=r.displacementMap:r.normalMap?a=r.normalMap:r.bumpMap?a=r.bumpMap:r.roughnessMap?a=r.roughnessMap:r.metalnessMap?a=r.metalnessMap:r.alphaMap?a=r.alphaMap:r.emissiveMap?a=r.emissiveMap:r.clearcoatMap?a=r.clearcoatMap:r.clearcoatNormalMap?a=r.clearcoatNormalMap:r.clearcoatRoughnessMap?a=r.clearcoatRoughnessMap:r.specularIntensityMap?a=r.specularIntensityMap:r.specularColorMap?a=r.specularColorMap:r.transmissionMap?a=r.transmissionMap:r.thicknessMap?a=r.thicknessMap:r.sheenColorMap?a=r.sheenColorMap:r.sheenRoughnessMap&&(a=r.sheenRoughnessMap),void 0!==a&&(a.isWebGLRenderTarget&&(a=a.texture),!0===a.matrixAutoUpdate&&a.updateMatrix(),n.uvTransform.value.copy(a.matrix)),r.aoMap?o=r.aoMap:r.lightMap&&(o=r.lightMap),void 0!==o&&(o.isWebGLRenderTarget&&(o=o.texture),!0===o.matrixAutoUpdate&&o.updateMatrix(),n.uv2Transform.value.copy(o.matrix))}return{refreshFogUniforms:function(t,e){t.fogColor.value.copy(e.color),e.isFog?(t.fogNear.value=e.near,t.fogFar.value=e.far):e.isFogExp2&&(t.fogDensity.value=e.density)},refreshMaterialUniforms:function(t,r,s,a,o){r.isMeshBasicMaterial||r.isMeshLambertMaterial?n(t,r):r.isMeshToonMaterial?(n(t,r),function(t,e){e.gradientMap&&(t.gradientMap.value=e.gradientMap)}(t,r)):r.isMeshPhongMaterial?(n(t,r),function(t,e){t.specular.value.copy(e.specular),t.shininess.value=Math.max(e.shininess,1e-4)}(t,r)):r.isMeshStandardMaterial?(n(t,r),function(t,n){t.roughness.value=n.roughness,t.metalness.value=n.metalness,n.roughnessMap&&(t.roughnessMap.value=n.roughnessMap),n.metalnessMap&&(t.metalnessMap.value=n.metalnessMap),e.get(n).envMap&&(t.envMapIntensity.value=n.envMapIntensity)}(t,r),r.isMeshPhysicalMaterial&&function(t,e,n){t.ior.value=e.ior,e.sheen>0&&(t.sheenColor.value.copy(e.sheenColor).multiplyScalar(e.sheen),t.sheenRoughness.value=e.sheenRoughness,e.sheenColorMap&&(t.sheenColorMap.value=e.sheenColorMap),e.sheenRoughnessMap&&(t.sheenRoughnessMap.value=e.sheenRoughnessMap)),e.clearcoat>0&&(t.clearcoat.value=e.clearcoat,t.clearcoatRoughness.value=e.clearcoatRoughness,e.clearcoatMap&&(t.clearcoatMap.value=e.clearcoatMap),e.clearcoatRoughnessMap&&(t.clearcoatRoughnessMap.value=e.clearcoatRoughnessMap),e.clearcoatNormalMap&&(t.clearcoatNormalScale.value.copy(e.clearcoatNormalScale),t.clearcoatNormalMap.value=e.clearcoatNormalMap,e.side===i._Li&&t.clearcoatNormalScale.value.negate())),e.transmission>0&&(t.transmission.value=e.transmission,t.transmissionSamplerMap.value=n.texture,t.transmissionSamplerSize.value.set(n.width,n.height),e.transmissionMap&&(t.transmissionMap.value=e.transmissionMap),t.thickness.value=e.thickness,e.thicknessMap&&(t.thicknessMap.value=e.thicknessMap),t.attenuationDistance.value=e.attenuationDistance,t.attenuationColor.value.copy(e.attenuationColor)),t.specularIntensity.value=e.specularIntensity,t.specularColor.value.copy(e.specularColor),e.specularIntensityMap&&(t.specularIntensityMap.value=e.specularIntensityMap),e.specularColorMap&&(t.specularColorMap.value=e.specularColorMap)}(t,r,o)):r.isMeshMatcapMaterial?(n(t,r),function(t,e){e.matcap&&(t.matcap.value=e.matcap)}(t,r)):r.isMeshDepthMaterial?n(t,r):r.isMeshDistanceMaterial?(n(t,r),function(t,e){t.referencePosition.value.copy(e.referencePosition),t.nearDistance.value=e.nearDistance,t.farDistance.value=e.farDistance}(t,r)):r.isMeshNormalMaterial?n(t,r):r.isLineBasicMaterial?(function(t,e){t.diffuse.value.copy(e.color),t.opacity.value=e.opacity}(t,r),r.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(t,r)):r.isPointsMaterial?function(t,e,n,i){let r;t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.size.value=e.size*n,t.scale.value=.5*i,e.map&&(t.map.value=e.map),e.alphaMap&&(t.alphaMap.value=e.alphaMap),e.alphaTest>0&&(t.alphaTest.value=e.alphaTest),e.map?r=e.map:e.alphaMap&&(r=e.alphaMap),void 0!==r&&(!0===r.matrixAutoUpdate&&r.updateMatrix(),t.uvTransform.value.copy(r.matrix))}(t,r,s,a):r.isSpriteMaterial?function(t,e){let n;t.diffuse.value.copy(e.color),t.opacity.value=e.opacity,t.rotation.value=e.rotation,e.map&&(t.map.value=e.map),e.alphaMap&&(t.alphaMap.value=e.alphaMap),e.alphaTest>0&&(t.alphaTest.value=e.alphaTest),e.map?n=e.map:e.alphaMap&&(n=e.alphaMap),void 0!==n&&(!0===n.matrixAutoUpdate&&n.updateMatrix(),t.uvTransform.value.copy(n.matrix))}(t,r):r.isShadowMaterial?(t.color.value.copy(r.color),t.opacity.value=r.opacity):r.isShaderMaterial&&(r.uniformsNeedUpdate=!1)}}}function pn(t={}){const e=void 0!==t.canvas?t.canvas:function(){const t=(0,it.c)("canvas");return t.style.display="block",t}(),n=void 0!==t.context?t.context:null,d=void 0===t.depth||t.depth,f=void 0===t.stencil||t.stencil,p=void 0!==t.antialias&&t.antialias,m=void 0===t.premultipliedAlpha||t.premultipliedAlpha,g=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,v=void 0!==t.powerPreference?t.powerPreference:"default",y=void 0!==t.failIfMajorPerformanceCaveat&&t.failIfMajorPerformanceCaveat;let _;_=null!==n?n.getContextAttributes().alpha:void 0!==t.alpha&&t.alpha;let x=null,w=null;const M=[],I=[];this.domElement=e,this.debug={checkShaderErrors:!0},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.outputEncoding=i.rnI,this.physicallyCorrectLights=!1,this.toneMapping=i.uL9,this.toneMappingExposure=1;const C=this;let R=!1,L=0,P=0,N=null,O=-1,F=null;const U=new c.L,k=new c.L;let B=null,z=e.width,G=e.height,H=1,W=null,q=null;const j=new c.L(0,0,z,G),X=new c.L(0,0,z,G);let K=!1;const $=new s.i;let Y=!1,Q=!1,J=null;const Z=new a.Matrix4,tt=new o.Vector2,ot=new l.Vector3,lt={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};function ct(){return null===N?H:1}let ut,ft,pt,mt,gt,vt,yt,_t,xt,wt,bt,St,Et,Tt,Mt,At,It,Ct,Rt,Dt,Lt,Pt,Nt,Ot=n;function Ft(t,n){for(let i=0;i<t.length;i++){const r=t[i],s=e.getContext(r,n);if(null!==s)return s}return null}try{const t={alpha:!0,depth:d,stencil:f,antialias:p,premultipliedAlpha:m,preserveDrawingBuffer:g,powerPreference:v,failIfMajorPerformanceCaveat:y};if("setAttribute"in e&&e.setAttribute("data-engine",`three.js r${i.UZH}`),e.addEventListener("webglcontextlost",kt,!1),e.addEventListener("webglcontextrestored",Bt,!1),null===Ot){const e=["webgl2","webgl","experimental-webgl"];if(!0===C.isWebGL1Renderer&&e.shift(),Ot=Ft(e,t),null===Ot)throw Ft(e)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}void 0===Ot.getShaderPrecisionFormat&&(Ot.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){throw console.error("THREE.WebGLRenderer: "+t.message),t}function Ut(){ut=new nt(Ot),ft=new T(Ot,ut,t),ut.init(ft),Pt=new an(Ot,ut,ft),pt=new nn(Ot,ut,ft),mt=new at(Ot),gt=new ze,vt=new sn(Ot,ut,pt,gt,ft,Pt,mt),yt=new V(C),_t=new et(C),xt=new h(Ot,ft),Nt=new S(Ot,ut,xt,ft),wt=new rt(Ot,xt,mt,Nt),bt=new dt(Ot,wt,xt,mt),Rt=new ht(Ot,ft,vt),At=new A(gt),St=new Be(C,yt,_t,ut,ft,Nt,At),Et=new fn(C,gt),Tt=new qe,Mt=new Qe(ut,ft),Ct=new b(C,yt,pt,bt,_,m),It=new en(C,bt,ft),Dt=new E(Ot,ut,mt,ft),Lt=new st(Ot,ut,mt,ft),mt.programs=St.programs,C.capabilities=ft,C.extensions=ut,C.properties=gt,C.renderLists=Tt,C.shadowMap=It,C.state=pt,C.info=mt}Ut();const Vt=new dn(C,Ot);function kt(t){t.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),R=!0}function Bt(){console.log("THREE.WebGLRenderer: Context Restored."),R=!1;const t=mt.autoReset,e=It.enabled,n=It.autoUpdate,i=It.needsUpdate,r=It.type;Ut(),mt.autoReset=t,It.enabled=e,It.autoUpdate=n,It.needsUpdate=i,It.type=r}function zt(t){const e=t.target;e.removeEventListener("dispose",zt),function(t){(function(t){const e=gt.get(t).programs;void 0!==e&&(e.forEach((function(t){St.releaseProgram(t)})),t.isShaderMaterial&&St.releaseShaderCache(t))})(t),gt.remove(t)}(e)}this.xr=Vt,this.getContext=function(){return Ot},this.getContextAttributes=function(){return Ot.getContextAttributes()},this.forceContextLoss=function(){const t=ut.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){const t=ut.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return H},this.setPixelRatio=function(t){void 0!==t&&(H=t,this.setSize(z,G,!1))},this.getSize=function(t){return t.set(z,G)},this.setSize=function(t,n,i){Vt.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(z=t,G=n,e.width=Math.floor(t*H),e.height=Math.floor(n*H),!1!==i&&(e.style.width=t+"px",e.style.height=n+"px"),this.setViewport(0,0,t,n))},this.getDrawingBufferSize=function(t){return t.set(z*H,G*H).floor()},this.setDrawingBufferSize=function(t,n,i){z=t,G=n,H=i,e.width=Math.floor(t*i),e.height=Math.floor(n*i),this.setViewport(0,0,t,n)},this.getCurrentViewport=function(t){return t.copy(U)},this.getViewport=function(t){return t.copy(j)},this.setViewport=function(t,e,n,i){t.isVector4?j.set(t.x,t.y,t.z,t.w):j.set(t,e,n,i),pt.viewport(U.copy(j).multiplyScalar(H).floor())},this.getScissor=function(t){return t.copy(X)},this.setScissor=function(t,e,n,i){t.isVector4?X.set(t.x,t.y,t.z,t.w):X.set(t,e,n,i),pt.scissor(k.copy(X).multiplyScalar(H).floor())},this.getScissorTest=function(){return K},this.setScissorTest=function(t){pt.setScissorTest(K=t)},this.setOpaqueSort=function(t){W=t},this.setTransparentSort=function(t){q=t},this.getClearColor=function(t){return t.copy(Ct.getClearColor())},this.setClearColor=function(){Ct.setClearColor.apply(Ct,arguments)},this.getClearAlpha=function(){return Ct.getClearAlpha()},this.setClearAlpha=function(){Ct.setClearAlpha.apply(Ct,arguments)},this.clear=function(t=!0,e=!0,n=!0){let i=0;t&&(i|=Ot.COLOR_BUFFER_BIT),e&&(i|=Ot.DEPTH_BUFFER_BIT),n&&(i|=Ot.STENCIL_BUFFER_BIT),Ot.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){e.removeEventListener("webglcontextlost",kt,!1),e.removeEventListener("webglcontextrestored",Bt,!1),Tt.dispose(),Mt.dispose(),gt.dispose(),yt.dispose(),_t.dispose(),bt.dispose(),Nt.dispose(),St.dispose(),Vt.dispose(),Vt.removeEventListener("sessionstart",Ht),Vt.removeEventListener("sessionend",Wt),J&&(J.dispose(),J=null),qt.stop()},this.renderBufferDirect=function(t,e,n,r,s,a){null===e&&(e=lt);const o=s.isMesh&&s.matrixWorld.determinant()<0,l=function(t,e,n,r,s){!0!==e.isScene&&(e=lt),vt.resetTextureUnits();const a=e.fog,o=r.isMeshStandardMaterial?e.environment:null,l=null===N?C.outputEncoding:!0===N.isXRRenderTarget?N.texture.encoding:i.rnI,c=(r.isMeshStandardMaterial?_t:yt).get(r.envMap||o),u=!0===r.vertexColors&&!!n.attributes.color&&4===n.attributes.color.itemSize,h=!!r.normalMap&&!!n.attributes.tangent,d=!!n.morphAttributes.position,f=!!n.morphAttributes.normal,p=!!n.morphAttributes.color,m=r.toneMapped?C.toneMapping:i.uL9,g=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,v=void 0!==g?g.length:0,y=gt.get(r),_=w.state.lights;if(!0===Y&&(!0===Q||t!==F)){const e=t===F&&r.id===O;At.setState(r,t,e)}let x=!1;r.version===y.__version?y.needsLights&&y.lightsStateVersion!==_.state.version||y.outputEncoding!==l||s.isInstancedMesh&&!1===y.instancing?x=!0:s.isInstancedMesh||!0!==y.instancing?s.isSkinnedMesh&&!1===y.skinning?x=!0:s.isSkinnedMesh||!0!==y.skinning?y.envMap!==c||!0===r.fog&&y.fog!==a?x=!0:void 0===y.numClippingPlanes||y.numClippingPlanes===At.numPlanes&&y.numIntersection===At.numIntersection?(y.vertexAlphas!==u||y.vertexTangents!==h||y.morphTargets!==d||y.morphNormals!==f||y.morphColors!==p||y.toneMapping!==m||!0===ft.isWebGL2&&y.morphTargetsCount!==v)&&(x=!0):x=!0:x=!0:x=!0:(x=!0,y.__version=r.version);let b=y.currentProgram;!0===x&&(b=Yt(r,e,s));let S=!1,E=!1,T=!1;const M=b.getUniforms(),A=y.uniforms;if(pt.useProgram(b.program)&&(S=!0,E=!0,T=!0),r.id!==O&&(O=r.id,E=!0),S||F!==t){if(M.setValue(Ot,"projectionMatrix",t.projectionMatrix),ft.logarithmicDepthBuffer&&M.setValue(Ot,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),F!==t&&(F=t,E=!0,T=!0),r.isShaderMaterial||r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshStandardMaterial||r.envMap){const e=M.map.cameraPosition;void 0!==e&&e.setValue(Ot,ot.setFromMatrixPosition(t.matrixWorld))}(r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial)&&M.setValue(Ot,"isOrthographic",!0===t.isOrthographicCamera),(r.isMeshPhongMaterial||r.isMeshToonMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial||r.isShadowMaterial||s.isSkinnedMesh)&&M.setValue(Ot,"viewMatrix",t.matrixWorldInverse)}if(s.isSkinnedMesh){M.setOptional(Ot,s,"bindMatrix"),M.setOptional(Ot,s,"bindMatrixInverse");const t=s.skeleton;t&&(ft.floatVertexTextures?(null===t.boneTexture&&t.computeBoneTexture(),M.setValue(Ot,"boneTexture",t.boneTexture,vt),M.setValue(Ot,"boneTextureSize",t.boneTextureSize)):console.warn("THREE.WebGLRenderer: SkinnedMesh can only be used with WebGL 2. With WebGL 1 OES_texture_float and vertex textures support is required."))}const I=n.morphAttributes;var R,D;return(void 0!==I.position||void 0!==I.normal||void 0!==I.color&&!0===ft.isWebGL2)&&Rt.update(s,n,r,b),(E||y.receiveShadow!==s.receiveShadow)&&(y.receiveShadow=s.receiveShadow,M.setValue(Ot,"receiveShadow",s.receiveShadow)),E&&(M.setValue(Ot,"toneMappingExposure",C.toneMappingExposure),y.needsLights&&(D=T,(R=A).ambientLightColor.needsUpdate=D,R.lightProbe.needsUpdate=D,R.directionalLights.needsUpdate=D,R.directionalLightShadows.needsUpdate=D,R.pointLights.needsUpdate=D,R.pointLightShadows.needsUpdate=D,R.spotLights.needsUpdate=D,R.spotLightShadows.needsUpdate=D,R.rectAreaLights.needsUpdate=D,R.hemisphereLights.needsUpdate=D),a&&!0===r.fog&&Et.refreshFogUniforms(A,a),Et.refreshMaterialUniforms(A,r,H,G,J),ye.upload(Ot,y.uniformsList,A,vt)),r.isShaderMaterial&&!0===r.uniformsNeedUpdate&&(ye.upload(Ot,y.uniformsList,A,vt),r.uniformsNeedUpdate=!1),r.isSpriteMaterial&&M.setValue(Ot,"center",s.center),M.setValue(Ot,"modelViewMatrix",s.modelViewMatrix),M.setValue(Ot,"normalMatrix",s.normalMatrix),M.setValue(Ot,"modelMatrix",s.matrixWorld),b}(t,e,n,r,s);pt.setMaterial(r,o);let c=n.index;const u=n.attributes.position;if(null===c){if(void 0===u||0===u.count)return}else if(0===c.count)return;let h,d=1;!0===r.wireframe&&(c=wt.getWireframeAttribute(n),d=2),Nt.setup(s,r,l,n,c);let f=Dt;null!==c&&(h=xt.get(c),f=Lt,f.setIndex(h));const p=null!==c?c.count:u.count,m=n.drawRange.start*d,g=n.drawRange.count*d,v=null!==a?a.start*d:0,y=null!==a?a.count*d:1/0,_=Math.max(m,v),x=Math.min(p,m+g,v+y)-1,b=Math.max(0,x-_+1);if(0!==b){if(s.isMesh)!0===r.wireframe?(pt.setLineWidth(r.wireframeLinewidth*ct()),f.setMode(Ot.LINES)):f.setMode(Ot.TRIANGLES);else if(s.isLine){let t=r.linewidth;void 0===t&&(t=1),pt.setLineWidth(t*ct()),s.isLineSegments?f.setMode(Ot.LINES):s.isLineLoop?f.setMode(Ot.LINE_LOOP):f.setMode(Ot.LINE_STRIP)}else s.isPoints?f.setMode(Ot.POINTS):s.isSprite&&f.setMode(Ot.TRIANGLES);if(s.isInstancedMesh)f.renderInstances(_,b,s.count);else if(n.isInstancedBufferGeometry){const t=Math.min(n.instanceCount,n._maxInstanceCount);f.renderInstances(_,b,t)}else f.render(_,b)}},this.compile=function(t,e){w=Mt.get(t),w.init(),I.push(w),t.traverseVisible((function(t){t.isLight&&t.layers.test(e.layers)&&(w.pushLight(t),t.castShadow&&w.pushShadow(t))})),w.setupLights(C.physicallyCorrectLights),t.traverse((function(e){const n=e.material;if(n)if(Array.isArray(n))for(let i=0;i<n.length;i++)Yt(n[i],t,e);else Yt(n,t,e)})),I.pop(),w=null};let Gt=null;function Ht(){qt.stop()}function Wt(){qt.start()}const qt=new u;function jt(t,e,n,i){if(!1===t.visible)return;if(t.layers.test(e.layers))if(t.isGroup)n=t.renderOrder;else if(t.isLOD)!0===t.autoUpdate&&t.update(e);else if(t.isLight)w.pushLight(t),t.castShadow&&w.pushShadow(t);else if(t.isSprite){if(!t.frustumCulled||$.intersectsSprite(t)){i&&ot.setFromMatrixPosition(t.matrixWorld).applyMatrix4(Z);const e=bt.update(t),r=t.material;r.visible&&x.push(t,e,r,n,ot.z,null)}}else if((t.isMesh||t.isLine||t.isPoints)&&(t.isSkinnedMesh&&t.skeleton.frame!==mt.render.frame&&(t.skeleton.update(),t.skeleton.frame=mt.render.frame),!t.frustumCulled||$.intersectsObject(t))){i&&ot.setFromMatrixPosition(t.matrixWorld).applyMatrix4(Z);const e=bt.update(t),r=t.material;if(Array.isArray(r)){const i=e.groups;for(let s=0,a=i.length;s<a;s++){const a=i[s],o=r[a.materialIndex];o&&o.visible&&x.push(t,e,o,n,ot.z,a)}}else r.visible&&x.push(t,e,r,n,ot.z,null)}const r=t.children;for(let t=0,s=r.length;t<s;t++)jt(r[t],e,n,i)}function Xt(t,e,n,s){const a=t.opaque,o=t.transmissive,l=t.transparent;w.setupLightsView(n),o.length>0&&function(t,e,n){const s=ft.isWebGL2;null===J&&(J=new D(1,1,{generateMipmaps:!0,type:ut.has("EXT_color_buffer_half_float")?i.cLu:i.ywz,minFilter:i.D1R,samples:s&&!0===p?4:0})),C.getDrawingBufferSize(tt),s?J.setSize(tt.x,tt.y):J.setSize((0,r.gy)(tt.x),(0,r.gy)(tt.y));const a=C.getRenderTarget();C.setRenderTarget(J),C.clear();const o=C.toneMapping;C.toneMapping=i.uL9,Kt(t,e,n),C.toneMapping=o,vt.updateMultisampleRenderTarget(J),vt.updateRenderTargetMipmap(J),C.setRenderTarget(a)}(a,e,n),s&&pt.viewport(U.copy(s)),a.length>0&&Kt(a,e,n),o.length>0&&Kt(o,e,n),l.length>0&&Kt(l,e,n),pt.buffers.depth.setTest(!0),pt.buffers.depth.setMask(!0),pt.buffers.color.setMask(!0),pt.setPolygonOffset(!1)}function Kt(t,e,n){const i=!0===e.isScene?e.overrideMaterial:null;for(let r=0,s=t.length;r<s;r++){const s=t[r],a=s.object,o=s.geometry,l=null===i?s.material:i,c=s.group;a.layers.test(n.layers)&&$t(a,e,n,o,l,c)}}function $t(t,e,n,r,s,a){t.onBeforeRender(C,e,n,r,s,a),t.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),s.onBeforeRender(C,e,n,r,t,a),!0===s.transparent&&s.side===i.ehD?(s.side=i._Li,s.needsUpdate=!0,C.renderBufferDirect(n,e,r,s,t,a),s.side=i.Wl3,s.needsUpdate=!0,C.renderBufferDirect(n,e,r,s,t,a),s.side=i.ehD):C.renderBufferDirect(n,e,r,s,t,a),t.onAfterRender(C,e,n,r,s,a)}function Yt(t,e,n){!0!==e.isScene&&(e=lt);const i=gt.get(t),r=w.state.lights,s=w.state.shadowsArray,a=r.state.version,o=St.getParameters(t,r.state,s,e,n),l=St.getProgramCacheKey(o);let c=i.programs;i.environment=t.isMeshStandardMaterial?e.environment:null,i.fog=e.fog,i.envMap=(t.isMeshStandardMaterial?_t:yt).get(t.envMap||i.environment),void 0===c&&(t.addEventListener("dispose",zt),c=new Map,i.programs=c);let u=c.get(l);if(void 0!==u){if(i.currentProgram===u&&i.lightsStateVersion===a)return Qt(t,o),u}else o.uniforms=St.getUniforms(t),t.onBuild(n,o,C),t.onBeforeCompile(o,C),u=St.acquireProgram(o,l),c.set(l,u),i.uniforms=o.uniforms;const h=i.uniforms;(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(h.clippingPlanes=At.uniform),Qt(t,o),i.needsLights=function(t){return t.isMeshLambertMaterial||t.isMeshToonMaterial||t.isMeshPhongMaterial||t.isMeshStandardMaterial||t.isShadowMaterial||t.isShaderMaterial&&!0===t.lights}(t),i.lightsStateVersion=a,i.needsLights&&(h.ambientLightColor.value=r.state.ambient,h.lightProbe.value=r.state.probe,h.directionalLights.value=r.state.directional,h.directionalLightShadows.value=r.state.directionalShadow,h.spotLights.value=r.state.spot,h.spotLightShadows.value=r.state.spotShadow,h.rectAreaLights.value=r.state.rectArea,h.ltc_1.value=r.state.rectAreaLTC1,h.ltc_2.value=r.state.rectAreaLTC2,h.pointLights.value=r.state.point,h.pointLightShadows.value=r.state.pointShadow,h.hemisphereLights.value=r.state.hemi,h.directionalShadowMap.value=r.state.directionalShadowMap,h.directionalShadowMatrix.value=r.state.directionalShadowMatrix,h.spotShadowMap.value=r.state.spotShadowMap,h.spotShadowMatrix.value=r.state.spotShadowMatrix,h.pointShadowMap.value=r.state.pointShadowMap,h.pointShadowMatrix.value=r.state.pointShadowMatrix);const d=u.getUniforms(),f=ye.seqWithValue(d.seq,h);return i.currentProgram=u,i.uniformsList=f,u}function Qt(t,e){const n=gt.get(t);n.outputEncoding=e.outputEncoding,n.instancing=e.instancing,n.skinning=e.skinning,n.morphTargets=e.morphTargets,n.morphNormals=e.morphNormals,n.morphColors=e.morphColors,n.morphTargetsCount=e.morphTargetsCount,n.numClippingPlanes=e.numClippingPlanes,n.numIntersection=e.numClipIntersection,n.vertexAlphas=e.vertexAlphas,n.vertexTangents=e.vertexTangents,n.toneMapping=e.toneMapping}qt.setAnimationLoop((function(t){Gt&&Gt(t)})),"undefined"!=typeof self&&qt.setContext(self),this.setAnimationLoop=function(t){Gt=t,Vt.setAnimationLoop(t),null===t?qt.stop():qt.start()},Vt.addEventListener("sessionstart",Ht),Vt.addEventListener("sessionend",Wt),this.render=function(t,e){if(void 0!==e&&!0!==e.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===R)return;!0===t.autoUpdate&&t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld(),!0===Vt.enabled&&!0===Vt.isPresenting&&(!0===Vt.cameraAutoUpdate&&Vt.updateCamera(e),e=Vt.getCamera()),!0===t.isScene&&t.onBeforeRender(C,t,e,N),w=Mt.get(t,I.length),w.init(),I.push(w),Z.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),$.setFromProjectionMatrix(Z),Q=this.localClippingEnabled,Y=At.init(this.clippingPlanes,Q,e),x=Tt.get(t,M.length),x.init(),M.push(x),jt(t,e,0,C.sortObjects),x.finish(),!0===C.sortObjects&&x.sort(W,q),!0===Y&&At.beginShadows();const n=w.state.shadowsArray;if(It.render(n,t,e),!0===Y&&At.endShadows(),!0===this.info.autoReset&&this.info.reset(),Ct.render(x,t),w.setupLights(C.physicallyCorrectLights),e.isArrayCamera){const n=e.cameras;for(let e=0,i=n.length;e<i;e++){const i=n[e];Xt(x,t,i,i.viewport)}}else Xt(x,t,e);null!==N&&(vt.updateMultisampleRenderTarget(N),vt.updateRenderTargetMipmap(N)),!0===t.isScene&&t.onAfterRender(C,t,e),Nt.resetDefaultState(),O=-1,F=null,I.pop(),w=I.length>0?I[I.length-1]:null,M.pop(),x=M.length>0?M[M.length-1]:null},this.getActiveCubeFace=function(){return L},this.getActiveMipmapLevel=function(){return P},this.getRenderTarget=function(){return N},this.setRenderTargetTextures=function(t,e,n){gt.get(t.texture).__webglTexture=e,gt.get(t.depthTexture).__webglTexture=n;const i=gt.get(t);i.__hasExternalTextures=!0,i.__hasExternalTextures&&(i.__autoAllocateDepthBuffer=void 0===n,i.__autoAllocateDepthBuffer||!0===ut.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),i.__useRenderToTexture=!1))},this.setRenderTargetFramebuffer=function(t,e){const n=gt.get(t);n.__webglFramebuffer=e,n.__useDefaultFramebuffer=void 0===e},this.setRenderTarget=function(t,e=0,n=0){N=t,L=e,P=n;let i=!0;if(t){const e=gt.get(t);void 0!==e.__useDefaultFramebuffer?(pt.bindFramebuffer(Ot.FRAMEBUFFER,null),i=!1):void 0===e.__webglFramebuffer?vt.setupRenderTarget(t):e.__hasExternalTextures&&vt.rebindTextures(t,gt.get(t.texture).__webglTexture,gt.get(t.depthTexture).__webglTexture)}let r=null,s=!1,a=!1;if(t){const n=t.texture;(n.isData3DTexture||n.isDataArrayTexture)&&(a=!0);const i=gt.get(t).__webglFramebuffer;t.isWebGLCubeRenderTarget?(r=i[e],s=!0):r=ft.isWebGL2&&t.samples>0&&!1===vt.useMultisampledRTT(t)?gt.get(t).__webglMultisampledFramebuffer:i,U.copy(t.viewport),k.copy(t.scissor),B=t.scissorTest}else U.copy(j).multiplyScalar(H).floor(),k.copy(X).multiplyScalar(H).floor(),B=K;if(pt.bindFramebuffer(Ot.FRAMEBUFFER,r)&&ft.drawBuffers&&i&&pt.drawBuffers(t,r),pt.viewport(U),pt.scissor(k),pt.setScissorTest(B),s){const i=gt.get(t.texture);Ot.framebufferTexture2D(Ot.FRAMEBUFFER,Ot.COLOR_ATTACHMENT0,Ot.TEXTURE_CUBE_MAP_POSITIVE_X+e,i.__webglTexture,n)}else if(a){const i=gt.get(t.texture),r=e||0;Ot.framebufferTextureLayer(Ot.FRAMEBUFFER,Ot.COLOR_ATTACHMENT0,i.__webglTexture,n||0,r)}O=-1},this.readRenderTargetPixels=function(t,e,n,r,s,a,o){if(!t||!t.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let l=gt.get(t).__webglFramebuffer;if(t.isWebGLCubeRenderTarget&&void 0!==o&&(l=l[o]),l){pt.bindFramebuffer(Ot.FRAMEBUFFER,l);try{const o=t.texture,l=o.format,c=o.type;if(l!==i.wk1&&Pt.convert(l)!==Ot.getParameter(Ot.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");const u=c===i.cLu&&(ut.has("EXT_color_buffer_half_float")||ft.isWebGL2&&ut.has("EXT_color_buffer_float"));if(!(c===i.ywz||Pt.convert(c)===Ot.getParameter(Ot.IMPLEMENTATION_COLOR_READ_TYPE)||c===i.VzW&&(ft.isWebGL2||ut.has("OES_texture_float")||ut.has("WEBGL_color_buffer_float"))||u))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");e>=0&&e<=t.width-r&&n>=0&&n<=t.height-s&&Ot.readPixels(e,n,r,s,Pt.convert(l),Pt.convert(c),a)}finally{const t=null!==N?gt.get(N).__webglFramebuffer:null;pt.bindFramebuffer(Ot.FRAMEBUFFER,t)}}},this.copyFramebufferToTexture=function(t,e,n=0){if(!0!==e.isFramebufferTexture)return void console.error("THREE.WebGLRenderer: copyFramebufferToTexture() can only be used with FramebufferTexture.");const i=Math.pow(2,-n),r=Math.floor(e.image.width*i),s=Math.floor(e.image.height*i);vt.setTexture2D(e,0),Ot.copyTexSubImage2D(Ot.TEXTURE_2D,n,0,0,t.x,t.y,r,s),pt.unbindTexture()},this.copyTextureToTexture=function(t,e,n,i=0){const r=e.image.width,s=e.image.height,a=Pt.convert(n.format),o=Pt.convert(n.type);vt.setTexture2D(n,0),Ot.pixelStorei(Ot.UNPACK_FLIP_Y_WEBGL,n.flipY),Ot.pixelStorei(Ot.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),Ot.pixelStorei(Ot.UNPACK_ALIGNMENT,n.unpackAlignment),e.isDataTexture?Ot.texSubImage2D(Ot.TEXTURE_2D,i,t.x,t.y,r,s,a,o,e.image.data):e.isCompressedTexture?Ot.compressedTexSubImage2D(Ot.TEXTURE_2D,i,t.x,t.y,e.mipmaps[0].width,e.mipmaps[0].height,a,e.mipmaps[0].data):Ot.texSubImage2D(Ot.TEXTURE_2D,i,t.x,t.y,a,o,e.image),0===i&&n.generateMipmaps&&Ot.generateMipmap(Ot.TEXTURE_2D),pt.unbindTexture()},this.copyTextureToTexture3D=function(t,e,n,i,r=0){if(C.isWebGL1Renderer)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: can only be used with WebGL2.");const s=t.max.x-t.min.x+1,a=t.max.y-t.min.y+1,o=t.max.z-t.min.z+1,l=Pt.convert(i.format),c=Pt.convert(i.type);let u;if(i.isData3DTexture)vt.setTexture3D(i,0),u=Ot.TEXTURE_3D;else{if(!i.isDataArrayTexture)return void console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: only supports THREE.DataTexture3D and THREE.DataTexture2DArray.");vt.setTexture2DArray(i,0),u=Ot.TEXTURE_2D_ARRAY}Ot.pixelStorei(Ot.UNPACK_FLIP_Y_WEBGL,i.flipY),Ot.pixelStorei(Ot.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),Ot.pixelStorei(Ot.UNPACK_ALIGNMENT,i.unpackAlignment);const h=Ot.getParameter(Ot.UNPACK_ROW_LENGTH),d=Ot.getParameter(Ot.UNPACK_IMAGE_HEIGHT),f=Ot.getParameter(Ot.UNPACK_SKIP_PIXELS),p=Ot.getParameter(Ot.UNPACK_SKIP_ROWS),m=Ot.getParameter(Ot.UNPACK_SKIP_IMAGES),g=n.isCompressedTexture?n.mipmaps[0]:n.image;Ot.pixelStorei(Ot.UNPACK_ROW_LENGTH,g.width),Ot.pixelStorei(Ot.UNPACK_IMAGE_HEIGHT,g.height),Ot.pixelStorei(Ot.UNPACK_SKIP_PIXELS,t.min.x),Ot.pixelStorei(Ot.UNPACK_SKIP_ROWS,t.min.y),Ot.pixelStorei(Ot.UNPACK_SKIP_IMAGES,t.min.z),n.isDataTexture||n.isData3DTexture?Ot.texSubImage3D(u,r,e.x,e.y,e.z,s,a,o,l,c,g.data):n.isCompressedTexture?(console.warn("THREE.WebGLRenderer.copyTextureToTexture3D: untested support for compressed srcTexture."),Ot.compressedTexSubImage3D(u,r,e.x,e.y,e.z,s,a,o,l,g.data)):Ot.texSubImage3D(u,r,e.x,e.y,e.z,s,a,o,l,c,g),Ot.pixelStorei(Ot.UNPACK_ROW_LENGTH,h),Ot.pixelStorei(Ot.UNPACK_IMAGE_HEIGHT,d),Ot.pixelStorei(Ot.UNPACK_SKIP_PIXELS,f),Ot.pixelStorei(Ot.UNPACK_SKIP_ROWS,p),Ot.pixelStorei(Ot.UNPACK_SKIP_IMAGES,m),0===r&&i.generateMipmaps&&Ot.generateMipmap(u),pt.unbindTexture()},this.initTexture=function(t){vt.setTexture2D(t,0),pt.unbindTexture()},this.resetState=function(){L=0,P=0,N=null,pt.reset(),Nt.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}pn.prototype.isWebGLRenderer=!0},8369:(t,e,n)=>{function i(t){const e={};for(const n in t){e[n]={};for(const i in t[n]){const r=t[n][i];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?e[n][i]=r.clone():Array.isArray(r)?e[n][i]=r.slice():e[n][i]=r}}return e}function r(t){const e={};for(let n=0;n<t.length;n++){const r=i(t[n]);for(const t in r)e[t]=r[t]}return e}n.d(e,{Rh:()=>r,dw:()=>i,rD:()=>s});const s={clone:i,merge:r}},546:(t,e,n)=>{n.d(e,{B:()=>s});var i=n(5593),r=n(7006);class s extends i.x{constructor(t,e,n,i,s,a,o,l,c,u){super(t=void 0!==t?t:[],e=void 0!==e?e:r.fY$,n,i,s,a,o,l,c,u),this.flipY=!1}get images(){return this.image}set images(t){this.image=t}}s.prototype.isCubeTexture=!0},5817:(t,e,n)=>{n.d(e,{H:()=>s});var i=n(2564),r=n(9542);class s{constructor(t=null){this.uuid=r.DO(),this.data=t,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const n={uuid:this.uuid,url:""},i=this.data;if(null!==i){let t;if(Array.isArray(i)){t=[];for(let e=0,n=i.length;e<n;e++)i[e].isDataTexture?t.push(a(i[e].image)):t.push(a(i[e]))}else t=a(i);n.url=t}return e||(t.images[this.uuid]=n),n}}function a(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?i.P.getDataURL(t):t.data?{data:Array.prototype.slice.call(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}s.prototype.isSource=!0},5593:(t,e,n)=>{n.d(e,{x:()=>u});var i=n(9574),r=n(7006),s=n(9542),a=n(6120),o=n(4894),l=n(5817);let c=0;class u extends i.p{constructor(t=u.DEFAULT_IMAGE,e=u.DEFAULT_MAPPING,n=r.uWy,i=r.uWy,h=r.wem,d=r.D1R,f=r.wk1,p=r.ywz,m=1,g=r.rnI){super(),Object.defineProperty(this,"id",{value:c++}),this.uuid=s.DO(),this.name="",this.source=new l.H(t),this.mipmaps=[],this.mapping=e,this.wrapS=n,this.wrapT=i,this.magFilter=h,this.minFilter=d,this.anisotropy=m,this.format=f,this.internalFormat=null,this.type=p,this.offset=new a.Vector2(0,0),this.repeat=new a.Vector2(1,1),this.center=new a.Vector2(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new o.V,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=g,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.needsPMREMUpdate=!1}get image(){return this.source.data}set image(t){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const n={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,type:this.type,encoding:this.encoding,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),e||(t.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(t){if(this.mapping!==r.xfE)return t;if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case r.rpg:t.x=t.x-Math.floor(t.x);break;case r.uWy:t.x=t.x<0?0:1;break;case r.OoA:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case r.rpg:t.y=t.y-Math.floor(t.y);break;case r.uWy:t.y=t.y<0?0:1;break;case r.OoA:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}return this.flipY&&(t.y=1-t.y),t}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}}u.DEFAULT_IMAGE=null,u.DEFAULT_MAPPING=r.xfE,u.prototype.isTexture=!0},5042:(t,e,n)=>{function i(t){for(let e=t.length-1;e>=0;--e)if(t[e]>65535)return!0;return!1}function r(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}n.d(e,{H7:()=>i,c:()=>r}),Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array}}]);
//# sourceMappingURL=277.82a02d5864aac071401e.js.map