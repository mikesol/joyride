/*! For license information please see 1591.bundle.js.LICENSE.txt */
"use strict";(self.webpackChunkjoyride=self.webpackChunkjoyride||[]).push([[1591],{1591:(t,e,n)=>{n.r(e),n.d(e,{AbstractUserDataWriter:()=>xm,Bytes:()=>If,CACHE_SIZE_UNLIMITED:()=>tf,CollectionReference:()=>$d,DocumentReference:()=>Gd,DocumentSnapshot:()=>Zf,FieldPath:()=>wf,FieldValue:()=>bf,Firestore:()=>ef,FirestoreError:()=>Ms,GeoPoint:()=>Tf,LoadBundleTask:()=>Zd,Query:()=>jd,QueryConstraint:()=>im,QueryDocumentSnapshot:()=>tm,QuerySnapshot:()=>em,SnapshotMetadata:()=>Jf,Timestamp:()=>Ws,Transaction:()=>$m,WriteBatch:()=>_m,_DatabaseId:()=>Qr,_DocumentKey:()=>er,_EmptyAppCheckTokenProvider:()=>Gs,_EmptyAuthCredentialsProvider:()=>Os,_FieldPath:()=>tr,_cast:()=>Pd,_debugAssert:()=>Cs,_isBase64Available:()=>Fr,_logWarn:()=>Ds,_setIndexConfiguration:()=>Zm,_validateIsNotUsedTogether:()=>Vd,addDoc:()=>Bm,arrayRemove:()=>Xm,arrayUnion:()=>Wm,clearIndexedDbPersistence:()=>hf,collection:()=>zd,collectionGroup:()=>Qd,connectFirestoreEmulator:()=>Kd,deleteDoc:()=>Um,deleteField:()=>Qm,disableNetwork:()=>ff,doc:()=>Hd,documentId:()=>vf,enableIndexedDbPersistence:()=>af,enableMultiTabIndexedDbPersistence:()=>uf,enableNetwork:()=>df,endAt:()=>vm,endBefore:()=>wm,ensureFirestoreConfigured:()=>rf,executeWrite:()=>Gm,getDoc:()=>Cm,getDocFromCache:()=>Rm,getDocFromServer:()=>Mm,getDocs:()=>Vm,getDocsFromCache:()=>Lm,getDocsFromServer:()=>Om,getFirestore:()=>sf,increment:()=>Ym,initializeFirestore:()=>nf,limit:()=>dm,limitToLast:()=>fm,loadBundle:()=>gf,namedQuery:()=>pf,onSnapshot:()=>qm,onSnapshotsInSync:()=>Km,orderBy:()=>hm,query:()=>om,queryEqual:()=>Xd,refEqual:()=>Wd,runTransaction:()=>zm,serverTimestamp:()=>Hm,setDoc:()=>Fm,setLogLevel:()=>Es,snapshotEqual:()=>sm,startAfter:()=>pm,startAt:()=>gm,terminate:()=>mf,updateDoc:()=>Pm,waitForPendingWrites:()=>lf,where:()=>um,writeBatch:()=>Jm});var s,r=n(2238),i=n(8463),o=n(3333),a=n(4444),u="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==n.g?n.g:"undefined"!=typeof self?self:{},c={},h=h||{},l=u||self;function d(){}function f(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function m(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var g="closure_uid_"+(1e9*Math.random()>>>0),p=0;function y(t,e,n){return t.call.apply(t.bind,arguments)}function w(t,e,n){if(!t)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,s),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function v(t,e,n){return(v=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?y:w).apply(null,arguments)}function I(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function b(t,e){function n(){}n.prototype=e.prototype,t.Z=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Vb=function(t,n,s){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.prototype[n].apply(t,r)}}function T(){this.s=this.s,this.o=this.o}var E={};T.prototype.s=!1,T.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),0)){var t=function(t){return Object.prototype.hasOwnProperty.call(t,g)&&t[g]||(t[g]=++p)}(this);delete E[t]}},T.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const S=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1},x=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(t,e,n){const s=t.length,r="string"==typeof t?t.split(""):t;for(let i=0;i<s;i++)i in r&&e.call(n,r[i],i,t)};function D(t){return Array.prototype.concat.apply([],arguments)}function A(t){const e=t.length;if(0<e){const n=Array(e);for(let s=0;s<e;s++)n[s]=t[s];return n}return[]}function _(t){return/^[\s\xa0]*$/.test(t)}var N,C=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function k(t,e){return-1!=t.indexOf(e)}function R(t,e){return t<e?-1:t>e?1:0}t:{var M=l.navigator;if(M){var V=M.userAgent;if(V){N=V;break t}}N=""}function L(t,e,n){for(const s in t)e.call(n,t[s],s,t)}function O(t){const e={};for(const n in t)e[n]=t[n];return e}var F="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function P(t,e){let n,s;for(let e=1;e<arguments.length;e++){for(n in s=arguments[e],s)t[n]=s[n];for(let e=0;e<F.length;e++)n=F[e],Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])}}function U(t){return U[" "](t),t}U[" "]=d;var B,q,K=k(N,"Opera"),G=k(N,"Trident")||k(N,"MSIE"),j=k(N,"Edge"),$=j||G,z=k(N,"Gecko")&&!(k(N.toLowerCase(),"webkit")&&!k(N,"Edge"))&&!(k(N,"Trident")||k(N,"MSIE"))&&!k(N,"Edge"),Q=k(N.toLowerCase(),"webkit")&&!k(N,"Edge");function H(){var t=l.document;return t?t.documentMode:void 0}t:{var W="",X=(q=N,z?/rv:([^\);]+)(\)|;)/.exec(q):j?/Edge\/([\d\.]+)/.exec(q):G?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(q):Q?/WebKit\/(\S+)/.exec(q):K?/(?:Version)[ \/]?(\S+)/.exec(q):void 0);if(X&&(W=X?X[1]:""),G){var Y=H();if(null!=Y&&Y>parseFloat(W)){B=String(Y);break t}}B=W}var J,Z={};function tt(){return t=Z,Object.prototype.hasOwnProperty.call(t,9)?t[9]:t[9]=function(){let t=0;const e=C(String(B)).split("."),n=C("9").split("."),s=Math.max(e.length,n.length);for(let o=0;0==t&&o<s;o++){var r=e[o]||"",i=n[o]||"";do{if(r=/(\d*)(\D*)(.*)/.exec(r)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],0==r[0].length&&0==i[0].length)break;t=R(0==r[1].length?0:parseInt(r[1],10),0==i[1].length?0:parseInt(i[1],10))||R(0==r[2].length,0==i[2].length)||R(r[2],i[2]),r=r[3],i=i[3]}while(0==t)}return 0<=t}();var t}l.document&&G?J=H()||parseInt(B,10)||void 0:J=void 0;var et=J,nt=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{l.addEventListener("test",d,e),l.removeEventListener("test",d,e)}catch(t){}return t}();function st(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function rt(t,e){if(st.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,s=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(z){t:{try{U(e.nodeName);var r=!0;break t}catch(t){}r=!1}r||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,s?(this.clientX=void 0!==s.clientX?s.clientX:s.pageX,this.clientY=void 0!==s.clientY?s.clientY:s.pageY,this.screenX=s.screenX||0,this.screenY=s.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:it[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&rt.Z.h.call(this)}}st.prototype.h=function(){this.defaultPrevented=!0},b(rt,st);var it={2:"touch",3:"pen",4:"mouse"};rt.prototype.h=function(){rt.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var ot="closure_listenable_"+(1e6*Math.random()|0),at=0;function ut(t,e,n,s,r){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!s,this.ia=r,this.key=++at,this.ca=this.fa=!1}function ct(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function ht(t){this.src=t,this.g={},this.h=0}function lt(t,e){var n=e.type;if(n in t.g){var s,r=t.g[n],i=S(r,e);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(ct(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function dt(t,e,n,s){for(var r=0;r<t.length;++r){var i=t[r];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==s)return r}return-1}ht.prototype.add=function(t,e,n,s,r){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=dt(t,e,s,r);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new ut(e,this.src,i,!!s,r)).fa=n,t.push(e)),e};var ft="closure_lm_"+(1e6*Math.random()|0),mt={};function gt(t,e,n,s,r){if(s&&s.once)return yt(t,e,n,s,r);if(Array.isArray(e)){for(var i=0;i<e.length;i++)gt(t,e[i],n,s,r);return null}return n=St(n),t&&t[ot]?t.N(e,n,m(s)?!!s.capture:!!s,r):pt(t,e,n,!1,s,r)}function pt(t,e,n,s,r,i){if(!e)throw Error("Invalid event type");var o=m(r)?!!r.capture:!!r,a=Tt(t);if(a||(t[ft]=a=new ht(t)),(n=a.add(e,n,s,o,i)).proxy)return n;if(s=function(){var t=bt;return function e(n){return t.call(e.src,e.listener,n)}}(),n.proxy=s,s.src=t,s.listener=n,t.addEventListener)nt||(r=o),void 0===r&&(r=!1),t.addEventListener(e.toString(),s,r);else if(t.attachEvent)t.attachEvent(It(e.toString()),s);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(s)}return n}function yt(t,e,n,s,r){if(Array.isArray(e)){for(var i=0;i<e.length;i++)yt(t,e[i],n,s,r);return null}return n=St(n),t&&t[ot]?t.O(e,n,m(s)?!!s.capture:!!s,r):pt(t,e,n,!0,s,r)}function wt(t,e,n,s,r){if(Array.isArray(e))for(var i=0;i<e.length;i++)wt(t,e[i],n,s,r);else s=m(s)?!!s.capture:!!s,n=St(n),t&&t[ot]?(t=t.i,(e=String(e).toString())in t.g&&-1<(n=dt(i=t.g[e],n,s,r))&&(ct(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--))):t&&(t=Tt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=dt(e,n,s,r)),(n=-1<t?e[t]:null)&&vt(n))}function vt(t){if("number"!=typeof t&&t&&!t.ca){var e=t.src;if(e&&e[ot])lt(e.i,t);else{var n=t.type,s=t.proxy;e.removeEventListener?e.removeEventListener(n,s,t.capture):e.detachEvent?e.detachEvent(It(n),s):e.addListener&&e.removeListener&&e.removeListener(s),(n=Tt(e))?(lt(n,t),0==n.h&&(n.src=null,e[ft]=null)):ct(t)}}}function It(t){return t in mt?mt[t]:mt[t]="on"+t}function bt(t,e){if(t.ca)t=!0;else{e=new rt(e,this);var n=t.listener,s=t.ia||t.src;t.fa&&vt(t),t=n.call(s,e)}return t}function Tt(t){return(t=t[ft])instanceof ht?t:null}var Et="__closure_events_fn_"+(1e9*Math.random()>>>0);function St(t){return"function"==typeof t?t:(t[Et]||(t[Et]=function(e){return t.handleEvent(e)}),t[Et])}function xt(){T.call(this),this.i=new ht(this),this.P=this,this.I=null}function Dt(t,e){var n,s=t.I;if(s)for(n=[];s;s=s.I)n.push(s);if(t=t.P,s=e.type||e,"string"==typeof e)e=new st(e,t);else if(e instanceof st)e.target=e.target||t;else{var r=e;P(e=new st(s,t),r)}if(r=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];r=At(o,s,!0,e)&&r}if(r=At(o=e.g=t,s,!0,e)&&r,r=At(o,s,!1,e)&&r,n)for(i=0;i<n.length;i++)r=At(o=e.g=n[i],s,!1,e)&&r}function At(t,e,n,s){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var r=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.ca&&o.capture==n){var a=o.listener,u=o.ia||o.src;o.fa&&lt(t.i,o),r=!1!==a.call(u,s)&&r}}return r&&!s.defaultPrevented}b(xt,T),xt.prototype[ot]=!0,xt.prototype.removeEventListener=function(t,e,n,s){wt(this,t,e,n,s)},xt.prototype.M=function(){if(xt.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],s=0;s<n.length;s++)ct(n[s]);delete e.g[t],e.h--}}this.I=null},xt.prototype.N=function(t,e,n,s){return this.i.add(String(t),e,!1,n,s)},xt.prototype.O=function(t,e,n,s){return this.i.add(String(t),e,!0,n,s)};var _t=l.JSON.stringify;function Nt(){var t=Ot;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Ct,kt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new Rt),(t=>t.reset()));class Rt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Mt(t){l.setTimeout((()=>{throw t}),0)}function Vt(t,e){Ct||function(){var t=l.Promise.resolve(void 0);Ct=function(){t.then(Ft)}}(),Lt||(Ct(),Lt=!0),Ot.add(t,e)}var Lt=!1,Ot=new class{constructor(){this.h=this.g=null}add(t,e){const n=kt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Ft(){for(var t;t=Nt();){try{t.h.call(t.g)}catch(t){Mt(t)}var e=kt;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Lt=!1}function Pt(t,e){xt.call(this),this.h=t||1,this.g=e||l,this.j=v(this.kb,this),this.l=Date.now()}function Ut(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Bt(t,e,n){if("function"==typeof t)n&&(t=v(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=v(t.handleEvent,t)}return 2147483647<Number(e)?-1:l.setTimeout(t,e||0)}function qt(t){t.g=Bt((()=>{t.g=null,t.i&&(t.i=!1,qt(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}b(Pt,xt),(s=Pt.prototype).da=!1,s.S=null,s.kb=function(){if(this.da){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),Dt(this,"tick"),this.da&&(Ut(this),this.start()))}},s.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},s.M=function(){Pt.Z.M.call(this),Ut(this),delete this.g};class Kt extends T{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:qt(this)}M(){super.M(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Gt(t){T.call(this),this.h=t,this.g={}}b(Gt,T);var jt=[];function $t(t,e,n,s){Array.isArray(n)||(n&&(jt[0]=n.toString()),n=jt);for(var r=0;r<n.length;r++){var i=gt(e,n[r],s||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function zt(t){L(t.g,(function(t,e){this.g.hasOwnProperty(e)&&vt(t)}),t),t.g={}}function Qt(){this.g=!0}function Ht(t,e,n,s){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var s=n[t];if(!(2>s.length)){var r=s[1];if(Array.isArray(r)&&!(1>r.length)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<r.length;o++)r[o]=""}}}return _t(n)}catch(t){return e}}(t,n)+(s?" "+s:"")}))}Gt.prototype.M=function(){Gt.Z.M.call(this),zt(this)},Gt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Qt.prototype.Aa=function(){this.g=!1},Qt.prototype.info=function(){};var Wt={},Xt=null;function Yt(){return Xt=Xt||new xt}function Jt(t){st.call(this,Wt.Ma,t)}function Zt(t){const e=Yt();Dt(e,new Jt(e,t))}function te(t,e){st.call(this,Wt.STAT_EVENT,t),this.stat=e}function ee(t){const e=Yt();Dt(e,new te(e,t))}function ne(t,e){st.call(this,Wt.Na,t),this.size=e}function se(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return l.setTimeout((function(){t()}),e)}Wt.Ma="serverreachability",b(Jt,st),Wt.STAT_EVENT="statevent",b(te,st),Wt.Na="timingevent",b(ne,st);var re={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},ie={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function oe(){}function ae(t){return t.h||(t.h=t.i())}function ue(){}oe.prototype.h=null;var ce,he={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function le(){st.call(this,"d")}function de(){st.call(this,"c")}function fe(){}function me(t,e,n,s){this.l=t,this.j=e,this.m=n,this.X=s||1,this.V=new Gt(this),this.P=pe,t=$?125:void 0,this.W=new Pt(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new ge}function ge(){this.i=null,this.g="",this.h=!1}b(le,st),b(de,st),b(fe,oe),fe.prototype.g=function(){return new XMLHttpRequest},fe.prototype.i=function(){return{}},ce=new fe;var pe=45e3,ye={},we={};function ve(t,e,n){t.K=1,t.v=Ke(Oe(e)),t.s=n,t.U=!0,Ie(t,null)}function Ie(t,e){t.F=Date.now(),Se(t),t.A=Oe(t.v);var n=t.A,s=t.X;Array.isArray(s)||(s=[String(s)]),en(n.h,"t",s),t.C=0,n=t.l.H,t.h=new ge,t.g=ns(t.l,n?e:null,!t.s),0<t.O&&(t.L=new Kt(v(t.Ia,t,t.g),t.O)),$t(t.V,t.g,"readystatechange",t.gb),e=t.H?O(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),Zt(1),function(t,e,n,s,r,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var h=c[0];c=c[1];var l=h.split("_");o=2<=l.length&&"type"==l[1]?o+(h+"=")+c+"&":o+(h+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+s+") [attempt "+r+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.u,t.A,t.m,t.X,t.s)}function be(t){return!!t.g&&"GET"==t.u&&2!=t.K&&t.l.Ba}function Te(t,e,n){let s,r=!0;for(;!t.I&&t.C<n.length;){if(s=Ee(t,n),s==we){4==e&&(t.o=4,ee(14),r=!1),Ht(t.j,t.m,null,"[Incomplete Response]");break}if(s==ye){t.o=4,ee(15),Ht(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}Ht(t.j,t.m,s,null),Ne(t,s)}be(t)&&s!=we&&s!=ye&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,ee(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),Hn(e),e.L=!0,ee(11))):(Ht(t.j,t.m,n,"[Invalid Chunked Response]"),_e(t),Ae(t))}function Ee(t,e){var n=t.C,s=e.indexOf("\n",n);return-1==s?we:(n=Number(e.substring(n,s)),isNaN(n)?ye:(s+=1)+n>e.length?we:(e=e.substr(s,n),t.C=s+n,e))}function Se(t){t.Y=Date.now()+t.P,xe(t,t.P)}function xe(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=se(v(t.eb,t),e)}function De(t){t.B&&(l.clearTimeout(t.B),t.B=null)}function Ae(t){0==t.l.G||t.I||Yn(t.l,t)}function _e(t){De(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,Ut(t.W),zt(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function Ne(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||un(n.i,t)))if(n.I=t.N,!t.J&&un(n.i,t)&&3==n.G){try{var s=n.Ca.g.parse(e)}catch(t){s=null}if(Array.isArray(s)&&3==s.length){var r=s;if(0==r[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;Xn(n),Un(n)}Qn(n),ee(18)}}else n.ta=r[1],0<n.ta-n.U&&37500>r[2]&&n.N&&0==n.A&&!n.v&&(n.v=se(v(n.ab,n),6e3));if(1>=an(n.i)&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Zn(n,11)}else if((t.J||n.g==t)&&Xn(n),!_(e))for(r=n.Ca.g.parse(e),e=0;e<r.length;e++){let c=r[e];if(n.U=c[0],c=c[1],2==n.G)if("c"==c[0]){n.J=c[1],n.la=c[2];const e=c[3];null!=e&&(n.ma=e,n.h.info("VER="+n.ma));const r=c[4];null!=r&&(n.za=r,n.h.info("SVER="+n.za));const h=c[5];null!=h&&"number"==typeof h&&0<h&&(s=1.5*h,n.K=s,n.h.info("backChannelRequestTimeoutMs_="+s)),s=n;const l=t.g;if(l){const t=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=s.i;!i.g&&(k(t,"spdy")||k(t,"quic")||k(t,"h2"))&&(i.j=i.l,i.g=new Set,i.h&&(cn(i,i.h),i.h=null))}if(s.D){const t=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(s.sa=t,qe(s.F,s.D,t))}}n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var o=t;if((s=n).oa=es(s,s.H?s.la:null,s.W),o.J){hn(s.i,o);var a=o,u=s.K;u&&a.setTimeout(u),a.B&&(De(a),Se(a)),s.g=o}else zn(s);0<n.l.length&&Kn(n)}else"stop"!=c[0]&&"close"!=c[0]||Zn(n,7);else 3==n.G&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?Zn(n,7):Pn(n):"noop"!=c[0]&&n.j&&n.j.wa(c),n.A=0)}Zt(4)}catch(t){}}function Ce(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(f(t)||"string"==typeof t)x(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(f(t)||"string"==typeof t){n=[];for(var s=t.length,r=0;r<s;r++)n.push(r)}else for(r in n=[],s=0,t)n[s++]=r;s=function(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(f(t)){for(var e=[],n=t.length,s=0;s<n;s++)e.push(t[s]);return e}for(s in e=[],n=0,t)e[n++]=t[s];return e}(t),r=s.length;for(var i=0;i<r;i++)e.call(void 0,s[i],n&&n[i],t)}}function ke(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var s=0;s<n;s+=2)this.set(arguments[s],arguments[s+1])}else if(t)if(t instanceof ke)for(n=t.T(),s=0;s<n.length;s++)this.set(n[s],t.get(n[s]));else for(s in t)this.set(s,t[s])}function Re(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var s=t.g[e];Me(t.h,s)&&(t.g[n++]=s),e++}t.g.length=n}if(t.i!=t.g.length){var r={};for(n=e=0;e<t.g.length;)Me(r,s=t.g[e])||(t.g[n++]=s,r[s]=1),e++;t.g.length=n}}function Me(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(s=me.prototype).setTimeout=function(t){this.P=t},s.gb=function(t){t=t.target;const e=this.L;e&&3==Mn(t)?e.l():this.Ia(t)},s.Ia=function(t){try{if(t==this.g)t:{const h=Mn(this.g);var e=this.g.Da();const d=this.g.ba();if(!(3>h)&&(3!=h||$||this.g&&(this.h.h||this.g.ga()||Vn(this.g)))){this.I||4!=h||7==e||Zt(8==e||0>=d?3:2),De(this);var n=this.g.ba();this.N=n;e:if(be(this)){var s=Vn(this.g);t="";var r=s.length,i=4==Mn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){_e(this),Ae(this);var o="";break e}this.h.i=new l.TextDecoder}for(e=0;e<r;e++)this.h.h=!0,t+=this.h.i.decode(s[e],{stream:i&&e==r-1});s.splice(0,r),this.h.g+=t,this.C=0,o=this.h.g}else o=this.g.ga();if(this.i=200==n,function(t,e,n,s,r,i,o){t.info((function(){return"XMLHTTP RESP ("+s+") [ attempt "+r+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.X,h,n),this.i){if(this.$&&!this.J){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!_(a)){var c=a;break e}}c=null}if(!(n=c)){this.i=!1,this.o=3,ee(12),_e(this),Ae(this);break t}Ht(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Ne(this,n)}this.U?(Te(this,h,o),$&&this.i&&3==h&&($t(this.V,this.W,"tick",this.fb),this.W.start())):(Ht(this.j,this.m,o,null),Ne(this,o)),4==h&&_e(this),this.i&&!this.I&&(4==h?Yn(this.l,this):(this.i=!1,Se(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,ee(12)):(this.o=0,ee(13)),_e(this),Ae(this)}}}catch(t){}},s.fb=function(){if(this.g){var t=Mn(this.g),e=this.g.ga();this.C<e.length&&(De(this),Te(this,t,e),this.i&&4!=t&&Se(this))}},s.cancel=function(){this.I=!0,_e(this)},s.eb=function(){this.B=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.K&&(Zt(3),ee(17)),_e(this),this.o=2,Ae(this)):xe(this,this.Y-t)},(s=ke.prototype).R=function(){Re(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},s.T=function(){return Re(this),this.g.concat()},s.get=function(t,e){return Me(this.h,t)?this.h[t]:e},s.set=function(t,e){Me(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},s.forEach=function(t,e){for(var n=this.T(),s=0;s<n.length;s++){var r=n[s],i=this.get(r);t.call(e,i,r,this)}};var Ve=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Le(t,e){if(this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof Le){this.g=void 0!==e?e:t.g,Fe(this,t.j),this.s=t.s,Pe(this,t.i),Ue(this,t.m),this.l=t.l,e=t.h;var n=new Ye;n.i=e.i,e.g&&(n.g=new ke(e.g),n.h=e.h),Be(this,n),this.o=t.o}else t&&(n=String(t).match(Ve))?(this.g=!!e,Fe(this,n[1]||"",!0),this.s=Ge(n[2]||""),Pe(this,n[3]||"",!0),Ue(this,n[4]),this.l=Ge(n[5]||"",!0),Be(this,n[6]||"",!0),this.o=Ge(n[7]||"")):(this.g=!!e,this.h=new Ye(null,this.g))}function Oe(t){return new Le(t)}function Fe(t,e,n){t.j=n?Ge(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Pe(t,e,n){t.i=n?Ge(e,!0):e}function Ue(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Be(t,e,n){e instanceof Ye?(t.h=e,function(t,e){e&&!t.j&&(Je(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(Ze(this,e),en(this,n,t))}),t)),t.j=e}(t.h,t.g)):(n||(e=je(e,We)),t.h=new Ye(e,t.g))}function qe(t,e,n){t.h.set(e,n)}function Ke(t){return qe(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function Ge(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function je(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,$e),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function $e(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Le.prototype.toString=function(){var t=[],e=this.j;e&&t.push(je(e,ze,!0),":");var n=this.i;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(je(e,ze,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(je(n,"/"==n.charAt(0)?He:Qe,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",je(n,Xe)),t.join("")};var ze=/[#\/\?@]/g,Qe=/[#\?:]/g,He=/[#\?]/g,We=/[#\?@]/g,Xe=/#/g;function Ye(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function Je(t){t.g||(t.g=new ke,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var s=t[n].indexOf("="),r=null;if(0<=s){var i=t[n].substring(0,s);r=t[n].substring(s+1)}else i=t[n];e(i,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function Ze(t,e){Je(t),e=nn(t,e),Me(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,Me((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&Re(t)))}function tn(t,e){return Je(t),e=nn(t,e),Me(t.g.h,e)}function en(t,e,n){Ze(t,e),0<n.length&&(t.i=null,t.g.set(nn(t,e),A(n)),t.h+=n.length)}function nn(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}function sn(t){this.l=t||rn,t=l.PerformanceNavigationTiming?0<(t=l.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(l.g&&l.g.Ea&&l.g.Ea()&&l.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(s=Ye.prototype).add=function(t,e){Je(this),this.i=null,t=nn(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},s.forEach=function(t,e){Je(this),this.g.forEach((function(n,s){x(n,(function(n){t.call(e,n,s,this)}),this)}),this)},s.T=function(){Je(this);for(var t=this.g.R(),e=this.g.T(),n=[],s=0;s<e.length;s++)for(var r=t[s],i=0;i<r.length;i++)n.push(e[s]);return n},s.R=function(t){Je(this);var e=[];if("string"==typeof t)tn(this,t)&&(e=D(e,this.g.get(nn(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=D(e,t[n])}return e},s.set=function(t,e){return Je(this),this.i=null,tn(this,t=nn(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},s.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},s.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++){var s=e[n],r=encodeURIComponent(String(s));s=this.R(s);for(var i=0;i<s.length;i++){var o=r;""!==s[i]&&(o+="="+encodeURIComponent(String(s[i]))),t.push(o)}}return this.i=t.join("&")};var rn=10;function on(t){return!!t.h||!!t.g&&t.g.size>=t.j}function an(t){return t.h?1:t.g?t.g.size:0}function un(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function cn(t,e){t.g?t.g.add(e):t.h=e}function hn(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function ln(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return A(t.i)}function dn(){}function fn(){this.g=new dn}function mn(t,e,n){const s=n||"";try{Ce(t,(function(t,n){let r=t;m(t)&&(r=_t(t)),e.push(s+n+"="+encodeURIComponent(r))}))}catch(t){throw e.push(s+"type="+encodeURIComponent("_badmap")),t}}function gn(t,e,n,s,r){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,r(s)}catch(t){}}function pn(t){this.l=t.$b||null,this.j=t.ib||!1}function yn(t,e){xt.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=wn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}sn.prototype.cancel=function(){if(this.i=ln(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},dn.prototype.stringify=function(t){return l.JSON.stringify(t,void 0)},dn.prototype.parse=function(t){return l.JSON.parse(t,void 0)},b(pn,oe),pn.prototype.g=function(){return new yn(this.l,this.j)},pn.prototype.i=function(t){return function(){return t}}({}),b(yn,xt);var wn=0;function vn(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function In(t){t.readyState=4,t.l=null,t.j=null,t.A=null,bn(t)}function bn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(s=yn.prototype).open=function(t,e){if(this.readyState!=wn)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,bn(this)},s.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||l).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},s.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,In(this)),this.readyState=wn},s.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,bn(this)),this.g&&(this.readyState=3,bn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==l.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;vn(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},s.Sa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?In(this):bn(this),3==this.readyState&&vn(this)}},s.Ua=function(t){this.g&&(this.response=this.responseText=t,In(this))},s.Ta=function(t){this.g&&(this.response=t,In(this))},s.ha=function(){this.g&&In(this)},s.setRequestHeader=function(t,e){this.v.append(t,e)},s.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},s.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(yn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var Tn=l.JSON.parse;function En(t){xt.call(this),this.headers=new ke,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Sn,this.K=this.L=!1}b(En,xt);var Sn="",xn=/^https?$/i,Dn=["POST","PUT"];function An(t){return"content-type"==t.toLowerCase()}function _n(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Nn(t),kn(t)}function Nn(t){t.D||(t.D=!0,Dt(t,"complete"),Dt(t,"error"))}function Cn(t){if(t.h&&void 0!==h&&(!t.C[1]||4!=Mn(t)||2!=t.ba()))if(t.v&&4==Mn(t))Bt(t.Fa,0,t);else if(Dt(t,"readystatechange"),4==Mn(t)){t.h=!1;try{const a=t.ba();t:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var s;if(s=0===a){var r=String(t.H).match(Ve)[1]||null;if(!r&&l.self&&l.self.location){var i=l.self.location.protocol;r=i.substr(0,i.length-1)}s=!xn.test(r?r.toLowerCase():"")}n=s}if(n)Dt(t,"complete"),Dt(t,"success");else{t.m=6;try{var o=2<Mn(t)?t.g.statusText:""}catch(t){o=""}t.j=o+" ["+t.ba()+"]",Nn(t)}}finally{kn(t)}}}function kn(t,e){if(t.g){Rn(t);const n=t.g,s=t.C[0]?d:null;t.g=null,t.C=null,e||Dt(t,"ready");try{n.onreadystatechange=s}catch(t){}}}function Rn(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(l.clearTimeout(t.A),t.A=null)}function Mn(t){return t.g?t.g.readyState:0}function Vn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case Sn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Ln(t,e,n){t:{for(s in n){var s=!1;break t}s=!0}s||(n=function(t){let e="";return L(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):qe(t,e,n))}function On(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Fn(t){this.za=0,this.l=[],this.h=new Qt,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=On("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=On("baseRetryDelayMs",5e3,t),this.$a=On("retryDelaySeedMs",1e4,t),this.Ya=On("forwardChannelMaxRetries",2,t),this.ra=On("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new sn(t&&t.concurrentRequestLimit),this.Ca=new fn,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function Pn(t){if(Bn(t),3==t.G){var e=t.V++,n=Oe(t.F);qe(n,"SID",t.J),qe(n,"RID",e),qe(n,"TYPE","terminate"),jn(t,n),(e=new me(t,t.h,e,void 0)).K=2,e.v=Ke(Oe(n)),n=!1,l.navigator&&l.navigator.sendBeacon&&(n=l.navigator.sendBeacon(e.v.toString(),"")),!n&&l.Image&&((new Image).src=e.v,n=!0),n||(e.g=ns(e.l,null),e.g.ea(e.v)),e.F=Date.now(),Se(e)}ts(t)}function Un(t){t.g&&(Hn(t),t.g.cancel(),t.g=null)}function Bn(t){Un(t),t.u&&(l.clearTimeout(t.u),t.u=null),Xn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&l.clearTimeout(t.m),t.m=null)}function qn(t,e){t.l.push(new class{constructor(t,e){this.h=t,this.g=e}}(t.Za++,e)),3==t.G&&Kn(t)}function Kn(t){on(t.i)||t.m||(t.m=!0,Vt(t.Ha,t),t.C=0)}function Gn(t,e){var n;n=e?e.m:t.V++;const s=Oe(t.F);qe(s,"SID",t.J),qe(s,"RID",n),qe(s,"AID",t.U),jn(t,s),t.o&&t.s&&Ln(s,t.o,t.s),n=new me(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=$n(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),cn(t.i,n),ve(n,s,e)}function jn(t,e){t.j&&Ce({},(function(t,n){qe(e,n,t)}))}function $n(t,e,n){n=Math.min(t.l.length,n);var s=t.j?v(t.j.Oa,t.j,t):null;t:{var r=t.l;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=r[0].h,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=r[o].h;const a=r[o].g;if(n-=e,0>n)e=Math.max(0,r[o].h-100),i=!1;else try{mn(a,t,"req"+n+"_")}catch(t){s&&s(a)}}if(i){s=t.join("&");break t}}}return t=t.l.splice(0,n),e.D=t,s}function zn(t){t.g||t.u||(t.Y=1,Vt(t.Ga,t),t.A=0)}function Qn(t){return!(t.g||t.u||3<=t.A||(t.Y++,t.u=se(v(t.Ga,t),Jn(t,t.A)),t.A++,0))}function Hn(t){null!=t.B&&(l.clearTimeout(t.B),t.B=null)}function Wn(t){t.g=new me(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=Oe(t.oa);qe(e,"RID","rpc"),qe(e,"SID",t.J),qe(e,"CI",t.N?"0":"1"),qe(e,"AID",t.U),jn(t,e),qe(e,"TYPE","xmlhttp"),t.o&&t.s&&Ln(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=Ke(Oe(e)),n.s=null,n.U=!0,Ie(n,t)}function Xn(t){null!=t.v&&(l.clearTimeout(t.v),t.v=null)}function Yn(t,e){var n=null;if(t.g==e){Xn(t),Hn(t),t.g=null;var s=2}else{if(!un(t.i,e))return;n=e.D,hn(t.i,e),s=1}if(t.I=e.N,0!=t.G)if(e.i)if(1==s){n=e.s?e.s.length:0,e=Date.now()-e.F;var r=t.C;Dt(s=Yt(),new ne(s,n,e,r)),Kn(t)}else zn(t);else if(3==(r=e.o)||0==r&&0<t.I||!(1==s&&function(t,e){return!(an(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.l=e.D.concat(t.l),0):1==t.G||2==t.G||t.C>=(t.Xa?0:t.Ya)||(t.m=se(v(t.Ha,t,e),Jn(t,t.C)),t.C++,0)))}(t,e)||2==s&&Qn(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),r){case 1:Zn(t,5);break;case 4:Zn(t,10);break;case 3:Zn(t,6);break;default:Zn(t,2)}}function Jn(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Zn(t,e){if(t.h.info("Error code "+e),2==e){var n=null;t.j&&(n=null);var s=v(t.jb,t);n||(n=new Le("//www.google.com/images/cleardot.gif"),l.location&&"http"==l.location.protocol||Fe(n,"https"),Ke(n)),function(t,e){const n=new Qt;if(l.Image){const s=new Image;s.onload=I(gn,n,s,"TestLoadImage: loaded",!0,e),s.onerror=I(gn,n,s,"TestLoadImage: error",!1,e),s.onabort=I(gn,n,s,"TestLoadImage: abort",!1,e),s.ontimeout=I(gn,n,s,"TestLoadImage: timeout",!1,e),l.setTimeout((function(){s.ontimeout&&s.ontimeout()}),1e4),s.src=t}else e(!1)}(n.toString(),s)}else ee(2);t.G=0,t.j&&t.j.va(e),ts(t),Bn(t)}function ts(t){t.G=0,t.I=-1,t.j&&(0==ln(t.i).length&&0==t.l.length||(t.i.i.length=0,A(t.l),t.l.length=0),t.j.ua())}function es(t,e,n){let s=function(t){return t instanceof Le?Oe(t):new Le(t,void 0)}(n);if(""!=s.i)e&&Pe(s,e+"."+s.i),Ue(s,s.m);else{const t=l.location;s=function(t,e,n,s){var r=new Le(null,void 0);return t&&Fe(r,t),e&&Pe(r,e),n&&Ue(r,n),s&&(r.l=s),r}(t.protocol,e?e+"."+t.hostname:t.hostname,+t.port,n)}return t.aa&&L(t.aa,(function(t,e){qe(s,e,t)})),e=t.D,n=t.sa,e&&n&&qe(s,e,n),qe(s,"VER",t.ma),jn(t,s),s}function ns(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new En(new pn({ib:!0})):new En(t.qa)).L=t.H,e}function ss(){}function rs(){if(G&&!(10<=Number(et)))throw Error("Environmental error: no available transport.")}function is(t,e){xt.call(this),this.g=new Fn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!_(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!_(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&e in(t=this.h)&&delete t[e]),this.j=new us(this)}function os(t){le.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function as(){de.call(this),this.status=1}function us(t){this.g=t}(s=En.prototype).ea=function(t,e,n,s){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():ce.g(),this.C=this.u?ae(this.u):ae(ce),this.g.onreadystatechange=v(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void _n(this,t)}t=n||"";const r=new ke(this.headers);s&&Ce(s,(function(t,e){r.set(e,t)})),s=function(t){t:{var e=An;const n=t.length,s="string"==typeof t?t.split(""):t;for(let r=0;r<n;r++)if(r in s&&e.call(void 0,s[r],r,t)){e=r;break t}e=-1}return 0>e?null:"string"==typeof t?t.charAt(e):t[e]}(r.T()),n=l.FormData&&t instanceof l.FormData,!(0<=S(Dn,e))||s||n||r.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),r.forEach((function(t,e){this.g.setRequestHeader(e,t)}),this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Rn(this),0<this.B&&((this.K=function(t){return G&&tt()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=v(this.pa,this)):this.A=Bt(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){_n(this,t)}},s.pa=function(){void 0!==h&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Dt(this,"timeout"),this.abort(8))},s.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,Dt(this,"complete"),Dt(this,"abort"),kn(this))},s.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),kn(this,!0)),En.Z.M.call(this)},s.Fa=function(){this.s||(this.F||this.v||this.l?Cn(this):this.cb())},s.cb=function(){Cn(this)},s.ba=function(){try{return 2<Mn(this)?this.g.status:-1}catch(t){return-1}},s.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},s.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),Tn(e)}},s.Da=function(){return this.m},s.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(s=Fn.prototype).ma=8,s.G=1,s.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},s.Ha=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.V=Math.floor(1e5*Math.random()),t=this.V++;const r=new me(this,this.h,t,void 0);let i=this.s;if(this.P&&(i?(i=O(i),P(i,this.P)):i=this.P),null===this.o&&(r.H=i),this.ja)t:{for(var e=0,n=0;n<this.l.length;n++){var s=this.l[n];if(void 0===(s="__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s.length:void 0))break;if(4096<(e+=s)){e=n;break t}if(4096===e||n===this.l.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=$n(this,r,e),qe(n=Oe(this.F),"RID",t),qe(n,"CVER",22),this.D&&qe(n,"X-HTTP-Session-Id",this.D),jn(this,n),this.o&&i&&Ln(n,this.o,i),cn(this.i,r),this.Ra&&qe(n,"TYPE","init"),this.ja?(qe(n,"$req",e),qe(n,"SID","null"),r.$=!0,ve(r,n,null)):ve(r,n,e),this.G=2}}else 3==this.G&&(t?Gn(this,t):0==this.l.length||on(this.i)||Gn(this))},s.Ga=function(){if(this.u=null,Wn(this),this.$&&!(this.L||null==this.g||0>=this.O)){var t=2*this.O;this.h.info("BP detection timer enabled: "+t),this.B=se(v(this.bb,this),t)}},s.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,ee(10),Un(this),Wn(this))},s.ab=function(){null!=this.v&&(this.v=null,Un(this),Qn(this),ee(19))},s.jb=function(t){t?(this.h.info("Successfully pinged google.com"),ee(2)):(this.h.info("Failed to ping google.com"),ee(1))},(s=ss.prototype).xa=function(){},s.wa=function(){},s.va=function(){},s.ua=function(){},s.Oa=function(){},rs.prototype.g=function(t,e){return new is(t,e)},b(is,xt),is.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),Vt(v(t.hb,t,e))),ee(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=es(t,null,t.W),Kn(t)},is.prototype.close=function(){Pn(this.g)},is.prototype.u=function(t){if("string"==typeof t){var e={};e.__data__=t,qn(this.g,e)}else this.v?((e={}).__data__=_t(t),qn(this.g,e)):qn(this.g,t)},is.prototype.M=function(){this.g.j=null,delete this.j,Pn(this.g),delete this.g,is.Z.M.call(this)},b(os,le),b(as,de),b(us,ss),us.prototype.xa=function(){Dt(this.g,"a")},us.prototype.wa=function(t){Dt(this.g,new os(t))},us.prototype.va=function(t){Dt(this.g,new as(t))},us.prototype.ua=function(){Dt(this.g,"b")},rs.prototype.createWebChannel=rs.prototype.g,is.prototype.send=is.prototype.u,is.prototype.open=is.prototype.m,is.prototype.close=is.prototype.close,re.NO_ERROR=0,re.TIMEOUT=8,re.HTTP_ERROR=6,ie.COMPLETE="complete",ue.EventType=he,he.OPEN="a",he.CLOSE="b",he.ERROR="c",he.MESSAGE="d",xt.prototype.listen=xt.prototype.N,En.prototype.listenOnce=En.prototype.O,En.prototype.getLastError=En.prototype.La,En.prototype.getLastErrorCode=En.prototype.Da,En.prototype.getStatus=En.prototype.ba,En.prototype.getResponseJson=En.prototype.Qa,En.prototype.getResponseText=En.prototype.ga,En.prototype.send=En.prototype.ea;var cs=c.createWebChannelTransport=function(){return new rs},hs=c.getStatEventTarget=function(){return Yt()},ls=c.ErrorCode=re,ds=c.EventType=ie,fs=c.Event=Wt,ms=c.Stat={rb:0,ub:1,vb:2,Ob:3,Tb:4,Qb:5,Rb:6,Pb:7,Nb:8,Sb:9,PROXY:10,NOPROXY:11,Lb:12,Hb:13,Ib:14,Gb:15,Jb:16,Kb:17,nb:18,mb:19,ob:20},gs=c.FetchXmlHttpFactory=pn,ps=c.WebChannel=ue,ys=c.XhrIo=En;const ws="@firebase/firestore";class vs{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}vs.UNAUTHENTICATED=new vs(null),vs.GOOGLE_CREDENTIALS=new vs("google-credentials-uid"),vs.FIRST_PARTY=new vs("first-party-uid"),vs.MOCK_USER=new vs("mock-user");let Is="9.8.3";const bs=new o.Yd("@firebase/firestore");function Ts(){return bs.logLevel}function Es(t){bs.setLogLevel(t)}function Ss(t,...e){if(bs.logLevel<=o.in.DEBUG){const n=e.map(As);bs.debug(`Firestore (${Is}): ${t}`,...n)}}function xs(t,...e){if(bs.logLevel<=o.in.ERROR){const n=e.map(As);bs.error(`Firestore (${Is}): ${t}`,...n)}}function Ds(t,...e){if(bs.logLevel<=o.in.WARN){const n=e.map(As);bs.warn(`Firestore (${Is}): ${t}`,...n)}}function As(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function _s(t="Unexpected state"){const e=`FIRESTORE (${Is}) INTERNAL ASSERTION FAILED: `+t;throw xs(e),new Error(e)}function Ns(t,e){t||_s()}function Cs(t,e){t||_s()}function ks(t,e){return t}const Rs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Ms extends a.ZR{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Vs{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Ls{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Os{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(vs.UNAUTHENTICATED)))}shutdown(){}}class Fs{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class Ps{constructor(t){this.t=t,this.currentUser=vs.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const s=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let r=new Vs;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new Vs,t.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const e=r;t.enqueueRetryable((async()=>{await e.promise,await s(this.currentUser)}))},o=t=>{Ss("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(Ss("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new Vs)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(Ss("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Ns("string"==typeof e.accessToken),new Ls(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Ns(null===t||"string"==typeof t),new vs(t)}}class Us{constructor(t,e,n){this.type="FirstParty",this.user=vs.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",e);const s=t.auth.getAuthHeaderValueForFirstParty([]);s&&this.headers.set("Authorization",s),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class Bs{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new Us(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable((()=>e(vs.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class qs{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Ks{constructor(t){this.g=t,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(t,e){const n=t=>{null!=t.error&&Ss("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.p;return this.p=t.token,Ss("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const s=t=>{Ss("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.g.onInit((t=>s(t))),setTimeout((()=>{if(!this.appCheck){const t=this.g.getImmediate({optional:!0});t?s(t):Ss("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Ns("string"==typeof t.token),this.p=t.token,new qs(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Gs{getToken(){return Promise.resolve(new qs(""))}invalidateToken(){}start(t,e){}shutdown(){}}function js(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class $s{static I(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const s=js(40);for(let r=0;r<s.length;++r)n.length<20&&s[r]<e&&(n+=t.charAt(s[r]%t.length))}return n}}function zs(t,e){return t<e?-1:t>e?1:0}function Qs(t,e,n){return t.length===e.length&&t.every(((t,s)=>n(t,e[s])))}function Hs(t){return t+"\0"}class Ws{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Ms(Rs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Ms(Rs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Ms(Rs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Ms(Rs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return Ws.fromMillis(Date.now())}static fromDate(t){return Ws.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new Ws(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?zs(this.nanoseconds,t.nanoseconds):zs(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Xs{constructor(t){this.timestamp=t}static fromTimestamp(t){return new Xs(t)}static min(){return new Xs(new Ws(0,0))}static max(){return new Xs(new Ws(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Ys{constructor(t,e,n){void 0===e?e=0:e>t.length&&_s(),void 0===n?n=t.length-e:n>t.length-e&&_s(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===Ys.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof Ys?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let s=0;s<n;s++){const n=t.get(s),r=e.get(s);if(n<r)return-1;if(n>r)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class Js extends Ys{construct(t,e,n){return new Js(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Ms(Rs.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new Js(e)}static emptyPath(){return new Js([])}}const Zs=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class tr extends Ys{construct(t,e,n){return new tr(t,e,n)}static isValidIdentifier(t){return Zs.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),tr.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new tr(["__name__"])}static fromServerFormat(t){const e=[];let n="",s=0;const r=()=>{if(0===n.length)throw new Ms(Rs.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;s<t.length;){const e=t[s];if("\\"===e){if(s+1===t.length)throw new Ms(Rs.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[s+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Ms(Rs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,s+=2}else"`"===e?(i=!i,s++):"."!==e||i?(n+=e,s++):(r(),s++)}if(r(),i)throw new Ms(Rs.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new tr(e)}static emptyPath(){return new tr([])}}class er{constructor(t){this.path=t}static fromPath(t){return new er(Js.fromString(t))}static fromName(t){return new er(Js.fromString(t).popFirst(5))}static empty(){return new er(Js.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===Js.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return Js.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new er(new Js(t.slice()))}}class nr{constructor(t,e,n,s){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=s}}function sr(t){return t.fields.find((t=>2===t.kind))}function rr(t){return t.fields.filter((t=>2!==t.kind))}nr.UNKNOWN_ID=-1;class ir{constructor(t,e){this.fieldPath=t,this.kind=e}}class or{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new or(0,cr.min())}}function ar(t,e){const n=t.toTimestamp().seconds,s=t.toTimestamp().nanoseconds+1,r=Xs.fromTimestamp(1e9===s?new Ws(n+1,0):new Ws(n,s));return new cr(r,er.empty(),e)}function ur(t){return new cr(t.readTime,t.key,-1)}class cr{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new cr(Xs.min(),er.empty(),-1)}static max(){return new cr(Xs.max(),er.empty(),-1)}}function hr(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=er.comparator(t.documentKey,e.documentKey),0!==n?n:zs(t.largestBatchId,e.largestBatchId))}const lr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class dr{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function fr(t){if(t.code!==Rs.FAILED_PRECONDITION||t.message!==lr)throw t;Ss("LocalStore","Unexpectedly lost primary lease")}class mr{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&_s(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new mr(((n,s)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,s)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,s)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof mr?e:mr.resolve(e)}catch(t){return mr.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):mr.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):mr.reject(e)}static resolve(t){return new mr(((e,n)=>{e(t)}))}static reject(t){return new mr(((e,n)=>{n(t)}))}static waitFor(t){return new mr(((e,n)=>{let s=0,r=0,i=!1;t.forEach((t=>{++s,t.next((()=>{++r,i&&r===s&&e()}),(t=>n(t)))})),i=!0,r===s&&e()}))}static or(t){let e=mr.resolve(!1);for(const n of t)e=e.next((t=>t?mr.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,s)=>{n.push(e.call(this,t,s))})),this.waitFor(n)}static mapArray(t,e){return new mr(((n,s)=>{const r=t.length,i=new Array(r);let o=0;for(let a=0;a<r;a++){const u=a;e(t[u]).next((t=>{i[u]=t,++o,o===r&&n(i)}),(t=>s(t)))}}))}static doWhile(t,e){return new mr(((n,s)=>{const r=()=>{!0===t()?e().next((()=>{r()}),s):n()};r()}))}}class gr{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.T=new Vs,this.transaction.oncomplete=()=>{this.T.resolve()},this.transaction.onabort=()=>{e.error?this.T.reject(new wr(t,e.error)):this.T.resolve()},this.transaction.onerror=e=>{const n=Er(e.target.error);this.T.reject(new wr(t,n))}}static open(t,e,n,s){try{return new gr(e,t.transaction(s,n))}catch(t){throw new wr(e,t)}}get A(){return this.T.promise}abort(t){t&&this.T.reject(t),this.aborted||(Ss("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}R(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new Ir(e)}}class pr{constructor(t,e,n){this.name=t,this.version=e,this.P=n,12.2===pr.v((0,a.z$)())&&xs("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return Ss("SimpleDb","Removing database:",t),br(window.indexedDB.deleteDatabase(t)).toPromise()}static V(){if(!(0,a.hl)())return!1;if(pr.S())return!0;const t=(0,a.z$)(),e=pr.v(t),n=0<e&&e<10,s=pr.D(t),r=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||r)}static S(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.C)}static N(t,e){return t.store(e)}static v(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static D(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async k(t){return this.db||(Ss("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{const n=t.target.result;e(n)},s.onblocked=()=>{n(new wr(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{const s=e.target.error;"VersionError"===s.name?n(new Ms(Rs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new Ms(Rs.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new wr(t,s))},s.onupgradeneeded=t=>{Ss("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.P.O(e,s.transaction,t.oldVersion,this.version).next((()=>{Ss("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.M&&(this.db.onversionchange=t=>this.M(t)),this.db}F(t){this.M=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,s){const r="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.k(t);const e=gr.open(this.db,t,r?"readonly":"readwrite",n),i=s(e).next((t=>(e.R(),t))).catch((t=>(e.abort(t),mr.reject(t)))).toPromise();return i.catch((()=>{})),await e.A,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(Ss("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class yr{constructor(t){this.$=t,this.B=!1,this.L=null}get isDone(){return this.B}get U(){return this.L}set cursor(t){this.$=t}done(){this.B=!0}q(t){this.L=t}delete(){return br(this.$.delete())}}class wr extends Ms{constructor(t,e){super(Rs.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function vr(t){return"IndexedDbTransactionError"===t.name}class Ir{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(Ss("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(Ss("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),br(n)}add(t){return Ss("SimpleDb","ADD",this.store.name,t,t),br(this.store.add(t))}get(t){return br(this.store.get(t)).next((e=>(void 0===e&&(e=null),Ss("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return Ss("SimpleDb","DELETE",this.store.name,t),br(this.store.delete(t))}count(){return Ss("SimpleDb","COUNT",this.store.name),br(this.store.count())}K(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.G(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new mr(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}j(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new mr(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}W(t,e){Ss("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.H=!1;const s=this.cursor(n);return this.G(s,((t,e,n)=>n.delete()))}J(t,e){let n;e?n=t:(n={},e=t);const s=this.cursor(n);return this.G(s,e)}Y(t){const e=this.cursor({});return new mr(((n,s)=>{e.onerror=t=>{const e=Er(t.target.error);s(e)},e.onsuccess=e=>{const s=e.target.result;s?t(s.primaryKey,s.value).next((t=>{t?s.continue():n()})):n()}}))}G(t,e){const n=[];return new mr(((s,r)=>{t.onerror=t=>{r(t.target.error)},t.onsuccess=t=>{const r=t.target.result;if(!r)return void s();const i=new yr(r),o=e(r.primaryKey,r.value,i);if(o instanceof mr){const t=o.catch((t=>(i.done(),mr.reject(t))));n.push(t)}i.isDone?s():null===i.U?r.continue():r.continue(i.U)}})).next((()=>mr.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.H?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function br(t){return new mr(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Er(t.target.error);n(e)}}))}let Tr=!1;function Er(t){const e=pr.v((0,a.z$)());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Ms("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Tr||(Tr=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Sr{constructor(t,e){this.asyncQueue=t,this.X=e,this.task=null}start(){}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}Z(t){Ss("IndexBackiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{Ss("IndexBackiller",`Documents written: ${await this.X.tt()}`)}catch(t){vr(t)?Ss("IndexBackiller","Ignoring IndexedDB error during index backfill: ",t):await fr(t)}await this.Z(1)}))}}class xr{constructor(t,e){this.localStore=t,this.persistence=e}async tt(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.et(e,t)))}et(t,e){const n=new Set;let s=e,r=!0;return mr.doWhile((()=>!0===r&&s>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return Ss("IndexBackiller",`Processing collection: ${e}`),this.nt(t,e,s).next((t=>{s-=t,n.add(e)}));r=!1})))).next((()=>e-s))}nt(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((s=>this.localStore.localDocuments.getNextDocuments(t,e,s,n).next((n=>{const r=n.changes;return this.localStore.indexManager.updateIndexEntries(t,r).next((()=>this.st(s,n))).next((n=>(Ss("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>r.size))}))))}st(t,e){let n=t;return e.changes.forEach(((t,e)=>{const s=ur(e);hr(s,n)>0&&(n=s)})),new cr(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Dr{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.it(t),this.rt=t=>e.writeSequenceNumber(t))}it(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.rt&&this.rt(t),t}}function Ar(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function _r(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Nr(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}Dr.ot=-1;class Cr{constructor(t,e){this.comparator=t,this.root=e||Rr.EMPTY}insert(t,e){return new Cr(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Rr.BLACK,null,null))}remove(t){return new Cr(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Rr.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(t,n.key);if(0===s)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new kr(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new kr(this.root,t,this.comparator,!1)}getReverseIterator(){return new kr(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new kr(this.root,t,this.comparator,!0)}}class kr{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?n(t.key,e):1,e&&s&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Rr{constructor(t,e,n,s,r){this.key=t,this.value=e,this.color=null!=n?n:Rr.RED,this.left=null!=s?s:Rr.EMPTY,this.right=null!=r?r:Rr.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,r){return new Rr(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this;const r=n(t,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(t,e,n),null):0===r?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return Rr.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===e(t,s.key)){if(s.right.isEmpty())return Rr.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Rr.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Rr.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw _s();if(this.right.isRed())throw _s();const t=this.left.check();if(t!==this.right.check())throw _s();return t+(this.isRed()?0:1)}}Rr.EMPTY=null,Rr.RED=!0,Rr.BLACK=!1,Rr.EMPTY=new class{constructor(){this.size=0}get key(){throw _s()}get value(){throw _s()}get color(){throw _s()}get left(){throw _s()}get right(){throw _s()}copy(t,e,n,s,r){return this}insert(t,e,n){return new Rr(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Mr{constructor(t){this.comparator=t,this.data=new Cr(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Vr(this.data.getIterator())}getIteratorFrom(t){return new Vr(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Mr))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(0!==this.comparator(t,s))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Mr(this.comparator);return e.data=t,e}}class Vr{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Lr(t){return t.hasNext()?t.getNext():void 0}class Or{constructor(t){this.fields=t,t.sort(tr.comparator)}static empty(){return new Or([])}unionWith(t){let e=new Mr(tr.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new Or(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return Qs(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function Fr(){return"undefined"!=typeof atob}class Pr{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new Pr(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Pr(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return zs(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Pr.EMPTY_BYTE_STRING=new Pr("");const Ur=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Br(t){if(Ns(!!t),"string"==typeof t){let e=0;const n=Ur.exec(t);if(Ns(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const s=new Date(t);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:qr(t.seconds),nanos:qr(t.nanos)}}function qr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Kr(t){return"string"==typeof t?Pr.fromBase64String(t):Pr.fromUint8Array(t)}function Gr(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function jr(t){const e=t.mapValue.fields.__previous_value__;return Gr(e)?jr(e):e}function $r(t){const e=Br(t.mapValue.fields.__local_write_time__.timestampValue);return new Ws(e.seconds,e.nanos)}class zr{constructor(t,e,n,s,r,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Qr{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new Qr("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Qr&&t.projectId===this.projectId&&t.database===this.database}}function Hr(t){return null==t}function Wr(t){return 0===t&&1/t==-1/0}function Xr(t){return"number"==typeof t&&Number.isInteger(t)&&!Wr(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}const Yr={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Jr={nullValue:"NULL_VALUE"};function Zr(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?Gr(t)?4:fi(t)?9007199254740991:10:_s()}function ti(t,e){if(t===e)return!0;const n=Zr(t);if(n!==Zr(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return $r(t).isEqual($r(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Br(t.timestampValue),s=Br(e.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return Kr(t.bytesValue).isEqual(Kr(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return qr(t.geoPointValue.latitude)===qr(e.geoPointValue.latitude)&&qr(t.geoPointValue.longitude)===qr(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return qr(t.integerValue)===qr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=qr(t.doubleValue),s=qr(e.doubleValue);return n===s?Wr(n)===Wr(s):isNaN(n)&&isNaN(s)}return!1}(t,e);case 9:return Qs(t.arrayValue.values||[],e.arrayValue.values||[],ti);case 10:return function(t,e){const n=t.mapValue.fields||{},s=e.mapValue.fields||{};if(Ar(n)!==Ar(s))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===s[t]||!ti(n[t],s[t])))return!1;return!0}(t,e);default:return _s()}}function ei(t,e){return void 0!==(t.values||[]).find((t=>ti(t,e)))}function ni(t,e){if(t===e)return 0;const n=Zr(t),s=Zr(e);if(n!==s)return zs(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return zs(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=qr(t.integerValue||t.doubleValue),s=qr(e.integerValue||e.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(t,e);case 3:return si(t.timestampValue,e.timestampValue);case 4:return si($r(t),$r(e));case 5:return zs(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Kr(t),s=Kr(e);return n.compareTo(s)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),s=e.split("/");for(let t=0;t<n.length&&t<s.length;t++){const e=zs(n[t],s[t]);if(0!==e)return e}return zs(n.length,s.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=zs(qr(t.latitude),qr(e.latitude));return 0!==n?n:zs(qr(t.longitude),qr(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],s=e.values||[];for(let t=0;t<n.length&&t<s.length;++t){const e=ni(n[t],s[t]);if(e)return e}return zs(n.length,s.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===Yr.mapValue&&e===Yr.mapValue)return 0;if(t===Yr.mapValue)return 1;if(e===Yr.mapValue)return-1;const n=t.fields||{},s=Object.keys(n),r=e.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let t=0;t<s.length&&t<i.length;++t){const e=zs(s[t],i[t]);if(0!==e)return e;const o=ni(n[s[t]],r[i[t]]);if(0!==o)return o}return zs(s.length,i.length)}(t.mapValue,e.mapValue);default:throw _s()}}function si(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return zs(t,e);const n=Br(t),s=Br(e),r=zs(n.seconds,s.seconds);return 0!==r?r:zs(n.nanos,s.nanos)}function ri(t){return ii(t)}function ii(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Br(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?Kr(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,er.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const s of t.values||[])n?n=!1:e+=",",e+=ii(s);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",s=!0;for(const r of e)s?s=!1:n+=",",n+=`${r}:${ii(t.fields[r])}`;return n+"}"}(t.mapValue):_s();var e,n}function oi(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function ai(t){return!!t&&"integerValue"in t}function ui(t){return!!t&&"arrayValue"in t}function ci(t){return!!t&&"nullValue"in t}function hi(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function li(t){return!!t&&"mapValue"in t}function di(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return _r(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=di(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=di(t.arrayValue.values[n]);return e}return Object.assign({},t)}function fi(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function mi(t){return"nullValue"in t?Jr:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?oi(Qr.empty(),er.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:_s()}function gi(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?oi(Qr.empty(),er.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?Yr:_s()}function pi(t,e){const n=ni(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function yi(t,e){const n=ni(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class wi{constructor(t){this.value=t}static empty(){return new wi({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!li(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=di(e)}setAll(t){let e=tr.emptyPath(),n={},s=[];t.forEach(((t,r)=>{if(!e.isImmediateParentOf(r)){const t=this.getFieldsMap(e);this.applyChanges(t,n,s),n={},s=[],e=r.popLast()}t?n[r.lastSegment()]=di(t):s.push(r.lastSegment())}));const r=this.getFieldsMap(e);this.applyChanges(r,n,s)}delete(t){const e=this.field(t.popLast());li(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return ti(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];li(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){_r(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new wi(di(this.value))}}function vi(t){const e=[];return _r(t.fields,((t,n)=>{const s=new tr([t]);if(li(n)){const t=vi(n.mapValue).fields;if(0===t.length)e.push(s);else for(const n of t)e.push(s.child(n))}else e.push(s)})),new Or(e)}class Ii{constructor(t,e,n,s,r,i){this.key=t,this.documentType=e,this.version=n,this.readTime=s,this.data=r,this.documentState=i}static newInvalidDocument(t){return new Ii(t,0,Xs.min(),Xs.min(),wi.empty(),0)}static newFoundDocument(t,e,n){return new Ii(t,1,e,Xs.min(),n,0)}static newNoDocument(t,e){return new Ii(t,2,e,Xs.min(),wi.empty(),0)}static newUnknownDocument(t,e){return new Ii(t,3,e,Xs.min(),wi.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=wi.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=wi.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Xs.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Ii&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Ii(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class bi{constructor(t,e=null,n=[],s=[],r=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.ut=null}}function Ti(t,e=null,n=[],s=[],r=null,i=null,o=null){return new bi(t,e,n,s,r,i,o)}function Ei(t){const e=ks(t);if(null===e.ut){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>{return(e=t).field.canonicalString()+e.op.toString()+ri(e.value);var e})).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),Hr(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>ri(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>ri(t))).join(",")),e.ut=t}return e.ut}function Si(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!Bi(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let r=0;r<t.filters.length;r++)if(n=t.filters[r],s=e.filters[r],n.op!==s.op||!n.field.isEqual(s.field)||!ti(n.value,s.value))return!1;var n,s;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Ki(t.startAt,e.startAt)&&Ki(t.endAt,e.endAt)}function xi(t){return er.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function Di(t,e){return t.filters.filter((t=>t instanceof Ni&&t.field.isEqual(e)))}function Ai(t,e,n){let s=Jr,r=!0;for(const n of Di(t,e)){let t=Jr,e=!0;switch(n.op){case"<":case"<=":t=mi(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=Jr}pi({value:s,inclusive:r},{value:t,inclusive:e})<0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];pi({value:s,inclusive:r},{value:t,inclusive:n.inclusive})<0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}function _i(t,e,n){let s=Yr,r=!0;for(const n of Di(t,e)){let t=Yr,e=!0;switch(n.op){case">=":case">":t=gi(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=Yr}yi({value:s,inclusive:r},{value:t,inclusive:e})>0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];yi({value:s,inclusive:r},{value:t,inclusive:n.inclusive})>0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}class Ni extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.ct(t,e,n):new Ci(t,e,n):"array-contains"===e?new Vi(t,n):"in"===e?new Li(t,n):"not-in"===e?new Oi(t,n):"array-contains-any"===e?new Fi(t,n):new Ni(t,e,n)}static ct(t,e,n){return"in"===e?new ki(t,n):new Ri(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.at(ni(e,this.value)):null!==e&&Zr(this.value)===Zr(e)&&this.at(ni(e,this.value))}at(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return _s()}}ht(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Ci extends Ni{constructor(t,e,n){super(t,e,n),this.key=er.fromName(n.referenceValue)}matches(t){const e=er.comparator(t.key,this.key);return this.at(e)}}class ki extends Ni{constructor(t,e){super(t,"in",e),this.keys=Mi(0,e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class Ri extends Ni{constructor(t,e){super(t,"not-in",e),this.keys=Mi(0,e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Mi(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>er.fromName(t.referenceValue)))}class Vi extends Ni{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return ui(e)&&ei(e.arrayValue,this.value)}}class Li extends Ni{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&ei(this.value.arrayValue,e)}}class Oi extends Ni{constructor(t,e){super(t,"not-in",e)}matches(t){if(ei(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!ei(this.value.arrayValue,e)}}class Fi extends Ni{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!ui(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>ei(this.value.arrayValue,t)))}}class Pi{constructor(t,e){this.position=t,this.inclusive=e}}class Ui{constructor(t,e="asc"){this.field=t,this.dir=e}}function Bi(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function qi(t,e,n){let s=0;for(let r=0;r<t.position.length;r++){const i=e[r],o=t.position[r];if(s=i.field.isKeyField()?er.comparator(er.fromName(o.referenceValue),n.key):ni(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function Ki(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!ti(t.position[n],e.position[n]))return!1;return!0}class Gi{constructor(t,e=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this.lt=null,this.ft=null,this.startAt,this.endAt}}function ji(t,e,n,s,r,i,o,a){return new Gi(t,e,n,s,r,i,o,a)}function $i(t){return new Gi(t)}function zi(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function Qi(t){for(const e of t.filters)if(e.ht())return e.field;return null}function Hi(t){return null!==t.collectionGroup}function Wi(t){const e=ks(t);if(null===e.lt){e.lt=[];const t=Qi(e),n=zi(e);if(null!==t&&null===n)t.isKeyField()||e.lt.push(new Ui(t)),e.lt.push(new Ui(tr.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e.lt.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e.lt.push(new Ui(tr.keyField(),t))}}}return e.lt}function Xi(t){const e=ks(t);if(!e.ft)if("F"===e.limitType)e.ft=Ti(e.path,e.collectionGroup,Wi(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of Wi(e)){const e="desc"===n.dir?"asc":"desc";t.push(new Ui(n.field,e))}const n=e.endAt?new Pi(e.endAt.position,e.endAt.inclusive):null,s=e.startAt?new Pi(e.startAt.position,e.startAt.inclusive):null;e.ft=Ti(e.path,e.collectionGroup,t,e.filters,e.limit,n,s)}return e.ft}function Yi(t,e,n){return new Gi(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Ji(t,e){return Si(Xi(t),Xi(e))&&t.limitType===e.limitType}function Zi(t){return`${Ei(Xi(t))}|lt:${t.limitType}`}function to(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${ri(e.value)}`;var e})).join(", ")}]`),Hr(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>ri(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>ri(t))).join(",")),`Target(${e})`}(Xi(t))}; limitType=${t.limitType})`}function eo(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):er.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const s=qi(t,e,n);return t.inclusive?s<=0:s<0}(t.startAt,Wi(t),e)||t.endAt&&!function(t,e,n){const s=qi(t,e,n);return t.inclusive?s>=0:s>0}(t.endAt,Wi(t),e))}(t,e)}function no(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function so(t){return(e,n)=>{let s=!1;for(const r of Wi(t)){const t=ro(r,e,n);if(0!==t)return t;s=s||r.field.isKeyField()}return 0}}function ro(t,e,n){const s=t.field.isKeyField()?er.comparator(e.key,n.key):function(t,e,n){const s=e.data.field(t),r=n.data.field(t);return null!==s&&null!==r?ni(s,r):_s()}(t.field,e,n);switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return _s()}}function io(t,e){if(t.dt){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Wr(e)?"-0":e}}function oo(t){return{integerValue:""+t}}function ao(t,e){return Xr(e)?oo(e):io(t,e)}class uo{constructor(){this._=void 0}}function co(t,e,n){return t instanceof fo?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof mo?go(t,e):t instanceof po?yo(t,e):function(t,e){const n=lo(t,e),s=vo(n)+vo(t._t);return ai(n)&&ai(t._t)?oo(s):io(t.wt,s)}(t,e)}function ho(t,e,n){return t instanceof mo?go(t,e):t instanceof po?yo(t,e):n}function lo(t,e){return t instanceof wo?ai(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class fo extends uo{}class mo extends uo{constructor(t){super(),this.elements=t}}function go(t,e){const n=Io(e);for(const e of t.elements)n.some((t=>ti(t,e)))||n.push(e);return{arrayValue:{values:n}}}class po extends uo{constructor(t){super(),this.elements=t}}function yo(t,e){let n=Io(e);for(const e of t.elements)n=n.filter((t=>!ti(t,e)));return{arrayValue:{values:n}}}class wo extends uo{constructor(t,e){super(),this.wt=t,this._t=e}}function vo(t){return qr(t.integerValue||t.doubleValue)}function Io(t){return ui(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class bo{constructor(t,e){this.field=t,this.transform=e}}class To{constructor(t,e){this.version=t,this.transformResults=e}}class Eo{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Eo}static exists(t){return new Eo(void 0,t)}static updateTime(t){return new Eo(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function So(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class xo{}function Do(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new Oo(t.key,Eo.none()):new ko(t.key,t.data,Eo.none());{const n=t.data,s=wi.empty();let r=new Mr(tr.comparator);for(let t of e.fields)if(!r.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?s.delete(t):s.set(t,e),r=r.add(t)}return new Ro(t.key,s,new Or(r.toArray()),Eo.none())}}function Ao(t,e,n){t instanceof ko?function(t,e,n){const s=t.value.clone(),r=Vo(t.fieldTransforms,e,n.transformResults);s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):t instanceof Ro?function(t,e,n){if(!So(t.precondition,e))return void e.convertToUnknownDocument(n.version);const s=Vo(t.fieldTransforms,e,n.transformResults),r=e.data;r.setAll(Mo(t)),r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function _o(t,e,n,s){return t instanceof ko?function(t,e,n,s){if(!So(t.precondition,e))return n;const r=t.value.clone(),i=Lo(t.fieldTransforms,s,e);return r.setAll(i),e.convertToFoundDocument(e.version,r).setHasLocalMutations(),null}(t,e,n,s):t instanceof Ro?function(t,e,n,s){if(!So(t.precondition,e))return n;const r=Lo(t.fieldTransforms,s,e),i=e.data;return i.setAll(Mo(t)),i.setAll(r),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,s):function(t,e,n){return So(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function No(t,e){let n=null;for(const s of t.fieldTransforms){const t=e.data.field(s.field),r=lo(s.transform,t||null);null!=r&&(null===n&&(n=wi.empty()),n.set(s.field,r))}return n||null}function Co(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&Qs(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof mo&&e instanceof mo||t instanceof po&&e instanceof po?Qs(t.elements,e.elements,ti):t instanceof wo&&e instanceof wo?ti(t._t,e._t):t instanceof fo&&e instanceof fo}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class ko extends xo{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}}class Ro extends xo{constructor(t,e,n,s,r=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Mo(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=t.data.field(n);e.set(n,s)}})),e}function Vo(t,e,n){const s=new Map;Ns(t.length===n.length);for(let r=0;r<n.length;r++){const i=t[r],o=i.transform,a=e.data.field(i.field);s.set(i.field,ho(o,a,n[r]))}return s}function Lo(t,e,n){const s=new Map;for(const r of t){const t=r.transform,i=n.data.field(r.field);s.set(r.field,co(t,i,e))}return s}class Oo extends xo{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Fo extends xo{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Po{constructor(t){this.count=t}}var Uo,Bo;function qo(t){switch(t){default:return _s();case Rs.CANCELLED:case Rs.UNKNOWN:case Rs.DEADLINE_EXCEEDED:case Rs.RESOURCE_EXHAUSTED:case Rs.INTERNAL:case Rs.UNAVAILABLE:case Rs.UNAUTHENTICATED:return!1;case Rs.INVALID_ARGUMENT:case Rs.NOT_FOUND:case Rs.ALREADY_EXISTS:case Rs.PERMISSION_DENIED:case Rs.FAILED_PRECONDITION:case Rs.ABORTED:case Rs.OUT_OF_RANGE:case Rs.UNIMPLEMENTED:case Rs.DATA_LOSS:return!0}}function Ko(t){if(void 0===t)return xs("GRPC error has no .code"),Rs.UNKNOWN;switch(t){case Uo.OK:return Rs.OK;case Uo.CANCELLED:return Rs.CANCELLED;case Uo.UNKNOWN:return Rs.UNKNOWN;case Uo.DEADLINE_EXCEEDED:return Rs.DEADLINE_EXCEEDED;case Uo.RESOURCE_EXHAUSTED:return Rs.RESOURCE_EXHAUSTED;case Uo.INTERNAL:return Rs.INTERNAL;case Uo.UNAVAILABLE:return Rs.UNAVAILABLE;case Uo.UNAUTHENTICATED:return Rs.UNAUTHENTICATED;case Uo.INVALID_ARGUMENT:return Rs.INVALID_ARGUMENT;case Uo.NOT_FOUND:return Rs.NOT_FOUND;case Uo.ALREADY_EXISTS:return Rs.ALREADY_EXISTS;case Uo.PERMISSION_DENIED:return Rs.PERMISSION_DENIED;case Uo.FAILED_PRECONDITION:return Rs.FAILED_PRECONDITION;case Uo.ABORTED:return Rs.ABORTED;case Uo.OUT_OF_RANGE:return Rs.OUT_OF_RANGE;case Uo.UNIMPLEMENTED:return Rs.UNIMPLEMENTED;case Uo.DATA_LOSS:return Rs.DATA_LOSS;default:return _s()}}(Bo=Uo||(Uo={}))[Bo.OK=0]="OK",Bo[Bo.CANCELLED=1]="CANCELLED",Bo[Bo.UNKNOWN=2]="UNKNOWN",Bo[Bo.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Bo[Bo.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Bo[Bo.NOT_FOUND=5]="NOT_FOUND",Bo[Bo.ALREADY_EXISTS=6]="ALREADY_EXISTS",Bo[Bo.PERMISSION_DENIED=7]="PERMISSION_DENIED",Bo[Bo.UNAUTHENTICATED=16]="UNAUTHENTICATED",Bo[Bo.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Bo[Bo.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Bo[Bo.ABORTED=10]="ABORTED",Bo[Bo.OUT_OF_RANGE=11]="OUT_OF_RANGE",Bo[Bo.UNIMPLEMENTED=12]="UNIMPLEMENTED",Bo[Bo.INTERNAL=13]="INTERNAL",Bo[Bo.UNAVAILABLE=14]="UNAVAILABLE",Bo[Bo.DATA_LOSS=15]="DATA_LOSS";class Go{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,s]of n)if(this.equalsFn(e,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),s=this.inner[n];if(void 0===s)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],t))return void(s[n]=[t,e]);s.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return 1===n.length?delete this.inner[e]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(t){_r(this.inner,((e,n)=>{for(const[e,s]of n)t(e,s)}))}isEmpty(){return Nr(this.inner)}size(){return this.innerSize}}const jo=new Cr(er.comparator);function $o(){return jo}const zo=new Cr(er.comparator);function Qo(...t){let e=zo;for(const n of t)e=e.insert(n.key,n);return e}function Ho(t){let e=zo;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function Wo(){return Yo()}function Xo(){return Yo()}function Yo(){return new Go((t=>t.toString()),((t,e)=>t.isEqual(e)))}const Jo=new Cr(er.comparator),Zo=new Mr(er.comparator);function ta(...t){let e=Zo;for(const n of t)e=e.add(n);return e}const ea=new Mr(zs);function na(){return ea}class sa{constructor(t,e,n,s,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,ra.createSynthesizedTargetChangeForCurrentChange(t,e)),new sa(Xs.min(),n,na(),$o(),ta())}}class ra{constructor(t,e,n,s,r){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e){return new ra(Pr.EMPTY_BYTE_STRING,e,ta(),ta(),ta())}}class ia{constructor(t,e,n,s){this.gt=t,this.removedTargetIds=e,this.key=n,this.yt=s}}class oa{constructor(t,e){this.targetId=t,this.It=e}}class aa{constructor(t,e,n=Pr.EMPTY_BYTE_STRING,s=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=s}}class ua{constructor(){this.Tt=0,this.Et=la(),this.At=Pr.EMPTY_BYTE_STRING,this.Rt=!1,this.bt=!0}get current(){return this.Rt}get resumeToken(){return this.At}get Pt(){return 0!==this.Tt}get vt(){return this.bt}Vt(t){t.approximateByteSize()>0&&(this.bt=!0,this.At=t)}St(){let t=ta(),e=ta(),n=ta();return this.Et.forEach(((s,r)=>{switch(r){case 0:t=t.add(s);break;case 2:e=e.add(s);break;case 1:n=n.add(s);break;default:_s()}})),new ra(this.At,this.Rt,t,e,n)}Dt(){this.bt=!1,this.Et=la()}Ct(t,e){this.bt=!0,this.Et=this.Et.insert(t,e)}xt(t){this.bt=!0,this.Et=this.Et.remove(t)}Nt(){this.Tt+=1}kt(){this.Tt-=1}Ot(){this.bt=!0,this.Rt=!0}}class ca{constructor(t){this.Mt=t,this.Ft=new Map,this.$t=$o(),this.Bt=ha(),this.Lt=new Mr(zs)}Ut(t){for(const e of t.gt)t.yt&&t.yt.isFoundDocument()?this.qt(e,t.yt):this.Kt(e,t.key,t.yt);for(const e of t.removedTargetIds)this.Kt(e,t.key,t.yt)}Gt(t){this.forEachTarget(t,(e=>{const n=this.Qt(e);switch(t.state){case 0:this.jt(e)&&n.Vt(t.resumeToken);break;case 1:n.kt(),n.Pt||n.Dt(),n.Vt(t.resumeToken);break;case 2:n.kt(),n.Pt||this.removeTarget(e);break;case 3:this.jt(e)&&(n.Ot(),n.Vt(t.resumeToken));break;case 4:this.jt(e)&&(this.Wt(e),n.Vt(t.resumeToken));break;default:_s()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Ft.forEach(((t,n)=>{this.jt(n)&&e(n)}))}zt(t){const e=t.targetId,n=t.It.count,s=this.Ht(e);if(s){const t=s.target;if(xi(t))if(0===n){const n=new er(t.path);this.Kt(e,n,Ii.newNoDocument(n,Xs.min()))}else Ns(1===n);else this.Jt(e)!==n&&(this.Wt(e),this.Lt=this.Lt.add(e))}}Yt(t){const e=new Map;this.Ft.forEach(((n,s)=>{const r=this.Ht(s);if(r){if(n.current&&xi(r.target)){const e=new er(r.target.path);null!==this.$t.get(e)||this.Xt(s,e)||this.Kt(s,e,Ii.newNoDocument(e,t))}n.vt&&(e.set(s,n.St()),n.Dt())}}));let n=ta();this.Bt.forEach(((t,e)=>{let s=!0;e.forEachWhile((t=>{const e=this.Ht(t);return!e||2===e.purpose||(s=!1,!1)})),s&&(n=n.add(t))})),this.$t.forEach(((e,n)=>n.setReadTime(t)));const s=new sa(t,e,this.Lt,this.$t,n);return this.$t=$o(),this.Bt=ha(),this.Lt=new Mr(zs),s}qt(t,e){if(!this.jt(t))return;const n=this.Xt(t,e.key)?2:0;this.Qt(t).Ct(e.key,n),this.$t=this.$t.insert(e.key,e),this.Bt=this.Bt.insert(e.key,this.Zt(e.key).add(t))}Kt(t,e,n){if(!this.jt(t))return;const s=this.Qt(t);this.Xt(t,e)?s.Ct(e,1):s.xt(e),this.Bt=this.Bt.insert(e,this.Zt(e).delete(t)),n&&(this.$t=this.$t.insert(e,n))}removeTarget(t){this.Ft.delete(t)}Jt(t){const e=this.Qt(t).St();return this.Mt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Nt(t){this.Qt(t).Nt()}Qt(t){let e=this.Ft.get(t);return e||(e=new ua,this.Ft.set(t,e)),e}Zt(t){let e=this.Bt.get(t);return e||(e=new Mr(zs),this.Bt=this.Bt.insert(t,e)),e}jt(t){const e=null!==this.Ht(t);return e||Ss("WatchChangeAggregator","Detected inactive target",t),e}Ht(t){const e=this.Ft.get(t);return e&&e.Pt?null:this.Mt.te(t)}Wt(t){this.Ft.set(t,new ua),this.Mt.getRemoteKeysForTarget(t).forEach((e=>{this.Kt(t,e,null)}))}Xt(t,e){return this.Mt.getRemoteKeysForTarget(t).has(e)}}function ha(){return new Cr(er.comparator)}function la(){return new Cr(er.comparator)}const da={asc:"ASCENDING",desc:"DESCENDING"},fa={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class ma{constructor(t,e){this.databaseId=t,this.dt=e}}function ga(t,e){return t.dt?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function pa(t,e){return t.dt?e.toBase64():e.toUint8Array()}function ya(t,e){return ga(t,e.toTimestamp())}function wa(t){return Ns(!!t),Xs.fromTimestamp(function(t){const e=Br(t);return new Ws(e.seconds,e.nanos)}(t))}function va(t,e){return function(t){return new Js(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Ia(t){const e=Js.fromString(t);return Ns(Ka(e)),e}function ba(t,e){return va(t.databaseId,e.path)}function Ta(t,e){const n=Ia(e);if(n.get(1)!==t.databaseId.projectId)throw new Ms(Rs.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Ms(Rs.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new er(Da(n))}function Ea(t,e){return va(t.databaseId,e)}function Sa(t){const e=Ia(t);return 4===e.length?Js.emptyPath():Da(e)}function xa(t){return new Js(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Da(t){return Ns(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Aa(t,e,n){return{name:ba(t,e),fields:n.value.mapValue.fields}}function _a(t,e,n){const s=Ta(t,e.name),r=wa(e.updateTime),i=new wi({mapValue:{fields:e.fields}}),o=Ii.newFoundDocument(s,r,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Na(t,e){let n;if(e instanceof ko)n={update:Aa(t,e.key,e.value)};else if(e instanceof Oo)n={delete:ba(t,e.key)};else if(e instanceof Ro)n={update:Aa(t,e.key,e.data),updateMask:qa(e.fieldMask)};else{if(!(e instanceof Fo))return _s();n={verify:ba(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof fo)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof mo)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof po)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof wo)return{fieldPath:e.field.canonicalString(),increment:n._t};throw _s()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:ya(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:_s()}(t,e.precondition)),n}function Ca(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Eo.updateTime(wa(t.updateTime)):void 0!==t.exists?Eo.exists(t.exists):Eo.none()}(e.currentDocument):Eo.none(),s=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Ns("REQUEST_TIME"===e.setToServerValue),n=new fo;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new mo(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new po(t)}else"increment"in e?n=new wo(t,e.increment):_s();const s=tr.fromServerFormat(e.fieldPath);return new bo(s,n)}(t,e))):[];if(e.update){e.update.name;const r=Ta(t,e.update.name),i=new wi({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Or(e.map((t=>tr.fromServerFormat(t))))}(e.updateMask);return new Ro(r,i,t,n,s)}return new ko(r,i,n,s)}if(e.delete){const s=Ta(t,e.delete);return new Oo(s,n)}if(e.verify){const s=Ta(t,e.verify);return new Fo(s,n)}return _s()}function ka(t,e){return{documents:[Ea(t,e.path)]}}function Ra(t,e){const n={structuredQuery:{}},s=e.path;null!==e.collectionGroup?(n.parent=Ea(t,s),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=Ea(t,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(hi(t.value))return{unaryFilter:{field:Fa(t.field),op:"IS_NAN"}};if(ci(t.value))return{unaryFilter:{field:Fa(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(hi(t.value))return{unaryFilter:{field:Fa(t.field),op:"IS_NOT_NAN"}};if(ci(t.value))return{unaryFilter:{field:Fa(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Fa(t.field),op:Oa(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);r&&(n.structuredQuery.where=r);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Fa(t.field),direction:La(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.dt||Hr(e)?e:{value:e}}(t,e.limit);var a;return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt={before:(a=e.startAt).inclusive,values:a.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function Ma(t){let e=Sa(t.parent);const n=t.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){Ns(1===s);const t=n.from[0];t.allDescendants?r=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=Va(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new Ui(Pa(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,Hr(e)?null:e}(n.limit));let u=null;n.startAt&&(u=function(t){const e=!!t.before,n=t.values||[];return new Pi(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new Pi(n,e)}(n.endAt)),ji(e,r,o,i,a,"F",u,c)}function Va(t){return t?void 0!==t.unaryFilter?[Ba(t)]:void 0!==t.fieldFilter?[Ua(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>Va(t))).reduce(((t,e)=>t.concat(e))):_s():[]}function La(t){return da[t]}function Oa(t){return fa[t]}function Fa(t){return{fieldPath:t.canonicalString()}}function Pa(t){return tr.fromServerFormat(t.fieldPath)}function Ua(t){return Ni.create(Pa(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return _s()}}(t.fieldFilter.op),t.fieldFilter.value)}function Ba(t){switch(t.unaryFilter.op){case"IS_NAN":const e=Pa(t.unaryFilter.field);return Ni.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=Pa(t.unaryFilter.field);return Ni.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=Pa(t.unaryFilter.field);return Ni.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=Pa(t.unaryFilter.field);return Ni.create(r,"!=",{nullValue:"NULL_VALUE"});default:return _s()}}function qa(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Ka(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function Ga(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=$a(e)),e=ja(t.get(n),e);return $a(e)}function ja(t,e){let n=e;const s=t.length;for(let e=0;e<s;e++){const s=t.charAt(e);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function $a(t){return t+""}function za(t){const e=t.length;if(Ns(e>=2),2===e)return Ns(""===t.charAt(0)&&""===t.charAt(1)),Js.emptyPath();const n=e-2,s=[];let r="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&_s(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"":r+=t.substring(i,e),r+="\0";break;case"":r+=t.substring(i,e+1);break;default:_s()}i=e+2}return new Js(s)}const Qa=["userId","batchId"];function Ha(t,e){return[t,Ga(e)]}function Wa(t,e,n){return[t,Ga(e),n]}const Xa={},Ya=["prefixPath","collectionGroup","readTime","documentId"],Ja=["prefixPath","collectionGroup","documentId"],Za=["collectionGroup","readTime","prefixPath","documentId"],tu=["canonicalId","targetId"],eu=["targetId","path"],nu=["path","targetId"],su=["collectionId","parent"],ru=["indexId","uid"],iu=["uid","sequenceNumber"],ou=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],au=["indexId","uid","orderedDocumentKey"],uu=["userId","collectionPath","documentId"],cu=["userId","collectionPath","largestBatchId"],hu=["userId","collectionGroup","largestBatchId"],lu=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],du=[...lu,"documentOverlays"],fu=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],mu=fu,gu=[...mu,"indexConfiguration","indexState","indexEntries"];class pu extends dr{constructor(t,e){super(),this.ee=t,this.currentSequenceNumber=e}}function yu(t,e){const n=ks(t);return pr.N(n.ee,e)}class wu{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const s=this.mutations[e];s.key.isEqual(t.key)&&Ao(s,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=_o(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=_o(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=Xo();return this.mutations.forEach((s=>{const r=t.get(s.key),i=r.overlayedDocument;let o=this.applyToLocalView(i,r.mutatedFields);o=e.has(s.key)?null:o;const a=Do(i,o);null!==a&&n.set(s.key,a),i.isValidDocument()||i.convertToNoDocument(Xs.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),ta())}isEqual(t){return this.batchId===t.batchId&&Qs(this.mutations,t.mutations,((t,e)=>Co(t,e)))&&Qs(this.baseMutations,t.baseMutations,((t,e)=>Co(t,e)))}}class vu{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){Ns(t.mutations.length===n.length);let s=Jo;const r=t.mutations;for(let t=0;t<r.length;t++)s=s.insert(r[t].key,n[t].version);return new vu(t,e,n,s)}}class Iu{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class bu{constructor(t,e,n,s,r=Xs.min(),i=Xs.min(),o=Pr.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new bu(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new bu(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new bu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class Tu{constructor(t){this.ne=t}}function Eu(t,e){const n=e.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Su(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())s.document=function(t,e){return{name:ba(t,e.key),fields:e.data.value.mapValue.fields,updateTime:ga(t,e.version.toTimestamp())}}(t.ne,e);else if(e.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:xu(e.version)};else{if(!e.isUnknownDocument())return _s();s.unknownDocument={path:n.path.toArray(),version:xu(e.version)}}return s}function Su(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function xu(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Du(t){const e=new Ws(t.seconds,t.nanoseconds);return Xs.fromTimestamp(e)}function Au(t,e){const n=(e.baseMutations||[]).map((e=>Ca(t.ne,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const s=e.mutations[t+1];n.updateTransforms=s.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const s=e.mutations.map((e=>Ca(t.ne,e))),r=Ws.fromMillis(e.localWriteTimeMs);return new wu(e.batchId,r,n,s)}function _u(t){const e=Du(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Du(t.lastLimboFreeSnapshotVersion):Xs.min();let s;var r;return void 0!==t.query.documents?(Ns(1===(r=t.query).documents.length),s=Xi($i(Sa(r.documents[0])))):s=function(t){return Xi(Ma(t))}(t.query),new bu(s,t.targetId,0,t.lastListenSequenceNumber,e,n,Pr.fromBase64String(t.resumeToken))}function Nu(t,e){const n=xu(e.snapshotVersion),s=xu(e.lastLimboFreeSnapshotVersion);let r;r=xi(e.target)?ka(t.ne,e.target):Ra(t.ne,e.target);const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Ei(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:r}}function Cu(t){const e=Ma({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Yi(e,e.limit,"L"):e}function ku(t,e){return new Iu(e.largestBatchId,Ca(t.ne,e.overlayMutation))}function Ru(t,e){const n=e.path.lastSegment();return[t,Ga(e.path.popLast()),n]}function Mu(t,e,n,s){return{indexId:t,uid:e.uid||"",sequenceNumber:n,readTime:xu(s.readTime),documentKey:Ga(s.documentKey.path),largestBatchId:s.largestBatchId}}class Vu{getBundleMetadata(t,e){return Lu(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:Du(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return Lu(t).put({bundleId:(n=e).id,createTime:xu(wa(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return Ou(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:Cu(e.bundledQuery),readTime:Du(e.readTime)};var e}))}saveNamedQuery(t,e){return Ou(t).put(function(t){return{name:t.name,readTime:xu(wa(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function Lu(t){return yu(t,"bundles")}function Ou(t){return yu(t,"namedQueries")}class Fu{constructor(t,e){this.wt=t,this.userId=e}static se(t,e){const n=e.uid||"";return new Fu(t,n)}getOverlay(t,e){return Pu(t).get(Ru(this.userId,e)).next((t=>t?ku(this.wt,t):null))}getOverlays(t,e){const n=Wo();return mr.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const s=[];return n.forEach(((n,r)=>{const i=new Iu(e,r);s.push(this.ie(t,i))})),mr.waitFor(s)}removeOverlaysForBatchId(t,e,n){const s=new Set;e.forEach((t=>s.add(Ga(t.getCollectionPath()))));const r=[];return s.forEach((e=>{const s=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);r.push(Pu(t).W("collectionPathOverlayIndex",s))})),mr.waitFor(r)}getOverlaysForCollection(t,e,n){const s=Wo(),r=Ga(e),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return Pu(t).K("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=ku(this.wt,e);s.set(t.getKey(),t)}return s}))}getOverlaysForCollectionGroup(t,e,n,s){const r=Wo();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Pu(t).J({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=ku(this.wt,e);r.size()<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}ie(t,e){return Pu(t).put(function(t,e,n){const[s,r,i]=Ru(e,n.mutation.key);return{userId:e,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Na(t.ne,n.mutation)}}(this.wt,this.userId,e))}}function Pu(t){return yu(t,"documentOverlays")}class Uu{constructor(){}re(t,e){this.oe(t,e),e.ue()}oe(t,e){if("nullValue"in t)this.ce(e,5);else if("booleanValue"in t)this.ce(e,10),e.ae(t.booleanValue?1:0);else if("integerValue"in t)this.ce(e,15),e.ae(qr(t.integerValue));else if("doubleValue"in t){const n=qr(t.doubleValue);isNaN(n)?this.ce(e,13):(this.ce(e,15),Wr(n)?e.ae(0):e.ae(n))}else if("timestampValue"in t){const n=t.timestampValue;this.ce(e,20),"string"==typeof n?e.he(n):(e.he(`${n.seconds||""}`),e.ae(n.nanos||0))}else if("stringValue"in t)this.le(t.stringValue,e),this.fe(e);else if("bytesValue"in t)this.ce(e,30),e.de(Kr(t.bytesValue)),this.fe(e);else if("referenceValue"in t)this._e(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.ce(e,45),e.ae(n.latitude||0),e.ae(n.longitude||0)}else"mapValue"in t?fi(t)?this.ce(e,Number.MAX_SAFE_INTEGER):(this.we(t.mapValue,e),this.fe(e)):"arrayValue"in t?(this.me(t.arrayValue,e),this.fe(e)):_s()}le(t,e){this.ce(e,25),this.ge(t,e)}ge(t,e){e.he(t)}we(t,e){const n=t.fields||{};this.ce(e,55);for(const t of Object.keys(n))this.le(t,e),this.oe(n[t],e)}me(t,e){const n=t.values||[];this.ce(e,50);for(const t of n)this.oe(t,e)}_e(t,e){this.ce(e,37),er.fromName(t).path.forEach((t=>{this.ce(e,60),this.ge(t,e)}))}ce(t,e){t.ae(e)}fe(t){t.ae(2)}}function Bu(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function qu(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const s=Bu(255&t[n]);if(e+=s,8!==s)break}return e}(t);return Math.ceil(e/8)}Uu.ye=new Uu;class Ku{constructor(){this.buffer=new Uint8Array(1024),this.position=0}pe(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ie(n.value),n=e.next();this.Te()}Ee(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ae(n.value),n=e.next();this.Re()}be(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ie(t);else if(t<2048)this.Ie(960|t>>>6),this.Ie(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ie(480|t>>>12),this.Ie(128|63&t>>>6),this.Ie(128|63&t);else{const t=e.codePointAt(0);this.Ie(240|t>>>18),this.Ie(128|63&t>>>12),this.Ie(128|63&t>>>6),this.Ie(128|63&t)}}this.Te()}Pe(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ae(t);else if(t<2048)this.Ae(960|t>>>6),this.Ae(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ae(480|t>>>12),this.Ae(128|63&t>>>6),this.Ae(128|63&t);else{const t=e.codePointAt(0);this.Ae(240|t>>>18),this.Ae(128|63&t>>>12),this.Ae(128|63&t>>>6),this.Ae(128|63&t)}}this.Re()}ve(t){const e=this.Ve(t),n=qu(e);this.Se(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}De(t){const e=this.Ve(t),n=qu(e);this.Se(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}Ce(){this.xe(255),this.xe(255)}Ne(){this.ke(255),this.ke(255)}reset(){this.position=0}seed(t){this.Se(t.length),this.buffer.set(t,this.position),this.position+=t.length}Oe(){return this.buffer.slice(0,this.position)}Ve(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ie(t){const e=255&t;0===e?(this.xe(0),this.xe(255)):255===e?(this.xe(255),this.xe(0)):this.xe(e)}Ae(t){const e=255&t;0===e?(this.ke(0),this.ke(255)):255===e?(this.ke(255),this.ke(0)):this.ke(t)}Te(){this.xe(0),this.xe(1)}Re(){this.ke(0),this.ke(1)}xe(t){this.Se(1),this.buffer[this.position++]=t}ke(t){this.Se(1),this.buffer[this.position++]=~t}Se(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class Gu{constructor(t){this.Me=t}de(t){this.Me.pe(t)}he(t){this.Me.be(t)}ae(t){this.Me.ve(t)}ue(){this.Me.Ce()}}class ju{constructor(t){this.Me=t}de(t){this.Me.Ee(t)}he(t){this.Me.Pe(t)}ae(t){this.Me.De(t)}ue(){this.Me.Ne()}}class $u{constructor(){this.Me=new Ku,this.Fe=new Gu(this.Me),this.$e=new ju(this.Me)}seed(t){this.Me.seed(t)}Be(t){return 0===t?this.Fe:this.$e}Oe(){return this.Me.Oe()}reset(){this.Me.reset()}}class zu{constructor(t,e,n,s){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=s}Le(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new zu(this.indexId,this.documentKey,this.arrayValue,n)}}function Qu(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Hu(t.arrayValue,e.arrayValue),0!==n?n:(n=Hu(t.directionalValue,e.directionalValue),0!==n?n:er.comparator(t.documentKey,e.documentKey)))}function Hu(t,e){for(let n=0;n<t.length&&n<e.length;++n){const s=t[n]-e[n];if(0!==s)return s}return t.length-e.length}class Wu{constructor(t){this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Ue=t.orderBy,this.qe=[];for(const e of t.filters){const t=e;t.ht()?this.Ke=t:this.qe.push(t)}}Ge(t){const e=sr(t);if(void 0!==e&&!this.Qe(e))return!1;const n=rr(t);let s=0,r=0;for(;s<n.length&&this.Qe(n[s]);++s);if(s===n.length)return!0;if(void 0!==this.Ke){const t=n[s];if(!this.je(this.Ke,t)||!this.We(this.Ue[r++],t))return!1;++s}for(;s<n.length;++s){const t=n[s];if(r>=this.Ue.length||!this.We(this.Ue[r++],t))return!1}return!0}Qe(t){for(const e of this.qe)if(this.je(e,t))return!0;return!1}je(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}We(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}class Xu{constructor(){this.ze=new Yu}addToCollectionParentIndex(t,e){return this.ze.add(e),mr.resolve()}getCollectionParents(t,e){return mr.resolve(this.ze.getEntries(e))}addFieldIndex(t,e){return mr.resolve()}deleteFieldIndex(t,e){return mr.resolve()}getDocumentsMatchingTarget(t,e){return mr.resolve(null)}getIndexType(t,e){return mr.resolve(0)}getFieldIndexes(t,e){return mr.resolve([])}getNextCollectionGroupToUpdate(t){return mr.resolve(null)}getMinOffset(t,e){return mr.resolve(cr.min())}getMinOffsetFromCollectionGroup(t,e){return mr.resolve(cr.min())}updateCollectionGroup(t,e,n){return mr.resolve()}updateIndexEntries(t,e){return mr.resolve()}}class Yu{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new Mr(Js.comparator),r=!s.has(n);return this.index[e]=s.add(n),r}has(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new Mr(Js.comparator)).toArray()}}const Ju=new Uint8Array(0);class Zu{constructor(t,e){this.user=t,this.databaseId=e,this.He=new Yu,this.Je=new Go((t=>Ei(t)),((t,e)=>Si(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.He.has(e)){const n=e.lastSegment(),s=e.popLast();t.addOnCommittedListener((()=>{this.He.add(e)}));const r={collectionId:n,parent:Ga(s)};return tc(t).put(r)}return mr.resolve()}getCollectionParents(t,e){const n=[],s=IDBKeyRange.bound([e,""],[Hs(e),""],!1,!0);return tc(t).K(s).next((t=>{for(const s of t){if(s.collectionId!==e)break;n.push(za(s.parent))}return n}))}addFieldIndex(t,e){const n=nc(t),s=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete s.indexId;const r=n.add(s);if(e.indexState){const n=sc(t);return r.next((t=>{n.put(Mu(t,this.user,e.indexState.sequenceNumber,e.indexState.offset))}))}return r.next()}deleteFieldIndex(t,e){const n=nc(t),s=sc(t),r=ec(t);return n.delete(e.indexId).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e){const n=ec(t);let s=!0;const r=new Map;return mr.forEach(this.Ye(e),(e=>this.Xe(t,e).next((t=>{s&&(s=!!t),r.set(e,t)})))).next((()=>{if(s){let t=ta();const s=[];return mr.forEach(r,((r,i)=>{var o;Ss("IndexedDbIndexManager",`Using index ${o=r,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`} to execute ${Ei(e)}`);const a=function(t,e){const n=sr(e);if(void 0===n)return null;for(const e of Di(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,r),u=function(t,e){const n=new Map;for(const s of rr(e))for(const e of Di(t,s.fieldPath))switch(e.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,r),c=function(t,e){const n=[];let s=!0;for(const r of rr(e)){const e=0===r.kind?Ai(t,r.fieldPath,t.startAt):_i(t,r.fieldPath,t.startAt);n.push(e.value),s&&(s=e.inclusive)}return new Pi(n,s)}(i,r),h=function(t,e){const n=[];let s=!0;for(const r of rr(e)){const e=0===r.kind?_i(t,r.fieldPath,t.endAt):Ai(t,r.fieldPath,t.endAt);n.push(e.value),s&&(s=e.inclusive)}return new Pi(n,s)}(i,r),l=this.Ze(r,i,c),d=this.Ze(r,i,h),f=this.tn(r,i,u),m=this.en(r.indexId,a,l,c.inclusive,d,h.inclusive,f);return mr.forEach(m,(r=>n.j(r,e.limit).next((e=>{e.forEach((e=>{const n=er.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),s.push(n))}))}))))})).next((()=>s))}return mr.resolve(null)}))}Ye(t){let e=this.Je.get(t);return e||(e=[t],this.Je.set(t,e),e)}en(t,e,n,s,r,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,r.length),u=a/(null!=e?e.length:1),c=[];for(let h=0;h<a;++h){const a=e?this.nn(e[h/u]):Ju,l=this.sn(t,a,n[h%u],s),d=this.rn(t,a,r[h%u],i),f=o.map((e=>this.sn(t,a,e,!0)));c.push(...this.createRange(l,d,f))}return c}sn(t,e,n,s){const r=new zu(t,er.empty(),e,n);return s?r:r.Le()}rn(t,e,n,s){const r=new zu(t,er.empty(),e,n);return s?r.Le():r}Xe(t,e){const n=new Wu(e),s=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,s).next((t=>{let e=null;for(const s of t)n.Ge(s)&&(!e||s.fields.length>e.fields.length)&&(e=s);return e}))}getIndexType(t,e){let n=2;return mr.forEach(this.Ye(e),(e=>this.Xe(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Mr(tr.comparator),n=!1;for(const s of t.filters){const t=s;t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field))}for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>n))}on(t,e){const n=new $u;for(const s of rr(t)){const t=e.data.field(s.fieldPath);if(null==t)return null;const r=n.Be(s.kind);Uu.ye.re(t,r)}return n.Oe()}nn(t){const e=new $u;return Uu.ye.re(t,e.Be(0)),e.Oe()}un(t,e){const n=new $u;return Uu.ye.re(oi(this.databaseId,e),n.Be(function(t){const e=rr(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Oe()}tn(t,e,n){if(null===n)return[];let s=[];s.push(new $u);let r=0;for(const i of rr(t)){const t=n[r++];for(const n of s)if(this.cn(e,i.fieldPath)&&ui(t))s=this.an(s,i,t);else{const e=n.Be(i.kind);Uu.ye.re(t,e)}}return this.hn(s)}Ze(t,e,n){return this.tn(t,e,n.position)}hn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Oe();return e}an(t,e,n){const s=[...t],r=[];for(const t of n.arrayValue.values||[])for(const n of s){const s=new $u;s.seed(n.Oe()),Uu.ye.re(t,s.Be(e.kind)),r.push(s)}return r}cn(t,e){return!!t.filters.find((t=>t instanceof Ni&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=nc(t),s=sc(t);return(e?n.K("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.K()).next((t=>{const e=[];return mr.forEach(t,(t=>s.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new or(e.sequenceNumber,new cr(Du(e.readTime),new er(za(e.documentKey)),e.largestBatchId)):or.empty(),s=t.fields.map((([t,e])=>new ir(tr.fromServerFormat(t),e)));return new nr(t.indexId,t.collectionGroup,s,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:zs(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const s=nc(t),r=sc(t);return this.ln(t).next((t=>s.K("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>mr.forEach(e,(e=>r.put(Mu(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return mr.forEach(e,((e,s)=>{const r=n.get(e.collectionGroup);return(r?mr.resolve(r):this.getFieldIndexes(t,e.collectionGroup)).next((r=>(n.set(e.collectionGroup,r),mr.forEach(r,(n=>this.fn(t,e,n).next((e=>{const r=this.dn(s,n);return e.isEqual(r)?mr.resolve():this._n(t,s,n,e,r)})))))))}))}wn(t,e,n,s){return ec(t).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.un(n,e.key),documentKey:e.key.path.toArray()})}mn(t,e,n,s){return ec(t).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.un(n,e.key),e.key.path.toArray()])}fn(t,e,n){const s=ec(t);let r=new Mr(Qu);return s.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.un(n,e)])},((t,s)=>{r=r.add(new zu(n.indexId,e,s.arrayValue,s.directionalValue))})).next((()=>r))}dn(t,e){let n=new Mr(Qu);const s=this.on(e,t);if(null==s)return n;const r=sr(e);if(null!=r){const i=t.data.field(r.fieldPath);if(ui(i))for(const r of i.arrayValue.values||[])n=n.add(new zu(e.indexId,t.key,this.nn(r),s))}else n=n.add(new zu(e.indexId,t.key,Ju,s));return n}_n(t,e,n,s,r){Ss("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,s,r){const i=t.getIterator(),o=e.getIterator();let a=Lr(i),u=Lr(o);for(;a||u;){let t=!1,e=!1;if(a&&u){const s=n(a,u);s<0?e=!0:s>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(s(u),u=Lr(o)):e?(r(a),a=Lr(i)):(a=Lr(i),u=Lr(o))}}(s,r,Qu,(s=>{i.push(this.wn(t,e,n,s))}),(s=>{i.push(this.mn(t,e,n,s))})),mr.waitFor(i)}ln(t){let e=1;return sc(t).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,s)=>{s.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>Qu(t,e))).filter(((t,e,n)=>!e||0!==Qu(t,n[e-1])));const s=[];s.push(t);for(const r of n){const n=Qu(r,t),i=Qu(r,e);if(0===n)s[0]=t.Le();else if(n>0&&i<0)s.push(r),s.push(r.Le());else if(i>0)break}s.push(e);const r=[];for(let t=0;t<s.length;t+=2)r.push(IDBKeyRange.bound([s[t].indexId,this.uid,s[t].arrayValue,s[t].directionalValue,Ju,[]],[s[t+1].indexId,this.uid,s[t+1].arrayValue,s[t+1].directionalValue,Ju,[]]));return r}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(rc)}getMinOffset(t,e){return mr.mapArray(this.Ye(e),(e=>this.Xe(t,e).next((t=>t||_s())))).next(rc)}}function tc(t){return yu(t,"collectionParents")}function ec(t){return yu(t,"indexEntries")}function nc(t){return yu(t,"indexConfiguration")}function sc(t){return yu(t,"indexState")}function rc(t){Ns(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let s=1;s<t.length;s++){const r=t[s].indexState.offset;hr(r,e)<0&&(e=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new cr(e.readTime,e.documentKey,n)}const ic={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class oc{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new oc(t,oc.DEFAULT_COLLECTION_PERCENTILE,oc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function ac(t,e,n){const s=t.store("mutations"),r=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=s.J({range:o},((t,e,n)=>(a++,n.delete())));i.push(u.next((()=>{Ns(1===a)})));const c=[];for(const t of n.mutations){const s=Wa(e,t.key.path,n.batchId);i.push(r.delete(s)),c.push(t.key)}return mr.waitFor(i).next((()=>c))}function uc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw _s();e=t.noDocument}return JSON.stringify(e).length}oc.DEFAULT_COLLECTION_PERCENTILE=10,oc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,oc.DEFAULT=new oc(41943040,oc.DEFAULT_COLLECTION_PERCENTILE,oc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),oc.DISABLED=new oc(-1,0,0);class cc{constructor(t,e,n,s){this.userId=t,this.wt=e,this.indexManager=n,this.referenceDelegate=s,this.gn={}}static se(t,e,n,s){Ns(""!==t.uid);const r=t.isAuthenticated()?t.uid:"";return new cc(r,e,n,s)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return lc(t).J({index:"userMutationsIndex",range:n},((t,n,s)=>{e=!1,s.done()})).next((()=>e))}addMutationBatch(t,e,n,s){const r=dc(t),i=lc(t);return i.add({}).next((o=>{Ns("number"==typeof o);const a=new wu(o,e,n,s),u=function(t,e,n){const s=n.baseMutations.map((e=>Na(t.ne,e))),r=n.mutations.map((e=>Na(t.ne,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:r}}(this.wt,this.userId,a),c=[];let h=new Mr(((t,e)=>zs(t.canonicalString(),e.canonicalString())));for(const t of s){const e=Wa(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),c.push(i.put(u)),c.push(r.put(e,Xa))}return h.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.gn[o]=a.keys()})),mr.waitFor(c).next((()=>a))}))}lookupMutationBatch(t,e){return lc(t).get(e).next((t=>t?(Ns(t.userId===this.userId),Au(this.wt,t)):null))}yn(t,e){return this.gn[e]?mr.resolve(this.gn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.gn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return lc(t).J({index:"userMutationsIndex",range:s},((t,e,s)=>{e.userId===this.userId&&(Ns(e.batchId>=n),r=Au(this.wt,e)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return lc(t).J({index:"userMutationsIndex",range:e,reverse:!0},((t,e,s)=>{n=e.batchId,s.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return lc(t).K("userMutationsIndex",e).next((t=>t.map((t=>Au(this.wt,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=Ha(this.userId,e.path),s=IDBKeyRange.lowerBound(n),r=[];return dc(t).J({range:s},((n,s,i)=>{const[o,a,u]=n,c=za(a);if(o===this.userId&&e.path.isEqual(c))return lc(t).get(u).next((t=>{if(!t)throw _s();Ns(t.userId===this.userId),r.push(Au(this.wt,t))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Mr(zs);const s=[];return e.forEach((e=>{const r=Ha(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=dc(t).J({range:i},((t,s,r)=>{const[i,o,a]=t,u=za(o);i===this.userId&&e.path.isEqual(u)?n=n.add(a):r.done()}));s.push(o)})),mr.waitFor(s).next((()=>this.pn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1,r=Ha(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new Mr(zs);return dc(t).J({range:i},((t,e,r)=>{const[i,a,u]=t,c=za(a);i===this.userId&&n.isPrefixOf(c)?c.length===s&&(o=o.add(u)):r.done()})).next((()=>this.pn(t,o)))}pn(t,e){const n=[],s=[];return e.forEach((e=>{s.push(lc(t).get(e).next((t=>{if(null===t)throw _s();Ns(t.userId===this.userId),n.push(Au(this.wt,t))})))})),mr.waitFor(s).next((()=>n))}removeMutationBatch(t,e){return ac(t.ee,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.In(e.batchId)})),mr.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}In(t){delete this.gn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return mr.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return dc(t).J({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=za(t[1]);s.push(e)}else n.done()})).next((()=>{Ns(0===s.length)}))}))}containsKey(t,e){return hc(t,this.userId,e)}Tn(t){return fc(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function hc(t,e,n){const s=Ha(e,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return dc(t).J({range:i,H:!0},((t,n,s)=>{const[i,a,u]=t;i===e&&a===r&&(o=!0),s.done()})).next((()=>o))}function lc(t){return yu(t,"mutations")}function dc(t){return yu(t,"documentMutations")}function fc(t){return yu(t,"mutationQueues")}class mc{constructor(t){this.En=t}next(){return this.En+=2,this.En}static An(){return new mc(0)}static Rn(){return new mc(-1)}}class gc{constructor(t,e){this.referenceDelegate=t,this.wt=e}allocateTargetId(t){return this.bn(t).next((e=>{const n=new mc(e.highestTargetId);return e.highestTargetId=n.next(),this.Pn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.bn(t).next((t=>Xs.fromTimestamp(new Ws(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.bn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.bn(t).next((s=>(s.highestListenSequenceNumber=e,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),e>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=e),this.Pn(t,s))))}addTargetData(t,e){return this.vn(t,e).next((()=>this.bn(t).next((n=>(n.targetCount+=1,this.Vn(e,n),this.Pn(t,n))))))}updateTargetData(t,e){return this.vn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>pc(t).delete(e.targetId))).next((()=>this.bn(t))).next((e=>(Ns(e.targetCount>0),e.targetCount-=1,this.Pn(t,e))))}removeTargets(t,e,n){let s=0;const r=[];return pc(t).J(((i,o)=>{const a=_u(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(t,a)))})).next((()=>mr.waitFor(r))).next((()=>s))}forEachTarget(t,e){return pc(t).J(((t,n)=>{const s=_u(n);e(s)}))}bn(t){return yc(t).get("targetGlobalKey").next((t=>(Ns(null!==t),t)))}Pn(t,e){return yc(t).put("targetGlobalKey",e)}vn(t,e){return pc(t).put(Nu(this.wt,e))}Vn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.bn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Ei(e),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return pc(t).J({range:s,index:"queryTargetsIndex"},((t,n,s)=>{const i=_u(n);Si(e,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(t,e,n){const s=[],r=wc(t);return e.forEach((e=>{const i=Ga(e.path);s.push(r.put({targetId:n,path:i})),s.push(this.referenceDelegate.addReference(t,n,e))})),mr.waitFor(s)}removeMatchingKeys(t,e,n){const s=wc(t);return mr.forEach(e,(e=>{const r=Ga(e.path);return mr.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=wc(t),s=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),s=wc(t);let r=ta();return s.J({range:n,H:!0},((t,e,n)=>{const s=za(t[1]),i=new er(s);r=r.add(i)})).next((()=>r))}containsKey(t,e){const n=Ga(e.path),s=IDBKeyRange.bound([n],[Hs(n)],!1,!0);let r=0;return wc(t).J({index:"documentTargetsIndex",H:!0,range:s},(([t,e],n,s)=>{0!==t&&(r++,s.done())})).next((()=>r>0))}te(t,e){return pc(t).get(e).next((t=>t?_u(t):null))}}function pc(t){return yu(t,"targets")}function yc(t){return yu(t,"targetGlobal")}function wc(t){return yu(t,"targetDocuments")}function vc([t,e],[n,s]){const r=zs(t,n);return 0===r?zs(e,s):r}class Ic{constructor(t){this.Sn=t,this.buffer=new Mr(vc),this.Dn=0}Cn(){return++this.Dn}xn(t){const e=[t,this.Cn()];if(this.buffer.size<this.Sn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();vc(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class bc{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Nn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.kn(6e4)}stop(){this.Nn&&(this.Nn.cancel(),this.Nn=null)}get started(){return null!==this.Nn}kn(t){Ss("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Nn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Nn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){vr(t)?Ss("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await fr(t)}await this.kn(3e5)}))}}class Tc{constructor(t,e){this.On=t,this.params=e}calculateTargetCount(t,e){return this.On.Mn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return mr.resolve(Dr.ot);const n=new Ic(e);return this.On.forEachTarget(t,(t=>n.xn(t.sequenceNumber))).next((()=>this.On.Fn(t,(t=>n.xn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.On.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.On.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(Ss("LruGarbageCollector","Garbage collection skipped; disabled"),mr.resolve(ic)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(Ss("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),ic):this.$n(t,e)))}getCacheSize(t){return this.On.getCacheSize(t)}$n(t,e){let n,s,r,i,a,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(Ss("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),s=this.params.maximumSequenceNumbersToCollect):s=e,i=Date.now(),this.nthSequenceNumber(t,s)))).next((s=>(n=s,a=Date.now(),this.removeTargets(t,n,e)))).next((e=>(r=e,u=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(c=Date.now(),Ts()<=o.in.DEBUG&&Ss("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-h}ms\n\tDetermined least recently used ${s} in `+(a-i)+"ms\n"+`\tRemoved ${r} targets in `+(u-a)+"ms\n"+`\tRemoved ${t} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),mr.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:t}))))}}class Ec{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new Tc(t,e)}(this,e)}Mn(t){const e=this.Bn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Bn(t){let e=0;return this.Fn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Fn(t,e){return this.Ln(t,((t,n)=>e(n)))}addReference(t,e,n){return Sc(t,n)}removeReference(t,e,n){return Sc(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Sc(t,e)}Un(t,e){return function(t,e){let n=!1;return fc(t).Y((s=>hc(t,s,e).next((t=>(t&&(n=!0),mr.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this.Ln(t,((i,o)=>{if(o<=e){const e=this.Un(t,i).next((e=>{if(!e)return r++,n.getEntry(t,i).next((()=>(n.removeEntry(i,Xs.min()),wc(t).delete([0,Ga(i.path)]))))}));s.push(e)}})).next((()=>mr.waitFor(s))).next((()=>n.apply(t))).next((()=>r))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Sc(t,e)}Ln(t,e){const n=wc(t);let s,r=Dr.ot;return n.J({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(r!==Dr.ot&&e(new er(za(s)),r),r=o,s=i):r=Dr.ot})).next((()=>{r!==Dr.ot&&e(new er(za(s)),r)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Sc(t,e){return wc(t).put(function(t,e){return{targetId:0,path:Ga(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class xc{constructor(){this.changes=new Go((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Ii.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?mr.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Dc{constructor(t){this.wt=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Cc(t).put(n)}removeEntry(t,e,n){return Cc(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Su(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.qn(t,n))))}getEntry(t,e){let n=Ii.newInvalidDocument(e);return Cc(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(kc(e))},((t,s)=>{n=this.Kn(e,s)})).next((()=>n))}Gn(t,e){let n={size:0,document:Ii.newInvalidDocument(e)};return Cc(t).J({index:"documentKeyIndex",range:IDBKeyRange.only(kc(e))},((t,s)=>{n={document:this.Kn(e,s),size:uc(s)}})).next((()=>n))}getEntries(t,e){let n=$o();return this.Qn(t,e,((t,e)=>{const s=this.Kn(t,e);n=n.insert(t,s)})).next((()=>n))}jn(t,e){let n=$o(),s=new Cr(er.comparator);return this.Qn(t,e,((t,e)=>{const r=this.Kn(t,e);n=n.insert(t,r),s=s.insert(t,uc(e))})).next((()=>({documents:n,Wn:s})))}Qn(t,e,n){if(e.isEmpty())return mr.resolve();let s=new Mr(Mc);e.forEach((t=>s=s.add(t)));const r=IDBKeyRange.bound(kc(s.first()),kc(s.last())),i=s.getIterator();let o=i.getNext();return Cc(t).J({index:"documentKeyIndex",range:r},((t,e,s)=>{const r=er.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Mc(o,r)<0;)n(o,null),o=i.getNext();o&&o.isEqual(r)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?s.q(kc(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getAllFromCollection(t,e,n){const s=[e.popLast().toArray(),e.lastSegment(),Su(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],r=[e.popLast().toArray(),e.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Cc(t).K(IDBKeyRange.bound(s,r,!0)).next((t=>{let e=$o();for(const n of t){const t=this.Kn(er.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e=e.insert(t.key,t)}return e}))}getAllFromCollectionGroup(t,e,n,s){let r=$o();const i=Rc(e,n),o=Rc(e,cr.max());return Cc(t).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.Kn(er.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);r=r.insert(i.key,i),r.size===s&&n.done()})).next((()=>r))}newChangeBuffer(t){return new _c(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Nc(t).get("remoteDocumentGlobalKey").next((t=>(Ns(!!t),t)))}qn(t,e){return Nc(t).put("remoteDocumentGlobalKey",e)}Kn(t,e){if(e){const t=function(t,e){let n;if(e.document)n=_a(t.ne,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=er.fromSegments(e.noDocument.path),s=Du(e.noDocument.readTime);n=Ii.newNoDocument(t,s),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return _s();{const t=er.fromSegments(e.unknownDocument.path),s=Du(e.unknownDocument.version);n=Ii.newUnknownDocument(t,s)}}return e.readTime&&n.setReadTime(function(t){const e=new Ws(t[0],t[1]);return Xs.fromTimestamp(e)}(e.readTime)),n}(this.wt,e);if(!t.isNoDocument()||!t.version.isEqual(Xs.min()))return t}return Ii.newInvalidDocument(t)}}function Ac(t){return new Dc(t)}class _c extends xc{constructor(t,e){super(),this.zn=t,this.trackRemovals=e,this.Hn=new Go((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,s=new Mr(((t,e)=>zs(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.Hn.get(r);if(e.push(this.zn.removeEntry(t,r,o.readTime)),i.isValidDocument()){const a=Eu(this.zn.wt,i);s=s.add(r.path.popLast());const u=uc(a);n+=u-o.size,e.push(this.zn.addEntry(t,r,a))}else if(n-=o.size,this.trackRemovals){const n=Eu(this.zn.wt,i.convertToNoDocument(Xs.min()));e.push(this.zn.addEntry(t,r,n))}})),s.forEach((n=>{e.push(this.zn.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.zn.updateMetadata(t,n)),mr.waitFor(e)}getFromCache(t,e){return this.zn.Gn(t,e).next((t=>(this.Hn.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.zn.jn(t,e).next((({documents:t,Wn:e})=>(e.forEach(((e,n)=>{this.Hn.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function Nc(t){return yu(t,"remoteDocumentGlobal")}function Cc(t){return yu(t,"remoteDocumentsV14")}function kc(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Rc(t,e){const n=e.documentKey.path.toArray();return[t,Su(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Mc(t,e){const n=t.path.toArray(),s=e.path.toArray();let r=0;for(let t=0;t<n.length-2&&t<s.length-2;++t)if(r=zs(n[t],s[t]),r)return r;return r=zs(n.length,s.length),r||(r=zs(n[n.length-2],s[s.length-2]),r||zs(n[n.length-1],s[s.length-1]))}class Vc{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class Lc{constructor(t,e,n,s){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=s}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((s=>(n=s,this.getBaseDocument(t,e,n)))).next((t=>(null!==n&&_o(n.mutation,t,Or.empty(),Ws.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,ta()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=ta()){const s=Wo();return this.populateOverlays(t,s,e).next((()=>this.computeViews(t,e,s,n).next((t=>{let e=Qo();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=Wo();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,ta())))}populateOverlays(t,e,n){const s=[];return n.forEach((t=>{e.has(t)||s.push(t)})),this.documentOverlayCache.getOverlays(t,s).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,s){let r=$o();const i=Yo(),o=Yo();return e.forEach(((t,e)=>{const o=n.get(e.key);s.has(e.key)&&(void 0===o||o.mutation instanceof Ro)?r=r.insert(e.key,e):void 0!==o&&(i.set(e.key,o.mutation.getFieldMask()),_o(o.mutation,e,o.mutation.getFieldMask(),Ws.now()))})),this.recalculateAndSaveOverlays(t,r).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new Vc(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=Yo();let s=new Cr(((t,e)=>t-e)),r=ta();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const r of t)r.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||Or.empty();o=r.applyToLocalView(i,o),n.set(t,o);const a=(s.get(r.batchId)||ta()).add(t);s=s.insert(r.batchId,a)}))})).next((()=>{const i=[],o=s.getReverseIterator();for(;o.hasNext();){const s=o.getNext(),a=s.key,u=s.value,c=Xo();u.forEach((t=>{if(!r.has(t)){const s=Do(e.get(t),n.get(t));null!==s&&c.set(t,s),r=r.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,c))}return mr.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n){return function(t){return er.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):Hi(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)}getNextDocuments(t,e,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,s).next((r=>{const i=s-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,s-r.size):mr.resolve(Wo());let o=-1,a=r;return i.next((e=>mr.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),r.get(e)?mr.resolve():this.getBaseDocument(t,e,n).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,r))).next((()=>this.computeViews(t,a,e,ta()))).next((t=>({batchId:o,changes:Ho(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new er(e)).next((t=>{let e=Qo();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n){const s=e.collectionGroup;let r=Qo();return this.indexManager.getCollectionParents(t,s).next((i=>mr.forEach(i,(i=>{const o=function(t,e){return new Gi(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(s));return this.getDocumentsMatchingCollectionQuery(t,o,n).next((t=>{t.forEach(((t,e)=>{r=r.insert(t,e)}))}))})).next((()=>r))))}getDocumentsMatchingCollectionQuery(t,e,n){let s;return this.remoteDocumentCache.getAllFromCollection(t,e.path,n).next((r=>(s=r,this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId)))).next((t=>{t.forEach(((t,e)=>{const n=e.getKey();null===s.get(n)&&(s=s.insert(n,Ii.newInvalidDocument(n)))}));let n=Qo();return s.forEach(((s,r)=>{const i=t.get(s);void 0!==i&&_o(i.mutation,r,Or.empty(),Ws.now()),eo(e,r)&&(n=n.insert(s,r))})),n}))}getBaseDocument(t,e,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(t,e):mr.resolve(Ii.newInvalidDocument(e))}}class Oc{constructor(t){this.wt=t,this.Jn=new Map,this.Yn=new Map}getBundleMetadata(t,e){return mr.resolve(this.Jn.get(e))}saveBundleMetadata(t,e){var n;return this.Jn.set(e.id,{id:(n=e).id,version:n.version,createTime:wa(n.createTime)}),mr.resolve()}getNamedQuery(t,e){return mr.resolve(this.Yn.get(e))}saveNamedQuery(t,e){return this.Yn.set(e.name,function(t){return{name:t.name,query:Cu(t.bundledQuery),readTime:wa(t.readTime)}}(e)),mr.resolve()}}class Fc{constructor(){this.overlays=new Cr(er.comparator),this.Xn=new Map}getOverlay(t,e){return mr.resolve(this.overlays.get(e))}getOverlays(t,e){const n=Wo();return mr.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,s)=>{this.ie(t,e,s)})),mr.resolve()}removeOverlaysForBatchId(t,e,n){const s=this.Xn.get(n);return void 0!==s&&(s.forEach((t=>this.overlays=this.overlays.remove(t))),this.Xn.delete(n)),mr.resolve()}getOverlaysForCollection(t,e,n){const s=Wo(),r=e.length+1,i=new er(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===r&&t.largestBatchId>n&&s.set(t.getKey(),t)}return mr.resolve(s)}getOverlaysForCollectionGroup(t,e,n,s){let r=new Cr(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=r.get(t.largestBatchId);null===e&&(e=Wo(),r=r.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=Wo(),a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=s)););return mr.resolve(o)}ie(t,e,n){const s=this.overlays.get(n.key);if(null!==s){const t=this.Xn.get(s.largestBatchId).delete(n.key);this.Xn.set(s.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new Iu(e,n));let r=this.Xn.get(e);void 0===r&&(r=ta(),this.Xn.set(e,r)),this.Xn.set(e,r.add(n.key))}}class Pc{constructor(){this.Zn=new Mr(Uc.ts),this.es=new Mr(Uc.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(t,e){const n=new Uc(t,e);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.rs(new Uc(t,e))}os(t,e){t.forEach((t=>this.removeReference(t,e)))}us(t){const e=new er(new Js([])),n=new Uc(e,t),s=new Uc(e,t+1),r=[];return this.es.forEachInRange([n,s],(t=>{this.rs(t),r.push(t.key)})),r}cs(){this.Zn.forEach((t=>this.rs(t)))}rs(t){this.Zn=this.Zn.delete(t),this.es=this.es.delete(t)}hs(t){const e=new er(new Js([])),n=new Uc(e,t),s=new Uc(e,t+1);let r=ta();return this.es.forEachInRange([n,s],(t=>{r=r.add(t.key)})),r}containsKey(t){const e=new Uc(t,0),n=this.Zn.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Uc{constructor(t,e){this.key=t,this.ls=e}static ts(t,e){return er.comparator(t.key,e.key)||zs(t.ls,e.ls)}static ns(t,e){return zs(t.ls,e.ls)||er.comparator(t.key,e.key)}}class Bc{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.fs=1,this.ds=new Mr(Uc.ts)}checkEmpty(t){return mr.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,s){const r=this.fs;this.fs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new wu(r,e,n,s);this.mutationQueue.push(i);for(const e of s)this.ds=this.ds.add(new Uc(e.key,r)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return mr.resolve(i)}lookupMutationBatch(t,e){return mr.resolve(this._s(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=this.ws(n),r=s<0?0:s;return mr.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return mr.resolve(0===this.mutationQueue.length?-1:this.fs-1)}getAllMutationBatches(t){return mr.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Uc(e,0),s=new Uc(e,Number.POSITIVE_INFINITY),r=[];return this.ds.forEachInRange([n,s],(t=>{const e=this._s(t.ls);r.push(e)})),mr.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Mr(zs);return e.forEach((t=>{const e=new Uc(t,0),s=new Uc(t,Number.POSITIVE_INFINITY);this.ds.forEachInRange([e,s],(t=>{n=n.add(t.ls)}))})),mr.resolve(this.gs(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1;let r=n;er.isDocumentKey(r)||(r=r.child(""));const i=new Uc(new er(r),0);let o=new Mr(zs);return this.ds.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===s&&(o=o.add(t.ls)),!0)}),i),mr.resolve(this.gs(o))}gs(t){const e=[];return t.forEach((t=>{const n=this._s(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Ns(0===this.ys(e.batchId,"removed")),this.mutationQueue.shift();let n=this.ds;return mr.forEach(e.mutations,(s=>{const r=new Uc(s.key,e.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)})).next((()=>{this.ds=n}))}In(t){}containsKey(t,e){const n=new Uc(e,0),s=this.ds.firstAfterOrEqual(n);return mr.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.mutationQueue.length,mr.resolve()}ys(t,e){return this.ws(t)}ws(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}_s(t){const e=this.ws(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class qc{constructor(t){this.ps=t,this.docs=new Cr(er.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,s=this.docs.get(n),r=s?s.size:0,i=this.ps(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return mr.resolve(n?n.document.mutableCopy():Ii.newInvalidDocument(e))}getEntries(t,e){let n=$o();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():Ii.newInvalidDocument(t))})),mr.resolve(n)}getAllFromCollection(t,e,n){let s=$o();const r=new er(e.child("")),i=this.docs.getIteratorFrom(r);for(;i.hasNext();){const{key:t,value:{document:r}}=i.getNext();if(!e.isPrefixOf(t.path))break;t.path.length>e.length+1||hr(ur(r),n)<=0||(s=s.insert(r.key,r.mutableCopy()))}return mr.resolve(s)}getAllFromCollectionGroup(t,e,n,s){_s()}Is(t,e){return mr.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Kc(this)}getSize(t){return mr.resolve(this.size)}}class Kc extends xc{constructor(t){super(),this.zn=t}applyChanges(t){const e=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?e.push(this.zn.addEntry(t,s)):this.zn.removeEntry(n)})),mr.waitFor(e)}getFromCache(t,e){return this.zn.getEntry(t,e)}getAllFromCache(t,e){return this.zn.getEntries(t,e)}}class Gc{constructor(t){this.persistence=t,this.Ts=new Go((t=>Ei(t)),Si),this.lastRemoteSnapshotVersion=Xs.min(),this.highestTargetId=0,this.Es=0,this.As=new Pc,this.targetCount=0,this.Rs=mc.An()}forEachTarget(t,e){return this.Ts.forEach(((t,n)=>e(n))),mr.resolve()}getLastRemoteSnapshotVersion(t){return mr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return mr.resolve(this.Es)}allocateTargetId(t){return this.highestTargetId=this.Rs.next(),mr.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Es&&(this.Es=e),mr.resolve()}vn(t){this.Ts.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Rs=new mc(e),this.highestTargetId=e),t.sequenceNumber>this.Es&&(this.Es=t.sequenceNumber)}addTargetData(t,e){return this.vn(e),this.targetCount+=1,mr.resolve()}updateTargetData(t,e){return this.vn(e),mr.resolve()}removeTargetData(t,e){return this.Ts.delete(e.target),this.As.us(e.targetId),this.targetCount-=1,mr.resolve()}removeTargets(t,e,n){let s=0;const r=[];return this.Ts.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Ts.delete(i),r.push(this.removeMatchingKeysForTargetId(t,o.targetId)),s++)})),mr.waitFor(r).next((()=>s))}getTargetCount(t){return mr.resolve(this.targetCount)}getTargetData(t,e){const n=this.Ts.get(e)||null;return mr.resolve(n)}addMatchingKeys(t,e,n){return this.As.ss(e,n),mr.resolve()}removeMatchingKeys(t,e,n){this.As.os(e,n);const s=this.persistence.referenceDelegate,r=[];return s&&e.forEach((e=>{r.push(s.markPotentiallyOrphaned(t,e))})),mr.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.As.us(e),mr.resolve()}getMatchingKeysForTargetId(t,e){const n=this.As.hs(e);return mr.resolve(n)}containsKey(t,e){return mr.resolve(this.As.containsKey(e))}}class jc{constructor(t,e){this.bs={},this.overlays={},this.Ps=new Dr(0),this.vs=!1,this.vs=!0,this.referenceDelegate=t(this),this.Vs=new Gc(this),this.indexManager=new Xu,this.remoteDocumentCache=function(t){return new qc(t)}((t=>this.referenceDelegate.Ss(t))),this.wt=new Tu(e),this.Ds=new Oc(this.wt)}start(){return Promise.resolve()}shutdown(){return this.vs=!1,Promise.resolve()}get started(){return this.vs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Fc,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.bs[t.toKey()];return n||(n=new Bc(e,this.referenceDelegate),this.bs[t.toKey()]=n),n}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ds}runTransaction(t,e,n){Ss("MemoryPersistence","Starting transaction:",t);const s=new $c(this.Ps.next());return this.referenceDelegate.Cs(),n(s).next((t=>this.referenceDelegate.xs(s).next((()=>t)))).toPromise().then((t=>(s.raiseOnCommittedEvent(),t)))}Ns(t,e){return mr.or(Object.values(this.bs).map((n=>()=>n.containsKey(t,e))))}}class $c extends dr{constructor(t){super(),this.currentSequenceNumber=t}}class zc{constructor(t){this.persistence=t,this.ks=new Pc,this.Os=null}static Ms(t){return new zc(t)}get Fs(){if(this.Os)return this.Os;throw _s()}addReference(t,e,n){return this.ks.addReference(n,e),this.Fs.delete(n.toString()),mr.resolve()}removeReference(t,e,n){return this.ks.removeReference(n,e),this.Fs.add(n.toString()),mr.resolve()}markPotentiallyOrphaned(t,e){return this.Fs.add(e.toString()),mr.resolve()}removeTarget(t,e){this.ks.us(e.targetId).forEach((t=>this.Fs.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Fs.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Cs(){this.Os=new Set}xs(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return mr.forEach(this.Fs,(n=>{const s=er.fromPath(n);return this.$s(t,s).next((t=>{t||e.removeEntry(s,Xs.min())}))})).next((()=>(this.Os=null,e.apply(t))))}updateLimboDocument(t,e){return this.$s(t,e).next((t=>{t?this.Fs.delete(e.toString()):this.Fs.add(e.toString())}))}Ss(t){return 0}$s(t,e){return mr.or([()=>mr.resolve(this.ks.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ns(t,e)])}}class Qc{constructor(t){this.wt=t}O(t,e,n,s){const r=new gr("createOrUpgrade",e);n<1&&s>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Qa,{unique:!0}),t.createObjectStore("documentMutations")}(t),Hc(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=mr.resolve();return n<3&&s>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),Hc(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Xs.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").K().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Qa,{unique:!0});const s=e.store("mutations"),r=n.map((t=>s.put(t)));return mr.waitFor(r)}))}(t,r)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&s>=5&&(i=i.next((()=>this.Bs(r)))),n<6&&s>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.Ls(r))))),n<7&&s>=7&&(i=i.next((()=>this.Us(r)))),n<8&&s>=8&&(i=i.next((()=>this.qs(t,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&s>=10&&(i=i.next((()=>this.Ks(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&s>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:uu});e.createIndex("collectionPathOverlayIndex",cu,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",hu,{unique:!1})}(t)}))),n<13&&s>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:Ya});e.createIndex("documentKeyIndex",Ja),e.createIndex("collectionGroupIndex",Za)}(t))).next((()=>this.Gs(t,r))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(i=i.next((()=>this.Qs(t,r)))),n<15&&s>=15&&(i=i.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:ru}).createIndex("sequenceNumberIndex",iu,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:ou}).createIndex("documentKeyIndex",au,{unique:!1})}(t)))),i}Ls(t){let e=0;return t.store("remoteDocuments").J(((t,n)=>{e+=uc(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Bs(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.K().next((e=>mr.forEach(e,(e=>{const s=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.K("userMutationsIndex",s).next((n=>mr.forEach(n,(n=>{Ns(n.userId===e.userId);const s=Au(this.wt,n);return ac(t,e.userId,s).next((()=>{}))}))))}))))}Us(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const s=[];return n.J(((n,r)=>{const i=new Js(n),o=function(t){return[0,Ga(t)]}(i);s.push(e.get(o).next((n=>n?mr.resolve():(n=>e.put({targetId:0,path:Ga(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>mr.waitFor(s)))}))}qs(t,e){t.createObjectStore("collectionParents",{keyPath:su});const n=e.store("collectionParents"),s=new Yu,r=t=>{if(s.add(t)){const e=t.lastSegment(),s=t.popLast();return n.put({collectionId:e,parent:Ga(s)})}};return e.store("remoteDocuments").J({H:!0},((t,e)=>{const n=new Js(t);return r(n.popLast())})).next((()=>e.store("documentMutations").J({H:!0},(([t,e,n],s)=>{const i=za(e);return r(i.popLast())}))))}Ks(t){const e=t.store("targets");return e.J(((t,n)=>{const s=_u(n),r=Nu(this.wt,s);return e.put(r)}))}Gs(t,e){const n=e.store("remoteDocuments"),s=[];return n.J(((t,n)=>{const r=e.store("remoteDocumentsV14"),i=(o=n,o.document?new er(Js.fromString(o.document.name).popFirst(5)):o.noDocument?er.fromSegments(o.noDocument.path):o.unknownDocument?er.fromSegments(o.unknownDocument.path):_s()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(r.put(a))})).next((()=>mr.waitFor(s)))}Qs(t,e){const n=e.store("mutations"),s=Ac(this.wt),r=new jc(zc.Ms,this.wt.ne);return n.K().next((t=>{const n=new Map;return t.forEach((t=>{var e;let s=null!==(e=n.get(t.userId))&&void 0!==e?e:ta();Au(this.wt,t).keys().forEach((t=>s=s.add(t))),n.set(t.userId,s)})),mr.forEach(n,((t,n)=>{const i=new vs(n),o=Fu.se(this.wt,i),a=r.getIndexManager(i),u=cc.se(i,this.wt,a,r.referenceDelegate);return new Lc(s,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new pu(e,Dr.ot),t).next()}))}))}}function Hc(t){t.createObjectStore("targetDocuments",{keyPath:eu}).createIndex("documentTargetsIndex",nu,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",tu,{unique:!0}),t.createObjectStore("targetGlobal")}const Wc="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Xc{constructor(t,e,n,s,r,i,o,a,u,c,h=14){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.js=r,this.window=i,this.document=o,this.Ws=u,this.zs=c,this.Hs=h,this.Ps=null,this.vs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Js=null,this.inForeground=!1,this.Ys=null,this.Xs=null,this.Zs=Number.NEGATIVE_INFINITY,this.ti=t=>Promise.resolve(),!Xc.V())throw new Ms(Rs.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ec(this,s),this.ei=e+"main",this.wt=new Tu(a),this.ni=new pr(this.ei,this.Hs,new Qc(this.wt)),this.Vs=new gc(this.referenceDelegate,this.wt),this.remoteDocumentCache=Ac(this.wt),this.Ds=new Vu,this.window&&this.window.localStorage?this.si=this.window.localStorage:(this.si=null,!1===c&&xs("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ii().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Ms(Rs.FAILED_PRECONDITION,Wc);return this.ri(),this.oi(),this.ui(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Vs.getHighestSequenceNumber(t)))})).then((t=>{this.Ps=new Dr(t,this.Ws)})).then((()=>{this.vs=!0})).catch((t=>(this.ni&&this.ni.close(),Promise.reject(t))))}ci(t){return this.ti=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ni.F((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.js.enqueueAndForget((async()=>{this.started&&await this.ii()})))}ii(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>Jc(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.ai(t).next((t=>{t||(this.isPrimary=!1,this.js.enqueueRetryable((()=>this.ti(!1))))}))})).next((()=>this.hi(t))).next((e=>this.isPrimary&&!e?this.li(t).next((()=>!1)):!!e&&this.fi(t).next((()=>!0)))))).catch((t=>{if(vr(t))return Ss("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return Ss("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.js.enqueueRetryable((()=>this.ti(t))),this.isPrimary=t}))}ai(t){return Yc(t).get("owner").next((t=>mr.resolve(this.di(t))))}_i(t){return Jc(t).delete(this.clientId)}async wi(){if(this.isPrimary&&!this.mi(this.Zs,18e5)){this.Zs=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=yu(t,"clientMetadata");return e.K().next((t=>{const n=this.gi(t,18e5),s=t.filter((t=>-1===n.indexOf(t)));return mr.forEach(s,(t=>e.delete(t.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.si)for(const e of t)this.si.removeItem(this.yi(e.clientId))}}ui(){this.Xs=this.js.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ii().then((()=>this.wi())).then((()=>this.ui()))))}di(t){return!!t&&t.ownerId===this.clientId}hi(t){return this.zs?mr.resolve(!0):Yc(t).get("owner").next((e=>{if(null!==e&&this.mi(e.leaseTimestampMs,5e3)&&!this.pi(e.ownerId)){if(this.di(e)&&this.networkEnabled)return!0;if(!this.di(e)){if(!e.allowTabSynchronization)throw new Ms(Rs.FAILED_PRECONDITION,Wc);return!1}}return!(!this.networkEnabled||!this.inForeground)||Jc(t).K().next((t=>void 0===this.gi(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,s=this.networkEnabled===t.networkEnabled;if(e||n&&s)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&Ss("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.vs=!1,this.Ii(),this.Xs&&(this.Xs.cancel(),this.Xs=null),this.Ti(),this.Ei(),await this.ni.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new pu(t,Dr.ot);return this.li(e).next((()=>this._i(e)))})),this.ni.close(),this.Ai()}gi(t,e){return t.filter((t=>this.mi(t.updateTimeMs,e)&&!this.pi(t.clientId)))}Ri(){return this.runTransaction("getActiveClients","readonly",(t=>Jc(t).K().next((t=>this.gi(t,18e5).map((t=>t.clientId))))))}get started(){return this.vs}getMutationQueue(t,e){return cc.se(t,this.wt,e,this.referenceDelegate)}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new Zu(t,this.wt.ne.databaseId)}getDocumentOverlayCache(t){return Fu.se(this.wt,t)}getBundleCache(){return this.Ds}runTransaction(t,e,n){Ss("IndexedDbPersistence","Starting transaction:",t);const s="readonly"===e?"readonly":"readwrite",r=15===(i=this.Hs)?gu:14===i?mu:13===i?fu:12===i?du:11===i?lu:void _s();var i;let o;return this.ni.runTransaction(t,s,r,(s=>(o=new pu(s,this.Ps?this.Ps.next():Dr.ot),"readwrite-primary"===e?this.ai(o).next((t=>!!t||this.hi(o))).next((e=>{if(!e)throw xs(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.js.enqueueRetryable((()=>this.ti(!1))),new Ms(Rs.FAILED_PRECONDITION,lr);return n(o)})).next((t=>this.fi(o).next((()=>t)))):this.bi(o).next((()=>n(o)))))).then((t=>(o.raiseOnCommittedEvent(),t)))}bi(t){return Yc(t).get("owner").next((t=>{if(null!==t&&this.mi(t.leaseTimestampMs,5e3)&&!this.pi(t.ownerId)&&!this.di(t)&&!(this.zs||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Ms(Rs.FAILED_PRECONDITION,Wc)}))}fi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Yc(t).put("owner",e)}static V(){return pr.V()}li(t){const e=Yc(t);return e.get("owner").next((t=>this.di(t)?(Ss("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):mr.resolve()))}mi(t,e){const n=Date.now();return!(t<n-e||t>n&&(xs(`Detected an update time that is in the future: ${t} > ${n}`),1))}ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ys=()=>{this.js.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ii())))},this.document.addEventListener("visibilitychange",this.Ys),this.inForeground="visible"===this.document.visibilityState)}Ti(){this.Ys&&(this.document.removeEventListener("visibilitychange",this.Ys),this.Ys=null)}oi(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Js=()=>{this.Ii(),(0,a.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.js.enterRestrictedMode(!0),this.js.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Js))}Ei(){this.Js&&(this.window.removeEventListener("pagehide",this.Js),this.Js=null)}pi(t){var e;try{const n=null!==(null===(e=this.si)||void 0===e?void 0:e.getItem(this.yi(t)));return Ss("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return xs("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}Ii(){if(this.si)try{this.si.setItem(this.yi(this.clientId),String(Date.now()))}catch(t){xs("Failed to set zombie client id.",t)}}Ai(){if(this.si)try{this.si.removeItem(this.yi(this.clientId))}catch(t){}}yi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Yc(t){return yu(t,"owner")}function Jc(t){return yu(t,"clientMetadata")}function Zc(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class th{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.Pi=n,this.vi=s}static Vi(t,e){let n=ta(),s=ta();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:s=s.add(t.doc.key)}return new th(t,e.fromCache,n,s)}}class eh{constructor(){this.Si=!1}initialize(t,e){this.Di=t,this.indexManager=e,this.Si=!0}getDocumentsMatchingQuery(t,e,n,s){return this.Ci(t,e).next((r=>r||this.xi(t,e,s,n))).next((n=>n||this.Ni(t,e)))}Ci(t,e){return mr.resolve(null)}xi(t,e,n,s){return function(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}(e)||s.isEqual(Xs.min())?this.Ni(t,e):this.Di.getDocuments(t,n).next((r=>{const i=this.ki(e,r);return this.Oi(e,i,n,s)?this.Ni(t,e):(Ts()<=o.in.DEBUG&&Ss("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),to(e)),this.Mi(t,i,e,ar(s,-1)))}))}ki(t,e){let n=new Mr(so(t));return e.forEach(((e,s)=>{eo(t,s)&&(n=n.add(s))})),n}Oi(t,e,n,s){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const r="F"===t.limitType?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Ni(t,e){return Ts()<=o.in.DEBUG&&Ss("QueryEngine","Using full collection scan to execute query:",to(e)),this.Di.getDocumentsMatchingQuery(t,e,cr.min())}Mi(t,e,n,s){return this.Di.getDocumentsMatchingQuery(t,n,s).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class nh{constructor(t,e,n,s){this.persistence=t,this.Fi=e,this.wt=s,this.$i=new Cr(zs),this.Bi=new Go((t=>Ei(t)),Si),this.Li=new Map,this.Ui=t.getRemoteDocumentCache(),this.Vs=t.getTargetCache(),this.Ds=t.getBundleCache(),this.qi(n)}qi(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Lc(this.Ui,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ui.setIndexManager(this.indexManager),this.Fi.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.$i)))}}function sh(t,e,n,s){return new nh(t,e,n,s)}async function rh(t,e){const n=ks(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let s;return n.mutationQueue.getAllMutationBatches(t).next((r=>(s=r,n.qi(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const r=[],i=[];let o=ta();for(const t of s){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({Ki:t,removedBatchIds:r,addedBatchIds:i})))}))}))}function ih(t){const e=ks(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Vs.getLastRemoteSnapshotVersion(t)))}function oh(t,e,n){let s=ta(),r=ta();return n.forEach((t=>s=s.add(t))),e.getEntries(t,s).next((t=>{let s=$o();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(r=r.add(n)),i.isNoDocument()&&i.version.isEqual(Xs.min())?(e.removeEntry(n,i.readTime),s=s.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),s=s.insert(n,i)):Ss("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Gi:s,Qi:r}}))}function ah(t,e){const n=ks(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function uh(t,e){const n=ks(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let s;return n.Vs.getTargetData(t,e).next((r=>r?(s=r,mr.resolve(s)):n.Vs.allocateTargetId(t).next((r=>(s=new bu(e,r,0,t.currentSequenceNumber),n.Vs.addTargetData(t,s).next((()=>s)))))))})).then((t=>{const s=n.$i.get(t.targetId);return(null===s||t.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.$i=n.$i.insert(t.targetId,t),n.Bi.set(e,t.targetId)),t}))}async function ch(t,e,n){const s=ks(t),r=s.$i.get(e),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(t=>s.persistence.referenceDelegate.removeTarget(t,r)))}catch(t){if(!vr(t))throw t;Ss("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}s.$i=s.$i.remove(e),s.Bi.delete(r.target)}function hh(t,e,n){const s=ks(t);let r=Xs.min(),i=ta();return s.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const s=ks(t),r=s.Bi.get(n);return void 0!==r?mr.resolve(s.$i.get(r)):s.Vs.getTargetData(e,n)}(s,t,Xi(e)).next((e=>{if(e)return r=e.lastLimboFreeSnapshotVersion,s.Vs.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>s.Fi.getDocumentsMatchingQuery(t,e,n?r:Xs.min(),n?i:ta()))).next((t=>(fh(s,no(e),t),{documents:t,ji:i})))))}function lh(t,e){const n=ks(t),s=ks(n.Vs),r=n.$i.get(e);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(t=>s.te(t,e).next((t=>t?t.target:null))))}function dh(t,e){const n=ks(t),s=n.Li.get(e)||Xs.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.Ui.getAllFromCollectionGroup(t,e,ar(s,-1),Number.MAX_SAFE_INTEGER))).then((t=>(fh(n,e,t),t)))}function fh(t,e,n){let s=Xs.min();n.forEach(((t,e)=>{e.readTime.compareTo(s)>0&&(s=e.readTime)})),t.Li.set(e,s)}async function mh(t,e,n=ta()){const s=await uh(t,Xi(Cu(e.bundledQuery))),r=ks(t);return r.persistence.runTransaction("Save named query","readwrite",(t=>{const i=wa(e.readTime);if(s.snapshotVersion.compareTo(i)>=0)return r.Ds.saveNamedQuery(t,e);const o=s.withResumeToken(Pr.EMPTY_BYTE_STRING,i);return r.$i=r.$i.insert(o.targetId,o),r.Vs.updateTargetData(t,o).next((()=>r.Vs.removeMatchingKeysForTargetId(t,s.targetId))).next((()=>r.Vs.addMatchingKeys(t,n,s.targetId))).next((()=>r.Ds.saveNamedQuery(t,e)))}))}function gh(t,e){return`firestore_clients_${t}_${e}`}function ph(t,e,n){let s=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(s+=`_${e.uid}`),s}function yh(t,e){return`firestore_targets_${t}_${e}`}class wh{constructor(t,e,n,s){this.user=t,this.batchId=e,this.state=n,this.error=s}static Ji(t,e,n){const s=JSON.parse(n);let r,i="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return i&&s.error&&(i="string"==typeof s.error.message&&"string"==typeof s.error.code,i&&(r=new Ms(s.error.code,s.error.message))),i?new wh(t,e,s.state,r):(xs("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Yi(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class vh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Ji(t,e){const n=JSON.parse(e);let s,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(s=new Ms(n.error.code,n.error.message))),r?new vh(t,n.state,s):(xs("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Yi(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Ih{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Ji(t,e){const n=JSON.parse(e);let s="object"==typeof n&&n.activeTargetIds instanceof Array,r=na();for(let t=0;s&&t<n.activeTargetIds.length;++t)s=Xr(n.activeTargetIds[t]),r=r.add(n.activeTargetIds[t]);return s?new Ih(t,r):(xs("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class bh{constructor(t,e){this.clientId=t,this.onlineState=e}static Ji(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new bh(e.clientId,e.onlineState):(xs("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Th{constructor(){this.activeTargetIds=na()}Xi(t){this.activeTargetIds=this.activeTargetIds.add(t)}Zi(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Yi(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Eh{constructor(t,e,n,s,r){this.window=t,this.js=e,this.persistenceKey=n,this.tr=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.er=this.nr.bind(this),this.sr=new Cr(zs),this.started=!1,this.ir=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.rr=gh(this.persistenceKey,this.tr),this.ur=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.sr=this.sr.insert(this.tr,new Th),this.cr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.ar=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.hr=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.lr=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.dr=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.er)}static V(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Ri();for(const e of t){if(e===this.tr)continue;const t=this.getItem(gh(this.persistenceKey,e));if(t){const n=Ih.Ji(e,t);n&&(this.sr=this.sr.insert(n.clientId,n))}}this._r();const e=this.storage.getItem(this.lr);if(e){const t=this.wr(e);t&&this.mr(t)}for(const t of this.ir)this.nr(t);this.ir=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.ur,JSON.stringify(t))}getAllActiveQueryTargets(){return this.gr(this.sr)}isActiveQueryTarget(t){let e=!1;return this.sr.forEach(((n,s)=>{s.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.yr(t,"pending")}updateMutationState(t,e,n){this.yr(t,e,n),this.pr(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(yh(this.persistenceKey,t));if(n){const s=vh.Ji(t,n);s&&(e=s.state)}}return this.Ir.Xi(t),this._r(),e}removeLocalQueryTarget(t){this.Ir.Zi(t),this._r()}isLocalQueryTarget(t){return this.Ir.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(yh(this.persistenceKey,t))}updateQueryState(t,e,n){this.Tr(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.pr(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Er(t)}notifyBundleLoaded(t){this.Ar(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.er),this.removeItem(this.rr),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return Ss("SharedClientState","READ",t,e),e}setItem(t,e){Ss("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){Ss("SharedClientState","REMOVE",t),this.storage.removeItem(t)}nr(t){const e=t;if(e.storageArea===this.storage){if(Ss("SharedClientState","EVENT",e.key,e.newValue),e.key===this.rr)return void xs("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.js.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.cr.test(e.key)){if(null==e.newValue){const t=this.Rr(e.key);return this.br(t,null)}{const t=this.Pr(e.key,e.newValue);if(t)return this.br(t.clientId,t)}}else if(this.ar.test(e.key)){if(null!==e.newValue){const t=this.vr(e.key,e.newValue);if(t)return this.Vr(t)}}else if(this.hr.test(e.key)){if(null!==e.newValue){const t=this.Sr(e.key,e.newValue);if(t)return this.Dr(t)}}else if(e.key===this.lr){if(null!==e.newValue){const t=this.wr(e.newValue);if(t)return this.mr(t)}}else if(e.key===this.ur){const t=function(t){let e=Dr.ot;if(null!=t)try{const n=JSON.parse(t);Ns("number"==typeof n),e=n}catch(t){xs("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Dr.ot&&this.sequenceNumberHandler(t)}else if(e.key===this.dr){const t=this.Cr(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Nr(t))))}}else this.ir.push(e)}))}}get Ir(){return this.sr.get(this.tr)}_r(){this.setItem(this.rr,this.Ir.Yi())}yr(t,e,n){const s=new wh(this.currentUser,t,e,n),r=ph(this.persistenceKey,this.currentUser,t);this.setItem(r,s.Yi())}pr(t){const e=ph(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Er(t){const e={clientId:this.tr,onlineState:t};this.storage.setItem(this.lr,JSON.stringify(e))}Tr(t,e,n){const s=yh(this.persistenceKey,t),r=new vh(t,e,n);this.setItem(s,r.Yi())}Ar(t){const e=JSON.stringify(Array.from(t));this.setItem(this.dr,e)}Rr(t){const e=this.cr.exec(t);return e?e[1]:null}Pr(t,e){const n=this.Rr(t);return Ih.Ji(n,e)}vr(t,e){const n=this.ar.exec(t),s=Number(n[1]),r=void 0!==n[2]?n[2]:null;return wh.Ji(new vs(r),s,e)}Sr(t,e){const n=this.hr.exec(t),s=Number(n[1]);return vh.Ji(s,e)}wr(t){return bh.Ji(t)}Cr(t){return JSON.parse(t)}async Vr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.kr(t.batchId,t.state,t.error);Ss("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}Dr(t){return this.syncEngine.Or(t.targetId,t.state,t.error)}br(t,e){const n=e?this.sr.insert(t,e):this.sr.remove(t),s=this.gr(this.sr),r=this.gr(n),i=[],o=[];return r.forEach((t=>{s.has(t)||i.push(t)})),s.forEach((t=>{r.has(t)||o.push(t)})),this.syncEngine.Mr(i,o).then((()=>{this.sr=n}))}mr(t){this.sr.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}gr(t){let e=na();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class Sh{constructor(){this.Fr=new Th,this.$r={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.Fr.Xi(t),this.$r[t]||"not-current"}updateQueryState(t,e,n){this.$r[t]=e}removeLocalQueryTarget(t){this.Fr.Zi(t)}isLocalQueryTarget(t){return this.Fr.activeTargetIds.has(t)}clearQueryState(t){delete this.$r[t]}getAllActiveQueryTargets(){return this.Fr.activeTargetIds}isActiveQueryTarget(t){return this.Fr.activeTargetIds.has(t)}start(){return this.Fr=new Th,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class xh{Br(t){}shutdown(){}}class Dh{constructor(){this.Lr=()=>this.Ur(),this.qr=()=>this.Kr(),this.Gr=[],this.Qr()}Br(t){this.Gr.push(t)}shutdown(){window.removeEventListener("online",this.Lr),window.removeEventListener("offline",this.qr)}Qr(){window.addEventListener("online",this.Lr),window.addEventListener("offline",this.qr)}Ur(){Ss("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Gr)t(0)}Kr(){Ss("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Gr)t(1)}static V(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Ah={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class _h{constructor(t){this.jr=t.jr,this.Wr=t.Wr}zr(t){this.Hr=t}Jr(t){this.Yr=t}onMessage(t){this.Xr=t}close(){this.Wr()}send(t){this.jr(t)}Zr(){this.Hr()}eo(t){this.Yr(t)}no(t){this.Xr(t)}}class Nh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.so=e+"://"+t.host,this.io="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}ro(t,e,n,s,r){const i=this.oo(t,e);Ss("RestConnection","Sending: ",i,n);const o={};return this.uo(o,s,r),this.co(t,i,o,n).then((t=>(Ss("RestConnection","Received: ",t),t)),(e=>{throw Ds("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e}))}ao(t,e,n,s,r){return this.ro(t,e,n,s,r)}uo(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+Is,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}oo(t,e){const n=Ah[t];return`${this.so}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}co(t,e,n,s){return new Promise(((r,i)=>{const o=new ys;o.listenOnce(ds.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case ls.NO_ERROR:const e=o.getResponseJson();Ss("Connection","XHR received:",JSON.stringify(e)),r(e);break;case ls.TIMEOUT:Ss("Connection",'RPC "'+t+'" timed out'),i(new Ms(Rs.DEADLINE_EXCEEDED,"Request time out"));break;case ls.HTTP_ERROR:const n=o.getStatus();if(Ss("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Rs).indexOf(e)>=0?e:Rs.UNKNOWN}(t.status);i(new Ms(e,t.message))}else i(new Ms(Rs.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Ms(Rs.UNAVAILABLE,"Connection failed."));break;default:_s()}}finally{Ss("Connection",'RPC "'+t+'" completed.')}}));const a=JSON.stringify(s);o.send(e,"POST",a,n,15)}))}ho(t,e,n){const s=[this.so,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=cs(),i=hs(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new gs({})),this.uo(o.initMessageHeaders,e,n),(0,a.uI)()||(0,a.b$)()||(0,a.d)()||(0,a.w1)()||(0,a.Mn)()||(0,a.ru)()||(o.httpHeadersOverwriteParam="$httpHeaders");const u=s.join("");Ss("Connection","Creating WebChannel: "+u,o);const c=r.createWebChannel(u,o);let h=!1,l=!1;const d=new _h({jr:t=>{l?Ss("Connection","Not sending because WebChannel is closed:",t):(h||(Ss("Connection","Opening WebChannel transport."),c.open(),h=!0),Ss("Connection","WebChannel sending:",t),c.send(t))},Wr:()=>c.close()}),f=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return f(c,ps.EventType.OPEN,(()=>{l||Ss("Connection","WebChannel transport opened.")})),f(c,ps.EventType.CLOSE,(()=>{l||(l=!0,Ss("Connection","WebChannel transport closed"),d.eo())})),f(c,ps.EventType.ERROR,(t=>{l||(l=!0,Ds("Connection","WebChannel transport errored:",t),d.eo(new Ms(Rs.UNAVAILABLE,"The operation could not be completed")))})),f(c,ps.EventType.MESSAGE,(t=>{var e;if(!l){const n=t.data[0];Ns(!!n);const s=n,r=s.error||(null===(e=s[0])||void 0===e?void 0:e.error);if(r){Ss("Connection","WebChannel received error:",r);const t=r.status;let e=function(t){const e=Uo[t];if(void 0!==e)return Ko(e)}(t),n=r.message;void 0===e&&(e=Rs.INTERNAL,n="Unknown error status: "+t+" with message "+r.message),l=!0,d.eo(new Ms(e,n)),c.close()}else Ss("Connection","WebChannel received:",n),d.no(n)}})),f(i,fs.STAT_EVENT,(t=>{t.stat===ms.PROXY?Ss("Connection","Detected buffering proxy"):t.stat===ms.NOPROXY&&Ss("Connection","Detected no buffering proxy")})),setTimeout((()=>{d.Zr()}),0),d}}function Ch(){return"undefined"!=typeof window?window:null}function kh(){return"undefined"!=typeof document?document:null}function Rh(t){return new ma(t,!0)}class Mh{constructor(t,e,n=1e3,s=1.5,r=6e4){this.js=t,this.timerId=e,this.lo=n,this.fo=s,this._o=r,this.wo=0,this.mo=null,this.yo=Date.now(),this.reset()}reset(){this.wo=0}po(){this.wo=this._o}Io(t){this.cancel();const e=Math.floor(this.wo+this.To()),n=Math.max(0,Date.now()-this.yo),s=Math.max(0,e-n);s>0&&Ss("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.wo} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.mo=this.js.enqueueAfterDelay(this.timerId,s,(()=>(this.yo=Date.now(),t()))),this.wo*=this.fo,this.wo<this.lo&&(this.wo=this.lo),this.wo>this._o&&(this.wo=this._o)}Eo(){null!==this.mo&&(this.mo.skipDelay(),this.mo=null)}cancel(){null!==this.mo&&(this.mo.cancel(),this.mo=null)}To(){return(Math.random()-.5)*this.wo}}class Vh{constructor(t,e,n,s,r,i,o,a){this.js=t,this.Ao=n,this.Ro=s,this.bo=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Po=0,this.vo=null,this.Vo=null,this.stream=null,this.So=new Mh(t,e)}Do(){return 1===this.state||5===this.state||this.Co()}Co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.xo()}async stop(){this.Do()&&await this.close(0)}No(){this.state=0,this.So.reset()}ko(){this.Co()&&null===this.vo&&(this.vo=this.js.enqueueAfterDelay(this.Ao,6e4,(()=>this.Oo())))}Mo(t){this.Fo(),this.stream.send(t)}async Oo(){if(this.Co())return this.close(0)}Fo(){this.vo&&(this.vo.cancel(),this.vo=null)}$o(){this.Vo&&(this.Vo.cancel(),this.Vo=null)}async close(t,e){this.Fo(),this.$o(),this.So.cancel(),this.Po++,4!==t?this.So.reset():e&&e.code===Rs.RESOURCE_EXHAUSTED?(xs(e.toString()),xs("Using maximum backoff delay to prevent overloading the backend."),this.So.po()):e&&e.code===Rs.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Bo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Jr(e)}Bo(){}auth(){this.state=1;const t=this.Lo(this.Po),e=this.Po;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Po===e&&this.Uo(t,n)}),(e=>{t((()=>{const t=new Ms(Rs.UNKNOWN,"Fetching auth token failed: "+e.message);return this.qo(t)}))}))}Uo(t,e){const n=this.Lo(this.Po);this.stream=this.Ko(t,e),this.stream.zr((()=>{n((()=>(this.state=2,this.Vo=this.js.enqueueAfterDelay(this.Ro,1e4,(()=>(this.Co()&&(this.state=3),Promise.resolve()))),this.listener.zr())))})),this.stream.Jr((t=>{n((()=>this.qo(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}xo(){this.state=5,this.So.Io((async()=>{this.state=0,this.start()}))}qo(t){return Ss("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Lo(t){return e=>{this.js.enqueueAndForget((()=>this.Po===t?e():(Ss("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Lh extends Vh{constructor(t,e,n,s,r,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s,i),this.wt=r}Ko(t,e){return this.bo.ho("Listen",t,e)}onMessage(t){this.So.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const s=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:_s()}(e.targetChange.targetChangeType||"NO_CHANGE"),r=e.targetChange.targetIds||[],i=function(t,e){return t.dt?(Ns(void 0===e||"string"==typeof e),Pr.fromBase64String(e||"")):(Ns(void 0===e||e instanceof Uint8Array),Pr.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Rs.UNKNOWN:Ko(t.code);return new Ms(e,t.message||"")}(o);n=new aa(s,r,i,a||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const r=Ta(t,s.document.name),i=wa(s.document.updateTime),o=new wi({mapValue:{fields:s.document.fields}}),a=Ii.newFoundDocument(r,i,o),u=s.targetIds||[],c=s.removedTargetIds||[];n=new ia(u,c,a.key,a)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const r=Ta(t,s.document),i=s.readTime?wa(s.readTime):Xs.min(),o=Ii.newNoDocument(r,i),a=s.removedTargetIds||[];n=new ia([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const r=Ta(t,s.document),i=s.removedTargetIds||[];n=new ia([],i,r,null)}else{if(!("filter"in e))return _s();{e.filter;const t=e.filter;t.targetId;const s=t.count||0,r=new Po(s),i=t.targetId;n=new oa(i,r)}}return n}(this.wt,t),n=function(t){if(!("targetChange"in t))return Xs.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?Xs.min():e.readTime?wa(e.readTime):Xs.min()}(t);return this.listener.Go(e,n)}Qo(t){const e={};e.database=xa(this.wt),e.addTarget=function(t,e){let n;const s=e.target;return n=xi(s)?{documents:ka(t,s)}:{query:Ra(t,s)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=pa(t,e.resumeToken):e.snapshotVersion.compareTo(Xs.min())>0&&(n.readTime=ga(t,e.snapshotVersion.toTimestamp())),n}(this.wt,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return _s()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.wt,t);n&&(e.labels=n),this.Mo(e)}jo(t){const e={};e.database=xa(this.wt),e.removeTarget=t,this.Mo(e)}}class Oh extends Vh{constructor(t,e,n,s,r,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,i),this.wt=r,this.Wo=!1}get zo(){return this.Wo}start(){this.Wo=!1,this.lastStreamToken=void 0,super.start()}Bo(){this.Wo&&this.Ho([])}Ko(t,e){return this.bo.ho("Write",t,e)}onMessage(t){if(Ns(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Wo){this.So.reset();const e=function(t,e){return t&&t.length>0?(Ns(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?wa(t.updateTime):wa(e);return n.isEqual(Xs.min())&&(n=wa(e)),new To(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=wa(t.commitTime);return this.listener.Jo(n,e)}return Ns(!t.writeResults||0===t.writeResults.length),this.Wo=!0,this.listener.Yo()}Xo(){const t={};t.database=xa(this.wt),this.Mo(t)}Ho(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Na(this.wt,t)))};this.Mo(e)}}class Fh extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.bo=n,this.wt=s,this.Zo=!1}tu(){if(this.Zo)throw new Ms(Rs.FAILED_PRECONDITION,"The client has already been terminated.")}ro(t,e,n){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.bo.ro(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Rs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Ms(Rs.UNKNOWN,t.toString())}))}ao(t,e,n){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.bo.ao(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Rs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Ms(Rs.UNKNOWN,t.toString())}))}terminate(){this.Zo=!0}}class Ph{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.eu=0,this.nu=null,this.su=!0}iu(){0===this.eu&&(this.ru("Unknown"),this.nu=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.nu=null,this.ou("Backend didn't respond within 10 seconds."),this.ru("Offline"),Promise.resolve()))))}uu(t){"Online"===this.state?this.ru("Unknown"):(this.eu++,this.eu>=1&&(this.cu(),this.ou(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.ru("Offline")))}set(t){this.cu(),this.eu=0,"Online"===t&&(this.su=!1),this.ru(t)}ru(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}ou(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.su?(xs(e),this.su=!1):Ss("OnlineStateTracker",e)}cu(){null!==this.nu&&(this.nu.cancel(),this.nu=null)}}class Uh{constructor(t,e,n,s,r){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.au=[],this.hu=new Map,this.lu=new Set,this.fu=[],this.du=r,this.du.Br((t=>{n.enqueueAndForget((async()=>{Hh(this)&&(Ss("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=ks(t);e.lu.add(4),await qh(e),e._u.set("Unknown"),e.lu.delete(4),await Bh(e)}(this))}))})),this._u=new Ph(n,s)}}async function Bh(t){if(Hh(t))for(const e of t.fu)await e(!0)}async function qh(t){for(const e of t.fu)await e(!1)}function Kh(t,e){const n=ks(t);n.hu.has(e.targetId)||(n.hu.set(e.targetId,e),Qh(n)?zh(n):dl(n).Co()&&jh(n,e))}function Gh(t,e){const n=ks(t),s=dl(n);n.hu.delete(e),s.Co()&&$h(n,e),0===n.hu.size&&(s.Co()?s.ko():Hh(n)&&n._u.set("Unknown"))}function jh(t,e){t.wu.Nt(e.targetId),dl(t).Qo(e)}function $h(t,e){t.wu.Nt(e),dl(t).jo(e)}function zh(t){t.wu=new ca({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),te:e=>t.hu.get(e)||null}),dl(t).start(),t._u.iu()}function Qh(t){return Hh(t)&&!dl(t).Do()&&t.hu.size>0}function Hh(t){return 0===ks(t).lu.size}function Wh(t){t.wu=void 0}async function Xh(t){t.hu.forEach(((e,n)=>{jh(t,e)}))}async function Yh(t,e){Wh(t),Qh(t)?(t._u.uu(e),zh(t)):t._u.set("Unknown")}async function Jh(t,e,n){if(t._u.set("Online"),e instanceof aa&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const s of e.targetIds)t.hu.has(s)&&(await t.remoteSyncer.rejectListen(s,n),t.hu.delete(s),t.wu.removeTarget(s))}(t,e)}catch(n){Ss("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await Zh(t,n)}else if(e instanceof ia?t.wu.Ut(e):e instanceof oa?t.wu.zt(e):t.wu.Gt(e),!n.isEqual(Xs.min()))try{const e=await ih(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.wu.Yt(e);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=t.hu.get(s);r&&t.hu.set(s,r.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.hu.get(e);if(!n)return;t.hu.set(e,n.withResumeToken(Pr.EMPTY_BYTE_STRING,n.snapshotVersion)),$h(t,e);const s=new bu(n.target,e,1,n.sequenceNumber);jh(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){Ss("RemoteStore","Failed to raise snapshot:",e),await Zh(t,e)}}async function Zh(t,e,n){if(!vr(e))throw e;t.lu.add(1),await qh(t),t._u.set("Offline"),n||(n=()=>ih(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{Ss("RemoteStore","Retrying IndexedDB access"),await n(),t.lu.delete(1),await Bh(t)}))}function tl(t,e){return e().catch((n=>Zh(t,n,e)))}async function el(t){const e=ks(t),n=fl(e);let s=e.au.length>0?e.au[e.au.length-1].batchId:-1;for(;nl(e);)try{const t=await ah(e.localStore,s);if(null===t){0===e.au.length&&n.ko();break}s=t.batchId,sl(e,t)}catch(t){await Zh(e,t)}rl(e)&&il(e)}function nl(t){return Hh(t)&&t.au.length<10}function sl(t,e){t.au.push(e);const n=fl(t);n.Co()&&n.zo&&n.Ho(e.mutations)}function rl(t){return Hh(t)&&!fl(t).Do()&&t.au.length>0}function il(t){fl(t).start()}async function ol(t){fl(t).Xo()}async function al(t){const e=fl(t);for(const n of t.au)e.Ho(n.mutations)}async function ul(t,e,n){const s=t.au.shift(),r=vu.from(s,e,n);await tl(t,(()=>t.remoteSyncer.applySuccessfulWrite(r))),await el(t)}async function cl(t,e){e&&fl(t).zo&&await async function(t,e){if(qo(n=e.code)&&n!==Rs.ABORTED){const n=t.au.shift();fl(t).No(),await tl(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await el(t)}var n}(t,e),rl(t)&&il(t)}async function hl(t,e){const n=ks(t);n.asyncQueue.verifyOperationInProgress(),Ss("RemoteStore","RemoteStore received new credentials");const s=Hh(n);n.lu.add(3),await qh(n),s&&n._u.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.lu.delete(3),await Bh(n)}async function ll(t,e){const n=ks(t);e?(n.lu.delete(2),await Bh(n)):e||(n.lu.add(2),await qh(n),n._u.set("Unknown"))}function dl(t){return t.mu||(t.mu=function(t,e,n){const s=ks(t);return s.tu(),new Lh(e,s.bo,s.authCredentials,s.appCheckCredentials,s.wt,n)}(t.datastore,t.asyncQueue,{zr:Xh.bind(null,t),Jr:Yh.bind(null,t),Go:Jh.bind(null,t)}),t.fu.push((async e=>{e?(t.mu.No(),Qh(t)?zh(t):t._u.set("Unknown")):(await t.mu.stop(),Wh(t))}))),t.mu}function fl(t){return t.gu||(t.gu=function(t,e,n){const s=ks(t);return s.tu(),new Oh(e,s.bo,s.authCredentials,s.appCheckCredentials,s.wt,n)}(t.datastore,t.asyncQueue,{zr:ol.bind(null,t),Jr:cl.bind(null,t),Yo:al.bind(null,t),Jo:ul.bind(null,t)}),t.fu.push((async e=>{e?(t.gu.No(),await el(t)):(await t.gu.stop(),t.au.length>0&&(Ss("RemoteStore",`Stopping write stream with ${t.au.length} pending writes`),t.au=[]))}))),t.gu}class ml{constructor(t,e,n,s,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new Vs,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,s,r){const i=Date.now()+n,o=new ml(t,e,i,s,r);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Ms(Rs.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function gl(t,e){if(xs("AsyncQueue",`${e}: ${t}`),vr(t))return new Ms(Rs.UNAVAILABLE,`${e}: ${t}`);throw t}class pl{constructor(t){this.comparator=t?(e,n)=>t(e,n)||er.comparator(e.key,n.key):(t,e)=>er.comparator(t.key,e.key),this.keyedMap=Qo(),this.sortedSet=new Cr(this.comparator)}static emptySet(t){return new pl(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof pl))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(!t.isEqual(s))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new pl;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class yl{constructor(){this.yu=new Cr(er.comparator)}track(t){const e=t.doc.key,n=this.yu.get(e);n?0!==t.type&&3===n.type?this.yu=this.yu.insert(e,t):3===t.type&&1!==n.type?this.yu=this.yu.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.yu=this.yu.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.yu=this.yu.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.yu=this.yu.remove(e):1===t.type&&2===n.type?this.yu=this.yu.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.yu=this.yu.insert(e,{type:2,doc:t.doc}):_s():this.yu=this.yu.insert(e,t)}pu(){const t=[];return this.yu.inorderTraversal(((e,n)=>{t.push(n)})),t}}class wl{constructor(t,e,n,s,r,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,s){const r=[];return e.forEach((t=>{r.push({type:0,doc:t})})),new wl(t,e,pl.emptySet(e),r,n,s,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ji(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class vl{constructor(){this.Iu=void 0,this.listeners=[]}}class Il{constructor(){this.queries=new Go((t=>Zi(t)),Ji),this.onlineState="Unknown",this.Tu=new Set}}async function bl(t,e){const n=ks(t),s=e.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new vl),r)try{i.Iu=await n.onListen(s)}catch(t){const n=gl(t,`Initialization of query '${to(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,i),i.listeners.push(e),e.Eu(n.onlineState),i.Iu&&e.Au(i.Iu)&&xl(n)}async function Tl(t,e){const n=ks(t),s=e.query;let r=!1;const i=n.queries.get(s);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function El(t,e){const n=ks(t);let s=!1;for(const t of e){const e=t.query,r=n.queries.get(e);if(r){for(const e of r.listeners)e.Au(t)&&(s=!0);r.Iu=t}}s&&xl(n)}function Sl(t,e,n){const s=ks(t),r=s.queries.get(e);if(r)for(const t of r.listeners)t.onError(n);s.queries.delete(e)}function xl(t){t.Tu.forEach((t=>{t.next()}))}class Dl{constructor(t,e,n){this.query=t,this.Ru=e,this.bu=!1,this.Pu=null,this.onlineState="Unknown",this.options=n||{}}Au(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new wl(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.bu?this.vu(t)&&(this.Ru.next(t),e=!0):this.Vu(t,this.onlineState)&&(this.Su(t),e=!0),this.Pu=t,e}onError(t){this.Ru.error(t)}Eu(t){this.onlineState=t;let e=!1;return this.Pu&&!this.bu&&this.Vu(this.Pu,t)&&(this.Su(this.Pu),e=!0),e}Vu(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return!(this.options.Du&&n||t.docs.isEmpty()&&"Offline"!==e)}vu(t){if(t.docChanges.length>0)return!0;const e=this.Pu&&this.Pu.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Su(t){t=wl.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.bu=!0,this.Ru.next(t)}}class Al{constructor(t,e){this.payload=t,this.byteLength=e}Cu(){return"metadata"in this.payload}}class _l{constructor(t){this.wt=t}Wi(t){return Ta(this.wt,t)}zi(t){return t.metadata.exists?_a(this.wt,t.document,!1):Ii.newNoDocument(this.Wi(t.metadata.name),this.Hi(t.metadata.readTime))}Hi(t){return wa(t)}}class Nl{constructor(t,e,n){this.xu=t,this.localStore=e,this.wt=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Cl(t)}Nu(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.payload.namedQuery)this.queries.push(t.payload.namedQuery);else if(t.payload.documentMetadata){this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e;const n=Js.fromString(t.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}ku(t){const e=new Map,n=new _l(this.wt);for(const s of t)if(s.metadata.queries){const t=n.Wi(s.metadata.name);for(const n of s.metadata.queries){const s=(e.get(n)||ta()).add(t);e.set(n,s)}}return e}async complete(){const t=await async function(t,e,n,s){const r=ks(t);let i=ta(),o=$o();for(const t of n){const n=e.Wi(t.metadata.name);t.document&&(i=i.add(n));const s=e.zi(t);s.setReadTime(e.Hi(t.metadata.readTime)),o=o.insert(n,s)}const a=r.Ui.newChangeBuffer({trackRemovals:!0}),u=await uh(r,function(t){return Xi($i(Js.fromString(`__bundle__/docs/${t}`)))}(s));return r.persistence.runTransaction("Apply bundle documents","readwrite",(t=>oh(t,a,o).next((e=>(a.apply(t),e))).next((e=>r.Vs.removeMatchingKeysForTargetId(t,u.targetId).next((()=>r.Vs.addMatchingKeys(t,i,u.targetId))).next((()=>r.localDocuments.getLocalViewOfDocuments(t,e.Gi,e.Qi))).next((()=>e.Gi))))))}(this.localStore,new _l(this.wt),this.documents,this.xu.id),e=this.ku(this.documents);for(const t of this.queries)await mh(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,Ou:this.collectionGroups,Mu:t}}}function Cl(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class kl{constructor(t){this.key=t}}class Rl{constructor(t){this.key=t}}class Ml{constructor(t,e){this.query=t,this.Fu=e,this.$u=null,this.current=!1,this.Bu=ta(),this.mutatedKeys=ta(),this.Lu=so(t),this.Uu=new pl(this.Lu)}get qu(){return this.Fu}Ku(t,e){const n=e?e.Gu:new yl,s=e?e.Uu:this.Uu;let r=e?e.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,u="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(t.inorderTraversal(((t,e)=>{const c=s.get(t),h=eo(this.query,e)?e:null,l=!!c&&this.mutatedKeys.has(c.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;c&&h?c.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.Qu(c,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Lu(h,a)>0||u&&this.Lu(h,u)<0)&&(o=!0)):!c&&h?(n.track({type:0,doc:h}),f=!0):c&&!h&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(h?(i=i.add(h),r=d?r.add(t):r.delete(t)):(i=i.delete(t),r=r.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),r=r.delete(t.key),n.track({type:1,doc:t})}return{Uu:i,Gu:n,Oi:o,mutatedKeys:r}}Qu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const s=this.Uu;this.Uu=t.Uu,this.mutatedKeys=t.mutatedKeys;const r=t.Gu.pu();r.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return _s()}};return n(t)-n(e)}(t.type,e.type)||this.Lu(t.doc,e.doc))),this.ju(n);const i=e?this.Wu():[],o=0===this.Bu.size&&this.current?1:0,a=o!==this.$u;return this.$u=o,0!==r.length||a?{snapshot:new wl(this.query,t.Uu,s,r,t.mutatedKeys,0===o,a,!1),zu:i}:{zu:i}}Eu(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Uu:this.Uu,Gu:new yl,mutatedKeys:this.mutatedKeys,Oi:!1},!1)):{zu:[]}}Hu(t){return!this.Fu.has(t)&&!!this.Uu.has(t)&&!this.Uu.get(t).hasLocalMutations}ju(t){t&&(t.addedDocuments.forEach((t=>this.Fu=this.Fu.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.Fu=this.Fu.delete(t))),this.current=t.current)}Wu(){if(!this.current)return[];const t=this.Bu;this.Bu=ta(),this.Uu.forEach((t=>{this.Hu(t.key)&&(this.Bu=this.Bu.add(t.key))}));const e=[];return t.forEach((t=>{this.Bu.has(t)||e.push(new Rl(t))})),this.Bu.forEach((n=>{t.has(n)||e.push(new kl(n))})),e}Ju(t){this.Fu=t.ji,this.Bu=ta();const e=this.Ku(t.documents);return this.applyChanges(e,!0)}Yu(){return wl.fromInitialDocuments(this.query,this.Uu,this.mutatedKeys,0===this.$u)}}class Vl{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class Ll{constructor(t){this.key=t,this.Xu=!1}}class Ol{constructor(t,e,n,s,r,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.Zu={},this.tc=new Go((t=>Zi(t)),Ji),this.ec=new Map,this.nc=new Set,this.sc=new Cr(er.comparator),this.ic=new Map,this.rc=new Pc,this.oc={},this.uc=new Map,this.cc=mc.Rn(),this.onlineState="Unknown",this.ac=void 0}get isPrimaryClient(){return!0===this.ac}}async function Fl(t,e){const n=cd(t);let s,r;const i=n.tc.get(e);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.Yu();else{const t=await uh(n.localStore,Xi(e));n.isPrimaryClient&&Kh(n.remoteStore,t);const i=n.sharedClientState.addLocalQueryTarget(t.targetId);s=t.targetId,r=await Pl(n,e,s,"current"===i)}return r}async function Pl(t,e,n,s){t.hc=(e,n,s)=>async function(t,e,n,s){let r=e.view.Ku(n);r.Oi&&(r=await hh(t.localStore,e.query,!1).then((({documents:t})=>e.view.Ku(t,r))));const i=s&&s.targetChanges.get(e.targetId),o=e.view.applyChanges(r,t.isPrimaryClient,i);return Wl(t,e.targetId,o.zu),o.snapshot}(t,e,n,s);const r=await hh(t.localStore,e,!0),i=new Ml(e,r.ji),o=i.Ku(r.documents),a=ra.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==t.onlineState),u=i.applyChanges(o,t.isPrimaryClient,a);Wl(t,n,u.zu);const c=new Vl(e,n,i);return t.tc.set(e,c),t.ec.has(n)?t.ec.get(n).push(e):t.ec.set(n,[e]),u.snapshot}async function Ul(t,e){const n=ks(t),s=n.tc.get(e),r=n.ec.get(s.targetId);if(r.length>1)return n.ec.set(s.targetId,r.filter((t=>!Ji(t,e)))),void n.tc.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await ch(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),Gh(n.remoteStore,s.targetId),Ql(n,s.targetId)})).catch(fr)):(Ql(n,s.targetId),await ch(n.localStore,s.targetId,!0))}async function Bl(t,e){const n=ks(t);try{const t=await function(t,e){const n=ks(t),s=e.snapshotVersion;let r=n.$i;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Ui.newChangeBuffer({trackRemovals:!0});r=n.$i;const o=[];e.targetChanges.forEach(((i,a)=>{const u=r.get(a);if(!u)return;o.push(n.Vs.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Vs.addMatchingKeys(t,i.addedDocuments,a))));let c=u.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(a)?c=c.withResumeToken(Pr.EMPTY_BYTE_STRING,Xs.min()).withLastLimboFreeSnapshotVersion(Xs.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,s)),r=r.insert(a,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Vs.updateTargetData(t,c))}));let a=$o(),u=ta();if(e.documentUpdates.forEach((s=>{e.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,s))})),o.push(oh(t,i,e.documentUpdates).next((t=>{a=t.Gi,u=t.Qi}))),!s.isEqual(Xs.min())){const e=n.Vs.getLastRemoteSnapshotVersion(t).next((e=>n.Vs.setTargetsMetadata(t,t.currentSequenceNumber,s)));o.push(e)}return mr.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,u))).next((()=>a))})).then((t=>(n.$i=r,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const s=n.ic.get(e);s&&(Ns(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?s.Xu=!0:t.modifiedDocuments.size>0?Ns(s.Xu):t.removedDocuments.size>0&&(Ns(s.Xu),s.Xu=!1))})),await Jl(n,t,e)}catch(t){await fr(t)}}function ql(t,e,n){const s=ks(t);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const t=[];s.tc.forEach(((n,s)=>{const r=s.view.Eu(e);r.snapshot&&t.push(r.snapshot)})),function(t,e){const n=ks(t);n.onlineState=e;let s=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.Eu(e)&&(s=!0)})),s&&xl(n)}(s.eventManager,e),t.length&&s.Zu.Go(t),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function Kl(t,e,n){const s=ks(t);s.sharedClientState.updateQueryState(e,"rejected",n);const r=s.ic.get(e),i=r&&r.key;if(i){let t=new Cr(er.comparator);t=t.insert(i,Ii.newNoDocument(i,Xs.min()));const n=ta().add(i),r=new sa(Xs.min(),new Map,new Mr(zs),t,n);await Bl(s,r),s.sc=s.sc.remove(i),s.ic.delete(e),Yl(s)}else await ch(s.localStore,e,!1).then((()=>Ql(s,e,n))).catch(fr)}async function Gl(t,e){const n=ks(t),s=e.batch.batchId;try{const t=await function(t,e){const n=ks(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const s=e.batch.keys(),r=n.Ui.newChangeBuffer({trackRemovals:!0});return function(t,e,n,s){const r=n.batch,i=r.keys();let o=mr.resolve();return i.forEach((t=>{o=o.next((()=>s.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);Ns(null!==i),e.version.compareTo(i)<0&&(r.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),s.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,r)))}(n,t,e,r).next((()=>r.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=ta();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(n.localStore,e);zl(n,s,null),$l(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await Jl(n,t)}catch(t){await fr(t)}}async function jl(t,e,n){const s=ks(t);try{const t=await function(t,e){const n=ks(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let s;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(Ns(null!==e),s=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,s))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(s.localStore,e);zl(s,e,n),$l(s,e),s.sharedClientState.updateMutationState(e,"rejected",n),await Jl(s,t)}catch(n){await fr(n)}}function $l(t,e){(t.uc.get(e)||[]).forEach((t=>{t.resolve()})),t.uc.delete(e)}function zl(t,e,n){const s=ks(t);let r=s.oc[s.currentUser.toKey()];if(r){const t=r.get(e);t&&(n?t.reject(n):t.resolve(),r=r.remove(e)),s.oc[s.currentUser.toKey()]=r}}function Ql(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const s of t.ec.get(e))t.tc.delete(s),n&&t.Zu.lc(s,n);t.ec.delete(e),t.isPrimaryClient&&t.rc.us(e).forEach((e=>{t.rc.containsKey(e)||Hl(t,e)}))}function Hl(t,e){t.nc.delete(e.path.canonicalString());const n=t.sc.get(e);null!==n&&(Gh(t.remoteStore,n),t.sc=t.sc.remove(e),t.ic.delete(n),Yl(t))}function Wl(t,e,n){for(const s of n)s instanceof kl?(t.rc.addReference(s.key,e),Xl(t,s)):s instanceof Rl?(Ss("SyncEngine","Document no longer in limbo: "+s.key),t.rc.removeReference(s.key,e),t.rc.containsKey(s.key)||Hl(t,s.key)):_s()}function Xl(t,e){const n=e.key,s=n.path.canonicalString();t.sc.get(n)||t.nc.has(s)||(Ss("SyncEngine","New document in limbo: "+n),t.nc.add(s),Yl(t))}function Yl(t){for(;t.nc.size>0&&t.sc.size<t.maxConcurrentLimboResolutions;){const e=t.nc.values().next().value;t.nc.delete(e);const n=new er(Js.fromString(e)),s=t.cc.next();t.ic.set(s,new Ll(n)),t.sc=t.sc.insert(n,s),Kh(t.remoteStore,new bu(Xi($i(n.path)),s,2,Dr.ot))}}async function Jl(t,e,n){const s=ks(t),r=[],i=[],o=[];s.tc.isEmpty()||(s.tc.forEach(((t,a)=>{o.push(s.hc(a,e,n).then((t=>{if(t){s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),r.push(t);const e=th.Vi(a.targetId,t);i.push(e)}})))})),await Promise.all(o),s.Zu.Go(r),await async function(t,e){const n=ks(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>mr.forEach(e,(e=>mr.forEach(e.Pi,(s=>n.persistence.referenceDelegate.addReference(t,e.targetId,s))).next((()=>mr.forEach(e.vi,(s=>n.persistence.referenceDelegate.removeReference(t,e.targetId,s)))))))))}catch(t){if(!vr(t))throw t;Ss("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.$i.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.$i=n.$i.insert(e,r)}}}(s.localStore,i))}async function Zl(t,e){const n=ks(t);if(!n.currentUser.isEqual(e)){Ss("SyncEngine","User change. New user:",e.toKey());const t=await rh(n.localStore,e);n.currentUser=e,function(t,e){t.uc.forEach((t=>{t.forEach((t=>{t.reject(new Ms(Rs.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.uc.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await Jl(n,t.Ki)}}function td(t,e){const n=ks(t),s=n.ic.get(e);if(s&&s.Xu)return ta().add(s.key);{let t=ta();const s=n.ec.get(e);if(!s)return t;for(const e of s){const s=n.tc.get(e);t=t.unionWith(s.view.qu)}return t}}async function ed(t,e){const n=ks(t),s=await hh(n.localStore,e.query,!0),r=e.view.Ju(s);return n.isPrimaryClient&&Wl(n,e.targetId,r.zu),r}async function nd(t,e){const n=ks(t);return dh(n.localStore,e).then((t=>Jl(n,t)))}async function sd(t,e,n,s){const r=ks(t),i=await function(t,e){const n=ks(t),s=ks(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>s.yn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):mr.resolve(null)))))}(r.localStore,e);null!==i?("pending"===n?await el(r.remoteStore):"acknowledged"===n||"rejected"===n?(zl(r,e,s||null),$l(r,e),function(t,e){ks(ks(t).mutationQueue).In(e)}(r.localStore,e)):_s(),await Jl(r,i)):Ss("SyncEngine","Cannot apply mutation batch with id: "+e)}async function rd(t,e,n){const s=ks(t),r=[],i=[];for(const t of e){let e;const n=s.ec.get(t);if(n&&0!==n.length){e=await uh(s.localStore,Xi(n[0]));for(const t of n){const e=s.tc.get(t),n=await ed(s,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await lh(s.localStore,t);e=await uh(s.localStore,n),await Pl(s,id(n),t,!1)}r.push(e)}return s.Zu.Go(i),r}function id(t){return ji(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function od(t){const e=ks(t);return ks(ks(e.localStore).persistence).Ri()}async function ad(t,e,n,s){const r=ks(t);if(r.ac)return void Ss("SyncEngine","Ignoring unexpected query state notification.");const i=r.ec.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await dh(r.localStore,no(i[0])),s=sa.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await Jl(r,t,s);break}case"rejected":await ch(r.localStore,e,!0),Ql(r,e,s);break;default:_s()}}async function ud(t,e,n){const s=cd(t);if(s.ac){for(const t of e){if(s.ec.has(t)){Ss("SyncEngine","Adding an already active target "+t);continue}const e=await lh(s.localStore,t),n=await uh(s.localStore,e);await Pl(s,id(e),n.targetId,!1),Kh(s.remoteStore,n)}for(const t of n)s.ec.has(t)&&await ch(s.localStore,t,!1).then((()=>{Gh(s.remoteStore,t),Ql(s,t)})).catch(fr)}}function cd(t){const e=ks(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Bl.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=td.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Kl.bind(null,e),e.Zu.Go=El.bind(null,e.eventManager),e.Zu.lc=Sl.bind(null,e.eventManager),e}function hd(t){const e=ks(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Gl.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=jl.bind(null,e),e}class ld{constructor(){this.synchronizeTabs=!1}async initialize(t){this.wt=Rh(t.databaseInfo.databaseId),this.sharedClientState=this.dc(t),this.persistence=this._c(t),await this.persistence.start(),this.localStore=this.wc(t),this.gcScheduler=this.mc(t,this.localStore),this.indexBackfillerScheduler=this.gc(t,this.localStore)}mc(t,e){return null}gc(t,e){return null}wc(t){return sh(this.persistence,new eh,t.initialUser,this.wt)}_c(t){return new jc(zc.Ms,this.wt)}dc(t){return new Sh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class dd extends ld{constructor(t,e,n){super(),this.yc=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.yc.initialize(this,t),await hd(this.yc.syncEngine),await el(this.yc.remoteStore),await this.persistence.ci((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}wc(t){return sh(this.persistence,new eh,t.initialUser,this.wt)}mc(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new bc(n,t.asyncQueue,e)}gc(t,e){const n=new xr(e,this.persistence);return new Sr(t.asyncQueue,n)}_c(t){const e=Zc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?oc.withCacheSize(this.cacheSizeBytes):oc.DEFAULT;return new Xc(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Ch(),kh(),this.wt,this.sharedClientState,!!this.forceOwnership)}dc(t){return new Sh}}class fd extends dd{constructor(t,e){super(t,e,!1),this.yc=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.yc.syncEngine;this.sharedClientState instanceof Eh&&(this.sharedClientState.syncEngine={kr:sd.bind(null,e),Or:ad.bind(null,e),Mr:ud.bind(null,e),Ri:od.bind(null,e),Nr:nd.bind(null,e)},await this.sharedClientState.start()),await this.persistence.ci((async t=>{await async function(t,e){const n=ks(t);if(cd(n),hd(n),!0===e&&!0!==n.ac){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await rd(n,t.toArray());n.ac=!0,await ll(n.remoteStore,!0);for(const t of e)Kh(n.remoteStore,t)}else if(!1===e&&!1!==n.ac){const t=[];let e=Promise.resolve();n.ec.forEach(((s,r)=>{n.sharedClientState.isLocalQueryTarget(r)?t.push(r):e=e.then((()=>(Ql(n,r),ch(n.localStore,r,!0)))),Gh(n.remoteStore,r)})),await e,await rd(n,t),function(t){const e=ks(t);e.ic.forEach(((t,n)=>{Gh(e.remoteStore,n)})),e.rc.cs(),e.ic=new Map,e.sc=new Cr(er.comparator)}(n),n.ac=!1,await ll(n.remoteStore,!1)}}(this.yc.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}dc(t){const e=Ch();if(!Eh.V(e))throw new Ms(Rs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Zc(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Eh(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class md{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>ql(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=Zl.bind(null,this.syncEngine),await ll(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Il}createDatastore(t){const e=Rh(t.databaseInfo.databaseId),n=(s=t.databaseInfo,new Nh(s));var s;return function(t,e,n,s){return new Fh(t,e,n,s)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,s=t.asyncQueue,r=t=>ql(this.syncEngine,t,0),i=Dh.V()?new Dh:new xh,new Uh(e,n,s,r,i);var e,n,s,r,i}createSyncEngine(t,e){return function(t,e,n,s,r,i,o){const a=new Ol(t,e,n,s,r,i);return o&&(a.ac=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=ks(t);Ss("RemoteStore","RemoteStore shutting down."),e.lu.add(5),await qh(e),e.du.shutdown(),e._u.set("Unknown")}(this.remoteStore)}}function gd(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const s={value:t.slice(n,n+e),done:!1};return n+=e,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class pd{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ic(this.observer.next,t)}error(t){this.observer.error?this.Ic(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}Tc(){this.muted=!0}Ic(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class yd{constructor(t,e){this.Ec=t,this.wt=e,this.metadata=new Vs,this.buffer=new Uint8Array,this.Ac=new TextDecoder("utf-8"),this.Rc().then((t=>{t&&t.Cu()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.Ec.cancel()}async getMetadata(){return this.metadata.promise}async fc(){return await this.getMetadata(),this.Rc()}async Rc(){const t=await this.bc();if(null===t)return null;const e=this.Ac.decode(t),n=Number(e);isNaN(n)&&this.Pc(`length string (${e}) is not valid number`);const s=await this.vc(n);return new Al(JSON.parse(s),t.length+n)}Vc(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async bc(){for(;this.Vc()<0&&!await this.Sc(););if(0===this.buffer.length)return null;const t=this.Vc();t<0&&this.Pc("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async vc(t){for(;this.buffer.length<t;)await this.Sc()&&this.Pc("Reached the end of bundle when more is expected.");const e=this.Ac.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}Pc(t){throw this.Ec.cancel(),new Error(`Invalid bundle format: ${t}`)}async Sc(){const t=await this.Ec.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class wd{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new Ms(Rs.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=ks(t),s=xa(n.wt)+"/documents",r={documents:e.map((t=>ba(n.wt,t)))},i=await n.ao("BatchGetDocuments",s,r),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Ns(!!e.found),e.found.name,e.found.updateTime;const n=Ta(t,e.found.name),s=wa(e.found.updateTime),r=new wi({mapValue:{fields:e.found.fields}});return Ii.newFoundDocument(n,s,r)}(t,e):"missing"in e?function(t,e){Ns(!!e.missing),Ns(!!e.readTime);const n=Ta(t,e.missing),s=wa(e.readTime);return Ii.newNoDocument(n,s)}(t,e):_s()}(n.wt,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());Ns(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new Oo(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=er.fromPath(e);this.mutations.push(new Fo(n,this.precondition(n)))})),await async function(t,e){const n=ks(t),s=xa(n.wt)+"/documents",r={writes:e.map((t=>Na(n.wt,t)))};await n.ro("Commit",s,r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw _s();e=Xs.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Ms(Rs.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?Eo.updateTime(e):Eo.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(Xs.min()))throw new Ms(Rs.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Eo.updateTime(e)}return Eo.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class vd{constructor(t,e,n,s,r){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=s,this.deferred=r,this.Dc=n.maxAttempts,this.So=new Mh(this.asyncQueue,"transaction_retry")}run(){this.Dc-=1,this.Cc()}Cc(){this.So.Io((async()=>{const t=new wd(this.datastore),e=this.xc(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Nc(t)}))))})).catch((t=>{this.Nc(t)}))}))}xc(t){try{const e=this.updateFunction(t);return!Hr(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Nc(t){this.Dc>0&&this.kc(t)?(this.Dc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Cc(),Promise.resolve())))):this.deferred.reject(t)}kc(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!qo(e)}return!1}}class Id{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=vs.UNAUTHENTICATED,this.clientId=$s.I(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{Ss("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(Ss("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Ms(Rs.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new Vs;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=gl(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function bd(t,e){t.asyncQueue.verifyOperationInProgress(),Ss("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let s=n.initialUser;t.setCredentialChangeListener((async t=>{s.isEqual(t)||(await rh(e.localStore,t),s=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function Td(t,e){t.asyncQueue.verifyOperationInProgress();const n=await Ed(t);Ss("FirestoreClient","Initializing OnlineComponentProvider");const s=await t.getConfiguration();await e.initialize(n,s),t.setCredentialChangeListener((t=>hl(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>hl(e.remoteStore,n))),t.onlineComponents=e}async function Ed(t){return t.offlineComponents||(Ss("FirestoreClient","Using default OfflineComponentProvider"),await bd(t,new ld)),t.offlineComponents}async function Sd(t){return t.onlineComponents||(Ss("FirestoreClient","Using default OnlineComponentProvider"),await Td(t,new md)),t.onlineComponents}function xd(t){return Ed(t).then((t=>t.persistence))}function Dd(t){return Ed(t).then((t=>t.localStore))}function Ad(t){return Sd(t).then((t=>t.remoteStore))}function _d(t){return Sd(t).then((t=>t.syncEngine))}async function Nd(t){const e=await Sd(t),n=e.eventManager;return n.onListen=Fl.bind(null,e.syncEngine),n.onUnlisten=Ul.bind(null,e.syncEngine),n}function Cd(t,e,n={}){const s=new Vs;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new pd({next:i=>{e.enqueueAndForget((()=>Tl(t,o)));const a=i.docs.has(n);!a&&i.fromCache?r.reject(new Ms(Rs.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&s&&"server"===s.source?r.reject(new Ms(Rs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(i)},error:t=>r.reject(t)}),o=new Dl($i(n.path),i,{includeMetadataChanges:!0,Du:!0});return bl(t,o)}(await Nd(t),t.asyncQueue,e,n,s))),s.promise}function kd(t,e,n={}){const s=new Vs;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new pd({next:n=>{e.enqueueAndForget((()=>Tl(t,o))),n.fromCache&&"server"===s.source?r.reject(new Ms(Rs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:t=>r.reject(t)}),o=new Dl(n,i,{includeMetadataChanges:!0,Du:!0});return bl(t,o)}(await Nd(t),t.asyncQueue,e,n,s))),s.promise}const Rd=new Map;function Md(t,e,n){if(!n)throw new Ms(Rs.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Vd(t,e,n,s){if(!0===e&&!0===s)throw new Ms(Rs.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Ld(t){if(!er.isDocumentKey(t))throw new Ms(Rs.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Od(t){if(er.isDocumentKey(t))throw new Ms(Rs.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Fd(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":_s()}function Pd(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Ms(Rs.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Fd(t);throw new Ms(Rs.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Ud(t,e){if(e<=0)throw new Ms(Rs.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Bd{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Ms(Rs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Ms(Rs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Vd("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class qd{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Bd({}),this._settingsFrozen=!1,t instanceof Qr?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Ms(Rs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Qr(t.options.projectId)}(t))}get app(){if(!this._app)throw new Ms(Rs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Ms(Rs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Bd(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Os;switch(t.type){case"gapi":const e=t.client;return Ns(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new Bs(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new Ms(Rs.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Rd.get(t);e&&(Ss("ComponentProvider","Removing Datastore"),Rd.delete(t),e.terminate())}(this),Promise.resolve()}}function Kd(t,e,n,s={}){var r;const i=(t=Pd(t,qd))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Ds("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),s.mockUserToken){let e,n;if("string"==typeof s.mockUserToken)e=s.mockUserToken,n=vs.MOCK_USER;else{e=(0,a.Sg)(s.mockUserToken,null===(r=t._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new Ms(Rs.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new vs(i)}t._authCredentials=new Fs(new Ls(e,n))}}class Gd{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new $d(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Gd(this.firestore,t,this._key)}}class jd{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new jd(this.firestore,t,this._query)}}class $d extends jd{constructor(t,e,n){super(t,e,$i(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Gd(this.firestore,null,new er(t))}withConverter(t){return new $d(this.firestore,t,this._path)}}function zd(t,e,...n){if(t=(0,a.m9)(t),Md("collection","path",e),t instanceof qd){const s=Js.fromString(e,...n);return Od(s),new $d(t,null,s)}{if(!(t instanceof Gd||t instanceof $d))throw new Ms(Rs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(Js.fromString(e,...n));return Od(s),new $d(t.firestore,null,s)}}function Qd(t,e){if(t=Pd(t,qd),Md("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Ms(Rs.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new jd(t,null,function(t){return new Gi(Js.emptyPath(),t)}(e))}function Hd(t,e,...n){if(t=(0,a.m9)(t),1===arguments.length&&(e=$s.I()),Md("doc","path",e),t instanceof qd){const s=Js.fromString(e,...n);return Ld(s),new Gd(t,null,new er(s))}{if(!(t instanceof Gd||t instanceof $d))throw new Ms(Rs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(Js.fromString(e,...n));return Ld(s),new Gd(t.firestore,t instanceof $d?t.converter:null,new er(s))}}function Wd(t,e){return t=(0,a.m9)(t),e=(0,a.m9)(e),(t instanceof Gd||t instanceof $d)&&(e instanceof Gd||e instanceof $d)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function Xd(t,e){return t=(0,a.m9)(t),e=(0,a.m9)(e),t instanceof jd&&e instanceof jd&&t.firestore===e.firestore&&Ji(t._query,e._query)&&t.converter===e.converter}class Yd{constructor(){this.Oc=Promise.resolve(),this.Mc=[],this.Fc=!1,this.$c=[],this.Bc=null,this.Lc=!1,this.Uc=!1,this.qc=[],this.So=new Mh(this,"async_queue_retry"),this.Kc=()=>{const t=kh();t&&Ss("AsyncQueue","Visibility state changed to "+t.visibilityState),this.So.Eo()};const t=kh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Kc)}get isShuttingDown(){return this.Fc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Gc(),this.Qc(t)}enterRestrictedMode(t){if(!this.Fc){this.Fc=!0,this.Uc=t||!1;const e=kh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.Kc)}}enqueue(t){if(this.Gc(),this.Fc)return new Promise((()=>{}));const e=new Vs;return this.Qc((()=>this.Fc&&this.Uc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.Mc.push(t),this.jc())))}async jc(){if(0!==this.Mc.length){try{await this.Mc[0](),this.Mc.shift(),this.So.reset()}catch(t){if(!vr(t))throw t;Ss("AsyncQueue","Operation failed with retryable error: "+t)}this.Mc.length>0&&this.So.Io((()=>this.jc()))}}Qc(t){const e=this.Oc.then((()=>(this.Lc=!0,t().catch((t=>{this.Bc=t,this.Lc=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw xs("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.Lc=!1,t))))));return this.Oc=e,e}enqueueAfterDelay(t,e,n){this.Gc(),this.qc.indexOf(t)>-1&&(e=0);const s=ml.createAndSchedule(this,t,e,n,(t=>this.Wc(t)));return this.$c.push(s),s}Gc(){this.Bc&&_s()}verifyOperationInProgress(){}async zc(){let t;do{t=this.Oc,await t}while(t!==this.Oc)}Hc(t){for(const e of this.$c)if(e.timerId===t)return!0;return!1}Jc(t){return this.zc().then((()=>{this.$c.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.$c)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.zc()}))}Yc(t){this.qc.push(t)}Wc(t){const e=this.$c.indexOf(t);this.$c.splice(e,1)}}function Jd(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class Zd{constructor(){this._progressObserver={},this._taskCompletionResolver=new Vs,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const tf=-1;class ef extends qd{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new Yd,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||of(this),this._firestoreClient.terminate()}}function nf(t,e){const n=(0,r.qX)(t,"firestore");if(n.isInitialized()){const t=n.getImmediate(),s=n.getOptions();if((0,a.vZ)(s,e))return t;throw new Ms(Rs.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Ms(Rs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return n.initialize({options:e})}function sf(t=(0,r.Mq)()){return(0,r.qX)(t,"firestore").getImmediate()}function rf(t){return t._firestoreClient||of(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function of(t){var e;const n=t._freezeSettings(),s=function(t,e,n,s){return new zr(t,e,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new Id(t._authCredentials,t._appCheckCredentials,t._queue,s)}function af(t,e){yf(t=Pd(t,ef));const n=rf(t),s=t._freezeSettings(),r=new md;return cf(n,r,new dd(r,s.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function uf(t){yf(t=Pd(t,ef));const e=rf(t),n=t._freezeSettings(),s=new md;return cf(e,s,new fd(s,n.cacheSizeBytes))}function cf(t,e,n){const s=new Vs;return t.asyncQueue.enqueue((async()=>{try{await bd(t,n),await Td(t,e),s.resolve()}catch(t){if(!function(t){return"FirebaseError"===t.name?t.code===Rs.FAILED_PRECONDITION||t.code===Rs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}(t))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),s.reject(t)}})).then((()=>s.promise))}function hf(t){if(t._initialized&&!t._terminated)throw new Ms(Rs.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Vs;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!pr.V())return Promise.resolve();const e=t+"main";await pr.delete(e)}(Zc(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function lf(t){return function(t){const e=new Vs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=ks(t);Hh(n.remoteStore)||Ss("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=ks(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const s=n.uc.get(t)||[];s.push(e),n.uc.set(t,s)}catch(t){const n=gl(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await _d(t),e))),e.promise}(rf(t=Pd(t,ef)))}function df(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await xd(t),n=await Ad(t);return e.setNetworkEnabled(!0),function(t){const e=ks(t);return e.lu.delete(0),Bh(e)}(n)}))}(rf(t=Pd(t,ef)))}function ff(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await xd(t),n=await Ad(t);return e.setNetworkEnabled(!1),async function(t){const e=ks(t);e.lu.add(0),await qh(e),e._u.set("Offline")}(n)}))}(rf(t=Pd(t,ef)))}function mf(t){return(0,r.wN)(t.app,"firestore"),t._delete()}function gf(t,e){const n=rf(t=Pd(t,ef)),s=new Zd;return function(t,e,n,s){const r=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new yd(t,e)}(function(t,e){if(t instanceof Uint8Array)return gd(t,e);if(t instanceof ArrayBuffer)return gd(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Rh(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const s=ks(t);(async function(t,e,n){try{const s=await e.getMetadata();if(await function(t,e){const n=ks(t),s=wa(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Ds.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(s)>=0))}(t.localStore,s))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(s)),Promise.resolve(new Set);n._updateProgress(Cl(s));const r=new Nl(s,t.localStore,e.wt);let i=await e.fc();for(;i;){const t=await r.Nu(i);t&&n._updateProgress(t),i=await e.fc()}const o=await r.complete();return await Jl(t,o.Mu,void 0),await function(t,e){const n=ks(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Ds.saveBundleMetadata(t,e)))}(t.localStore,s),n._completeWith(o.progress),Promise.resolve(o.Ou)}catch(t){return Ds("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(s,e,n).then((t=>{s.sharedClientState.notifyBundleLoaded(t)}))}(await _d(t),r,s)}))}(n,t._databaseId,e,s),s}function pf(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=ks(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Ds.getNamedQuery(t,e)))}(await Dd(t),e)))}(rf(t=Pd(t,ef)),e).then((e=>e?new jd(t,null,e.query):null))}function yf(t){if(t._initialized||t._terminated)throw new Ms(Rs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class wf{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Ms(Rs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new tr(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function vf(){return new wf("__name__")}class If{constructor(t){this._byteString=t}static fromBase64String(t){try{return new If(Pr.fromBase64String(t))}catch(t){throw new Ms(Rs.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new If(Pr.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class bf{constructor(t){this._methodName=t}}class Tf{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Ms(Rs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Ms(Rs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return zs(this._lat,t._lat)||zs(this._long,t._long)}}const Ef=/^__.*__$/;class Sf{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Ro(t,this.data,this.fieldMask,e,this.fieldTransforms):new ko(t,this.data,e,this.fieldTransforms)}}class xf{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Ro(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function Df(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw _s()}}class Af{constructor(t,e,n,s,r,i){this.settings=t,this.databaseId=e,this.wt=n,this.ignoreUndefinedProperties=s,void 0===r&&this.Xc(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Zc(){return this.settings.Zc}ta(t){return new Af(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.wt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ea(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.ta({path:n,na:!1});return s.sa(t),s}ia(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.ta({path:n,na:!1});return s.Xc(),s}ra(t){return this.ta({path:void 0,na:!0})}oa(t){return Qf(t,this.settings.methodName,this.settings.ua||!1,this.path,this.settings.ca)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}Xc(){if(this.path)for(let t=0;t<this.path.length;t++)this.sa(this.path.get(t))}sa(t){if(0===t.length)throw this.oa("Document fields must not be empty");if(Df(this.Zc)&&Ef.test(t))throw this.oa('Document fields cannot begin and end with "__"')}}class _f{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.wt=n||Rh(t)}aa(t,e,n,s=!1){return new Af({Zc:t,methodName:e,ca:n,path:tr.emptyPath(),na:!1,ua:s},this.databaseId,this.wt,this.ignoreUndefinedProperties)}}function Nf(t){const e=t._freezeSettings(),n=Rh(t._databaseId);return new _f(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Cf(t,e,n,s,r,i={}){const o=t.aa(i.merge||i.mergeFields?2:0,e,n,r);Gf("Data must be an object, but it was:",o,s);const a=qf(s,o);let u,c;if(i.merge)u=new Or(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const s of i.mergeFields){const r=jf(e,s,n);if(!o.contains(r))throw new Ms(Rs.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);Hf(t,r)||t.push(r)}u=new Or(t),c=o.fieldTransforms.filter((t=>u.covers(t.field)))}else u=null,c=o.fieldTransforms;return new Sf(new wi(a),u,c)}class kf extends bf{_toFieldTransform(t){if(2!==t.Zc)throw 1===t.Zc?t.oa(`${this._methodName}() can only appear at the top level of your update data`):t.oa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof kf}}function Rf(t,e,n){return new Af({Zc:3,ca:e.settings.ca,methodName:t._methodName,na:n},e.databaseId,e.wt,e.ignoreUndefinedProperties)}class Mf extends bf{_toFieldTransform(t){return new bo(t.path,new fo)}isEqual(t){return t instanceof Mf}}class Vf extends bf{constructor(t,e){super(t),this.ha=e}_toFieldTransform(t){const e=Rf(this,t,!0),n=this.ha.map((t=>Bf(t,e))),s=new mo(n);return new bo(t.path,s)}isEqual(t){return this===t}}class Lf extends bf{constructor(t,e){super(t),this.ha=e}_toFieldTransform(t){const e=Rf(this,t,!0),n=this.ha.map((t=>Bf(t,e))),s=new po(n);return new bo(t.path,s)}isEqual(t){return this===t}}class Of extends bf{constructor(t,e){super(t),this.la=e}_toFieldTransform(t){const e=new wo(t.wt,ao(t.wt,this.la));return new bo(t.path,e)}isEqual(t){return this===t}}function Ff(t,e,n,s){const r=t.aa(1,e,n);Gf("Data must be an object, but it was:",r,s);const i=[],o=wi.empty();_r(s,((t,s)=>{const u=zf(e,t,n);s=(0,a.m9)(s);const c=r.ia(u);if(s instanceof kf)i.push(u);else{const t=Bf(s,c);null!=t&&(i.push(u),o.set(u,t))}}));const u=new Or(i);return new xf(o,u,r.fieldTransforms)}function Pf(t,e,n,s,r,i){const o=t.aa(1,e,n),u=[jf(e,s,n)],c=[r];if(i.length%2!=0)throw new Ms(Rs.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)u.push(jf(e,i[t])),c.push(i[t+1]);const h=[],l=wi.empty();for(let t=u.length-1;t>=0;--t)if(!Hf(h,u[t])){const e=u[t];let n=c[t];n=(0,a.m9)(n);const s=o.ia(e);if(n instanceof kf)h.push(e);else{const t=Bf(n,s);null!=t&&(h.push(e),l.set(e,t))}}const d=new Or(h);return new xf(l,d,o.fieldTransforms)}function Uf(t,e,n,s=!1){return Bf(n,t.aa(s?4:3,e))}function Bf(t,e){if(Kf(t=(0,a.m9)(t)))return Gf("Unsupported field value:",e,t),qf(t,e);if(t instanceof bf)return function(t,e){if(!Df(e.Zc))throw e.oa(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.oa(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.na&&4!==e.Zc)throw e.oa("Nested arrays are not supported");return function(t,e){const n=[];let s=0;for(const r of t){let t=Bf(r,e.ra(s));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),s++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=(0,a.m9)(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return ao(e.wt,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=Ws.fromDate(t);return{timestampValue:ga(e.wt,n)}}if(t instanceof Ws){const n=new Ws(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:ga(e.wt,n)}}if(t instanceof Tf)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof If)return{bytesValue:pa(e.wt,t._byteString)};if(t instanceof Gd){const n=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(n))throw e.oa(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:va(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.oa(`Unsupported field value: ${Fd(t)}`)}(t,e)}function qf(t,e){const n={};return Nr(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):_r(t,((t,s)=>{const r=Bf(s,e.ea(t));null!=r&&(n[t]=r)})),{mapValue:{fields:n}}}function Kf(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof Ws||t instanceof Tf||t instanceof If||t instanceof Gd||t instanceof bf)}function Gf(t,e,n){if(!Kf(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const s=Fd(n);throw"an object"===s?e.oa(t+" a custom object"):e.oa(t+" "+s)}}function jf(t,e,n){if((e=(0,a.m9)(e))instanceof wf)return e._internalPath;if("string"==typeof e)return zf(t,e);throw Qf("Field path arguments must be of type string or ",t,!1,void 0,n)}const $f=new RegExp("[~\\*/\\[\\]]");function zf(t,e,n){if(e.search($f)>=0)throw Qf(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new wf(...e.split("."))._internalPath}catch(s){throw Qf(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function Qf(t,e,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${s}`),o&&(u+=` in document ${r}`),u+=")"),new Ms(Rs.INVALID_ARGUMENT,a+t+u)}function Hf(t,e){return t.some((t=>t.isEqual(e)))}class Wf{constructor(t,e,n,s,r){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new Gd(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new Xf(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(Yf("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class Xf extends Wf{data(){return super.data()}}function Yf(t,e){return"string"==typeof e?zf(t,e):e instanceof wf?e._internalPath:e._delegate._internalPath}class Jf{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Zf extends Wf{constructor(t,e,n,s,r,i){super(t,e,n,s,i),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new tm(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(Yf("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class tm extends Zf{data(t={}){return super.data(t)}}class em{constructor(t,e,n,s){this._firestore=t,this._userDataWriter=e,this._snapshot=s,this.metadata=new Jf(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new tm(this._firestore,this._userDataWriter,n.key,n,new Jf(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Ms(Rs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new tm(t._firestore,t._userDataWriter,n.doc.key,n.doc,new Jf(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const s=new tm(t._firestore,t._userDataWriter,e.doc.key,e.doc,new Jf(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let r=-1,i=-1;return 0!==e.type&&(r=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:nm(e.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function nm(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return _s()}}function sm(t,e){return t instanceof Zf&&e instanceof Zf?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof em&&e instanceof em&&t._firestore===e._firestore&&Xd(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function rm(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new Ms(Rs.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class im{}function om(t,...e){for(const n of e)t=n._apply(t);return t}class am extends im{constructor(t,e,n){super(),this.fa=t,this.da=e,this._a=n,this.type="where"}_apply(t){const e=Nf(t.firestore),n=function(t,e,n,s,r,i,o){let a;if(r.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Ms(Rs.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Tm(o,i);const e=[];for(const n of o)e.push(bm(s,t,n));a={arrayValue:{values:e}}}else a=bm(s,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Tm(o,i),a=Uf(n,"where",o,"in"===i||"not-in"===i);const u=Ni.create(r,i,a);return function(t,e){if(e.ht()){const n=Qi(t);if(null!==n&&!n.isEqual(e.field))throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const s=zi(t);null!==s&&Em(0,e.field,s)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Ms(Rs.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Ms(Rs.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,u),u}(t._query,0,e,t.firestore._databaseId,this.fa,this.da,this._a);return new jd(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new Gi(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function um(t,e,n){const s=e,r=Yf("where",t);return new am(r,s,n)}class cm extends im{constructor(t,e){super(),this.fa=t,this.wa=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Ms(Rs.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Ms(Rs.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new Ui(e,n);return function(t,e){if(null===zi(t)){const n=Qi(t);null!==n&&Em(0,n,e.field)}}(t,s),s}(t._query,this.fa,this.wa);return new jd(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new Gi(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function hm(t,e="asc"){const n=e,s=Yf("orderBy",t);return new cm(s,n)}class lm extends im{constructor(t,e,n){super(),this.type=t,this.ma=e,this.ga=n}_apply(t){return new jd(t.firestore,t.converter,Yi(t._query,this.ma,this.ga))}}function dm(t){return Ud("limit",t),new lm("limit",t,"F")}function fm(t){return Ud("limitToLast",t),new lm("limitToLast",t,"L")}class mm extends im{constructor(t,e,n){super(),this.type=t,this.ya=e,this.pa=n}_apply(t){const e=Im(t,this.type,this.ya,this.pa);return new jd(t.firestore,t.converter,function(t,e){return new Gi(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function gm(...t){return new mm("startAt",t,!0)}function pm(...t){return new mm("startAfter",t,!1)}class ym extends im{constructor(t,e,n){super(),this.type=t,this.ya=e,this.pa=n}_apply(t){const e=Im(t,this.type,this.ya,this.pa);return new jd(t.firestore,t.converter,function(t,e){return new Gi(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function wm(...t){return new ym("endBefore",t,!1)}function vm(...t){return new ym("endAt",t,!0)}function Im(t,e,n,s){if(n[0]=(0,a.m9)(n[0]),n[0]instanceof Wf)return function(t,e,n,s,r){if(!s)throw new Ms(Rs.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Wi(t))if(n.field.isKeyField())i.push(oi(e,s.key));else{const t=s.data.field(n.field);if(Gr(t))throw new Ms(Rs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Pi(i,r)}(t._query,t.firestore._databaseId,e,n[0]._document,s);{const r=Nf(t.firestore);return function(t,e,n,s,r,i){const o=t.explicitOrderBy;if(r.length>o.length)throw new Ms(Rs.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<r.length;i++){const u=r[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof u}`);if(!Hi(t)&&-1!==u.indexOf("/"))throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${u}' contains a slash.`);const n=t.path.child(Js.fromString(u));if(!er.isDocumentKey(n))throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const r=new er(n);a.push(oi(e,r))}else{const t=Uf(n,s,u);a.push(t)}}return new Pi(a,i)}(t._query,t.firestore._databaseId,r,e,n,s)}}function bm(t,e,n){if("string"==typeof(n=(0,a.m9)(n))){if(""===n)throw new Ms(Rs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Hi(e)&&-1!==n.indexOf("/"))throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=e.path.child(Js.fromString(n));if(!er.isDocumentKey(s))throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return oi(t,new er(s))}if(n instanceof Gd)return oi(t,n._key);throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Fd(n)}.`)}function Tm(t,e){if(!Array.isArray(t)||0===t.length)throw new Ms(Rs.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new Ms(Rs.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function Em(t,e,n){if(!n.isEqual(e))throw new Ms(Rs.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}const Sm={maxAttempts:5};class xm{convertValue(t,e="none"){switch(Zr(t)){case 0:return null;case 1:return t.booleanValue;case 2:return qr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Kr(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw _s()}}convertObject(t,e){const n={};return _r(t.fields,((t,s)=>{n[t]=this.convertValue(s,e)})),n}convertGeoPoint(t){return new Tf(qr(t.latitude),qr(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=jr(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp($r(t));default:return null}}convertTimestamp(t){const e=Br(t);return new Ws(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=Js.fromString(t);Ns(Ka(n));const s=new Qr(n.get(1),n.get(3)),r=new er(n.popFirst(5));return s.isEqual(e)||xs(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}function Dm(t,e,n){let s;return s=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,s}class Am extends xm{constructor(t){super(),this.firestore=t}convertBytes(t){return new If(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Gd(this.firestore,null,e)}}class _m{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Nf(t)}set(t,e,n){this._verifyNotCommitted();const s=Nm(t,this._firestore),r=Dm(s.converter,e,n),i=Cf(this._dataReader,"WriteBatch.set",s._key,r,null!==s.converter,n);return this._mutations.push(i.toMutation(s._key,Eo.none())),this}update(t,e,n,...s){this._verifyNotCommitted();const r=Nm(t,this._firestore);let i;return i="string"==typeof(e=(0,a.m9)(e))||e instanceof wf?Pf(this._dataReader,"WriteBatch.update",r._key,e,n,s):Ff(this._dataReader,"WriteBatch.update",r._key,e),this._mutations.push(i.toMutation(r._key,Eo.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Nm(t,this._firestore);return this._mutations=this._mutations.concat(new Oo(e._key,Eo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Ms(Rs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Nm(t,e){if((t=(0,a.m9)(t)).firestore!==e)throw new Ms(Rs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function Cm(t){t=Pd(t,Gd);const e=Pd(t.firestore,ef);return Cd(rf(e),t._key).then((n=>jm(e,t,n)))}class km extends xm{constructor(t){super(),this.firestore=t}convertBytes(t){return new If(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new Gd(this.firestore,null,e)}}function Rm(t){t=Pd(t,Gd);const e=Pd(t.firestore,ef),n=rf(e),s=new km(e);return function(t,e){const n=new Vs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await function(t,e){const n=ks(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Ms(Rs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const s=gl(t,`Failed to get document '${e} from cache`);n.reject(s)}}(await Dd(t),e,n))),n.promise}(n,t._key).then((n=>new Zf(e,s,t._key,n,new Jf(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Mm(t){t=Pd(t,Gd);const e=Pd(t.firestore,ef);return Cd(rf(e),t._key,{source:"server"}).then((n=>jm(e,t,n)))}function Vm(t){t=Pd(t,jd);const e=Pd(t.firestore,ef),n=rf(e),s=new km(e);return rm(t._query),kd(n,t._query).then((n=>new em(e,s,t,n)))}function Lm(t){t=Pd(t,jd);const e=Pd(t.firestore,ef),n=rf(e),s=new km(e);return function(t,e){const n=new Vs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await hh(t,e,!0),r=new Ml(e,s.ji),i=r.Ku(s.documents),o=r.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const s=gl(t,`Failed to execute query '${e} against cache`);n.reject(s)}}(await Dd(t),e,n))),n.promise}(n,t._query).then((n=>new em(e,s,t,n)))}function Om(t){t=Pd(t,jd);const e=Pd(t.firestore,ef),n=rf(e),s=new km(e);return kd(n,t._query,{source:"server"}).then((n=>new em(e,s,t,n)))}function Fm(t,e,n){t=Pd(t,Gd);const s=Pd(t.firestore,ef),r=Dm(t.converter,e,n);return Gm(s,[Cf(Nf(s),"setDoc",t._key,r,null!==t.converter,n).toMutation(t._key,Eo.none())])}function Pm(t,e,n,...s){t=Pd(t,Gd);const r=Pd(t.firestore,ef),i=Nf(r);let o;return o="string"==typeof(e=(0,a.m9)(e))||e instanceof wf?Pf(i,"updateDoc",t._key,e,n,s):Ff(i,"updateDoc",t._key,e),Gm(r,[o.toMutation(t._key,Eo.exists(!0))])}function Um(t){return Gm(Pd(t.firestore,ef),[new Oo(t._key,Eo.none())])}function Bm(t,e){const n=Pd(t.firestore,ef),s=Hd(t),r=Dm(t.converter,e);return Gm(n,[Cf(Nf(t.firestore),"addDoc",s._key,r,null!==t.converter,{}).toMutation(s._key,Eo.exists(!1))]).then((()=>s))}function qm(t,...e){var n,s,r;t=(0,a.m9)(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||Jd(e[o])||(i=e[o],o++);const u={includeMetadataChanges:i.includeMetadataChanges};if(Jd(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(s=t.error)||void 0===s?void 0:s.bind(t),e[o+2]=null===(r=t.complete)||void 0===r?void 0:r.bind(t)}let c,h,l;if(t instanceof Gd)h=Pd(t.firestore,ef),l=$i(t._key.path),c={next:n=>{e[o]&&e[o](jm(h,t,n))},error:e[o+1],complete:e[o+2]};else{const n=Pd(t,jd);h=Pd(n.firestore,ef),l=n._query;const s=new km(h);c={next:t=>{e[o]&&e[o](new em(h,s,n,t))},error:e[o+1],complete:e[o+2]},rm(t._query)}return function(t,e,n,s){const r=new pd(s),i=new Dl(e,r,n);return t.asyncQueue.enqueueAndForget((async()=>bl(await Nd(t),i))),()=>{r.Tc(),t.asyncQueue.enqueueAndForget((async()=>Tl(await Nd(t),i)))}}(rf(h),l,u,c)}function Km(t,e){return function(t,e){const n=new pd(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){ks(t).Tu.add(e),e.next()}(await Nd(t),n))),()=>{n.Tc(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){ks(t).Tu.delete(e)}(await Nd(t),n)))}}(rf(t=Pd(t,ef)),Jd(e)?e:{next:e})}function Gm(t,e){return function(t,e){const n=new Vs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const s=hd(t);try{const t=await function(t,e){const n=ks(t),s=Ws.now(),r=e.reduce(((t,e)=>t.add(e.key)),ta());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=$o(),u=ta();return n.Ui.getEntries(t,r).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(u=u.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((r=>{i=r;const o=[];for(const t of e){const e=No(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new Ro(t.key,e,vi(e.value.mapValue),Eo.exists(!0)))}return n.mutationQueue.addMutationBatch(t,s,o,e)})).next((e=>{o=e;const s=e.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(t,e.batchId,s)}))})).then((()=>({batchId:o.batchId,changes:Ho(i)})))}(s.localStore,e);s.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let s=t.oc[t.currentUser.toKey()];s||(s=new Cr(zs)),s=s.insert(e,n),t.oc[t.currentUser.toKey()]=s}(s,t.batchId,n),await Jl(s,t.changes),await el(s.remoteStore)}catch(t){const e=gl(t,"Failed to persist write");n.reject(e)}}(await _d(t),e,n))),n.promise}(rf(t),e)}function jm(t,e,n){const s=n.docs.get(e._key),r=new km(t);return new Zf(t,r,e._key,s,new Jf(n.hasPendingWrites,n.fromCache),e.converter)}class $m extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Nf(t)}get(t){const e=Nm(t,this._firestore),n=new Am(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return _s();const s=t[0];if(s.isFoundDocument())return new Wf(this._firestore,n,s.key,s,e.converter);if(s.isNoDocument())return new Wf(this._firestore,n,e._key,null,e.converter);throw _s()}))}set(t,e,n){const s=Nm(t,this._firestore),r=Dm(s.converter,e,n),i=Cf(this._dataReader,"Transaction.set",s._key,r,null!==s.converter,n);return this._transaction.set(s._key,i),this}update(t,e,n,...s){const r=Nm(t,this._firestore);let i;return i="string"==typeof(e=(0,a.m9)(e))||e instanceof wf?Pf(this._dataReader,"Transaction.update",r._key,e,n,s):Ff(this._dataReader,"Transaction.update",r._key,e),this._transaction.update(r._key,i),this}delete(t){const e=Nm(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Nm(t,this._firestore),n=new km(this._firestore);return super.get(t).then((t=>new Zf(this._firestore,n,e._key,t._document,new Jf(!1,!1),e.converter)))}}function zm(t,e,n){t=Pd(t,ef);const s=Object.assign(Object.assign({},Sm),n);return function(t){if(t.maxAttempts<1)throw new Ms(Rs.INVALID_ARGUMENT,"Max attempts must be at least 1")}(s),function(t,e,n){const s=new Vs;return t.asyncQueue.enqueueAndForget((async()=>{const r=await function(t){return Sd(t).then((t=>t.datastore))}(t);new vd(t.asyncQueue,r,n,e,s).run()})),s.promise}(rf(t),(n=>e(new $m(t,n))),s)}function Qm(){return new kf("deleteField")}function Hm(){return new Mf("serverTimestamp")}function Wm(...t){return new Vf("arrayUnion",t)}function Xm(...t){return new Lf("arrayRemove",t)}function Ym(t){return new Of("increment",t)}function Jm(t){return rf(t=Pd(t,ef)),new _m(t,(e=>Gm(t,e)))}function Zm(t,e){rf(t=Pd(t,ef));const n="string"==typeof e?function(t){try{return JSON.parse(t)}catch(t){throw new Ms(Rs.INVALID_ARGUMENT,"Failed to parse JSON:"+t.message)}}(e):e,s=[];if(Array.isArray(n.indexes))for(const t of n.indexes){const e=tg(t,"collectionGroup"),n=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=zf("setIndexConfiguration",tg(e,"fieldPath"));"CONTAINS"===e.arrayConfig?n.push(new ir(t,2)):"ASCENDING"===e.order?n.push(new ir(t,0)):"DESCENDING"===e.order&&n.push(new ir(t,1))}s.push(new nr(nr.UNKNOWN_ID,e,n,or.empty()))}return Promise.resolve()}function tg(t,e){if("string"!=typeof t[e])throw new Ms(Rs.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}!function(t,e=!0){!function(t){Is=t}(r.Jn),(0,r.Xd)(new i.wA("firestore",((t,{options:n})=>{const s=t.getProvider("app").getImmediate(),r=new ef(s,new Ps(t.getProvider("auth-internal")),new Ks(t.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:e},n),r._setSettings(n),r}),"PUBLIC")),(0,r.KN)(ws,"3.4.10",t),(0,r.KN)(ws,"3.4.10","esm2017")}()}}]);